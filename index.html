<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Con-bridge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    
    <!-- Link al manifest per la PWA -->
    <link rel="manifest" href="manifest.json">
    <style>
        /* --- NUOVO DESIGN SYSTEM v4 (Stile App Nativa) --- */

        /* 1. Variabili e Stili di Base */
        :root {
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        /* Dark Theme (Default) */
        :root,
        :root[data-theme="dark"] {
            --bg-color: #121212;
            --surface-color: #1c1c1c;
            --surface-color-light: #2a2a2a;
            --primary-text: #FFFFFF;
            --secondary-text: #b3b3b3;
            --accent-color: #1DB954;
            --accent-color-dark: #19a34a;
            --danger: #e74c3c;
            --warning: #f1c40f;
        }

        /* Light Theme */
        :root[data-theme="light"] {
            --bg-color: #ffffff;
            --surface-color: #e9ecef;
            --surface-color-light: #dee2e6;
            --primary-text: #212529;
            --secondary-text: #6c757d;
            --accent-color: #1DB954;
            --accent-color-dark: #19a34a;
            --danger: #dc3545;
            --warning: #ffc107;
        }

        /* Theme Transition Styles */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-attachment: fixed;
            overflow-x: hidden;
        }

        #app {
            padding: 100px 1rem 100px 1rem;
        }

        body::-webkit-scrollbar {
            display: none;
        }

        body {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }


        /* 2. Componenti UI Ridisegnati */

        /* Header */
        .page-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--surface-color);
            z-index: 1000;
        }

        .header-buttons {
            flex-shrink: 0;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--bg-color);
            flex-shrink: 0;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 800;
            line-height: 1.2;
            word-break: break-word;
        }

        .page-subtitle {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--secondary-text);
            text-transform: capitalize;
        }

        /* Titoli di Sezione */
        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        /* Card (Per Moduli/Form) */
        .card {
            background: var(--surface-color);
            border-radius: var(--radius-md);
            padding: 1.5rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        /* Icon Buttons */
        .btn-icon {
            border: none;
            border-radius: var(--radius-sm);
            padding: 0.5rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            background: var(--surface-color-light);
            color: var(--primary-text);
        }

        .btn-icon:hover {
            background: var(--accent-color);
            transform: scale(1.05);
        }

        .btn-icon:active {
            transform: scale(0.95);
        }

        /* Enhanced mobile and accessibility support for theme toggle */
        #theme-toggle-btn {
            min-width: 44px;
            min-height: 44px;
            width: 44px;
            height: 44px;
            -webkit-tap-highlight-color: transparent;
            background: var(--accent-color) !important;
            color: white !important;
        }

        #theme-toggle-btn:focus {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
        }

        #theme-toggle-btn:focus:not(:focus-visible) {
            outline: none;
        }

        #theme-toggle-btn:hover {
            background: var(--accent-color-dark) !important;
            transform: scale(1.05);
        }

        /* Refresh button styling to match theme toggle button dimensions exactly */
        button[onclick="refreshApplication()"] {
            min-width: 44px;
            min-height: 44px;
            width: 44px;
            height: 44px;
        }

        @media (hover: none) and (pointer: coarse) {
            .btn-icon:hover {
                transform: none;
            }

            .btn-icon:active {
                background: var(--accent-color);
                transform: scale(0.95);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            #app {
                padding: 80px 0.5rem 100px 0.5rem;
            }

            .page-header {
                gap: 0.5rem;
                margin-bottom: 1rem;
                padding: 0.5rem;
            }

            .header-buttons {
                gap: 0.25rem;
            }

            .page-title {
                font-size: 1.5rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
            }

            .card {
                padding: 1rem;
            }

            .form-input,
            .form-select,
            .form-textarea {
                padding: 0.75rem;
                font-size: 16px;
                /* Prevents zoom on iOS */
            }
        }

        @media (max-width: 480px) {
            .page-header {
                flex-wrap: nowrap;
                gap: 0.25rem;
                padding: 0.5rem;
            }

            .header-buttons {
                gap: 0.25rem;
            }

            .header-buttons .btn-icon {
                padding: 0.4rem;
            }

            .page-title {
                font-size: 1.25rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .dashboard-card {
                aspect-ratio: 2 / 1;
            }

            .btn {
                padding: 0.75rem 1.25rem;
                font-size: 0.9rem;
            }

            .modal-content {
                margin: 0.5rem;
                padding: 1rem;
            }
        }

        /* Large screen media queries removed to use mobile-like layout on all screen sizes */

        /* Survey Search and Filter */
        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .gap-4 {
            gap: 1rem;
        }

        /* Badge styling */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
        }

        /* Access denied styling */
        .access-denied-icon {
            width: 64px;
            height: 64px;
            color: var(--danger);
            margin: 0 auto 1rem;
        }

        /* Bottoni */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.8rem 1.5rem;
            border-radius: var(--radius-md);
            border: none;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: var(--bg-color);
        }

        .btn-primary:hover {
            background-color: var(--accent-color-dark);
        }

        .btn-secondary {
            background-color: var(--surface-color-light);
            color: var(--primary-text);
        }

        .btn.w-full {
            width: 100%;
        }

        /* Form */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--secondary-text);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            background: var(--surface-color-light);
            border: 1px solid var(--surface-color-light);
            border-radius: var(--radius-sm);
            padding: 0.8rem 1rem;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            color: var(--primary-text);
            transition: border-color 0.2s ease;
        }

        .form-input::placeholder {
            color: var(--secondary-text);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--secondary-text);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Stile per pulsante mostra/nascondi password */
        .password-toggle-container {
            position: relative;
        }

        .password-toggle-btn {
            position: absolute;
            right: 0.2rem;
            top: 50%;
            transform: translateY(calc(-50% + 0.75rem));
            /* CORREZIONE APPLICATA QUI */
            background: none;
            border: none;
            cursor: pointer;
            color: var(--secondary-text);
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .password-toggle-btn svg {
            width: 22px;
            height: 22px;
        }

        /* --- MODIFICA INIZIO: Stili per selezione proprietà in registrazione --- */
        .property-selection-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            background-color: var(--bg-color);
            padding: 0.75rem;
            border-radius: var(--radius-sm);
        }

        .property-selection-item label {
            flex-grow: 1;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            font-weight: 500;
        }

        .property-selection-item .group-select,
        .property-selection-item .plan-select {
            flex-shrink: 0;
            font-size: 0.9rem;
            padding: 0.6rem 0.8rem;
        }

        .property-selection-item .group-select {
            flex-basis: 160px;
        }

        .property-selection-item .plan-select {
            flex-basis: 120px;
        }

        /* Stili per il contenitore dei menu a tendina impilati */
        .property-controls-stack {
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* Spazio tra i due menu */
            flex-shrink: 0;
            width: 160px; /* Larghezza fissa per il contenitore, come il campo 'gruppo' originale */
        }

        /* Reset e override per i select all'interno del nuovo contenitore */
        .property-controls-stack .group-select,
        .property-controls-stack .plan-select {
            flex-basis: auto; /* Annulla la base flessibile */
            width: 100%;
        }

        /* --- MODIFICA FINE --- */

        /* Messaggi di notifica */
        .message-box {
            padding: 1rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
            margin-bottom: 1.5rem;
            display: none;
        }

        .message-box.success {
            background-color: rgba(29, 185, 84, 0.2);
            color: var(--accent-color);
        }

        .message-box.error {
            background-color: rgba(231, 76, 60, 0.2);
            color: var(--danger);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-color);
            border-top: 1px solid var(--surface-color);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0 1rem 0;
            /* Aggiunto padding-bottom per schermi con notch */
            z-index: 1000;
        }

        .nav-item {
            position: relative;
            /* <-- AGGIUNTA CHIAVE */
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--secondary-text);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .nav-item svg {
            width: 1.75rem;
            height: 1.75rem;
            margin-bottom: 0.25rem;
        }

        .nav-item span {
            font-size: 0.75rem;
            font-weight: 500;
        }

        .nav-item.active {
            color: var(--accent-color);
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: 10px;
            min-width: 20px;
            height: 20px;
            background-color: var(--danger);
            color: var(--primary-text);
            border-radius: 10px;
            border: 2px solid var(--bg-color);
            font-size: 0.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            line-height: 1;
        }

        :root[data-theme="light"] .notification-badge {
            background-color: black;
            color: white;
        }

        /* Dashboard (Home Page) */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .dashboard-item {
            cursor: pointer;
        }

        .dashboard-card {
            background-color: var(--surface-color);
            aspect-ratio: 1 / 1;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s ease;
        }

        .dashboard-item:hover .dashboard-card {
            background-color: var(--surface-color-light);
        }

        .dashboard-card svg {
            width: 40%;
            height: 40%;
            color: var(--primary-text);
        }

        /* Light mode specific dashboard card styling - COMPLETE OVERRIDE */
        :root[data-theme="light"] .dashboard-card {
            background-color: #e9ecef !important;
            border: 2px solid #dee2e6 !important;
        }

        :root[data-theme="light"] .dashboard-item:hover .dashboard-card {
            background-color: #dee2e6 !important;
        }

        :root[data-theme="light"] .dashboard-card svg {
            color: black !important;
        }

        :root[data-theme="light"] .dashboard-item p {
            color: black !important;
        }

        /* Multiple specific selectors to ensure override */
        :root[data-theme="light"] .dashboard-grid .dashboard-card {
            background-color: #e9ecef !important;
            border: 2px solid #dee2e6 !important;
        }

        :root[data-theme="light"] .dashboard-grid .dashboard-item:hover .dashboard-card {
            background-color: #dee2e6 !important;
        }

        :root[data-theme="light"] .dashboard-grid .dashboard-card svg {
            color: black !important;
        }

        :root[data-theme="light"] .dashboard-grid .dashboard-item p {
            color: black !important;
        }

        /* Even more specific selectors */
        :root[data-theme="light"] main .dashboard-grid .dashboard-card {
            background-color: #e9ecef !important;
            border: 2px solid #dee2e6 !important;
        }

        :root[data-theme="light"] main .dashboard-grid .dashboard-card svg {
            color: black !important;
        }

        :root[data-theme="light"] main .dashboard-grid .dashboard-item p {
            color: black !important;
        }

        .dashboard-item p {
            font-weight: 600;
            text-align: left;
            padding-left: 0.5rem;
            word-break: break-word;
        }

        /* NUOVO: Stile per i pulsanti nei menu a lista (es. Funzioni Admin) */
        .menu-list-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            /* Spazio tra i pulsanti */
        }

        .menu-list-item {
            background-color: var(--surface-color);
            border-radius: var(--radius-lg);
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .menu-list-item:hover {
            background-color: var(--surface-color-light);
        }

        .menu-list-item svg {
            width: 28px;
            height: 28px;
            flex-shrink: 0;
            color: var(--accent-color);
            /* Forza il colore verde dell'icona */
        }

        .menu-list-item p {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--secondary-text);
            /* Testo grigio chiaro per contrasto */
        }

        /* Pagine a Lista */
        .list-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .list-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .list-item:hover {
            background-color: var(--surface-color);
        }

        .list-item-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-sm);
            background-color: var(--surface-color-light);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .list-item-icon svg {
            width: 24px;
            height: 24px;
            color: var(--secondary-text);
        }

        .list-item-content {
            flex-grow: 1;
            min-width: 0;
            /* Fix per flexbox overflow */
        }

        .list-item-content .title {
            font-weight: 600;
            color: var(--primary-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .list-item-content .subtitle {
            font-size: 0.85rem;
            color: var(--secondary-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .list-item-action {
            color: var(--accent-color);
            flex-shrink: 0;
        }

        /* Filtri "Chips" */
        .filter-chips-container {
            display: flex;
            gap: 0.75rem;
            overflow-x: auto;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        /* Nasconde la scrollbar */
        .filter-chips-container::-webkit-scrollbar {
            display: none;
        }

        .filter-chips-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .chip {
            padding: 0.5rem 1rem;
            border-radius: 99px;
            background-color: var(--surface-color-light);
            color: var(--primary-text);
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
        }

        .chip.active {
            background-color: var(--primary-text);
            color: var(--bg-color);
        }

        /* Badge */
        .badge {
            padding: 0.25rem 0.6rem;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 9999px;
            text-transform: capitalize;
            display: inline-block;
        }

        .badge.priority-alta {
            background-color: #922b21;
            color: #f5b7b1;
        }

        .badge.priority-media {
            background-color: #9c640c;
            color: #fdebd0;
        }

        .badge.priority-bassa {
            background-color: #145a32;
            color: #a9dfbf;
        }

        .badge.status-aperta {
            background-color: #1b4f72;
            color: #a9cce3;
        }

        .badge.status-in-corso {
            background-color: #9c640c;
            color: #fdebd0;
        }

        .badge.status-chiusa {
            background-color: #145a32;
            color: #a9dfbf;
        }

        /* Poll Bar */
        .poll-option-bar {
            width: 100%;
            background-color: var(--surface-color-light);
            border-radius: 99px;
            height: 6px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .poll-option-fill {
            height: 100%;
            background: var(--secondary-text);
            border-radius: 99px;
            transition: width 0.5s ease;
        }

        /* Stili per il Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
            cursor: pointer;
        }

        .modal-content {
            background: var(--surface-color);
            padding: 1.5rem;
            border-radius: var(--radius-md);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            cursor: default;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .modal-close-btn {
            background: none;
            border: none;
            color: var(--secondary-text);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body p {
            line-height: 1.6;
            white-space: pre-wrap;
            /* Mantiene la formattazione del testo */
        }

        .modal-body .voter-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--surface-color-light);
        }

        .modal-body .voter-item:last-child {
            border-bottom: none;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .space-y-4>*+* {
            margin-top: 1rem;
        }

        .flex {
            display: flex;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .items-center {
            align-items: center;
        }

        .justify-end {
            justify-content: flex-end;
        }

        .w-full {
            width: 100%;
        }

        .grid {
            display: grid;
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .user-action-btn {
            background: var(--surface-color-light);
            border: none;
            cursor: pointer;
            color: var(--secondary-text);
            padding: 0.5rem;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            transition: background-color 0.2s, color 0.2s;
        }

        .user-action-btn:hover {
            background-color: var(--accent-color);
            color: var(--bg-color);
        }

        /* Stili per Tabella Dati */
        .data-table-container {
            overflow-x: auto;
            /* Per responsività su schermi piccoli */
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--surface-color-light);
            white-space: nowrap;
        }

        .data-table th {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--secondary-text);
            text-transform: uppercase;
        }

        .data-table td {
            font-size: 0.95rem;
        }

        .data-table tr:hover {
            background-color: var(--surface-color-light);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* Stili per l'icona di modifica in linea nella tabella */
        .cell-content-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            width: 100%;
        }

        .inline-edit-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-text);
            opacity: 0.7;
            /* Visibile di default */
            transition: opacity 0.2s, color 0.2s;
        }

        /* La regola .data-table tr:hover .inline-edit-btn è stata rimossa */
        .inline-edit-btn:hover {
            opacity: 1;
            color: var(--accent-color);
            /* Evidenzia l'icona al passaggio del mouse */
        }

        .inline-edit-btn svg {
            width: 16px;
            height: 16px;
        }

        /* --- Stili per Custom Searchable Dropdown --- */
        .custom-dropdown-container {
            position: relative;
        }

        .custom-dropdown-list {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background-color: var(--surface-color-light);
            border: 1px solid var(--surface-color);
            border-radius: var(--radius-sm);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1100;
            /* Sopra altri elementi del form */
        }

        .custom-dropdown-list::-webkit-scrollbar {
            display: none;
        }

        .custom-dropdown-list {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .custom-dropdown-item {
            padding: 0.8rem 1rem;
            cursor: pointer;
            color: var(--primary-text);
            transition: background-color 0.2s ease;
        }

        .custom-dropdown-item:hover,
        .custom-dropdown-item.highlighted {
            background-color: var(--accent-color);
            color: var(--bg-color);
        }


        .custom-dropdown-item:not(:last-child) {
            border-bottom: 1px solid var(--surface-color);
        }

        /* --- Stili per Upload Allegati Segnalazioni --- */
        .attachment-upload-container {
            border: 2px dashed var(--surface-color-light);
            border-radius: var(--radius-sm);
            padding: 1.5rem;
            text-align: center;
            /* Mantenuto per fallback */
            cursor: pointer;
            transition: border-color 0.2s;
            /* --- MODIFICHE PER CENTRATURA VERTICALE --- */
            display: flex;
            flex-direction: column;
            /* Impila gli elementi verticalmente */
            justify-content: center;
            /* Allinea verticalmente al centro */
            align-items: center;
            /* Allinea orizzontalmente al centro */
        }

        .attachment-upload-container:hover {
            border-color: var(--accent-color);
        }

        .attachment-previews {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .preview-item {
            position: relative;
            aspect-ratio: 1 / 1;
        }

        .preview-item img,
        .preview-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-sm);
        }

        .preview-item-document {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            background-color: var(--surface-color-light);
            border-radius: var(--radius-sm);
            padding: 0.5rem;
            text-align: center;
            gap: 0.5rem;
        }

        .preview-item-document svg {
            width: 40%;
            height: 40%;
            flex-shrink: 0;
            color: var(--secondary-text);
        }

        .preview-item-document span {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--secondary-text);
            word-break: break-all;
            line-height: 1.2;
        }

        .preview-remove-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--danger);
            color: white;
            border: 2px solid var(--bg-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            line-height: 1;
        }

        .report-attachments-gallery {
            padding-left: 64px;
            /* Allineato con la descrizione */
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .gallery-item {
            aspect-ratio: 1 / 1;
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .gallery-item img,
        .gallery-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
    <div id="app"></div>

    <div id="modal-container" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" class="modal-title"></h3>
                <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            </div>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp, deleteApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, updateEmail } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, updateDoc, where, getDocs, deleteDoc, runTransaction, arrayUnion, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, listAll, uploadBytes, getDownloadURL, deleteObject, uploadBytesResumable, getBlob } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCrLAomryfk-0s5Inm2XOsBrJusgmMI87E",
            authDomain: "condo-app-49255.firebaseapp.com",
            projectId: "condo-app-49255",
            storageBucket: "condo-app-49255.appspot.com",
            messagingSenderId: "485319278595",
            appId: "1:485319278595:web:2997689b234fbba4dece36",
            measurementId: "G-2SM3DH41EZ"
        };
        const app = initializeApp(firebaseConfig);

        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app, "gs://condo-app-49255.firebasestorage.app");

        let currentUser = null;
        let userProfile = null;
        let currentPage = 'login';
        let communicationsListener = null;
        let pollsListener = null; // NUOVA RIGA
        let reportsListener = null; // NUOVA RIGA
        let sollecitisListener = null; // NUOVA RIGA
        let navigationHistory = [];
        let servicePermissions = null;
        let currentStoragePath = '';
        let selectedUploadPath = ''; // Nuova variabile per il percorso di upload scelto
        let selectedReportFiles = []; // Array per i file della segnalazione
        let selectedCommunicationFiles = []; // Array per i file della comunicazione
        let currentAdministrativePeriod = null; // NUOVO: Oggetto per il periodo amministrativo corrente

        // Stato per la registrazione, reso globale a livello di modulo per un reset corretto
        let groupedProperties = {};
        let partialCondosList = [];

        // Theme Controller Module
        const themeConfig = {
            dark: {
                name: 'dark',
                icon: 'sun'
            },
            light: {
                name: 'light',
                icon: 'moon'
            }
        };

        let currentTheme = 'dark';
        let themeToggleTimeout = null;

        const initializeTheme = () => {
            try {
                // Check for CSS custom property support
                if (!CSS.supports('color', 'var(--test)')) {
                    console.warn('CSS custom properties not supported, theme switching disabled');
                    return;
                }

                const savedTheme = localStorage.getItem('theme-preference');
                if (savedTheme && themeConfig[savedTheme]) {
                    currentTheme = savedTheme;
                } else {
                    currentTheme = 'dark'; // Default to dark theme
                }
                applyTheme(currentTheme);
            } catch (error) {
                console.error('Error initializing theme:', error);
                currentTheme = 'dark';
                applyTheme(currentTheme);
            }
        };

        const toggleTheme = () => {
            // Debounce rapid clicks
            if (themeToggleTimeout) {
                return;
            }

            themeToggleTimeout = setTimeout(() => {
                themeToggleTimeout = null;
            }, 300);

            try {
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                currentTheme = newTheme;
                applyTheme(newTheme);
                saveThemePreference(newTheme);
                updateThemeIcon(newTheme);
            } catch (error) {
                console.error('Error toggling theme:', error);
                // Reset timeout on error
                themeToggleTimeout = null;
            }
        };

        const applyTheme = (themeName) => {
            try {
                document.documentElement.setAttribute('data-theme', themeName);
            } catch (error) {
                console.error('Error applying theme:', error);
            }
        };

        const saveThemePreference = (themeName) => {
            try {
                // Validate theme name
                if (!themeConfig[themeName]) {
                    console.error('Invalid theme name:', themeName);
                    return;
                }

                localStorage.setItem('theme-preference', themeName);
            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    console.warn('localStorage quota exceeded, clearing old theme data');
                    try {
                        localStorage.removeItem('theme-preference');
                        localStorage.setItem('theme-preference', themeName);
                    } catch (retryError) {
                        console.error('Failed to save theme preference after cleanup:', retryError);
                    }
                } else {
                    console.error('Error saving theme preference:', error);
                }
            }
        };

        const updateThemeIcon = (themeName) => {
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                const iconType = themeConfig[themeName].icon;
                if (iconType === 'sun') {
                    themeIcon.innerHTML = `<path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z"/>`;
                } else {
                    themeIcon.innerHTML = `<path d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 01.818.162z"/>`;
                }
            }
        };

        const eyeIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;
        const eyeSlashIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-4 .68l1.64 1.64C9.74 7.13 10.82 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L21.73 23 20.46 21.73 4.54 5.81 3.27 4.54 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>`;

        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        const showModal = (title, contentHtml) => {
            modalTitle.textContent = title;
            modalBody.innerHTML = contentHtml;
            modalContainer.classList.remove('hidden');
        };

        const hideModal = () => {
            modalContainer.classList.add('hidden');
        };

        const loadServicePermissions = async () => {
            try {
                const settingsRef = doc(db, "settings", "servicePermissions");
                const docSnap = await getDoc(settingsRef);
                if (docSnap.exists()) {
                    servicePermissions = docSnap.data();
                } else {
                    // Default permissions if not set (all enabled for everyone)
                    servicePermissions = {
                        'all_services': { enabled: true, allowedRoles: ['tutti'] },
                        'bacheca': { enabled: true, allowedRoles: ['tutti'] },
                        'segnalazioni': { enabled: true, allowedRoles: ['tutti'] },
                        'sondaggi': { enabled: true, allowedRoles: ['tutti'] },
                        'numeri_utili': { enabled: true, allowedRoles: ['tutti'] },
                        'report': { enabled: true, allowedRoles: ['tutti'] }
                    };
                }
            } catch (error) {
                console.error("Error loading service permissions:", error);
                servicePermissions = {}; // Fallback to prevent crashes
            }
        };

        const isServiceEnabledForCurrentUser = (serviceId) => {
            if (!servicePermissions || !userProfile) return true; // Default to enabled if permissions not loaded or no profile
            if (userProfile.tipoUtente === 'adm') return true; // Adm can see and do everything

            const generalToggle = servicePermissions['all_services'];
            if (generalToggle && !generalToggle.enabled) {
                return false; // If all services are disabled, nothing is visible
            }

            const serviceConfig = servicePermissions[serviceId];
            if (!serviceConfig || !serviceConfig.enabled) return false;

            const userRole = userProfile.tipoUtente;
            return serviceConfig.allowedRoles.includes('tutti') || serviceConfig.allowedRoles.includes(userRole);
        };

        modalCloseBtn.addEventListener('click', hideModal);
        modalContainer.addEventListener('click', (event) => {
            if (event.target === modalContainer) {
                hideModal();
            }
        });

        const logActivity = async (type, userId, userName, details = {}) => {
            if (!userId || !userName) {
                console.warn("Tentativo di logging senza userId o userName.", { type, details });
                return;
            }
            try {
                // Arricchiamo i dettagli con informazioni contestuali
                const finalDetails = {
                    ...details,
                    page: currentPage, // Pagina corrente da cui parte l'azione
                    userAgent: navigator.userAgent // User agent per debugging
                };

                await addDoc(collection(db, "activities"), {
                    type: type, // es. "user_login", "report_created"
                    userId: userId,
                    userName: userName,
                    userType: userProfile?.tipoUtente || 'N/D', // Tipo di utente che ha eseguito l'azione
                    details: finalDetails, // Dettagli specifici dell'azione
                    timestamp: serverTimestamp(), // Timestamp del server per coerenza
                    createdAt: new Date() // Data JS per query complesse se necessario
                });
            } catch (error) {
                console.error("Errore nel logging dell'attività:", error);
            }
        };
        const register = async (t, e, o) => { const a = await createUserWithEmailAndPassword(auth, t, e); const totalMillesimi = o.proprieta.reduce(((sum, prop) => sum + (parseFloat(prop.millesimi) || 0)), 0); return await setDoc(doc(db, "users", a.user.uid), { nome: o.nome, cognome: o.cognome, email: t, tipoUtente: o.tipoUtente, proprieta: o.proprieta || [], telefono: o.telefono || "", millesimiTotali: totalMillesimi, createdAt: (new Date).toISOString() }), await logActivity("user_registered", a.user.uid, `${o.nome} ${o.cognome}`, { userType: o.tipoUtente }), a };

        const adminCreateUser = async (email, password, profileData) => {
            const tempAppName = `user-creation-${Date.now()}`;
            const secondaryApp = initializeApp(firebaseConfig, tempAppName);
            const secondaryAuth = getAuth(secondaryApp);

            try {
                const newUserCredential = await createUserWithEmailAndPassword(secondaryAuth, email, password);
                const newUserId = newUserCredential.user.uid;

                const totalMillesimi = profileData.proprieta.reduce(((sum, prop) => sum + (parseFloat(prop.millesimi) || 0)), 0);
                await setDoc(doc(db, "users", newUserId), {
                    nome: profileData.nome,
                    cognome: profileData.cognome,
                    email: email,
                    tipoUtente: profileData.tipoUtente,
                    proprieta: profileData.proprieta || [],
                    telefono: profileData.telefono || "",
                    millesimiTotali: totalMillesimi,
                    createdAt: (new Date).toISOString()
                });

                await logActivity("user_created_by_admin", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, {
                    createdUserId: newUserId,
                    createdUserEmail: email,
                    createdUserType: profileData.tipoUtente
                });
            } catch (error) {
                throw error;
            } finally {
                await deleteApp(secondaryApp);
            }
        };
        const login = async (t, e) => await signInWithEmailAndPassword(auth, t, e);

        // --- FUNZIONE LOGOUT CORRETTA ---
        const logout = async () => {
            communicationsListener && (communicationsListener(), communicationsListener = null);
            // Si limita a chiamare signOut. Sarà onAuthStateChanged a gestire il resto.
            await signOut(auth);
        };

        const resetPassword = async t => await sendPasswordResetEmail(auth, t);
        const loadUserProfile = async t => { if (t) { const e = await getDoc(doc(db, "users", t.uid)); e.exists() && (userProfile = e.data()) } };
        
        // NUOVO: Carica il periodo amministrativo corrente
        const loadCurrentAdministrativePeriod = async () => {
            try {
                const now = new Date();
                const q = query(collection(db, "administrativePeriods"), 
                    where("startDate", "<=", now), 
                    orderBy("startDate", "desc"),
                    limit(1));

                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    const periodDoc = snapshot.docs[0];
                    const periodData = periodDoc.data();
                    if (periodData.endDate.toDate() >= now) {
                        currentAdministrativePeriod = { id: periodDoc.id, ...periodData };
                    } else {
                        currentAdministrativePeriod = null;
                    }
                } else {
                    currentAdministrativePeriod = null;
                }
            } catch (error) {
                console.error("Errore nel caricamento del periodo amministrativo:", error);
                currentAdministrativePeriod = null;
            }
        };

        // NUOVO: Renderizza il banner del periodo amministrativo
        const renderCurrentPeriodBanner = () => {
            if (currentAdministrativePeriod) {
                const startDate = currentAdministrativePeriod.startDate.toDate().toLocaleDateString('it-IT');
                const endDate = currentAdministrativePeriod.endDate.toDate().toLocaleDateString('it-IT');
                return `
                <div class="card" style="margin-bottom: 1.5rem; border-left: 4px solid var(--accent-color);">
                    <p style="font-weight: 500; color: var(--secondary-text);">
                        Periodo Amministrativo Corrente: <strong style="color: var(--primary-text);">${currentAdministrativePeriod.year}</strong> (dal ${startDate} al ${endDate})
                    </p>
                </div>`;
            }
            return '';
        };

        // NUOVO: Pagina di gestione dei periodi amministrativi
        const renderPeriodiAmministrativi = () => `
            ${renderHeader('Periodi Amministrativi')}
            <main>
                <div class="card" style="margin-bottom: 2rem;">
                    <h3 class="card-title">Crea Nuovo Periodo</h3>
                    <div id="period-message" class="message-box"></div>
                    <form id="create-period-form" class="space-y-4">
                        <div class="form-group">
                            <label for="period-year" class="form-label">Anno Amministrativo</label>
                            <input type="text" id="period-year" class="form-input" required placeholder="Es. 2023-2024">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="period-start-date" class="form-label">Dal</label>
                                <input type="date" id="period-start-date" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="period-end-date" class="form-label">Al</label>
                                <input type="date" id="period-end-date" class="form-input" required>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" class="btn btn-primary">Crea Periodo</button>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <h3 class="card-title">Periodi Esistenti</h3>
                    <div id="periods-list-container" class="list-container">
                        <p style="color:var(--secondary-text);">Caricamento periodi...</p>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        // NUOVO: Handler per la pagina dei periodi
        const setupPeriodiAmministrativiHandlers = () => {
            const form = document.getElementById('create-period-form');
            form?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const messageBox = document.getElementById('period-message');
                messageBox.style.display = 'none';

                const year = document.getElementById('period-year').value.trim();
                const startDateStr = document.getElementById('period-start-date').value;
                const endDateStr = document.getElementById('period-end-date').value;

                if (!year || !startDateStr || !endDateStr) {
                    messageBox.className = 'message-box error';
                    messageBox.textContent = 'Tutti i campi sono obbligatori.';
                    messageBox.style.display = 'block';
                    return;
                }

                const startDate = new Date(startDateStr);
                const endDate = new Date(endDateStr);

                if (endDate < startDate) {
                    messageBox.className = 'message-box error';
                    messageBox.textContent = 'La data di fine non può essere precedente alla data di inizio.';
                    messageBox.style.display = 'block';
                    return;
                }

                try {
                    await addDoc(collection(db, "administrativePeriods"), {
                        year: year,
                        startDate: startDate,
                        endDate: endDate,
                        createdAt: serverTimestamp()
                    });
                    
                    await logActivity("admin_period_created", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { year });
                    messageBox.className = 'message-box success';
                    messageBox.textContent = 'Periodo creato con successo!';
                    messageBox.style.display = 'block';
                    form.reset();
                    await loadCurrentAdministrativePeriod(); // Ricarica il periodo corrente

                } catch (error) {
                    console.error("Errore creazione periodo:", error);
                    messageBox.className = 'message-box error';
                    messageBox.textContent = `Errore: ${error.message}`;
                    messageBox.style.display = 'block';
                }
            });

            const listContainer = document.getElementById('periods-list-container');
            const q = query(collection(db, "administrativePeriods"), orderBy("startDate", "desc"));
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    listContainer.innerHTML = '<p style="color:var(--secondary-text);">Nessun periodo amministrativo creato.</p>';
                    return;
                }
                listContainer.innerHTML = snapshot.docs.map(docSnap => {
                    const period = docSnap.data();
                    const startDate = period.startDate.toDate().toLocaleDateString('it-IT');
                    const endDate = period.endDate.toDate().toLocaleDateString('it-IT');
                    const isCurrent = currentAdministrativePeriod && currentAdministrativePeriod.id === docSnap.id;
                    return `
                    <div class="list-item" style="background: var(--surface-color-light);">
                        <div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1M17,12H12V17H17V12Z"/></svg></div>
                        <div class="list-item-content">
                            <div class="title">${period.year} ${isCurrent ? '<span class="badge status-chiusa" style="margin-left:8px;">In Corso</span>' : ''}</div>
                            <div class="subtitle">Dal ${startDate} al ${endDate}</div>
                        </div>
                        <div class="list-item-action">
                            <button onclick="deleteAdministrativePeriod('${docSnap.id}')" class="btn-icon" style="background:var(--danger); color:white;">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                            </button>
                        </div>
                    </div>`;
                }).join('');
            });
        };

        // NUOVO: Funzione per eliminare un periodo
        const deleteAdministrativePeriod = async (periodId) => {
            if (!confirm("Sei sicuro di voler eliminare questo periodo amministrativo? L'azione è irreversibile.")) {
                return;
            }
            try {
                await deleteDoc(doc(db, 'administrativePeriods', periodId));
                await logActivity("admin_period_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { periodId });
                await loadCurrentAdministrativePeriod(); // Ricarica per verificare se il periodo corrente è stato eliminato
            } catch (error) {
                console.error("Errore eliminazione periodo:", error);
                alert(`Errore: ${error.message}`);
            }
        };

        const navigateTo = (e) => {
            const userType = userProfile?.tipoUtente;

            // Service permission check
            const serviceMap = {
                'bacheca': 'bacheca',
                'segnalazioni': 'segnalazioni', 'segnalazioni_crea': 'segnalazioni', 'segnalazioni_ricevute': 'segnalazioni', 'segnalazioni_utente': 'segnalazioni',
                'sondaggi': 'sondaggi', 'sondaggi_crea': 'sondaggi', 'sondaggi_elenco': 'sondaggi', 'sondaggi_attivi': 'sondaggi', 'sondaggi_conclusi': 'sondaggi',
                'infoUtili': 'numeri_utili', 'numeriUtiliImportati': 'numeri_utili', 'numeriUtiliManuali': 'numeri_utili', 'numeriUtiliRubrica': 'numeri_utili', 'numeriUtiliCustode': 'numeri_utili', 'infoUtili_amministratore': 'numeri_utili',
                'reportPage': 'report', 'elencoCondomini': 'report'
            };
            const requiredService = serviceMap[e];
            if (requiredService && !isServiceEnabledForCurrentUser(requiredService)) {
                console.log(`Access to page '${e}' denied by service permissions.`);
                navigateTo('dashboard'); // Redirect to a safe page
                return;
            }

            // --- NUOVA LOGICA DI AUTORIZZAZIONE ROBUSTA ---
            const supervisorePages = ['userManagement', 'gestioneGruppi', 'importazione', 'orariCustode'];
            const admOnlyPages = ['abilitaServizi', 'cronologiaAttivita'];

            // Se la pagina è riservata solo all'ADM, ma l'utente non è ADM, blocca e reindirizza.
            if (admOnlyPages.includes(e) && userType !== 'adm') {
                console.warn(`Accesso negato per il ruolo '${userType}' alla pagina '${e}'. Reindirizzamento.`);
                navigateTo('dashboard'); // Reindirizza a una pagina sicura
                return;
            }

            // Se la pagina è per Supervisore/ADM, ma l'utente non ha nessuno dei due ruoli, blocca e reindirizza.
            if (supervisorePages.includes(e) && !['supervisore', 'adm'].includes(userType)) {
                console.warn(`Accesso negato per il ruolo '${userType}' alla pagina '${e}'. Reindirizzamento.`);
                navigateTo('dashboard'); // Reindirizza a una pagina sicura
                return;
            }
            // --- FINE NUOVA LOGICA ---

            if (navigationHistory[navigationHistory.length - 1] !== e) {
                navigationHistory.push(e);
            }

            if (userType === "custode" && ["sondaggi", "sondaggi_crea", "sondaggi_elenco", "sondaggi_attivi", "sondaggi_conclusi"].includes(e)) {
                navigateTo("segnalazioni");
            } else {
                currentPage = e, renderCurrentPage();
            }
        };

        const navigateBack = () => {
            if (navigationHistory.length > 1) {
                navigationHistory.pop(); // Rimuove la pagina corrente dalla cronologia
                currentPage = navigationHistory[navigationHistory.length - 1]; // La pagina precedente diventa quella corrente
                renderCurrentPage();
            }
            // Non fa nulla se non c'è una pagina precedente
        };

        const refreshApplication = async () => {
            const refreshBtn = document.querySelector('button[onclick="refreshApplication()"]');
            if (refreshBtn) {
                // Add spinning animation to the refresh icon
                const icon = refreshBtn.querySelector('svg');
                if (icon) {
                    icon.style.animation = 'spin 1s linear infinite';
                }
                refreshBtn.disabled = true;
            }

            try {
                // Show a brief loading message
                const tempMessage = document.createElement('div');
                tempMessage.className = 'message-box success';
                tempMessage.textContent = 'Aggiornamento in corso...';
                tempMessage.style.position = 'fixed';
                tempMessage.style.top = '80px';
                tempMessage.style.left = '1rem';
                tempMessage.style.right = '1rem';
                tempMessage.style.zIndex = '1500';
                tempMessage.style.display = 'block';
                document.body.appendChild(tempMessage);

                // Reload user profile to get latest data
                if (currentUser) {
                    const userDoc = await getDoc(doc(db, "users", currentUser.uid));
                    if (userDoc.exists()) {
                        userProfile = userDoc.data();
                    }
                }

                // Reload service permissions
                await loadServicePermissions();

                // Restart real-time listeners for fresh data
                if (typeof checkForNewCommunications === 'function') {
                    checkForNewCommunications();
                }
                if (typeof checkForNewPolls === 'function') {
                    checkForNewPolls();
                }
                if (typeof checkForNewReports === 'function') {
                    checkForNewReports();
                }
                if (typeof checkForNewSolleciti === 'function') {
                    checkForNewSolleciti();
                }
                if (typeof checkForUserReportUpdates === 'function') {
                    checkForUserReportUpdates();
                }
                if (typeof checkForNewArchivioActivity === 'function') {
                    checkForNewArchivioActivity();
                }

                // Re-render the current page to show latest data
                renderCurrentPage();

                // Show success message
                tempMessage.textContent = 'Applicazione aggiornata con successo!';
                setTimeout(() => {
                    if (tempMessage.parentNode) {
                        tempMessage.parentNode.removeChild(tempMessage);
                    }
                }, 2000);

            } catch (error) {
                console.error('Errore durante l\'aggiornamento:', error);

                // Show error message
                const errorMessage = document.createElement('div');
                errorMessage.className = 'message-box error';
                errorMessage.textContent = 'Errore durante l\'aggiornamento. Riprova.';
                errorMessage.style.position = 'fixed';
                errorMessage.style.top = '80px';
                errorMessage.style.left = '1rem';
                errorMessage.style.right = '1rem';
                errorMessage.style.zIndex = '1500';
                errorMessage.style.display = 'block';
                document.body.appendChild(errorMessage);

                setTimeout(() => {
                    if (errorMessage.parentNode) {
                        errorMessage.parentNode.removeChild(errorMessage);
                    }
                }, 3000);
            } finally {
                // Remove spinning animation and re-enable button
                if (refreshBtn) {
                    const icon = refreshBtn.querySelector('svg');
                    if (icon) {
                        icon.style.animation = '';
                    }
                    refreshBtn.disabled = false;
                }
            }
        };

        const getPriorityColor = t => ({
            "solo-segnalazione": "priority-bassa",
            "richiesta-intervento-propria": "priority-media",
            "richiesta-intervento-danno": "priority-alta",
            "altre-richieste": "priority-media",
            // Legacy support for old values
            alta: "priority-alta",
            media: "priority-media",
            bassa: "priority-bassa"
        }[t] || "priority-bassa");

        const getPriorityDisplayText = t => ({
            "solo-segnalazione": "Solo segnalazione",
            "richiesta-intervento-propria": "Richiesta d'intervento nella propria UI",
            "richiesta-intervento-danno": "Richiesta d'intervento per danno propria UI da altre parti",
            "altre-richieste": "Altre richieste",
            // Legacy support for old values
            alta: "Alta",
            media: "Media",
            bassa: "Bassa"
        }[t] || t);
        const getStatusColor = t => ({ aperta: "status-aperta", "in-corso": "status-in-corso", risolta: "status-in-corso", chiusa: "status-chiusa" }[t] || "status-aperta");

        const renderHeader = (title) => {
            const userInitial = userProfile?.nome ? userProfile.nome.charAt(0).toUpperCase() : 'U';
            const userType = userProfile?.tipoUtente || '';

            const backButtonHtml = navigationHistory.length > 1 ? `
                <button onclick="navigateBack()" style="background:none; border:none; color:var(--primary-text); cursor:pointer; padding:0;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                </button>
            ` : '';

            // Only show theme toggle and refresh buttons on Home page
            const showButtons = title === 'Home';

            const themeToggleButtonHtml = showButtons ? `
                <button id="theme-toggle-btn" onclick="toggleTheme()" class="btn-icon" title="Cambia tema" aria-label="Cambia tema" role="button" tabindex="0">
                    <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 01.818.162z"/>
                    </svg>
                </button>
            ` : '';

            const refreshButtonHtml = showButtons ? `
                <button onclick="refreshApplication()" class="btn-icon" title="Aggiorna per ricevere gli ultimi aggiornamenti">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                </button>
            ` : '';

            const buttonsContainer = showButtons ? `
                <div class="header-buttons" style="display: flex; gap: 0.5rem; margin-left: auto;">
                    ${themeToggleButtonHtml}
                    ${refreshButtonHtml}
                </div>
            ` : '';

            return `
            <header class="page-header">
                <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                    ${backButtonHtml}
                    <div class="user-avatar">${userInitial}</div>
                    <div>
                        <h1 class="page-title">${title}</h1>
                        <p class="page-subtitle">${userType}</p>
                    </div>
                </div>
                ${buttonsContainer}
            </header>`;
        }

        const renderLoginPage = () => `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; padding:1rem;">
                <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; color: var(--accent-color);">Con-bridge</h1>
                <h2 id="auth-title" style="font-size: 1.5rem; font-weight: 600; margin-bottom: 2rem;">Accedi</h2>
                
                <div id="error-message" class="message-box error w-full" style="max-width:400px;"></div>
                <div id="success-message" class="message-box success w-full" style="max-width:400px;"></div>

                <form id="auth-form" class="space-y-4 w-full" style="max-width:400px;">
                    <div class="form-group"><label for="email" class="form-label">Email</label><input id="email" name="email" type="email" required placeholder="la-tua-email@esempio.com" class="form-input"></div>
                    
                    <div class="form-group password-toggle-container">
                        <label for="password" class="form-label">Password</label>
                        <input id="password" name="password" type="password" required placeholder="••••••••" class="form-input" style="padding-right: 3.5rem;">
                        <button type="button" class="password-toggle-btn" data-target="password">${eyeIcon}</button>
                    </div>
                    
                    <div id="register-fields" class="hidden space-y-4">
                        <div class="form-group password-toggle-container">
                            <label for="confirm-password" class="form-label">Conferma Password</label>
                            <input id="confirm-password" name="confirm-password" type="password" placeholder="••••••••" class="form-input" style="padding-right: 3.5rem;">
                            <button type="button" class="password-toggle-btn" data-target="confirm-password">${eyeIcon}</button>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group"><label for="nome" class="form-label">Nome</label><input id="nome" name="nome" type="text" placeholder="Mario" class="form-input"></div>
                            <div class="form-group"><label for="cognome" class="form-label">Cognome</label><input id="cognome" name="cognome" type="text" placeholder="Rossi" class="form-input"></div>
                        </div>
                        <input id="tipo-utente" name="tipo-utente" type="hidden" value="condomino">
                        <p style="font-size: 0.8rem; color: var(--secondary-text); text-align: center; margin-top: -0.5rem; margin-bottom: 1rem;">La registrazione è consentita solo ai condomini. Per altri ruoli, contattare il supervisore.</p>
                        
                        <div class="form-group custom-dropdown-container">
                            <label for="nominativo-search" class="form-label">Nominativo proprietario</label>
                            <input id="nominativo-search" name="nominativo-search" type="text" placeholder="Digita per cercare e selezionare..." class="form-input" autocomplete="off">
                            <div id="nominativo-options" class="custom-dropdown-list hidden">
                                <!-- Le opzioni verranno popolate dinamicamente via JS -->
                            </div>
                        </div>

                        <!-- --- MODIFICA INIZIO: Contenitore per la selezione delle proprietà e dei gruppi --- -->
                        <div id="property-selection-wrapper" class="form-group hidden" style="background: var(--surface-color-light); padding: 1rem; border-radius: var(--radius-sm);">
                             <label class="form-label" style="margin-bottom: 1rem;">Seleziona le tue Unità e assegna un Gruppo</label>
                             <div id="property-items-container" class="space-y-4">
                                 <!-- Le proprietà con i dropdown verranno aggiunte dinamicamente qui -->
                             </div>
                        </div>
                        <!-- --- MODIFICA FINE --- -->

                        <div class="form-group">
                            <label class="form-label">Riepilogo Selezione</label>
                            <div id="selection-summary" style="background: var(--surface-color-light); padding: 1rem; border-radius: var(--radius-sm); min-height: 60px; color: var(--secondary-text);">
                                Seleziona un nominativo per continuare...
                            </div>
                        </div>
                        <div class="form-group"><label for="telefono" class="form-label">Telefono</label><input id="telefono" name="telefono" type="tel" placeholder="123-456-7890" class="form-input"></div>
                    </div>
                    
                    <button type="submit" id="auth-submit" class="btn btn-primary w-full">Accedi</button>

                    <div id="error-message" class="message-box error w-full" style="max-width:400px; margin-top: 1rem;"></div>
                    <div id="success-message" class="message-box success w-full" style="max-width:400px; margin-top: 1rem;"></div>
                </form>

                <div class="flex w-full mt-4" style="max-width:400px; justify-content: space-between;">
                    <button type="button" id="toggle-auth" style="background:none; border:none; color:var(--secondary-text); cursor:pointer;">Registrati</button>
                    <button type="button" id="forgot-password" style="background:none; border:none; color:var(--secondary-text); cursor:pointer;">Password dimenticata?</button>
                </div>

                <div id="error-message" class="message-box error w-full" style="max-width:400px; margin-top: 1rem;"></div>
                <div id="success-message" class="message-box success w-full" style="max-width:400px; margin-top: 1rem;"></div>
            </div>`;

        const renderBottomNavigation = () => {
            const isCustodian = userProfile?.tipoUtente === 'custode';

            const navItems = isCustodian
                ? `
        <a href="#" onclick="navigateTo('dashboard')" class="nav-item ${currentPage === 'dashboard' ? 'active' : ''}"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>Home</span></a>
        <a href="#" onclick="navigateTo('segnalazioni')" class="nav-item ${currentPage === 'segnalazioni' ? 'active' : ''}">
            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2Z"/></svg>
            <span>Segnala</span>
        </a>
        <a href="#" onclick="navigateTo('bacheca')" id="nav-item-bacheca" class="nav-item ${currentPage === 'bacheca' ? 'active' : ''}">
            <span id="bacheca-notification-badge" class="notification-badge hidden"></span>
            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
            <span>Bacheca</span>
        </a>
        <a href="#" onclick="navigateTo('infoUtili')" class="nav-item ${currentPage === 'infoUtili' ? 'active' : ''}">
            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.2,16.2L11,13V7H12.5V12.2L17,14.9L16.2,16.2Z" /></svg>
            <span>Orari</span>
        </a>
        <a href="#" onclick="navigateTo('profilo')" class="nav-item ${currentPage === 'profilo' ? 'active' : ''}">
            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></svg>
            <span>Profilo</span>
        </a>
    `
                // --- SOSTITUISCI CON QUESTO BLOCCO ---
                : `
    <a href="#" onclick="navigateTo('dashboard')" class="nav-item ${currentPage === 'dashboard' ? 'active' : ''}"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>Home</span></a>
    ${isServiceEnabledForCurrentUser('bacheca') ? `<a href="#" onclick="navigateTo('bacheca')" id="nav-item-bacheca" class="nav-item ${currentPage === 'bacheca' ? 'active' : ''}">
        <span id="bacheca-notification-badge" class="notification-badge hidden"></span>
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
        <span>Bacheca</span>
    </a>` : ''}
    ${isServiceEnabledForCurrentUser('segnalazioni') ? `<a href="#" onclick="navigateTo('segnalazioni')" class="nav-item ${['segnalazioni', 'segnalazioni_crea', 'segnalazioni_ricevute', 'segnalazioni_utente'].includes(currentPage) ? 'active' : ''}">
    <span id="segnalazioni-notification-badge" class="notification-badge hidden"></span>
    <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2Z"/></svg>
    <span>Segnala</span>
</a>` : ''}
    ${['supervisore', 'adm', 'amministratore', 'consigliere'].includes(userProfile?.tipoUtente) ? `<a href="#" onclick="navigateTo('segnalazioni_urgenti')" class="nav-item ${currentPage === 'segnalazioni_urgenti' ? 'active' : ''}">
    <span id="solleciti-notification-badge" class="notification-badge hidden"></span>
    <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
    <span>Solleciti</span>
</a>` : ''}
    ${isServiceEnabledForCurrentUser('sondaggi') ? `<a href="#" onclick="navigateTo('sondaggi')" class="nav-item ${['sondaggi', 'sondaggi_crea', 'sondaggi_elenco', 'sondaggi_attivi', 'sondaggi_conclusi'].includes(currentPage) ? 'active' : ''}">
        <span id="sondaggi-notification-badge" class="notification-badge hidden"></span>
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/></svg>
        <span>Sondaggi</span>
    </a>` : ''}
    <a href="#" onclick="navigateTo('profilo')" class="nav-item ${currentPage === 'profilo' ? 'active' : ''}"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></svg><span>Profilo</span></a>
`;
            return `<nav class="bottom-nav">${navItems}</nav>`;
        };

        const renderDashboard = () => {
            const dashboardItemsHtml = [];

            if (isServiceEnabledForCurrentUser('bacheca') && userProfile?.tipoUtente !== 'fornitore') {
                dashboardItemsHtml.push(`
        <div onclick="navigateTo('bacheca')" class="dashboard-item">
            <div class="dashboard-card" style="position: relative;">
                <span id="dashboard-bacheca-badge" class="notification-badge hidden" style="top: 8px; right: 8px;"></span>
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
            </div>
            <p>Bacheca</p>
        </div>
    `);
            }
            if (isServiceEnabledForCurrentUser('segnalazioni')) {
                dashboardItemsHtml.push(`
        <div onclick="navigateTo('segnalazioni')" class="dashboard-item">
            <div class="dashboard-card" style="position: relative;">
                <span id="dashboard-segnalazioni-badge" class="notification-badge hidden" style="top: 8px; right: 8px;"></span>
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
            </div>
            <p>Segnalazioni</p>
        </div>
    `);
            }
            if (['supervisore', 'adm', 'amministratore', 'consigliere'].includes(userProfile?.tipoUtente)) {
                dashboardItemsHtml.push(`
        <div onclick="navigateTo('segnalazioni_urgenti')" class="dashboard-item">
            <div class="dashboard-card" style="position: relative;">
                <span id="dashboard-solleciti-badge" class="notification-badge hidden" style="top: 8px; right: 8px;"></span>
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
            </div>
            <p>Solleciti</p>
        </div>
    `);
            }
            if (isServiceEnabledForCurrentUser('sondaggi') && userProfile?.tipoUtente !== 'fornitore') {
                dashboardItemsHtml.push(`
                    <div onclick="navigateTo('sondaggi')" class="dashboard-item">
                        <div class="dashboard-card" style="position: relative;">
                            <span id="dashboard-sondaggi-badge" class="notification-badge hidden" style="top: 8px; right: 8px;"></span>
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/></svg>
                        </div>
                        <p>Sondaggi</p>
                    </div>
                `);
            }
            if (isServiceEnabledForCurrentUser('numeri_utili') && userProfile?.tipoUtente !== 'fornitore') {
                dashboardItemsHtml.push(`
                    <div onclick="navigateTo('infoUtili')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg></div>
                        <p>Numeri utili</p>
                    </div>
                `);
            }
            if (isServiceEnabledForCurrentUser('report')) {
                dashboardItemsHtml.push(`
                    <div onclick="navigateTo('reportPage')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z"/></svg></div>
                        <p>Report</p>
                    </div>
                `);
            }
            // Aggiunta pulsante Archivio
            if (userProfile?.tipoUtente !== 'fornitore') {
                dashboardItemsHtml.push(`
                    <div onclick="navigateTo('archivio')" class="dashboard-item" style="position: relative;">
                        <span id="dashboard-archivio-badge" class="notification-badge hidden" style="position: absolute; top: 8px; right: 8px;"></span>
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V6h5.17l2 2H20v10z"/></svg></div>
                        <p>Archivio</p>
                    </div>
                `);
            }
            if (['adm', 'amministratore'].includes(userProfile?.tipoUtente)) {
                    dashboardItemsHtml.push(`
                        <div onclick="navigateTo('statisticheCondomini')" class="dashboard-item">
                            <div class="dashboard-card">
                                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M4 4h4v16H4V4zm6 0h4v16h-4V4zm6 0h4v16h-4V4z"/></svg>
                            </div>
                            <p>Statistiche</p>
                        </div>
                    `);
                }

                if (['supervisore', 'adm'].includes(userProfile?.tipoUtente)) {
                    dashboardItemsHtml.push(`
                        <div onclick="navigateTo('gestioneGruppi')" class="dashboard-item">
                        <div class="dashboard-card">
                            <svg fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M10,22C9.75,22 9.54,21.82 9.5,21.58L9.13,18.93C8.5,18.68 7.96,18.34 7.44,17.94L4.95,18.95C4.73,19.03 4.46,18.95 4.34,18.73L2.34,15.27C2.21,15.05 2.27,14.78 2.46,14.63L4.57,12.97L4.5,12L4.57,11.03L2.46,9.37C2.27,9.22 2.21,8.95 2.34,8.73L4.34,5.27C4.46,5.05 4.73,4.96 4.95,5.05L7.44,6.05C7.96,5.66 8.5,5.32 9.13,5.07L9.5,2.42C9.54,2.18 9.75,2 10,2H14C14.25,2 14.46,2.18 14.5,2.42L14.87,5.07C15.5,5.32 16.04,5.66 16.56,6.05L19.05,5.05C19.27,4.96 19.54,5.05 19.66,5.27L21.66,8.73C21.79,8.95 21.73,9.22 21.54,9.37L19.43,11.03L19.5,12L19.43,12.97L21.54,14.63C21.73,14.78 21.79,15.05 21.66,15.27L19.66,18.73C19.54,18.95 19.27,19.04 19.05,18.95L16.56,17.95C16.04,18.34 15.5,18.68 14.87,18.93L14.5,21.58C14.46,21.82 14.25,22 14,22H10M11.25,4L10.88,6.61C9.68,6.86 8.62,7.5 7.85,8.39L5.44,7.35L4.69,8.65L6.8,10.2C6.4,11.37 6.4,12.64 6.8,13.8L4.68,15.36L5.43,16.66L7.86,15.62C8.63,16.5 9.68,17.14 10.87,17.38L11.24,20H12.76L13.13,17.39C14.32,17.14 15.37,16.5 16.14,15.62L18.57,16.66L19.32,15.36L17.2,13.81C17.6,12.64 17.6,11.37 17.2,10.2L19.31,8.65L18.56,7.35L16.15,8.39C15.38,7.5 14.32,6.86 13.12,6.62L12.75,4H11.25Z"/>
                            </svg>
                        </div>
                        <p>${userProfile?.tipoUtente === 'adm' ? 'Funzioni Admin' : 'Funzioni Supervisore'}</p>
                    </div>
                `);

                // Aggiungi il pulsante Cronologia solo per l'utente 'adm'
                if (userProfile?.tipoUtente === 'adm') {
                    dashboardItemsHtml.push(`
                        <div onclick="navigateTo('cronologiaAttivita')" class="dashboard-item">
                            <div class="dashboard-card">
                               <svg fill="currentColor" viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
                            </div>
                            <p>Cronologia Attività</p>
                        </div>
                    `);
                }
            }

            return `
            ${renderHeader('Home')}
            <main>
                <h2 class="section-title">Accesso Rapido</h2>
                <div class="dashboard-grid">
                    ${dashboardItemsHtml.join('')}
                </div>

                ${['adm', 'amministratore'].includes(userProfile?.tipoUtente) ? `

                ` : ''}
                
                <div style="margin-top: 2rem;">
                  <button onclick="logout()" class="btn btn-secondary w-full">Esci</button>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;
        }

        const renderStatisticheCondomini = () => `
            ${renderHeader('Statistiche')}
            <main>
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 class="card-title">Filtra Statistiche</h3>
                    <form id="stats-filter-form" class="space-y-4">
                        <div class="form-group">
                            <label for="condo-filter" class="form-label">Condominio / Gruppo</label>
                            <select id="condo-filter" class="form-select">
                                <option value="all">Tutti i gruppi</option>
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="activity-type-filter" class="form-label">Tipo di Attività</label>
                            <select id="activity-type-filter" class="form-select">
                                <option value="all">Tutte le attività</option>
                                <option value="communications">Comunicazioni</option>
                                <option value="reports">Segnalazioni</option>
                                <option value="polls">Sondaggi</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="start-date" class="form-label">Data Inizio</label>
                                <input type="date" id="start-date" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="end-date" class="form-label">Data Fine</label>
                                <input type="date" id="end-date" class="form-input">
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-primary" style="flex:1;">Applica Filtri</button>
                            <button type="reset" id="reset-stats-filters-btn" class="btn btn-secondary" style="flex:1;">Resetta</button>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <h2 class="section-title">Riepilogo Attività per Gruppo</h2>
                    <div id="condo-stats-container" class="data-table-container">
                        <p style="color:var(--secondary-text);">Applica i filtri per visualizzare le statistiche...</p>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;
        
        const setupStatisticheCondominiHandlers = async () => {
            const filterForm = document.getElementById('stats-filter-form');
            const resetBtn = document.getElementById('reset-stats-filters-btn');
            const condoFilterSelect = document.getElementById('condo-filter');

            // Populate the condo filter dropdown
            try {
                const groupsSnapshot = await getDocs(query(collection(db, "partialCondos"), orderBy("name")));
                groupsSnapshot.forEach(doc => {
                    const groupName = doc.data().name;
                    const option = document.createElement('option');
                    option.value = groupName;
                    option.textContent = groupName;
                    condoFilterSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error populating condo filter:", error);
                condoFilterSelect.innerHTML += '<option disabled>Errore nel caricamento</option>';
            }
            
            const handleFilter = (e) => {
                if(e) e.preventDefault();
                loadCondoStats();
            };
            
            filterForm.addEventListener('submit', handleFilter);
            resetBtn.addEventListener('click', () => {
                filterForm.reset();
                setTimeout(handleFilter, 0); 
            });

            loadCondoStats();
        };

        const loadCondoStats = async () => {
            const container = document.getElementById('condo-stats-container');
            if (!container) return;
            container.innerHTML = '<p style="color:var(--secondary-text);">Caricamento statistiche...</p>';

            try {
                const startDateInput = document.getElementById('start-date')?.value;
                const endDateInput = document.getElementById('end-date')?.value;
                
                let startDate = null;
                let endDate = null;

                if (startDateInput) {
                    startDate = new Date(startDateInput);
                    startDate.setHours(0, 0, 0, 0);
                }
                if (endDateInput) {
                    endDate = new Date(endDateInput);
                    endDate.setHours(23, 59, 59, 999);
                }

                const buildQueryWithFilters = (collectionName) => {
                    const constraints = [];
                    if (startDate) {
                        constraints.push(where("createdAt", ">=", startDate));
                    }
                    if (endDate) {
                        constraints.push(where("createdAt", "<=", endDate));
                    }
                    return query(collection(db, collectionName), ...constraints);
                };

                // 1. Fetch all necessary data in parallel
                const [groupsSnapshot, usersSnapshot, commsSnapshot, reportsSnapshot, pollsSnapshot] = await Promise.all([
                    getDocs(query(collection(db, "partialCondos"), orderBy("name"))),
                    getDocs(collection(db, "users")),
                    getDocs(buildQueryWithFilters("communications")),
                    getDocs(buildQueryWithFilters("reports")),
                    getDocs(buildQueryWithFilters("polls"))
                ]);

                // 2. Initialize stats object and user-to-group mapping
                const stats = {};
                const allGroupNames = [];
                groupsSnapshot.forEach(doc => {
                    const groupName = doc.data().name;
                    stats[groupName] = { communications: 0, reports: 0, polls: 0 };
                    allGroupNames.push(groupName);
                });

                const userToGroupsMap = new Map();
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    const userGroups = user.proprieta?.map(p => p.gruppo).filter(Boolean) || [];
                    // Use a Set to store unique group names for each user
                    if (userGroups.length > 0) {
                        userToGroupsMap.set(doc.id, [...new Set(userGroups)]);
                    }
                });

                // 3. Process data
                // Process Communications
                commsSnapshot.forEach(doc => {
                    const comm = doc.data();
                    if (comm.targetGroup === 'Tutti') {
                        allGroupNames.forEach(groupName => {
                            if (stats[groupName]) stats[groupName].communications++;
                        });
                    } else if (stats[comm.targetGroup]) {
                        stats[comm.targetGroup].communications++;
                    }
                });

                // Process Reports
                reportsSnapshot.forEach(doc => {
                    const report = doc.data();
                    const userGroups = userToGroupsMap.get(report.createdById);
                    if (userGroups) {
                        userGroups.forEach(groupName => {
                            if (stats[groupName]) stats[groupName].reports++;
                        });
                    }
                });

                // Process Polls
                pollsSnapshot.forEach(doc => {
                    const poll = doc.data();
                    if (poll.pollType === 'condomini') {
                         allGroupNames.forEach(groupName => {
                            if (stats[groupName]) stats[groupName].polls++;
                        });
                    }
                });

                // 4. Apply condo filter and render the table
                const selectedCondo = document.getElementById('condo-filter')?.value || 'all';
                const selectedActivity = document.getElementById('activity-type-filter')?.value || 'all';
                const groupsToDisplay = selectedCondo === 'all' 
                    ? allGroupNames 
                    : allGroupNames.filter(name => name === selectedCondo);

                if (groupsToDisplay.length === 0) {
                    container.innerHTML = '<p style="color:var(--secondary-text);">Nessun gruppo trovato per i filtri selezionati.</p>';
                    return;
                }
                
                let tableHtml = `<table class="data-table"><thead><tr><th>Condominio / Gruppo</th>`;
                
                if (selectedActivity === 'all' || selectedActivity === 'communications') {
                    tableHtml += `<th style="text-align:center;">Comunicazioni</th>`;
                }
                if (selectedActivity === 'all' || selectedActivity === 'reports') {
                    tableHtml += `<th style="text-align:center;">Segnalazioni</th>`;
                }
                if (selectedActivity === 'all' || selectedActivity === 'polls') {
                    tableHtml += `<th style="text-align:center;">Sondaggi</th>`;
                }
                tableHtml += `</tr></thead><tbody>`;

                for (const groupName of groupsToDisplay) {
                    const groupStats = stats[groupName];
                    tableHtml += `<tr><td data-label="Gruppo">${groupName}</td>`;

                    if (selectedActivity === 'all' || selectedActivity === 'communications') {
                        tableHtml += `<td data-label="Comunicazioni" style="text-align:center;">${groupStats.communications}</td>`;
                    }
                    if (selectedActivity === 'all' || selectedActivity === 'reports') {
                        tableHtml += `<td data-label="Segnalazioni" style="text-align:center;">${groupStats.reports}</td>`;
                    }
                    if (selectedActivity === 'all' || selectedActivity === 'polls') {
                        tableHtml += `<td data-label="Sondaggi" style="text-align:center;">${groupStats.polls}</td>`;
                    }
                    tableHtml += `</tr>`;
                }

                tableHtml += '</tbody></table>';
                container.innerHTML = tableHtml;

            } catch (error) {
                console.error("Error loading condo stats:", error);
                container.innerHTML = `<div class="message-box error" style="display:block;">Errore nel caricamento delle statistiche: ${error.message}</div>`;
            }
        };

        const renderBachecaTutte = () => `
    ${renderHeader('Tutte le Comunicazioni')}
    <main>
        ${renderCurrentPeriodBanner()}
        <div class="card" style="margin-bottom: 1rem;">
            <div class="form-group" style="margin-bottom: 0;">
                <input type="text" id="communication-search" placeholder="Cerca per titolo o contenuto..." class="form-input">
            </div>
        </div>
        <div id="communications-list" class="list-container"></div>
    </main>
    ${renderBottomNavigation()}
`;

        const renderBachecaCrea = () => {
            const canUpload = ['amministratore', 'supervisore', 'consigliere', 'adm'].includes(userProfile?.tipoUtente);

            const uploadSectionHtml = canUpload ? `
            <div>
                <label class="form-label">Allegati (Foto, Video, Documenti)</label>
                <div class="attachment-upload-container" onclick="document.getElementById('comm-attachments').click()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" style="margin: 0 auto 0.5rem; color: var(--secondary-text);"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
                    Tocca per aggiungere file
                </div>
                <input type="file" id="comm-attachments" class="hidden" multiple accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt" onchange="handleCommunicationFileSelection(event)">
                <div id="comm-attachment-previews-container" class="attachment-previews"></div>
            </div>
        ` : '';

            return `
            ${renderHeader('Nuova Comunicazione')}
            <main>
                <div class="card" style="margin-bottom:2rem;">
                    <h3 class="card-title">Nuova comunicazione</h3>
                    <div id="comm-creation-message" class="message-box"></div>
                    <form id="create-communication-form" class="space-y-4">
                        <div><label for="comm-title" class="form-label">Titolo</label><input type="text" id="comm-title" required class="form-input" placeholder="Es. Interruzione acqua"></div>
                        <div><label for="comm-content" class="form-label">Messaggio</label><textarea id="comm-content" rows="4" required class="form-textarea" placeholder="Scrivi qui..."></textarea></div>
                        <div>
                            <label for="comm-target-group" class="form-label">Destinatari</label>
                            <select id="comm-target-group" class="form-select">
                                <option value="Tutti">Intero Condominio</option>
                                <!-- Groups will be populated dynamically -->
                            </select>
                        </div>

                        
                        ${['adm', 'supervisore', 'consigliere', 'amministratore'].includes(userProfile?.tipoUtente) ? `
                        <div class="form-group">
                            <label class="flex items-center gap-3 p-3 rounded-md cursor-pointer" style="background-color: var(--surface-color-light);">
                                <input type="checkbox" id="comm-forward-custode" style="width: 20px; height: 20px; accent-color: var(--accent-color); flex-shrink: 0;">
                                <span class="font-medium">Da comunicare al custode</span>
                            </label>
                        </div>
                        ` : ''}
                        
                        ${uploadSectionHtml}
                        <div class="flex justify-end"><button type="submit" id="publish-comm-btn" class="btn btn-primary">Pubblica</button></div>
                    </form>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;
        };



        const renderBacheca = () => {
            const canCreate = ['supervisore', 'amministratore', 'adm', 'consigliere'].includes(userProfile?.tipoUtente);
            const createButtonHtml = canCreate ? `
                <div onclick="navigateTo('bacheca_crea')" class="dashboard-item">
                    <div class="dashboard-card">
                        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z"/></svg>
                    </div>
                    <p>Nuova comunicazione</p>
                </div>
            ` : '';

            return `
            ${renderHeader('Bacheca')}
            <main>
                <div class="dashboard-grid">
                    ${createButtonHtml}
                    <div onclick="navigateTo('bacheca_tutte')" class="dashboard-item">
                        <div class="dashboard-card" style="position: relative;">
                            <span id="bacheca-menu-notification-badge" class="notification-badge hidden" style="top: 8px; right: 8px;"></span>
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M4,6H20V8H4V6M4,10H20V12H4V10M4,14H20V16H4V14M4,18H14V20H4V18Z"/></svg>
                        </div>
                        <p>Tutte le comunicazioni</p>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;
        };

        const renderSondaggiMenu = async () => {
            const canCreatePolls = await isUserAllowedToCreatePolls();
            const createPollButtonHtml = canCreatePolls ? `
                <div onclick="navigateTo('sondaggi_crea')" class="dashboard-item">
                    <div class="dashboard-card">
                        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    </div>
                    <p>Nuovo Sondaggio</p>
                </div>
            ` : '';

            return `
            ${renderHeader('Sondaggi')}
            <main>
                <div class="dashboard-grid">
                    ${createPollButtonHtml}
                    <div onclick="navigateTo('sondaggi_elenco')" class="dashboard-item">
                        <div class="dashboard-card" style="position: relative;">
                            <span id="sondaggi-menu-notification-badge" class="notification-badge hidden" style="top: 8px; right: 8px;"></span>
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/></svg>
                        </div>
                        <p>Elenco Sondaggi</p>
                    </div>
                    <div onclick="navigateTo('sondaggi_attivi')" class="dashboard-item">
                        <div class="dashboard-card">
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                        </div>
                        <p>Sondaggi Attivi</p>
                    </div>
                    <div onclick="navigateTo('sondaggi_conclusi')" class="dashboard-item">
                        <div class="dashboard-card">
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                        </div>
                        <p>Sondaggi Conclusi</p>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;
        };

        const renderSondaggiCrea = () => `
            ${renderHeader('Crea Sondaggio')}
            <main>
                <div class="card">
                    <h3 class="card-title">Crea un Nuovo Sondaggio</h3>
                    <div id="poll-creation-message" class="message-box"></div>
                    <form id="create-poll-form" class="space-y-4">
                        <div><label class="form-label">Tipo Sondaggio</label>
                            <select id="poll-type" required class="form-select">
                                <option value="">Seleziona tipo...</option>
                                <option value="supervisor-consiglieri">Sondaggio tra Supervisor e Consiglieri</option>
                                <option value="condomini">Sondaggio rivolto ai Condomini</option>
                            </select>
                        </div>
                        <div><label class="form-label">Titolo</label><input type="text" id="poll-title" required class="form-input"></div>
                        <div><label class="form-label">Descrizione (opzionale)</label><textarea id="poll-description" rows="3" class="form-textarea"></textarea></div>
                        <div><label class="form-label">Opzioni</label><div id="poll-options-list" class="space-y-4"></div><button type="button" id="add-poll-option" class="btn btn-secondary mt-4">Aggiungi opzione</button></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label">Data fine</label><input type="date" id="poll-deadline" required class="form-input"></div>
                            <div><label class="form-label">Ora fine</label><input type="time" id="poll-deadline-time" required class="form-input"></div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="flex items-center gap-3 p-3 rounded-md cursor-pointer" style="background-color: var(--surface-color-light);">
                                <input type="checkbox" id="poll-multiple-choice" style="width: 20px; height: 20px; accent-color: var(--accent-color); flex-shrink: 0;">
                                <span class="font-medium">Abilita Risposta Multipla</span>
                            </label>
                        </div>
                        <div class="flex justify-end gap-4 pt-4"><button type="reset" class="btn btn-secondary">Annulla</button><button type="submit" class="btn btn-primary">Crea</button></div>
                    </form>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderSondaggiElenco = () => `
            ${renderHeader('Elenco Sondaggi')}
            <main>
                ${renderCurrentPeriodBanner()}
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="margin-bottom: 1rem;">
                        <input type="text" id="poll-search" placeholder="Cerca sondaggi per parole chiave..." class="form-input w-full">
                    </div>
                    <div>
                        <select id="poll-type-filter" class="form-select w-full">
                            <option value="">Tutti i tipi</option>
                            <option value="supervisor-consiglieri">Supervisor e Consiglieri</option>
                            <option value="condomini">Condomini</option>
                        </select>
                    </div>
                </div>
                <div id="polls-container" class="list-container"></div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderSondaggiAttivi = () => `
            ${renderHeader('Sondaggi Attivi')}
            <main>
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="margin-bottom: 1rem;">
                        <input type="text" id="poll-search" placeholder="Cerca sondaggi attivi per parole chiave..." class="form-input w-full">
                    </div>
                    <div>
                        <select id="poll-type-filter" class="form-select w-full">
                            <option value="">Tutti i tipi</option>
                            <option value="supervisor-consiglieri">Supervisor e Consiglieri</option>
                            <option value="condomini">Condomini</option>
                        </select>
                    </div>
                </div>
                <div id="polls-container" class="list-container"></div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderSondaggiConclusi = () => `
            ${renderHeader('Sondaggi Conclusi')}
            <main>
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="margin-bottom: 1rem;">
                        <input type="text" id="poll-search" placeholder="Cerca sondaggi conclusi per parole chiave..." class="form-input w-full">
                    </div>
                    <div>
                        <select id="poll-type-filter" class="form-select w-full">
                            <option value="">Tutti i tipi</option>
                            <option value="supervisor-consiglieri">Supervisor e Consiglieri</option>
                            <option value="condomini">Condomini</option>
                        </select>
                    </div>
                </div>
                <div id="polls-container" class="list-container"></div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderSegnalazioniMenu = () => {
            const userRole = userProfile?.tipoUtente;
            const isManager = ["amministratore", "custode", "consigliere", "fornitore", "supervisore", "adm"].includes(userRole);

            let menuItemsHtml = [];

            // 1. Solleciti - MODIFICATO per includere 'consigliere'
            if (['supervisore', 'adm', 'amministratore', 'consigliere'].includes(userRole)) {
                menuItemsHtml.push(`
                    <div onclick="navigateTo('segnalazioni_urgenti')" class="dashboard-item">
                        <div class="dashboard-card" style="position: relative; border: 2px solid var(--danger);">
                            <span id="solleciti-menu-notification-badge" class="notification-badge hidden" style="top: 8px; right: 8px;"></span>
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                        </div>
                        <p>Solleciti</p>
                    </div>
                `);
            }

            // 2. Segnalazioni ricevute
            if (isManager) {
                // MODIFICA: Etichetta cambiata in "Segnalazioni Ricevute"
                const label = 'Segnalazioni Ricevute';
                menuItemsHtml.push(`
        <div onclick="navigateTo('segnalazioni_ricevute')" class="dashboard-item">
            <div class="dashboard-card" style="position: relative;">
                <span id="segnalazioni-menu-notification-badge" class="notification-badge hidden" style="top: 8px; right: 8px;"></span>
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,3H5C3.89,3 3,3.89,3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.89 20.1,3 19,3M19,19H5V5H19V19M17,17H7V15H17V17M17,13H7V11H17V13M17,9H7V7H17V9Z"/></svg>
            </div>
            <p>${userProfile?.tipoUtente === 'custode' ? 'Segnalazioni Ricevute' : label}</p>
        </div>
    `);
            }

            // 3. Crea una segnalazione
            if (userRole !== 'fornitore') {
                menuItemsHtml.push(`
                    <div onclick="navigateTo('segnalazioni_crea')" class="dashboard-item">
                        <div class="dashboard-card">
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                        </div>
                        <p>Crea Segnalazione</p>
                    </div>
                `);
            }

            // 4. Segnalazioni inviate (Segnalazioni Inviate)
            if (userRole !== 'fornitore') {
                menuItemsHtml.push(`
                    <div onclick="navigateTo('segnalazioni_utente')" class="dashboard-item" style="position: relative;">
                        <span id="dashboard-segnalazioni-inviate-badge" class="notification-badge hidden" style="position: absolute; top: 8px; right: 8px;"></span>
                        <div class="dashboard-card">
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.2,16.2L11,13V7H12.5V12.2L17,14.9L16.2,16.2Z"/></svg>
                        </div>
                        <p>Segnalazioni Inviate</p>
                    </div>
                `);
            }



            return `
            ${renderHeader('Segnalazioni')}
            <main>
                <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                    ${menuItemsHtml.join('')}
                </div>
            </main>
            ${renderBottomNavigation()}
            `;
        };

        const renderSegnalazioniCrea = () => {
            const isCustodian = userProfile?.tipoUtente === 'custode';

        const recipientOptions = isCustodian
            ? `
                <option value="amministratore" id="admin-option">Amministratore</option>
                <option value="condomini">Condomini</option>
                <option value="consigliere" id="consigliere-option">Consiglieri</option>
                <option value="adm" id="adm-option">Sviluppatore</option>
              `
            : `
                <option value="amministratore" id="admin-option">Amministratore</option>
                <option value="custode" id="custode-option">Custode</option>
                <option value="consigliere" id="consigliere-option">Consiglieri</option>
                <option value="adm" id="adm-option">Sviluppatore</option>
              `;

        const formRecipientField = `
        <div>
            <label class="form-label">Destinatario</label>
            <select id="report-recipient" required class="form-select">
                <option value="">Seleziona a chi inviare...</option>
                ${recipientOptions}
            </select>
        </div>`;

            return `
                ${renderHeader('Crea Segnalazione')}
                <main>
                    ${renderCurrentPeriodBanner()}
                    <div class="card" style="margin-bottom:2rem;">
                        <h3 class="card-title">Invia una Segnalazione</h3>
                        <form id="create-report-form" class="space-y-4">
                            <div><label class="form-label">Titolo</label><input type="text" id="report-title" required class="form-input" placeholder="es. Perdita d'acqua"></div>
                            <div><label class="form-label">Descrizione</label><textarea id="report-description" rows="4" required class="form-textarea" placeholder="Descrivi il problema..."></textarea></div>
                        ${userProfile?.tipoUtente === 'condomino' ? `<p style="font-size: 0.85rem; color: var(--warning); margin-top: -0.5rem; margin-bottom: 1rem;">In caso di richieste d'intervento per danni alla propria U.I. indicare l'U.I. vicina che potrebbe aver creato la richiesta d'intervento</p>` : ''}
                        
                        <!-- NUOVA SEZIONE PER UPLOAD ALLEGATI -->
                            <div>
                                <label class="form-label">Allegati (Foto/Video)</label>
                                <div class="attachment-upload-container" onclick="document.getElementById('report-attachments').click()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" style="margin: 0 auto 0.5rem; color: var(--secondary-text);"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
                                    Tocca per aggiungere file
                                </div>
                                <input type="file" id="report-attachments" class="hidden" multiple accept="image/*,video/*" onchange="handleReportFileSelection(event)">
                                <div id="attachment-previews-container" class="attachment-previews"></div>
                            </div>
                            <!-- FINE NUOVA SEZIONE -->

                            ${formRecipientField}
                            
                            <div>
                                <label for="report-interest-type" class="form-label">Tipo di Interesse</label>
                                <select id="report-interest-type" required class="form-select">
                                    <option value="">Seleziona...</option>
                                    <option value="personale">Segnalazione di interesse personale</option>
                                    <option value="condominiale">Segnalazione di interesse condominiale</option>
                                </select>
                            </div>
                            
                            <div><label class="form-label">Genere di intervento</label><select id="report-priority" required class="form-select" disabled><option value="">Seleziona prima il destinatario...</option></select></div>
                            <div><label class="form-label">Categoria</label><select id="report-category" required class="form-select"><option value="">...</option><option value="ascensore">Ascensore</option><option value="elettrico">Elettrico</option><option value="idraulico">Idraulico</option><option value="portierato">Portierato</option><option value="posta">Posta</option><option value="pulizie">Pulizie</option><option value="raccolta-rifiuti">Raccolta rifiuti</option><option value="riscaldamento">Riscaldamento</option><option value="sicurezza">Sicurezza</option><option value="tv">TV</option><option value="altro">Altro</option></select></div>
                            <div class="form-group">
    <label for="report-property-select" class="form-label">Unità Immobiliare (Ubicazione)</label>
    <select id="report-property-select" required class="form-select">
        <option value="" disabled>Seleziona la tua unità...</option>
        <!-- Le opzioni verranno popolate dinamicamente via JS -->
    </select>
</div>
<input type="hidden" id="report-location"> <!-- Mantenuto per compatibilità e logica interna -->
                            
                            <!-- Campi condizionali per checkboxes comunicazione -->
                            <div id="phone-communication-checkboxes" class="hidden">
                                <label class="form-label">Opzioni di comunicazione</label>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="communicate-owner-phone" style="margin: 0;">
                                        <span>Comunicare  n. di telefono condomino al fornitore</span>
                                    </label>
                                    <label id="other-ui-phone-checkbox" class="hidden" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="communicate-other-ui-phone" style="margin: 0;">
                                        <span>N. telefono altra U.I.</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Campo condizionale per indicazione proprietario altra U.I. -->
                            <div id="other-ui-owner-field" class="hidden">
                                <label class="form-label">Indicazione proprietario altra U.I.</label>
                                <input type="text" id="other-ui-owner" class="form-input" placeholder="Inserisci il nome del proprietario...">
                            </div>

                            <div class="flex justify-end pt-4"><button type="submit" id="submit-report-btn" class="btn btn-primary">Invia Segnalazione</button></div>
                        </form>
                    </div>
                    <div class="mt-4"><h2 class="section-title">Segnalazioni Recenti</h2><div id="reports-secondary-container" class="list-container"></div></div>
                </main>
                ${renderBottomNavigation()}
             `;
        };

        const renderSegnalazioniElenco = (title) => {
            // Show controls for all user types
            const controlsHtml = `
                <div id="ticket-counters" class="grid grid-cols-3 gap-2" style="margin-bottom: 1rem;">
                    <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--danger);">0</div><div class="page-subtitle" style="text-transform: none;">Richieste aperte n.0</div></div>
                    <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--warning);">0</div><div class="page-subtitle" style="text-transform: none;">Richieste in corso n.0</div></div>
                    <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--primary);">0</div><div class="page-subtitle" style="text-transform: none;">Tutte</div></div>
                </div>
                <div class="card" style="margin-bottom: 1.5rem; padding: 1rem;">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="form-group" style="flex-grow: 1; margin-bottom: 0;">
                            <div style="position: relative; display: flex; align-items: center;">
                                <svg style="position: absolute; left: 1rem; width: 20px; height: 20px; color: var(--secondary-text);" fill="currentColor" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                                <input type="text" id="report-search-input" placeholder="Cerca per titolo, numero o descrizione..." class="form-input" style="padding-left: 3rem;">
                            </div>
                        </div>
                        <div class="form-group" style="flex-shrink: 0; min-width: 150px; margin-bottom: 0;">
                            <select id="report-status-filter" class="form-select">
                                <option value="all">Tutti gli stati</option>
                                <option value="aperta">Aperta</option>
                                <option value="in-corso">In Corso</option>
                                <option value="risolta">Risolta</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;

            return `
                ${renderHeader(title)}
                <main>
                    ${controlsHtml}
                    <div id="reports-main-container" class="list-container"></div>
                </main>
                ${renderBottomNavigation()}
            `;
        };

        const renderProfilo = () => `
            ${renderHeader('Profilo')}
            <main>
                <div id="profile-message" class="message-box"></div>
                <div class="card">
                    <h3 class="card-title">I Tuoi Dati</h3>
                    <form id="profile-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label">Nome</label><input type="text" id="profile-nome" value="${userProfile?.nome || ''}" required class="form-input"></div>
                            <div><label class="form-label">Cognome</label><input type="text" id="profile-cognome" value="${userProfile?.cognome || ''}" required class="form-input"></div>
                        </div>
                        <div><label class="form-label">Email</label><input type="email" id="profile-email" value="${currentUser?.email || ''}" required class="form-input"></div>
                        <div><label class="form-label">Telefono</label><input type="tel" id="profile-telefono" value="${userProfile?.telefono || ''}" placeholder="Nessun numero" class="form-input"></div>
                        <div class="form-group">
                            <label class="form-label">Le Tue Proprietà</label>
                            <div style="background: var(--surface-color-light); padding: 1rem; border-radius: var(--radius-sm);">
                                ${userProfile?.proprieta && userProfile.proprieta.length > 0
                ? `<ul>${userProfile.proprieta.map(p => `<li style="list-style-type: disc; margin-left: 20px;">${p.interno} (${(p.millesimi || 0).toFixed(2)} ‰) - Piano: ${p.piano ?? 'N/A'} ${p.gruppo ? `- <strong>Gruppo:</strong> ${p.gruppo}` : ''}</li>`).join('')}</ul>
                                       <hr style="border-color: var(--surface-color); margin: 0.75rem 0;">
                                       <div style="display:flex; justify-content:space-between; font-weight:600;"><span>Millesimi Totali:</span><span>${(userProfile.millesimiTotali || 0).toFixed(2)} ‰</span></div>`
                : '<p style="color:var(--secondary-text);">Nessuna proprietà associata.</p>'
            }
                            </div>
                        </div>
                        <div><label class="form-label">Tipo Utente</label><input type="text" value="${userProfile?.tipoUtente || ''}" class="form-input" disabled></div>
                        <button type="submit" class="btn btn-primary w-full">Salva Nome e Telefono</button>
                    </form>
                </div>
                 <div style="margin-top: 2rem;">
                  <button onclick="logout()" class="btn btn-secondary w-full">Esci</button>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderInfoUtili = () => {
            const isSupervisore = userProfile?.tipoUtente === 'supervisore';

            if (isSupervisore) {
                // La visualizzazione per il Supervisore rimane invariata
                return `
                ${renderHeader('Numeri Utili')}
                <main>
                    <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                        <div onclick="navigateTo('numeriUtiliImportati')" class="dashboard-item">
                            <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z"/></svg></div>
                            <p>Importazione</p>
                        </div>
                        <div onclick="navigateTo('numeriUtiliManuali')" class="dashboard-item">
                            <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z"/></svg></div>
                            <p>Inserimento</p>
                        </div>
                        <div onclick="navigateTo('numeriUtiliRubrica')" class="dashboard-item" style="grid-column: 1 / -1;">
                            <div class="dashboard-card" style="aspect-ratio: auto; height: 80px; flex-direction: row; justify-content: flex-start; gap: 1.5rem; padding: 1rem 1.5rem;">
                                <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M20,2H4A2,2 0,0,0 2,4V20A2,2 0,0,0 4,22H20A2,2 0,0,0 22,20V4A2,2 0,0,0 20,2M12,6A3,3 0,0,1 15,9A3,3 0,0,1 12,12A3,3 0,0,1 9,9A3,3 0,0,1 12,6M18,20H6V18.6C6,16.6 10,15.5 12,15.5C14,15.5 18,16.6 18,18.6V20Z"/></svg>
                                <p style="text-align: left; font-size: 1.1rem;">Rubrica Completa</p>
                            </div>
                        </div>
                    </div>
                </main>
                ${renderBottomNavigation()}
                `;
            } else {
                // Tutti gli altri utenti (condomino, custode, etc.) vedono la nuova visualizzazione
                return `
                ${renderHeader('Numeri Utili')}
                <main>
                    <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                        <div onclick="navigateTo('numeriUtiliRubrica')" class="dashboard-item">
                            <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20,2H4A2,2 0,0,0 2,4V20A2,2 0,0,0 4,22H20A2,2 0,0,0 22,20V4A2,2 0,0,0 20,2M12,6A3,3 0,0,1 15,9A3,3 0,0,1 12,12A3,3 0,0,1 9,9A3,3 0,0,1 12,6M18,20H6V18.6C6,16.6 10,15.5 12,15.5C14,15.5 18,16.6 18,18.6V20Z"/></svg></div>
                            <p>Rubrica Fornitori</p>
                        </div>
                        <div onclick="navigateTo('numeriUtiliCustode')" class="dashboard-item">
                            <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M7,2A5,5 0 0,1 12,7A5,5 0 0,1 10.68,10.27L22,21.55L20.45,23.1L9.17,11.82C8.5,11.95 7.77,11.95 7.1,11.82L2,16.92L0.45,15.37L5.55,10.27A5,5 0 0,1 2,7A5,5 0 0,1 7,2M7,4A3,3 0 0,0 4,7A3,3 0 0,0 7,10A3,3 0 0,0 10,7A3,3 0 0,0 7,4Z"/></svg></div>
                            <p>Custode</p>
                        </div>
                        <div onclick="navigateTo('infoUtili_amministratore')" class="dashboard-item">
                            <div class="dashboard-card">
                                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2M12,4.5L11.5,7.5L8.5,8L11.5,8.5L12,11.5L12.5,8.5L15.5,8L12.5,7.5L12,4.5M5,16L6.5,21L12,19L17.5,21L19,16H5Z"/></svg>
                            </div>
                            <p>Amministratore</p>
                        </div>
                    </div>
                </main>
                ${renderBottomNavigation()}
                `;
            }
        };

        const renderNumeriUtiliImportati = () => {
            const canImport = userProfile?.tipoUtente === 'supervisore';

            if (!canImport) {
                return `
                ${renderHeader('Accesso Negato')}
                <main>
                    <div class="card">
                        <div style="text-align: center; padding: 2rem;">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 64px; height: 64px; color: var(--danger); margin: 0 auto 1rem;">
                                <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                            </svg>
                            <h3 style="color: var(--danger); margin-bottom: 1rem;">Accesso Negato</h3>
                            <p style="color: var(--secondary-text); margin-bottom: 1.5rem;">Non hai i permessi per accedere a questa sezione.</p>
                            <button onclick="navigateTo('infoUtili')" class="btn btn-primary">Torna ai Numeri Utili</button>
                        </div>
                    </div>
                </main>
                ${renderBottomNavigation()}
                `;
            }

            const importSectionHtml = `
                <div class="flex gap-4 mt-4">
                    <button id="trigger-phone-import-btn" class="btn btn-primary flex-grow">Importa Nuovo File</button>
                    <button onclick="navigateTo('importazione')" class="btn btn-secondary">Gestione Avanzata</button>
                </div>
                <input type="file" id="info-utili-phone-import-input" class="hidden" accept=".xlsx, .xls">
                <div id="info-utili-import-message" class="message-box mt-4"></div>
            `;

            return `
            ${renderHeader('Contatti Importati')}
            <main>
                <div class="card">
                    <p class="form-label" style="color: var(--secondary-text); margin-bottom: 1.5rem;">
                        Elenco dei contatti importati tramite file Excel. Il file più recente sostituisce i precedenti.
                    </p>
                    <div id="imported-numbers-table-container" class="data-table-container">
                        <p style="color:var(--secondary-text);">Caricamento contatti importati...</p>
                    </div>
                    ${importSectionHtml}
                </div>
            </main>
            ${renderBottomNavigation()}
            `;
        };

        const renderNumeriUtiliManuali = () => {
            const canManage = userProfile?.tipoUtente === 'supervisore';

            if (!canManage) {
                return `
                ${renderHeader('Accesso Negato')}
                <main>
                    <div class="card">
                        <div style="text-align: center; padding: 2rem;">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 64px; height: 64px; color: var(--danger); margin: 0 auto 1rem;">
                                <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                            </svg>
                            <h3 style="color: var(--danger); margin-bottom: 1rem;">Accesso Negato</h3>
                            <p style="color: var(--secondary-text); margin-bottom: 1.5rem;">Non hai i permessi per accedere a questa sezione.</p>
                            <button onclick="navigateTo('infoUtili')" class="btn btn-primary">Torna ai Numeri Utili</button>
                        </div>
                    </div>
                </main>
                ${renderBottomNavigation()}
                `;
            }

            const addFormHtml = `
                <form id="add-useful-number-form" class="space-y-4" style="margin-bottom: 2rem;">
                    <div><label for="nu-title" class="form-label">INTERVENTO RICHIESTO</label><input type="text" id="nu-title" required class="form-input" placeholder="Es. Idraulico, Elettricista..."></div>
                    <div><label for="nu-company" class="form-label">IMPRESA (Opzionale)</label><input type="text" id="nu-company" class="form-input" placeholder="Nome dell'azienda"></div>
                    <div><label for="nu-number" class="form-label">1 NUM. TELEFONICO</label><input type="text" id="nu-number" required class="form-input" placeholder="Numero di telefono principale"></div>
                    <div><label for="nu-number-2" class="form-label">2 NUM. TELEFONICO (Opzionale)</label><input type="text" id="nu-number-2" class="form-input" placeholder="Numero di telefono secondario"></div>
                    <div class="flex justify-end"><button type="submit" class="btn btn-primary">Aggiungi Contatto</button></div>
                </form>
            `;

            return `
            ${renderHeader('Contatti Manuali')}
            <main>
                <div class="card">
                    <p class="form-label" style="color: var(--secondary-text); margin-bottom: 1.5rem;">Aggiungi o visualizza i contatti di emergenza inseriti manualmente. La modifica è riservata ai ruoli autorizzati.</p>
                    ${addFormHtml}
                    <div class="data-table-container">
                        <table class="data-table" id="useful-numbers-table">
                            <tbody id="useful-numbers-table-body">
                                <tr><td colspan="4" style="text-align:center; color:var(--secondary-text);">Caricamento contatti...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
            `;
        };

        const renderReportPage = () => `
            ${renderHeader('Report')}
            <main>
                <div class="dashboard-grid">
                    <div onclick="navigateTo('elencoCondomini')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L2 7v13h20V7L12 2z"/></svg></div>
                        <p>Elenco Condomini</p>
                    </div>
                    <div onclick="navigateTo('bacheca')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg></div>
                        <p>Bacheca</p>
                    </div>
                    <div onclick="navigateTo('sondaggi')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/></svg></div>
                        <p>Sondaggi</p>
                    </div>
                    <div onclick="navigateTo('infoUtili')" class="dashboard-item">
                        <div class="dashboard-card"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg></div>
                        <p>Numeri utili</p>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderElencoCondomini = () => `
            ${renderHeader('Elenco Condomini')}
            <main>
                <div class="filter-chips-container" style="margin-bottom: 1.5rem;">
                    <div id="report-mode-confronto" class="chip active" onclick="loadElencoCondomini('confronto')">Confronto Dati</div>
                    <div id="report-mode-complessiva" class="chip" onclick="loadElencoCondomini('complessiva')">Riepilogo Complessivo</div>
                    <div id="report-mode-anagrafica" class="chip" onclick="loadElencoCondomini('anagrafica')">Riepilogo Anagrafica</div>
                </div>
                <div id="elenco-condomini-container">
                    <div class="card"><p>Caricamento elenco in corso...</p></div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const loadElencoCondomini = async (mode = 'confronto') => {
            // --- 1. Aggiornamento UI per la selezione della modalità ---
            const confrontoBtn = document.getElementById('report-mode-confronto');
            const complessivaBtn = document.getElementById('report-mode-complessiva');
            const anagraficaBtn = document.getElementById('report-mode-anagrafica');
            if (confrontoBtn && complessivaBtn && anagraficaBtn) {
                confrontoBtn.classList.toggle('active', mode === 'confronto');
                complessivaBtn.classList.toggle('active', mode === 'complessiva');
                anagraficaBtn.classList.toggle('active', mode === 'anagrafica');
            }

            const container = document.getElementById('elenco-condomini-container');
            if (!container) return;
            container.innerHTML = `<div class="card"><p>Caricamento dati in modalità '${mode}'...</p></div>`;

            try {
                // --- 2. Recupero Dati ---
                const [usersSnapshot, importedDataSnapshot, partialCondosSnapshot] = await Promise.all([
                    getDocs(query(collection(db, "users"), orderBy("cognome"))),
                    getDocs(query(collection(db, "importedData"), orderBy("uploadedAt", "desc"), limit(1))),
                    getDocs(query(collection(db, "partialCondos"), orderBy("name")))
                ]);

                if (mode !== 'anagrafica' && importedDataSnapshot.empty) {
                    container.innerHTML = `<div class="card"><p class="message-box error" style="display:block;">Dati delle proprietà non trovati. Eseguire prima l'importazione.</p></div>`;
                    return;
                }

                // --- 3. Preparazione Dati ---
                const allProperties = !importedDataSnapshot.empty ? importedDataSnapshot.docs[0].data().tableData : [];
                const partialCondosList = partialCondosSnapshot.docs.map(doc => doc.data());
                const headers = Object.keys(allProperties[0] || {});
                const findHeader = (h, k) => h.find(header => k.map(key => key.toLowerCase()).includes(header.toLowerCase()));
                const millesimiHeader = findHeader(headers, ['millesimi', 'quota']);
                const groupHeader = findHeader(headers, ['raggruppamento', 'gruppo']);

                // --- 4. Logica di Raggruppamento e Generazione HTML ---
                let html = '';

                if (mode === 'anagrafica') {
                    html = `<h2 class="section-title">Riepilogo Anagrafica Utenti Registrati</h2>`;
                    if (usersSnapshot.empty) {
                        html += `<div class="card"><p>Nessun utente registrato.</p></div>`;
                    } else {
                        html += `<div class="card" style="padding:0;"><div class="data-table-container"><table class="data-table">
                                    <thead><tr><th>Cognome e Nome</th><th>Email</th><th>Proprietà</th><th style="text-align:right;">Millesimi Tot.</th></tr></thead>
                                    <tbody>`;
                        usersSnapshot.docs.forEach(doc => {
                            const user = doc.data();
                            const propertiesHtml = user.proprieta && user.proprieta.length > 0
                                ? user.proprieta.map(p => `<div>${p.interno} (Piano: ${p.piano ?? 'N/A'}, ${(p.millesimi || 0).toFixed(2)} ‰)</div>`).join('')
                                : 'N/D';
                            html += `
                                <tr>
                                    <td data-label="Cognome e Nome">${user.cognome} ${user.nome}</td>
                                    <td data-label="Email">${user.email}</td>
                                    <td data-label="Proprietà">${propertiesHtml}</td>
                                    <td data-label="Millesimi Tot." style="text-align:right;">${(user.millesimiTotali || 0).toFixed(2).replace('.', ',')}</td>
                                </tr>
                            `;
                        });
                        html += `</tbody></table></div></div>`;
                    }
                } else {
                    const groupedData = {};
                    partialCondosList.forEach(condo => {
                        groupedData[condo.name] = { users: [], totalMillesimiImport: 0, totalPropertiesImport: 0 };
                    });
                    if (!groupedData['Senza Gruppo']) {
                        groupedData['Senza Gruppo'] = { users: [], totalMillesimiImport: 0, totalPropertiesImport: 0 };
                    }

                    usersSnapshot.docs.forEach(doc => {
                        const user = doc.data();
                        user.proprieta?.forEach(prop => {
                            const groupName = prop.gruppo || 'Senza Gruppo';
                            if (!groupedData[groupName]) {
                                groupedData[groupName] = { users: [], totalMillesimiImport: 0, totalPropertiesImport: 0 };
                            }
                            groupedData[groupName].users.push({
                                idUI: prop.interno,
                                proprietario: `${user.nome} ${user.cognome}`,
                                millesimi: parseFloat(prop.millesimi) || 0
                            });
                        });
                    });

                    allProperties.forEach(prop => {
                        const groupName = (groupHeader && prop[groupHeader]) ? prop[groupHeader] : 'Senza Gruppo';
                        if (!groupedData[groupName]) {
                            groupedData[groupName] = { users: [], totalMillesimiImport: 0, totalPropertiesImport: 0 };
                        }
                        groupedData[groupName].totalMillesimiImport += parseFloat(prop[millesimiHeader]) || 0;
                        groupedData[groupName].totalPropertiesImport += 1;
                    });

                    const grandTotalAllMillesimi = Object.values(groupedData).reduce((sum, group) => sum + group.totalMillesimiImport, 0);
                    const grandTotalProperties = Object.values(groupedData).reduce((sum, group) => sum + group.totalPropertiesImport, 0);

                    if (mode === 'confronto') {
                        html = `<h2 class="section-title">Confronto Dati Registrati vs. Importati</h2>`;
                        let grandTotalAccounts = 0;
                        let grandTotalAccountMillesimi = 0;

                        for (const groupName in groupedData) {
                            const group = groupedData[groupName];
                            if (group.users.length === 0 && group.totalPropertiesImport === 0) continue;
                            const accountSubtotalMillesimi = group.users.reduce((sum, u) => sum + u.millesimi, 0);
                            grandTotalAccounts += group.users.length;
                            grandTotalAccountMillesimi += accountSubtotalMillesimi;
                            html += `<div class="card" style="margin-bottom: 1.5rem;"><h3 class="card-title" style="text-transform: capitalize;">${groupName.toLowerCase()}</h3><div class="data-table-container"><table class="data-table"><thead><tr><th>Id U.I.</th><th>Proprietario Registrato</th><th style="text-align:right;">Millesimi</th></tr></thead><tbody>${group.users.length > 0 ? group.users.map(u => `<tr><td data-label="Id U.I.">${u.idUI}</td><td data-label="Proprietario">${u.proprietario}</td><td data-label="Millesimi" style="text-align:right;">${u.millesimi.toFixed(2).replace('.', ',')}</td></tr>`).join('') : `<tr><td colspan="3" style="color:var(--secondary-text); text-align:center;">Nessun account registrato per questo gruppo.</td></tr>`}<tr style="font-weight:bold; background-color: var(--surface-color-light);"><td data-label="Riepilogo">Totale Account Registrati</td><td data-label="N. Account" style="text-align:right;">${group.users.length}</td><td data-label="Millesimi" style="text-align:right;">${accountSubtotalMillesimi.toFixed(2).replace('.', ',')}</td></tr><tr style="font-weight:bold; background-color: var(--surface-color-light);"><td data-label="Riepilogo">Totale Unità da Import</td><td data-label="N. Unità" style="text-align:right;">${group.totalPropertiesImport}</td><td data-label="Millesimi" style="text-align:right;">${group.totalMillesimiImport.toFixed(2).replace('.', ',')}</td></tr></tbody></table></div></div>`;
                        }
                        html += `<div class="card" style="margin-bottom: 1.5rem;"><h3 class="card-title">Riepilogo Complessivo Confronto</h3><div class="data-table-container"><table class="data-table"><tbody><tr style="font-weight:bold; background-color: var(--surface-color-light);"><td>Totale Account Registrati</td><td style="text-align:right;">${grandTotalAccounts}</td><td style="text-align:right;">${grandTotalAccountMillesimi.toFixed(2).replace('.', ',')}</td></tr><tr style="font-weight:bold; background-color: var(--surface-color-light);"><td>Totale Unità da Import</td><td style="text-align:right;">${grandTotalProperties}</td><td style="text-align:right;">${grandTotalAllMillesimi.toFixed(2).replace('.', ',')}</td></tr></tbody></table></div></div>`;
                    } else { // mode === 'complessiva'
                        html = `<h2 class="section-title">Riepilogo Complessivo Dati Importati</h2><div class="card" style="margin-bottom: 1.5rem;"><div class="data-table-container"><table class="data-table"><thead><tr><th>Gruppo / Scala</th><th style="text-align:right;">N. Unità (Teste)</th><th style="text-align:right;">Somma Millesimi</th></tr></thead><tbody>`;
                        for (const groupName in groupedData) {
                            const group = groupedData[groupName];
                            if (group.totalPropertiesImport === 0) continue;
                            html += `<tr><td data-label="Gruppo / Scala" style="text-transform: capitalize;">${groupName.toLowerCase()}</td><td data-label="N. Unità" style="text-align:right;">${group.totalPropertiesImport}</td><td data-label="Somma Millesimi" style="text-align:right;">${group.totalMillesimiImport.toFixed(2).replace('.', ',')}</td></tr>`;
                        }
                        html += `<tr style="font-weight:bold; background-color: var(--surface-color-light);"><td>Totale Complessivo</td><td style="text-align:right;">${grandTotalProperties}</td><td style="text-align:right;">${grandTotalAllMillesimi.toFixed(2).replace('.', ',')}</td></tr></tbody></table></div></div>`;
                    }
                }

                container.innerHTML = html;

            } catch (error) {
                console.error("Errore nel caricamento dell'elenco condomini:", error);
                container.innerHTML = `<div class="card"><p class="message-box error" style="display:block;">Si è verificato un errore: ${error.message}</p></div>`;
            }
        };

        const renderImportazione = () => `
            ${renderHeader('Importa Anagrafica e Millesimi')}
            <main>
                <!-- SEZIONE UNICA: IMPORTAZIONE MILLESIMI / ANAGRAFICA -->
                <div class="card">
                    <h3 class="card-title">Importa Anagrafica e Millesimi</h3>
                    <p class="form-label" style="margin-bottom: 1.5rem; color: var(--secondary-text);">
                        Carica il file Excel contenente i dati anagrafici dei proprietari, le unità immobiliari e i relativi millesimi. Questo file è <strong>fondamentale</strong> per la registrazione degli utenti e per i report.
                    </p>
                    <div class="form-group">
                        <label class="form-label">Carica Nuovo File Anagrafica (.xlsx, .xls)</label>
                        <input type="file" id="excel-file-input-millesimi" class="form-input" accept=".xlsx, .xls">
                    </div>
                    <div id="message-import-millesimi" class="message-box"></div>
                    <div id="save-button-container-millesimi" class="hidden mt-4">
                        <button id="save-imported-data-btn-millesimi" class="btn btn-primary w-full">Salva Dati Anagrafica</button>
                    </div>
                    <div class="mt-4">
                        <h4 class="section-title" style="font-size: 1rem; margin-bottom: 0.5rem;">Anteprima / Dati Attuali</h4>
                        <div id="excel-table-container-millesimi" class="data-table-container">
                            <p style="color:var(--secondary-text);">Nessun file selezionato o caricato.</p>
                        </div>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderOrariCustode = () => `
            ${renderHeader('Orari Custode')}
            <main>
                <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                    <div onclick="navigateTo('orariCustode_manuale')" class="dashboard-item">
                        <div class="dashboard-card">
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z"/></svg>
                        </div>
                        <p>Gestione Manuale</p>
                    </div>
                    <div onclick="navigateTo('orariCustode_import')" class="dashboard-item">
                        <div class="dashboard-card">
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z"/></svg>
                        </div>
                        <p>Importazione Dati</p>
                    </div>
                    <div onclick="navigateTo('orariCustode_visualizza')" class="dashboard-item" style="grid-column: 1 / -1;">
                        <div class="dashboard-card" style="aspect-ratio: auto; height: 80px; flex-direction: row; justify-content: flex-start; gap: 1.5rem; padding: 1rem 1.5rem;">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M20,2H4A2,2 0 0,0 2,4V20A2,2 0,0,0 4,22H20A2,2 0,0,0 22,20V4A2,2 0,0,0 20,2M12,6A3,3 0,0,1 15,9A3,3 0,0,1 12,12A3,3 0,0,1 9,9A3,3 0,0,1 12,6M18,20H6V18.6C6,16.6 10,15.5 12,15.5C14,15.5 18,16.6 18,18.6V20Z"/></svg>
                            <p style="text-align: left; font-size: 1.1rem;">Riepilogo Dati</p>
                        </div>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderOrariCustodeManuale = () => `
            ${renderHeader('Gestione Manuale Orari')}
            <main>
                <div class="card" style="margin-bottom: 2rem;">
                    <h3 class="card-title">Aggiungi Nuova Voce</h3>
                    <div id="add-custodian-message" class="message-box"></div>
                    <form id="add-custodian-form" class="space-y-4">
                        <div class="form-group">
                            <label for="custodian-nominativo" class="form-label">Nominativo</label>
                            <input type="text" id="custodian-nominativo" required class="form-input" placeholder="Es. Mario Rossi">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="custodian-lun-ven" class="form-label">Orario Lun-Ven</label>
                                <input type="text" id="custodian-lun-ven" class="form-input" placeholder="Es. 08:00 - 12:00">
                            </div>
                            <div class="form-group">
                                <label for="custodian-sabato" class="form-label">Orario Sabato</label>
                                <input type="text" id="custodian-sabato" class="form-input" placeholder="Es. 09:00 - 11:00">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="custodian-ruolo" class="form-label">Ruolo</label>
                                <input type="text" id="custodian-ruolo" class="form-input" placeholder="Es. Custode Principale">
                            </div>
                            <div class="form-group">
                                <label for="custodian-telefono" class="form-label">Telefono</label>
                                <input type="tel" id="custodian-telefono" class="form-input" placeholder="Numero di telefono">
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" class="btn btn-primary">Aggiungi Voce</button>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <h3 class="card-title">Dati Attuali</h3>
                    <p class="form-label" style="margin-bottom: 1.5rem; color: var(--secondary-text);">
                        Visualizza, modifica o elimina le voci esistenti.
                    </p>
                    <div id="excel-table-container-orari-custode-manual" class="data-table-container">
                        <p style="color:var(--secondary-text);">Nessun dato presente.</p>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderOrariCustodeImport = () => `
            ${renderHeader('Importazione Orari')}
            <main>
                <div class="card">
                    <h3 class="card-title">Importa da File</h3>
                    <p class="form-label" style="margin-bottom: 1.5rem; color: var(--secondary-text);">
                        Carica un file Excel per sostituire tutti i dati degli orari esistenti. Questa azione è irreversibile.
                    </p>
                    <div class="form-group">
                        <label class="form-label">Carica File Orari Custode (.xlsx, .xls)</label>
                        <input type="file" id="excel-file-input-orari-custode" class="form-input" accept=".xlsx, .xls">
                        <small style="color: var(--secondary-text); font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                            Dimensione massima: 10MB. Il file deve contenere almeno una colonna con dati.
                        </small>
                    </div>
                    <div id="message-import-orari-custode" class="message-box"></div>
                    <div id="save-button-container-orari-custode" class="hidden mt-4">
                        <button id="save-imported-data-btn-orari-custode" class="btn btn-primary w-full">
                            <span id="save-btn-text">Salva e Sostituisci Dati</span>
                            <span id="save-btn-loading" class="hidden" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                <svg class="animate-spin" style="width: 16px; height: 16px;" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke-dasharray="31.416" stroke-dashoffset="31.416">
                                        <animate attributeName="stroke-dasharray" dur="2s" values="0 31.416;15.708 15.708;0 31.416" repeatCount="indefinite"/>
                                        <animate attributeName="stroke-dashoffset" dur="2s" values="0;-15.708;-31.416" repeatCount="indefinite"/>
                                    </circle>
                                </svg>
                                Salvataggio...
                            </span>
                        </button>
                    </div>
                    <div class="mt-4">
                        <h4 class="section-title" style="font-size: 1rem; margin-bottom: 0.5rem;">Anteprima</h4>
                        <div id="excel-table-container-orari-custode-import" class="data-table-container">
                            <p style="color:var(--secondary-text);">Nessun file selezionato.</p>
                        </div>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderOrariCustodeVisualizza = () => `
            ${renderHeader('Riepilogo Orari Custode')}
            <main>
                <div class="card">
                    <h3 class="card-title">Elenco Completo Orari</h3>
                    <p class="form-label" style="color: var(--secondary-text); margin-bottom: 2rem;">
                        Elenco completo di tutti i dati relativi agli orari del custode. Le modifiche possono essere effettuate nella sezione "Gestione Manuale".
                    </p>
                    <div id="excel-table-container-orari-custode-view" class="data-table-container">
                        <p style="color:var(--secondary-text);">Caricamento dati...</p>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderDatiAmministratoreMenu = () => `
            ${renderHeader('Dati Amministratore')}
            <main>
                <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                    <div onclick="navigateTo('datiAmministratore_manuale')" class="dashboard-item">
                        <div class="dashboard-card">
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z"/></svg>
                        </div>
                        <p>Gestione Manuale</p>
                    </div>
                    <div onclick="navigateTo('datiAmministratore_import')" class="dashboard-item">
                        <div class="dashboard-card">
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z"/></svg>
                        </div>
                        <p>Importazione Dati</p>
                    </div>
                    <div onclick="navigateTo('datiAmministratore_visualizza')" class="dashboard-item" style="grid-column: 1 / -1;">
                        <div class="dashboard-card" style="aspect-ratio: auto; height: 80px; flex-direction: row; justify-content: flex-start; gap: 1.5rem; padding: 1rem 1.5rem;">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M20,2H4A2,2 0 0,0 2,4V20A2,2 0,0,0 4,22H20A2,2 0,0,0 22,20V4A2,2 0,0,0 20,2M12,6A3,3 0,0,1 15,9A3,3 0,0,1 12,12A3,3 0,0,1 9,9A3,3 0,0,1 12,6M18,20H6V18.6C6,16.6 10,15.5 12,15.5C14,15.5 18,16.6 18,18.6V20Z"/></svg>
                            <p style="text-align: left; font-size: 1.1rem;">Riepilogo Dati</p>
                        </div>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderDatiAmministratoreManuale = () => `
            ${renderHeader('Gestione Manuale Amministratore')}
            <main>
                <div class="card" style="margin-bottom: 2rem;">
                    <h3 class="card-title">Aggiungi Nuova Voce</h3>
                    <div id="add-admin-data-message" class="message-box"></div>
                    <form id="add-admin-data-form" class="space-y-4">
                        <div class="form-group">
                            <label for="admin-data-nominativo" class="form-label">Nominativo</label>
                            <input type="text" id="admin-data-nominativo" required class="form-input" placeholder="Es. Studio Amministrazioni S.r.l.">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="admin-data-referente" class="form-label">Referente</label>
                                <input type="text" id="admin-data-referente" class="form-input" placeholder="Es. Dott. Rossi">
                            </div>
                            <div class="form-group">
                                <label for="admin-data-telefono" class="form-label">Telefono</label>
                                <input type="tel" id="admin-data-telefono" class="form-input" placeholder="Numero di telefono">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="admin-data-email" class="form-label">Email</label>
                            <input type="email" id="admin-data-email" class="form-input" placeholder="Indirizzo email">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="admin-data-orari" class="form-label">Orari</label>
                                <input type="text" id="admin-data-orari" class="form-input" placeholder="Es. 9:00-18:00">
                            </div>
                            <div class="form-group">
                                <label for="admin-data-giorni-lavorativi" class="form-label">Giorni Lavorativi</label>
                                <input type="text" id="admin-data-giorni-lavorativi" class="form-input" placeholder="Es. Lun-Ven">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="admin-data-ruolo" class="form-label">Ruolo</label>
                            <input type="text" id="admin-data-ruolo" class="form-input" placeholder="Es. Amministratore di condominio">
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" class="btn btn-primary">Aggiungi Voce</button>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <h3 class="card-title">Dati Attuali</h3>
                    <div id="table-container-admin-data" class="data-table-container">
                        <p style="color:var(--secondary-text);">Nessun dato presente.</p>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderDatiAmministratoreImport = () => `
            ${renderHeader('Importazione Dati Amministratore')}
            <main>
                <div class="card">
                    <h3 class="card-title">Importa da File</h3>
                    <p class="form-label" style="margin-bottom: 1.5rem; color: var(--secondary-text);">
                        Carica un file Excel per sostituire tutti i dati dell'amministratore. Questa azione è irreversibile.
                    </p>
                    <div class="form-group">
                        <label class="form-label">Carica File Dati Amministratore (.xlsx, .xls)</label>
                        <input type="file" id="file-input-admin-data" class="form-input" accept=".xlsx, .xls">
                    </div>
                    <div id="message-import-admin-data" class="message-box"></div>
                    <div id="save-button-container-admin-data" class="hidden mt-4">
                        <button id="save-imported-data-btn-admin-data" class="btn btn-primary w-full">Salva e Sostituisci Dati</button>
                    </div>
                    <div class="mt-4">
                        <h4 class="section-title" style="font-size: 1rem; margin-bottom: 0.5rem;">Anteprima</h4>
                        <div id="table-container-admin-data" class="data-table-container">
                            <p style="color:var(--secondary-text);">Nessun file selezionato.</p>
                        </div>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderDatiAmministratoreVisualizza = () => `
            ${renderHeader('Riepilogo Dati Amministratore')}
            <main>
                <div class="card">
                    <h3 class="card-title">Elenco Completo Dati</h3>
                    <p class="form-label" style="color: var(--secondary-text); margin-bottom: 2rem;">
                        Elenco completo di tutti i dati relativi all'amministratore.
                    </p>
                    <div id="table-container-admin-data" class="data-table-container">
                        <p style="color:var(--secondary-text);">Caricamento dati...</p>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderInfoUtiliAmministratore = () => `
            ${renderHeader('Amministratore')}
            <main>
                <div class="card">
                    <h3 class="card-title">Recapiti Amministrazione</h3>
                    <p class="form-label" style="color: var(--secondary-text); margin-bottom: 2rem;">
                        Informazioni di contatto per l'amministrazione del condominio.
                    </p>
                    <div id="admin-data-summary-container" class="data-table-container">
                        <p style="color:var(--secondary-text);">Caricamento dati...</p>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderGestioneGruppiMenu = () => `
            ${renderHeader(userProfile?.tipoUtente === 'adm' ? 'Funzioni Admin' : 'Funzioni Supervisore')}
            <main>
                <div class="dashboard-grid" style="grid-template-columns: 1fr;">
                    <div onclick="navigateTo('periodiAmministrativi')" class="dashboard-item">
                        <div class="menu-list-item">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1M17,12H12V17H17V12Z"/></svg>
                            <p style="text-align: left; font-size: 1.1rem;">Periodi Amministrativi</p>
                        </div>
                    </div>
                    <div onclick="navigateTo('userManagement')" class="dashboard-item">
                        <div class="menu-list-item">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4Z"/></svg>
                            <p style="text-align: left; font-size: 1.1rem;">Gestione Utenti</p>
                        </div>
                    </div>
                    <div onclick="navigateTo('gestioneGruppi_lista')" class="dashboard-item">
                        <div class="menu-list-item">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M10 4v4h4V4h-4m6 12v4h4v-4h-4m-6 0v4h4v-4h-4m6-6v4h4v-4h-4m-6 0v4h4v-4h-4m-6-6v4h4V4H4m6 6v4h4v-4h-4M4 16v4h4v-4H4m14-2h2v-4h-2v4m0 6h2v-4h-2v4m-12-2h2v-4H6v4m0 6h2v-4H6v4M2 2v20h20V2H2z"/></svg>
                            <p style="text-align: left; font-size: 1.1rem;">Crea e Visualizza Gruppi</p>
                        </div>
                    </div>
                    <div onclick="navigateTo('gestioneGruppi_regole')" class="dashboard-item">
                        <div class="menu-list-item">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17-.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24-.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                            <p style="text-align: left; font-size: 1.1rem;">Gestione Regole</p>
                        </div>
                    </div>
                    <div onclick="navigateTo('importazione')" class="dashboard-item">
                        <div class="menu-list-item">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z"/></svg>
                            <p style="text-align: left; font-size: 1.1rem;">Importa Dati Millesimi</p>
                        </div>
                    </div>
                    <div onclick="navigateTo('gestione_archivio')" class="dashboard-item" style="position: relative;">
                        <span id="dashboard-gestione-archivio-badge" class="notification-badge hidden" style="position: absolute; top: 8px; right: 8px;"></span>
                        <div class="menu-list-item">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V6h5.17l2 2H20v10z"/></svg>
                            <p style="text-align: left; font-size: 1.1rem;">Gestione Archivio</p>
                        </div>
                    </div>
                    <div onclick="navigateTo('impostazioniSondaggi')" class="dashboard-item">
                        <div class="menu-list-item">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M3,5H9V11H3V5M5,7V9H7V7H5M11,7H21V9H11V7M11,15H21V17H11V15M5,15H7V17H5V15M3,13H9V19H3V13Z" /></svg>
                            <p style="text-align: left; font-size: 1.1rem;">Gestione Sondaggi</p>
                        </div>
                    </div>
                    <div onclick="navigateTo('orariCustode')" class="dashboard-item">
                        <div class="menu-list-item">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.2,16.2L11,13V7H12.5V12.2L17,14.9L16.2,16.2Z"/></svg>
                            <p style="text-align: left; font-size: 1.1rem;">Importa Dati Custode</p>
                        </div>
                    </div>
                    <div onclick="navigateTo('datiAmministratore')" class="dashboard-item">
                        <div class="menu-list-item">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M10,2H14A2,2 0 0,1 16,4V6H20A2,2 0 0,1 22,8V19A2,2 0 0,1 20,21H4A2,2 0 0,1 2,19V8A2,2 0 0,1 4,6H8V4A2,2 0 0,1 10,2M14,6V4H10V6H14Z"/></svg>
                            <p style="text-align: left; font-size: 1.1rem;">Importa Dati Amministratore</p>
                        </div>
                    </div>
                    ${userProfile?.tipoUtente === 'adm' ? `
                    <div onclick="navigateTo('abilitaServizi')" class="dashboard-item">
                        <div class="menu-list-item">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M12,1L3,5V11C3,16.55,6.84,21.74,12,23C17.16,21.74,21,16.55,21,11V5L12,1M12,6.19L13.41,7.59L12,9L10.59,7.59L12,6.19M16.5,11H7.5V10C7.5,8.62,8.62,7.5,10,7.5H14C15.38,7.5,16.5,8.62,16.5,10V11M14.12,15.88L15.5,14.5L12,11L8.5,14.5L9.88,15.88L12,13.75L14.12,15.88Z"/></svg>
                            <p style="text-align: left; font-size: 1.1rem;">Abilita Servizi</p>
                        </div>
                    </div>
                    ` : ''}
                    <div onclick="navigateTo('puliziaDati')" class="dashboard-item">
                        <div class="menu-list-item">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 32px; height: 32px; flex-shrink: 0;"><path d="M15 16h4v2h-4v-2zm0-8h7v2h-7V8zm0 4h6v2h-6v-2zM3 18c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2V8H3v10zM14 5h-3l-1-1H6L5 5H2v2h12V5z"/></svg>
                            <p style="text-align: left; font-size: 1.1rem;">Pulizia Dati</p>
                        </div>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderGestioneGruppi_Lista = () => `
            ${renderHeader('Crea e Visualizza Gruppi')}
            <main>
                <div class="card" style="margin-bottom:2rem;">
                    <h3 class="card-title">Crea Gruppo Manualmente</h3>
                    <form id="create-partial-condo-form" class="space-y-4">
                        <div class="form-group">
                            <label for="partial-condo-name" class="form-label">Nome Gruppo</label>
                            <input type="text" id="partial-condo-name" required class="form-input" placeholder="Es. Scala Bellini 11, Box, Giardino...">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="partial-condo-start-plan" class="form-label">Piano Iniziale</label>
                                <input type="number" id="partial-condo-start-plan" required class="form-input" placeholder="Es. -1">
                            </div>
                            <div class="form-group">
                                <label for="partial-condo-end-plan" class="form-label">Piano Finale</label>
                                <input type="number" id="partial-condo-end-plan" required class="form-input" placeholder="Es. 8">
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" class="btn btn-primary">Crea Gruppo</button>
                        </div>
                    </form>
                </div>

                <div class="card" style="margin-bottom: 2.5rem;">
                    <div 
                        id="toggle-group-list-btn" 
                        onclick="toggleGroupListVisibility()" 
                        class="flex items-center justify-between" 
                        style="cursor: pointer; padding-bottom: 1rem; border-bottom: 1px solid var(--surface-color-light);"
                    >
                        <h3 class="card-title" style="margin-bottom: 0;">Elenco Gruppi Creati</h3>
                        <svg id="group-list-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 24px; height: 24px; transition: transform 0.3s ease;">
                            <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
                        </svg>
                    </div>
                    <div id="partial-condos-list" class="list-container" style="padding-top: 1rem;">
                        <p>Caricamento...</p>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderGestioneGruppi_Regole = () => `
            ${renderHeader('Gestione Regole')}
            <main>
                <div class="flex items-center justify-between" style="margin-bottom: 1rem;">
                    <h2 class="section-title" style="margin-bottom: 0;">Regole di Classificazione</h2>
                    <button id="add-new-rule-btn" class="btn btn-secondary" style="padding: 0.6rem 1rem; font-size: 0.9rem;">+ Nuova Regola</button>
                </div>
                <div id="rule-editor-card" class="card hidden" style="margin-bottom: 2rem; background-color: var(--surface-color-light);">
                    <form id="rule-editor-form">
                        <input type="hidden" id="rule-id">
                        <h3 id="rule-editor-title" class="card-title">Crea Nuova Regola</h3>
                        <div class="space-y-4">
                            <div class="form-group"><label for="rule-name" class="form-label">Nome Regola</label><input type="text" id="rule-name" class="form-input" required placeholder="Es. Assegnazione automatica Box"></div>
                            <div class="form-group"><label for="rule-type" class="form-label">Tipo di Condizione</label><select id="rule-type" class="form-select" required><option value="row_range_classification">Intervallo di Righe</option><option value="text_contains_classification">Testo Contiene</option></select></div>
                            <div id="params-row-range" class="space-y-4"><div class="grid grid-cols-2 gap-4"><div class="form-group"><label for="rule-start-row" class="form-label">Da Riga (inclusa)</label><input type="number" id="rule-start-row" class="form-input" min="1"></div><div class="form-group"><label for="rule-end-row" class="form-label">A Riga (inclusa)</label><input type="number" id="rule-end-row" class="form-input" min="1"></div></div></div>
                            <div id="params-text-contains" class="hidden space-y-4"><div class="form-group"><label for="rule-target-column" class="form-label">Nella Colonna</label><select id="rule-target-column" class="form-select"><option value="">Caricamento colonne...</option></select></div><div class="form-group"><label for="rule-search-text" class="form-label">Testo da Cercare</label><input type="text" id="rule-search-text" class="form-input" placeholder="Es. BOX, Giardino"></div></div>
                            <hr style="border-color: var(--surface-color); margin: 1rem 0;">
                            <div class="form-group"><label for="rule-classification" class="form-label">Azione: Assegna al Gruppo</label><select id="rule-classification" class="form-select" required><option value="">Caricamento gruppi...</option></select></div>
                            <div id="new-group-container" class="form-group hidden" style="margin-top: 0.5rem;"><label for="rule-new-group-name" class="form-label">Nome Nuovo Gruppo</label><input type="text" id="rule-new-group-name" class="form-input" placeholder="Digita il nome del nuovo gruppo"></div>
                        </div>
                        <div class="flex justify-end gap-4 mt-4"><button type="button" id="cancel-rule-edit-btn" class="btn btn-secondary">Annulla</button><button type="submit" class="btn btn-primary">Salva Regola</button></div>
                    </form>
                </div>
                <div id="group-rules-list" class="list-container"><p>Caricamento regole...</p></div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderUserManagementMenu = () => `
            ${renderHeader('Gestione Utenti')}
            <main>
                <div class="dashboard-grid">
                    <div onclick="navigateTo('userManagement_create')" class="dashboard-item">
                        <div class="dashboard-card">
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        </div>
                        <p>Crea Nuovi Utenti</p>
                    </div>
                    <div onclick="navigateTo('userManagement_list')" class="dashboard-item">
                        <div class="dashboard-card">
                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                        </div>
                        <p>Elenco Utenti</p>
                    </div>
                    <div onclick="navigateTo('userManagement_edit')" class="dashboard-item">
                        <div class="dashboard-card">
                           <svg fill="currentColor" viewBox="0 0 24 24"><path d="M14.06,9L15,9.94L5.92,19H5V18.08L14.06,9M17.66,3C17.41,3 17.15,3.1 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18.17,3.09 17.92,3 17.66,3M14.06,6.19L3,17.25V21H6.75L17.81,9.94L14.06,6.19Z"/></svg>
                        </div>
                        <p>Modifica Utenti</p>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderUserManagement_Create = () => `
            ${renderHeader('Crea Nuovo Utente')}
            <main>
                <div class="card">
                    <h3 class="card-title">Crea Nuovo Utente</h3>
                    <div id="admin-create-user-message" class="message-box"></div>
                    <form id="admin-create-user-form" class="space-y-4">
                        <div class="form-group"><label for="admin-email" class="form-label">Email</label><input id="admin-email" type="email" required class="form-input"></div>
                        <div class="form-group"><label for="admin-password" class="form-label">Password Temporanea</label><input id="admin-password" type="password" required class="form-input"></div>
                        
                        <div class="form-group custom-dropdown-container">
                            <label for="admin-nominativo-search" class="form-label">Cerca Nominativo (per auto-compilazione)</label>
                            <div style="position: relative;">
                                <input id="admin-nominativo-search" type="text" placeholder="Digita per cercare nella tabella importata..." class="form-input" autocomplete="off">
                                <button type="button" id="admin-clear-nominativo-search" class="password-toggle-btn hidden" style="transform: translateY(calc(-50% + 0.25rem));">&times;</button>
                            </div>
                            <div id="admin-nominativo-options" class="custom-dropdown-list hidden"></div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group"><label for="admin-nome" class="form-label">Nome</label><input id="admin-nome" type="text" required class="form-input"></div>
                            <div class="form-group"><label for="admin-cognome" class="form-label">Cognome/Azienda</label><input id="admin-cognome" type="text" required class="form-input"></div>
                        </div>
                        <div class="form-group"><label for="admin-tipo-utente" class="form-label">Tipo di Utente</label>
                            <select id="admin-tipo-utente" required class="form-select">
                                <option value="">Seleziona...</option>
                                <option value="condomino">Condomino</option>
                                <option value="amministratore">Amministratore</option>
                                <option value="custode">Custode</option>
                                <option value="consigliere">Consigliere</option>
                                <option value="fornitore">Fornitore</option>
                                <option value="supervisore">Supervisore</option>
                                ${userProfile?.tipoUtente === 'adm' ? `<option value="adm">Admin (ADM)</option>` : ''}
                            </select>
                        </div>
                        <div class="form-group"><label for="admin-telefono" class="form-label">Telefono</label><input id="admin-telefono" type="tel" class="form-input"></div>
                        
                        <hr style="border-color: var(--surface-color-light); margin: 1.5rem 0;">

                        <div class="form-group">
                            <div class="flex justify-between items-center mb-2">
                                <label class="form-label" style="margin-bottom:0;">Proprietà, Millesimi e Gruppi</label>
                                <button type="button" id="admin-add-property-btn" onclick="addPropertyRow()" class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size:0.8rem;">+ Aggiungi Proprietà</button>
                            </div>
                            <div id="properties-editor-container">
                                <p class="form-label" style="color:var(--secondary-text); font-size:0.9rem;">Cerca un nominativo per caricare i dati o aggiungi le proprietà manualmente.</p>
                            </div>
                        </div>

                        <div class="flex justify-end pt-2">
                           <button type="submit" class="btn btn-primary">Crea Utente</button>
                        </div>
                    </form>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderUserManagement_List = () => `
            ${renderHeader('Elenco Utenti')}
            <main>
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <input type="text" id="user-list-search" placeholder="Cerca per nome o cognome..." class="form-input">
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Riepilogo Utenti e Proprietà</h3>
                    <div id="user-summary-table-container" class="data-table-container">
                        <p>Caricamento elenco...</p>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderUserManagement_Edit = () => `
            ${renderHeader('Modifica Utenti')}
            <main>
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <input type="text" id="user-edit-search" placeholder="Cerca per nome o cognome..." class="form-input">
                    </div>
                </div>
                <h2 class="section-title">Elenco Utenti Esistenti</h2>
                <p class="form-label" style="margin-bottom: 1.5rem; color: var(--secondary-text);">
                    Clicca sull'icona di modifica per aggiornare i dati di un utente, incluse le sue proprietà, millesimi e raggruppamenti.
                </p>
                <div id="user-list-container" class="list-container">
                    <p>Caricamento utenti...</p>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const renderArchivio = () => {
            const canManage = ['supervisore', 'adm'].includes(userProfile?.tipoUtente);
            const managementButtons = canManage ? `
                <div class="flex gap-4">
                    <button onclick="openUploadModal()" class="btn btn-primary" style="flex:1;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 0.5rem;"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/></svg>
                        Carica File
                    </button>
                    <input type="file" id="file-upload-input" class="hidden" multiple onchange="handleFileUpload(event)">
                    <button id="create-folder-btn" class="btn btn-secondary" style="flex:1;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 0.5rem;"><path d="M20 6h-8l-2-2H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5 7h-2v2h-2v-2H9v-2h2V9h2v2h2v2z"/></svg>
                        Nuova Cartella
                    </button>
                </div>
                <div id="upload-progress-container" class="hidden" style="margin-top: 1rem;"></div>
            ` : '';

            return `
            ${renderHeader('Archivio Documenti')}
            <main>
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div id="storage-breadcrumbs" class="filter-chips-container" style="padding-bottom: 0; margin-bottom: 1rem;">
                        <!-- Breadcrumbs will be populated here -->
                    </div>
                    <div id="storage-list-container" class="list-container">
                        <p style="color:var(--secondary-text);">Caricamento...</p>
                    </div>
                </div>
                ${managementButtons}
            </main>
            ${renderBottomNavigation()}
            `;
        };

        const setupArchivioHandlers = () => {
            // Reset notifiche per archivio
            localStorage.setItem(`lastSeenArchivio_${currentUser.uid}`, Date.now());
            updateNotificationUI('gestione-archivio', 0);
            updateNotificationUI('archivio', 0);

            loadStorageItems(currentStoragePath);

            const createFolderBtn = document.getElementById('create-folder-btn');
            createFolderBtn?.addEventListener('click', handleCreateFolder);
        };

        const renderImpostazioniSondaggi = () => {
            const userRole = userProfile?.tipoUtente;

            // Definiamo le opzioni come oggetti per gestirle più facilmente
            const optionTutti = { value: 'option2', label: 'Tutti (Supervisore, Amministratore, Consiglieri, Condomini)' };
            const optionSac = { value: 'option1', label: 'Solo Supervisore, Amministratore e Consiglieri' };
            const optionSc = { value: 'option3', label: 'Solo Supervisore e Consiglieri' };

            let orderedOptions;

            // Controlliamo il ruolo dell'utente per determinare l'ordine
            if (['supervisore', 'adm'].includes(userRole)) {
                // Ordine speciale per supervisore e adm: DAL PIÙ AL MENO RISTRETTO
                orderedOptions = [optionSc, optionSac, optionTutti]; // <-- UNICA RIGA MODIFICATA
            } else {
                // Ordine di default per tutti gli altri ruoli
                orderedOptions = [optionSac, optionTutti, optionSc];
            }

            // Generiamo l'HTML delle opzioni basandoci sull'array ordinato
            const optionsHtml = orderedOptions.map(option => `
        <div class="form-group">
            <label class="property-selection-item" style="background-color: var(--surface-color-light); cursor: pointer;">
                <input type="radio" name="pollAuth" value="${option.value}" style="width: 20px; height: 20px; accent-color: var(--accent-color);">
                <span style="flex-grow: 1;">${option.label}</span>
            </label>
        </div>
    `).join('');

            // Componiamo il template finale della pagina
            return `
        ${renderHeader('Impostazione Sondaggi')}
        <main>
            <div class="card">
                <h3 class="card-title">Chi può votare nei sondaggi</h3>
                <div id="poll-settings-message" class="message-box"></div>
                <form id="poll-settings-form" class="space-y-4">
                    ${optionsHtml}
                    <div class="flex justify-end pt-2">
                       <button type="submit" class="btn btn-primary">Salva Impostazioni</button>
                    </div>
                </form>
            </div>
        </main>
        ${renderBottomNavigation()}
    `;
        };

        const renderCronologiaAttivita = () => `
            ${renderHeader('Cronologia Attività')}
            <main>
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 class="card-title">Filtra Attività</h3>
                    <form id="activity-filter-form" class="space-y-4">
                        <div class="grid grid-cols-1 gap-4">
                            <div class="form-group">
                                <label for="filter-type" class="form-label">Tipo Evento</label>
                                <select id="filter-type" class="form-select">
                                    <option value="">Tutti gli eventi</option>
                                    <optgroup label="Utenti">
                                        <option value="user_">Accessi e Registrazioni</option>
                                        <option value="user_created_by_admin">Creazione Utenti (Admin)</option>
                                        <option value="user_deleted">Eliminazione Utenti</option>
                                        <option value="user_updated">Modifiche Profili</option>
                                    </optgroup>
                                    <optgroup label="Comunicazioni">
                                        <option value="communication_posted">Pubblicazione Bacheca</option>
                                    </optgroup>
                                    <optgroup label="Segnalazioni">
                                        <option value="report_created">Creazione Segnalazioni</option>
                                        <option value="report_status_updated">Aggiornamento Stato</option>
                                        <option value="report_reminder_sent">Invio Solleciti</option>
                                        <option value="report_reassigned">Riassegnazione</option>
                                        <option value="report_comment_added">Aggiunta Commenti</option>
                                    </optgroup>
                                    <optgroup label="Sondaggi">
                                        <option value="poll_created">Creazione Sondaggi</option>
                                        <option value="poll_voted">Votazioni</option>
                                        <option value="poll_deleted">Eliminazione Sondaggi</option>
                                    </optgroup>
                                    <optgroup label="File e Archivio">
                                        <option value="file_uploaded">Caricamento File</option>
                                        <option value="file_deleted">Eliminazione File</option>
                                        <option value="folder_created">Creazione Cartelle</option>
                                        <option value="folder_deleted">Eliminazione Cartelle</option>
                                    </optgroup>
                                    <optgroup label="Impostazioni">
                                        <option value="service_permissions_updated">Modifica Permessi Servizi</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="filter-date" class="form-label">Mostra attività a partire da:</label>
                            <input type="date" id="filter-date" class="form-input">
                        </div>
                        <div class="flex flex-col gap-2">
                            <button type="submit" class="btn btn-primary">Applica Filtri</button>
                            <button type="button" onclick="loadActivityHistory(false)" class="btn btn-secondary">Ricarica</button>
                            <button type="reset" id="reset-filters-btn" class="btn btn-secondary">Resetta</button>
                            <button type="button" onclick="clearActivityHistory()" class="btn" style="background-color: var(--danger); color: white;">Svuota Cronologia</button>
                        </div>
                    </form>
                </div>

                <div id="activity-log-container" class="list-container">
                    <p style="color:var(--secondary-text);">Caricamento cronologia...</p>
                </div>

                <div class="flex justify-center mt-4">
                    <button id="load-more-activities-btn" class="btn btn-secondary hidden">Carica Altri</button>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        let lastVisibleDoc = null; // Variabile per la paginazione

        const formatActivityLog = (activity) => {
            const { type, details } = activity;
            const detailsText = (text) => text || 'N/D';

            switch (type) {
                case 'user_registered': return `si è registrato con il ruolo ${detailsText(details.userType)}.`;
                case 'user_created_by_admin': return `ha creato l'utente ${detailsText(details.createdUserEmail)} (${detailsText(details.createdUserType)}).`;
                case 'user_deleted': return `ha eliminato l'utente ${detailsText(details.deletedUserName)}.`;
                case 'user_updated': return `ha aggiornato il profilo di un utente (ID: ${detailsText(details.updatedUserId)}).`;
                case 'communication_posted': return `ha pubblicato la comunicazione "${detailsText(details.title)}" per il gruppo: ${detailsText(details.targetGroup)}.`;
                case 'report_created': return `ha creato la segnalazione #${detailsText(details.reportId)}: "${detailsText(details.title)}" (Priorità: ${detailsText(details.priority)}).`;
                case 'report_status_updated': return `ha aggiornato lo stato della segnalazione #${detailsText(details.reportId)} a "${detailsText(details.newStatus)}".`;
                case 'report_reminder_sent': return `ha inviato un sollecito per la segnalazione #${detailsText(details.reportId)}.`;
                case 'report_reassigned': return `ha riassegnato la segnalazione #${detailsText(details.reportId)} a: ${detailsText(details.newRecipient)}.`;
                case 'report_comment_added': return `ha aggiunto un aggiornamento alla segnalazione #${detailsText(details.reportId)}.`;
                case 'poll_created': return `ha creato il sondaggio: "${detailsText(details.title)}".`;
                case 'poll_voted': return `ha votato per l'opzione "${detailsText(details.option)}" nel sondaggio "${detailsText(details.pollTitle)}".`;
                case 'poll_deleted': return `ha eliminato un sondaggio.`;
                case 'service_permissions_updated': return `ha modificato i permessi di visibilità dei servizi.`;
                case 'file_uploaded': return `ha caricato il file nel percorso: ${detailsText(details.path)}.`;
                case 'file_deleted': return `ha eliminato il file dal percorso: ${detailsText(details.path)}.`;
                case 'folder_created': return `ha creato la cartella nel percorso: ${detailsText(details.path)}.`;
                case 'folder_deleted': return `ha eliminato la cartella dal percorso: ${detailsText(details.path)}.`;
                default: return `ha eseguito l'azione di tipo "${type}".`;
            }
        };

        const renderActivityItemHTML = (activity) => {
            const timestamp = activity.timestamp ? activity.timestamp.toDate().toLocaleString('it-IT', { dateStyle: 'short', timeStyle: 'medium' }) : 'N/D';
            const naturalLanguageLog = formatActivityLog(activity);

            return `
            <div class="list-item" style="background-color: var(--surface-color); flex-direction: column; align-items: flex-start; gap: 0.5rem;">
                <div class="flex justify-between w-full">
                    <div class="title" style="font-weight: 500;">
                        <strong style="color: var(--accent-color);">${activity.userName}</strong> (${activity.userType})
                    </div>
                    <div class="subtitle" style="font-size: 0.8rem;">${timestamp}</div>
                </div>
                <div class="subtitle" style="font-weight: 400; font-size: 0.95rem;">
                    ${naturalLanguageLog}
                </div>
            </div>
            `;
        };

        const loadActivityHistory = async (loadMore = false) => {
            const container = document.getElementById('activity-log-container');
            const loadMoreBtn = document.getElementById('load-more-activities-btn');
            if (!container || !loadMoreBtn) return;

            if (!loadMore) {
                container.innerHTML = '<p style="color:var(--secondary-text);">Caricamento...</p>';
                lastVisibleDoc = null;
            }

            try {
                let constraints = [orderBy("timestamp", "desc"), limit(20)];

                const filterDate = document.getElementById('filter-date')?.value;
                if (filterDate) {
                    const startDate = new Date(filterDate);
                    startDate.setHours(0, 0, 0, 0); // Inizia dalla mezzanotte del giorno selezionato
                    constraints.push(where("timestamp", ">=", startDate));
                }

                if (lastVisibleDoc && loadMore) {
                    constraints.push(startAfter(lastVisibleDoc));
                }

                const q = query(collection(db, "activities"), ...constraints);
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty && !loadMore) {
                    container.innerHTML = '<p style="color:var(--secondary-text);">Nessuna attività trovata con i filtri applicati.</p>';
                    loadMoreBtn.classList.add('hidden');
                    return;
                }

                let activities = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Filtri testuali applicati post-query
                const filterUser = document.getElementById('filter-user')?.value.trim().toLowerCase();
                const filterTypePrefix = document.getElementById('filter-type')?.value; // Non serve toLowerCase()

                if (filterUser) {
                    activities = activities.filter(act => act.userName.toLowerCase().includes(filterUser));
                }
                // Il nuovo filtro controlla se il tipo di evento INIZIA con il prefisso selezionato
                if (filterTypePrefix) {
                    activities = activities.filter(act => act.type.startsWith(filterTypePrefix));
                }

                const newHtml = activities.map(renderActivityItemHTML).join('');
                if (loadMore) {
                    container.innerHTML += newHtml;
                } else {
                    container.innerHTML = newHtml.length > 0 ? newHtml : '<p style="color:var(--secondary-text);">Nessuna attività corrisponde ai filtri.</p>';
                }

                lastVisibleDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                loadMoreBtn.classList.toggle('hidden', querySnapshot.docs.length < 20);

            } catch (error) {
                console.error("Errore nel caricamento della cronologia:", error);
                container.innerHTML = `<div class="message-box error" style="display:block;">Errore: ${error.message}</div>`;
            }
        };

        const setupCronologiaAttivitaHandlers = () => {
            const filterForm = document.getElementById('activity-filter-form');
            const loadMoreBtn = document.getElementById('load-more-activities-btn');
            const resetBtn = document.getElementById('reset-filters-btn');

            filterForm?.addEventListener('submit', (e) => {
                e.preventDefault();
                loadActivityHistory(false);
            });

            resetBtn?.addEventListener('click', () => {
                filterForm.reset();
                loadActivityHistory(false);
            });

            loadMoreBtn?.addEventListener('click', () => {
                loadActivityHistory(true);
            });

            loadActivityHistory();
        };

        const renderAbilitaServizi = () => {
            const services = [
                { id: 'all_services', name: 'Tutti i Servizi (Generale)' },
                { id: 'bacheca', name: 'Bacheca' },
                { id: 'segnalazioni', name: 'Segnalazioni' },
                { id: 'sondaggi', name: 'Sondaggi' },
                { id: 'numeri_utili', name: 'Numeri Utili' },
                { id: 'report', name: 'Report' },
            ];

            const roles = [
                { id: 'tutti', name: 'Tutti i Ruoli' },
                { id: 'condomino', name: 'Condomino' },
                { id: 'amministratore', name: 'Amministratore' },
                { id: 'custode', name: 'Custode' },
                { id: 'consigliere', name: 'Consigliere' },
                { id: 'fornitore', name: 'Fornitore' },
                { id: 'supervisore', name: 'Supervisore' },
            ];

            const generateServiceRow = (service) => `
                <div class="card" style="margin-bottom: 1.5rem; background-color: var(--surface-color-light);">
                    <div class="flex items-center justify-between" style="padding-bottom: 1rem; border-bottom: 1px solid var(--surface-color);">
                        <h4 class="card-title" style="margin: 0;">${service.name}</h4>
                        <label class="flex items-center cursor-pointer">
                            <div style="position: relative;">
                                <input type="checkbox" id="toggle-${service.id}" class="hidden service-toggle">
                                <div class="toggle-bg" style="width: 40px; height: 22px; background-color: var(--surface-color); border-radius: 99px;"></div>
                                <div class="toggle-dot" style="position: absolute; top: 3px; left: 3px; width: 16px; height: 16px; background-color: white; border-radius: 50%; transition: transform 0.3s ease;"></div>
                            </div>
                        </label>
                    </div>
                    <div style="padding-top: 1rem;">
                        <p class="form-label">Chi può vedere questo servizio?</p>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                            ${roles.map(role => `
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" class="role-checkbox" data-service="${service.id}" data-role="${role.id}" style="width: 18px; height: 18px; accent-color: var(--accent-color);">
                                    <span>${role.name}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            return `
                ${renderHeader('Abilita Servizi')}
                <main>
                    <div class="card" style="padding:0; background:none;">
                        <h3 class="section-title">Gestione Visibilità Servizi</h3>
                        <p class="form-label" style="margin-bottom: 1.5rem; color: var(--secondary-text);">
                            Abilita o disabilita i singoli servizi e definisci quali ruoli di utenti possono visualizzarli.
                        </p>
                        <div id="service-permissions-message" class="message-box"></div>
                        <form id="service-permissions-form">
                            ${services.map(generateServiceRow).join('')}
                            <div class="flex justify-end pt-2">
                                <button type="submit" class="btn btn-primary">Salva Impostazioni</button>
                            </div>
                        </form>
                    </div>
                </main>
                ${renderBottomNavigation()}
            `;
        };

        const renderPuliziaDati = () => `
            ${renderHeader('Pulizia Dati')}
            <main>
                <div class="card">
                    <h3 class="card-title">Pulizia Dati di Massa</h3>
                    <p class="form-label" style="color:var(--secondary-text); margin-bottom: 1.5rem;">
                        Seleziona una categoria di dati da visualizzare. Potrai selezionare ed eliminare più elementi contemporaneamente. <strong>Questa operazione è irreversibile.</strong>
                    </p>
                    <div id="cleanup-message-box" class="message-box"></div>
                    <div class="filter-chips-container" style="margin-bottom: 1.5rem;">
                        <div id="cleanup-chip-communications" class="chip" onclick="loadItemsForCleanup('communications')">Comunicazioni</div>
                        <div id="cleanup-chip-reports" class="chip" onclick="loadItemsForCleanup('reports')">Segnalazioni</div>
                        <div id="cleanup-chip-polls" class="chip" onclick="loadItemsForCleanup('polls')">Sondaggi</div>
                    </div>
                    <div id="cleanup-list-container" class="list-container" style="min-height: 200px; max-height: 60vh; overflow-y: auto;">
                        <p style="color:var(--secondary-text);">Seleziona una categoria per iniziare.</p>
                    </div>
                    <div id="cleanup-actions-container" class="hidden" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--surface-color-light);">
                        <!-- "Select All" Checkbox will be injected here by JS -->
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const loadItemsForCleanup = async (type) => {
            const listContainer = document.getElementById('cleanup-list-container');
            const actionsContainer = document.getElementById('cleanup-actions-container');
            const messageBox = document.getElementById('cleanup-message-box');
            messageBox.style.display = 'none';

            // Reset chips and set active
            document.querySelectorAll('.filter-chips-container .chip').forEach(c => c.classList.remove('active'));
            document.getElementById(`cleanup-chip-${type}`).classList.add('active');

            listContainer.innerHTML = '<p style="color:var(--secondary-text);">Caricamento dati...</p>';
            actionsContainer.classList.add('hidden');

            const typeMap = {
                communications: { collection: 'communications', titleField: 'title', dateField: 'createdAt' },
                reports: { collection: 'reports', titleField: 'title', dateField: 'createdAt' },
                polls: { collection: 'polls', titleField: 'title', dateField: 'createdAt' }
            };

            if (!typeMap[type]) return;
            const config = typeMap[type];

            try {
                const q = query(collection(db, config.collection), orderBy(config.dateField, "desc"));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    listContainer.innerHTML = `<p style="color:var(--secondary-text);">Nessun elemento trovato in questa categoria.</p>`;
                    return;
                }

                const itemsHtml = snapshot.docs.map(doc => {
                    const item = doc.data();
                    const title = item[config.titleField] || 'Senza titolo';
                    const date = item[config.dateField]?.toDate()?.toLocaleDateString('it-IT') || 'Data non disponibile';

                    return `
                    <div class="list-item" style="background: var(--surface-color-light);">
                        <label class="flex items-center gap-4 w-full cursor-pointer">
                            <input type="checkbox" class="cleanup-item-checkbox" data-id="${doc.id}" data-type="${type}" onchange="handleCleanupSelectionChange('${type}')" style="width: 20px; height: 20px; accent-color: var(--accent-color); flex-shrink: 0;">
                            <div class="list-item-content">
                                <div class="title">${title}</div>
                                <div class="subtitle">${date}</div>
                            </div>
                        </label>
                    </div>
                    `;
                }).join('');

                listContainer.innerHTML = itemsHtml;

                actionsContainer.innerHTML = `
                    <label class="flex items-center gap-3 p-3 rounded-md cursor-pointer" style="background-color: var(--surface-color-light); margin-bottom: 1rem;">
                        <input type="checkbox" id="cleanup-select-all" onchange="toggleAllForCleanup(this, '${type}')" style="width: 20px; height: 20px; accent-color: var(--accent-color);">
                        <span class="font-medium">Seleziona / Deseleziona Tutto</span>
                    </label>
                    <button id="cleanup-delete-btn" class="btn w-full" style="background-color: var(--danger); color: white;" onclick="handleBulkDelete('${type}')" disabled>Elimina Selezionati (0)</button>
                `;
                actionsContainer.classList.remove('hidden');

            } catch (error) {
                console.error(`Error loading ${type} for cleanup:`, error);
                listContainer.innerHTML = `<div class="message-box error" style="display:block">Errore nel caricamento: ${error.message}</div>`;
            }
        };

        const toggleAllForCleanup = (source, type) => {
            const checkboxes = document.querySelectorAll(`.cleanup-item-checkbox[data-type="${type}"]`);
            checkboxes.forEach(checkbox => {
                checkbox.checked = source.checked;
            });
            handleCleanupSelectionChange(type);
        };

        const handleCleanupSelectionChange = (type) => {
            const selectedCheckboxes = document.querySelectorAll(`.cleanup-item-checkbox[data-type="${type}"]:checked`);
            const deleteBtn = document.getElementById('cleanup-delete-btn');
            const selectAllCheckbox = document.getElementById('cleanup-select-all');

            if (deleteBtn) {
                deleteBtn.disabled = selectedCheckboxes.length === 0;
                deleteBtn.textContent = `Elimina Selezionati (${selectedCheckboxes.length})`;
            }

            if (selectAllCheckbox) {
                const totalCheckboxes = document.querySelectorAll(`.cleanup-item-checkbox[data-type="${type}"]`).length;
                selectAllCheckbox.checked = selectedCheckboxes.length === totalCheckboxes && totalCheckboxes > 0;
                selectAllCheckbox.indeterminate = selectedCheckboxes.length > 0 && selectedCheckboxes.length < totalCheckboxes;
            }
        };

        const handleBulkDelete = async (type) => {
            const selectedCheckboxes = document.querySelectorAll(`.cleanup-item-checkbox[data-type="${type}"]:checked`);
            const idsToDelete = Array.from(selectedCheckboxes).map(cb => cb.dataset.id);
            const messageBox = document.getElementById('cleanup-message-box');

            if (idsToDelete.length === 0) {
                alert("Nessun elemento selezionato.");
                return;
            }

            const typeName = {
                communications: "comunicazioni",
                reports: "segnalazioni",
                polls: "sondaggi"
            }[type];

            if (!confirm(`Sei sicuro di voler eliminare definitivamente ${idsToDelete.length} ${typeName}?`)) {
                return;
            }

            const confirmationText = prompt(`Questa azione è irreversibile. Per confermare, digita "ELIMINA" nel campo sottostante.`);
            if (confirmationText !== 'ELIMINA') {
                alert("Operazione annullata. La parola di conferma non è corretta.");
                return;
            }

            const deleteBtn = document.getElementById('cleanup-delete-btn');
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'Eliminazione in corso...';

            try {
                const collectionName = { communications: 'communications', reports: 'reports', polls: 'polls' }[type];
                const deletePromises = idsToDelete.map(id => deleteDoc(doc(db, collectionName, id)));

                await Promise.all(deletePromises);

                // NUOVO: Resetta il contatore se si stanno eliminando le comunicazioni
                if (type === 'communications') {
                    const counterRef = doc(db, "counters", "communicationsCounter");
                    await setDoc(counterRef, { lastNumber: 0 });
                }

                await logActivity("bulk_delete", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, {
                    dataType: type,
                    count: idsToDelete.length,
                    deletedIds: idsToDelete
                });

                messageBox.className = 'message-box success';
                messageBox.textContent = `${idsToDelete.length} ${typeName} eliminati con successo.`;
                messageBox.style.display = 'block';

                // Ricarica la lista per mostrare i cambiamenti
                loadItemsForCleanup(type);

            } catch (error) {
                console.error(`Bulk delete error for ${type}:`, error);
                messageBox.className = 'message-box error';
                messageBox.textContent = `Errore durante l'eliminazione: ${error.message}`;
                messageBox.style.display = 'block';
                deleteBtn.disabled = false;
                handleCleanupSelectionChange(type); // Ripristina il conteggio corretto
            }
        };

        const clearActivityHistory = async () => {
            if (!confirm("Sei assolutamente sicuro di voler eliminare TUTTA la cronologia delle attività? Questa azione è irreversibile.")) {
                return;
            }

            const confirmationText = prompt('Per confermare, digita "SVUOTA CRONOLOGIA" nel campo sottostante.');
            if (confirmationText !== 'SVUOTA CRONOLOGIA') {
                alert("Operazione annullata. La parola di conferma non è corretta.");
                return;
            }

            const container = document.getElementById('activity-log-container');
            container.innerHTML = '<p style="color:var(--secondary-text);">Eliminazione della cronologia in corso...</p>';

            try {
                const activitiesCollection = collection(db, "activities");
                const snapshot = await getDocs(activitiesCollection);

                if (snapshot.empty) {
                    alert("La cronologia è già vuota.");
                    loadActivityHistory(false);
                    return;
                }

                // Firestore limits batch writes to 500 operations. We process in chunks.
                const batchSize = 499; // A bit less than 500 for safety
                const batches = [];
                for (let i = 0; i < snapshot.docs.length; i += batchSize) {
                    const batch = writeBatch(db);
                    snapshot.docs.slice(i, i + batchSize).forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    batches.push(batch.commit());
                }

                await Promise.all(batches);

                // Log this important action
                await logActivity("history_cleared", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, {
                    clearedCount: snapshot.size
                });

                alert(`Cronologia eliminata con successo. ${snapshot.size} record rimossi.`);

            } catch (error) {
                console.error("Errore durante la pulizia della cronologia:", error);
                alert(`Si è verificato un errore: ${error.message}`);
            } finally {
                // Refresh the view
                loadActivityHistory(false);
            }
        };

        const setupAbilitaServiziHandlers = async () => {
            const form = document.getElementById('service-permissions-form');
            if (!form) return;

            const settingsRef = doc(db, "settings", "servicePermissions");

            const updateToggleVisuals = (checkbox) => {
                const parentLabel = checkbox.closest('label');
                if (!parentLabel) return;
                const bg = parentLabel.querySelector('.toggle-bg');
                const dot = parentLabel.querySelector('.toggle-dot');
                if (!bg || !dot) return;

                if (checkbox.checked) {
                    bg.style.backgroundColor = 'var(--accent-color)';
                    dot.style.transform = 'translateX(18px)';
                } else {
                    bg.style.backgroundColor = 'var(--surface-color-light)';
                    dot.style.transform = 'translateX(0)';
                }
            };

            try {
                const docSnap = await getDoc(settingsRef);
                if (docSnap.exists()) {
                    const permissions = docSnap.data();
                    for (const serviceId in permissions) {
                        const serviceConfig = permissions[serviceId];
                        const serviceToggle = document.getElementById(`toggle-${serviceId}`);
                        if (serviceToggle) {
                            serviceToggle.checked = serviceConfig.enabled;
                            updateToggleVisuals(serviceToggle);
                        }

                        const roleCheckboxes = document.querySelectorAll(`.role-checkbox[data-service="${serviceId}"]`);
                        roleCheckboxes.forEach(cb => {
                            const role = cb.dataset.role;
                            if (serviceConfig.allowedRoles && serviceConfig.allowedRoles.includes(role)) {
                                cb.checked = true;
                            }
                        });
                    }
                }
            } catch (error) {
                console.error("Error loading service permissions:", error);
            }

            form.addEventListener('change', (e) => {
                // --- NUOVA LOGICA PER I TOGGLE DI ABILITAZIONE ---
                if (e.target.classList.contains('service-toggle')) {
                    const checkbox = e.target;
                    updateToggleVisuals(checkbox);

                    // Se il toggle modificato è "Tutti i servizi", aggiorna gli altri
                    if (checkbox.id === 'toggle-all_services') {
                        const isChecked = checkbox.checked;
                        const allOtherToggles = form.querySelectorAll('.service-toggle:not(#toggle-all_services)');
                        allOtherToggles.forEach(toggle => {
                            if (toggle.checked !== isChecked) { // Evita di scatenare eventi inutili
                                toggle.checked = isChecked;
                                updateToggleVisuals(toggle);
                            }
                        });
                    }
                }

                // --- LOGICA ESISTENTE PER I RUOLI (corretta) ---
                if (e.target.classList.contains('role-checkbox') && e.target.dataset.role === 'tutti') {
                    const serviceId = e.target.dataset.service;
                    const allCheckboxesForService = document.querySelectorAll(`.role-checkbox[data-service="${serviceId}"]`);
                    allCheckboxesForService.forEach(cb => {
                        cb.checked = e.target.checked;
                    });
                } else if (e.target.classList.contains('role-checkbox') && !e.target.checked) {
                    const serviceId = e.target.dataset.service;
                    const tuttiCheckbox = document.querySelector(`.role-checkbox[data-service="${serviceId}"][data-role="tutti"]`);
                    if (tuttiCheckbox) tuttiCheckbox.checked = false;
                }
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const messageBox = document.getElementById('service-permissions-message');
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Salvataggio...';

                const newPermissions = {};
                const services = ['all_services', 'bacheca', 'segnalazioni', 'sondaggi', 'numeri_utili', 'report'];

                services.forEach(serviceId => {
                    const serviceToggle = document.getElementById(`toggle-${serviceId}`);
                    const enabled = serviceToggle ? serviceToggle.checked : false;

                    const allowedRoles = [];
                    const roleCheckboxes = document.querySelectorAll(`.role-checkbox[data-service="${serviceId}"]:checked`);
                    roleCheckboxes.forEach(cb => {
                        allowedRoles.push(cb.dataset.role);
                    });

                    newPermissions[serviceId] = { enabled, allowedRoles };
                });

                try {
                    await setDoc(settingsRef, newPermissions);
                    await logActivity("service_permissions_updated", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`);

                    messageBox.className = 'message-box success';
                    messageBox.textContent = 'Impostazioni salvate con successo!';
                    messageBox.style.display = 'block';
                    setTimeout(() => { messageBox.style.display = 'none'; }, 3000);

                } catch (error) {
                    console.error("Error saving service permissions:", error);
                    messageBox.className = 'message-box error';
                    messageBox.textContent = `Errore nel salvataggio: ${error.message}`;
                    messageBox.style.display = 'block';
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Salva Impostazioni';
                }
            });
        };

        const setupImpostazioniSondaggiHandlers = async () => {
            const form = document.getElementById('poll-settings-form');
            if (!form) return;

            const messageBox = document.getElementById('poll-settings-message');
            const settingsRef = doc(db, "settings", "pollCreationAuthorization");

            // Load current setting
            try {
                const docSnap = await getDoc(settingsRef);
                if (docSnap.exists()) {
                    const setting = docSnap.data().setting;
                    const radio = form.querySelector(`input[name="pollAuth"][value="${setting}"]`);
                    if (radio) radio.checked = true;
                } else {
                    // Default to option 2 if not set
                    const radio = form.querySelector('input[name="pollAuth"][value="option2"]');
                    if (radio) radio.checked = true;
                }
            } catch (error) {
                console.error("Error loading poll settings:", error);
                messageBox.className = 'message-box error';
                messageBox.textContent = 'Errore nel caricamento delle impostazioni.';
                messageBox.style.display = 'block';
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const selectedOption = formData.get('pollAuth');

                if (!selectedOption) {
                    alert('Seleziona un\'opzione.');
                    return;
                }

                try {
                    await setDoc(settingsRef, { setting: selectedOption });
                    await logActivity("poll_voting_settings_updated", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { newSetting: selectedOption });

                    messageBox.className = 'message-box success';
                    messageBox.textContent = 'Impostazioni salvate con successo!';
                    messageBox.style.display = 'block';
                    setTimeout(() => { messageBox.style.display = 'none'; }, 3000);
                } catch (error) {
                    console.error("Error saving poll settings:", error);
                    messageBox.className = 'message-box error';
                    messageBox.textContent = `Errore nel salvataggio: ${error.message}`;
                    messageBox.style.display = 'block';
                }
            });
        };

        const renderCurrentPage = async () => {
            const app = document.getElementById('app');
            if (currentPage === 'login') {
                app.innerHTML = renderLoginPage();
                setupLoginHandlers();
                return;
            }
            app.innerHTML = `<div style="padding:1rem;">Caricamento...</div>`;
            const userType = userProfile?.tipoUtente;

            let content = '';
            switch (currentPage) {
                case 'dashboard': content = renderDashboard(); break;
                case 'bacheca': content = renderBacheca(); break;
                case 'bacheca_tutte': content = renderBachecaTutte(); break;
                case 'bacheca_crea': content = renderBachecaCrea(); break;
                case 'sondaggi': if (userType !== 'custode') { content = await renderSondaggiMenu(); } break;
                case 'sondaggi_crea': if (userType !== 'custode') { content = renderSondaggiCrea(); } break;
                case 'sondaggi_elenco': if (userType !== 'custode') { content = renderSondaggiElenco(); } break;
                case 'sondaggi_attivi': if (userType !== 'custode') { content = renderSondaggiAttivi(); } break;
                case 'sondaggi_conclusi': if (userType !== 'custode') { content = renderSondaggiConclusi(); } break;
                case 'segnalazioni': content = renderSegnalazioniMenu(); break;
                case 'segnalazioni_crea': content = renderSegnalazioniCrea(); break;

                case 'segnalazioni_ricevute': content = renderSegnalazioniRicevute(); break;
                case 'segnalazioni_urgenti': content = renderSegnalazioniUrgenti(); break;
                case 'segnalazioni_utente': content = renderSegnalazioniUtente(); break;
                case 'profilo': content = renderProfilo(); break;
                case 'infoUtili': content = renderInfoUtili(); break;
                case 'numeriUtiliImportati':
                    if (userType === 'supervisore') content = renderNumeriUtiliImportati();
                    else navigateTo('dashboard');
                    break;
                case 'numeriUtiliManuali':
                    if (userType === 'supervisore') content = renderNumeriUtiliManuali();
                    else navigateTo('dashboard');
                    break;
                case 'numeriUtiliRubrica': content = renderNumeriUtiliRubrica(); break;
                case 'numeriUtiliCustode': content = renderNumeriUtiliCustode(); break;
                case 'infoUtili_amministratore': content = renderInfoUtiliAmministratore(); break;

                case 'userManagement':
                    if (['supervisore', 'adm'].includes(userType)) content = renderUserManagementMenu();
                    else navigateTo('dashboard');
                    break;
                case 'userManagement_create':
                    if (['supervisore', 'adm'].includes(userType)) content = renderUserManagement_Create();
                    else navigateTo('dashboard');
                    break;
                case 'userManagement_list':
                    if (['supervisore', 'adm'].includes(userType)) content = renderUserManagement_List();
                    else navigateTo('dashboard');
                    break;
                case 'userManagement_edit':
                    if (['supervisore', 'adm'].includes(userType)) content = renderUserManagement_Edit();
                    else navigateTo('dashboard');
                    break;
                case 'gestioneGruppi':
                    if (['supervisore', 'adm'].includes(userType)) content = renderGestioneGruppiMenu();
                    else navigateTo('dashboard');
                    break;
                case 'gestioneGruppi_lista':
                    if (['supervisore', 'adm'].includes(userType)) content = renderGestioneGruppi_Lista();
                    else navigateTo('dashboard');
                    break;
                case 'gestioneGruppi_regole':
                    if (['supervisore', 'adm'].includes(userType)) content = renderGestioneGruppi_Regole();
                    else navigateTo('dashboard');
                    break;
                case 'importazione':
                    if (['supervisore', 'adm'].includes(userType)) content = renderImportazione();
                    else navigateTo('dashboard');
                    break;
                case 'orariCustode':
                    if (['supervisore', 'adm'].includes(userType)) content = renderOrariCustode();
                    else navigateTo('dashboard');
                    break;
                case 'orariCustode_manuale':
                    if (['supervisore', 'adm'].includes(userType)) content = renderOrariCustodeManuale();
                    else navigateTo('dashboard');
                    break;
                case 'orariCustode_import':
                    if (['supervisore', 'adm'].includes(userType)) content = renderOrariCustodeImport();
                    else navigateTo('dashboard');
                    break;
                case 'orariCustode_visualizza':
                    if (['supervisore', 'adm'].includes(userType)) content = renderOrariCustodeVisualizza();
                    else navigateTo('dashboard');
                    break;
                case 'datiAmministratore':
                    if (['supervisore', 'adm'].includes(userType)) content = renderDatiAmministratoreMenu();
                    else navigateTo('dashboard');
                    break;
                case 'datiAmministratore_manuale':
                    if (['supervisore', 'adm'].includes(userType)) content = renderDatiAmministratoreManuale();
                    else navigateTo('dashboard');
                    break;
                case 'datiAmministratore_import':
                    if (['supervisore', 'adm'].includes(userType)) content = renderDatiAmministratoreImport();
                    else navigateTo('dashboard');
                    break;
                case 'datiAmministratore_visualizza':
                    if (['supervisore', 'adm'].includes(userType)) content = renderDatiAmministratoreVisualizza();
                    else navigateTo('dashboard');
                    break;
                case 'reportPage':
                    content = renderReportPage();
                    break;
                case 'elencoCondomini':
                    content = renderElencoCondomini();
                    break;
                case 'impostazioniSondaggi':
                    if (['supervisore', 'adm'].includes(userType)) content = renderImpostazioniSondaggi();
                    else navigateTo('dashboard');
                    break;
                case 'archivio':
                case 'gestione_archivio':
                    content = renderArchivio();
                    break;
                case 'abilitaServizi':
                    if (userProfile?.tipoUtente === 'adm') content = renderAbilitaServizi();
                    else navigateTo('dashboard');
                    break;
                case 'cronologiaAttivita':
                    if (userProfile?.tipoUtente === 'adm') content = renderCronologiaAttivita();
                    else navigateTo('dashboard');
                    break;
                case 'puliziaDati':
                    if (['supervisore', 'adm'].includes(userProfile?.tipoUtente)) content = renderPuliziaDati();
                    else navigateTo('dashboard');
                    break;
                case 'statisticheCondomini':
                    if (['adm', 'amministratore'].includes(userProfile?.tipoUtente)) content = renderStatisticheCondomini();
                    else navigateTo('dashboard');
                    break;
                case 'periodiAmministrativi': // NUOVO
                    if (['supervisore', 'adm'].includes(userProfile?.tipoUtente)) content = renderPeriodiAmministrativi();
                    else navigateTo('dashboard');
                    break;
                default: content = renderLoginPage();
            }

            app.innerHTML = content;

            // Update theme icon after page render
            updateThemeIcon(currentTheme);

            switch (currentPage) {
                case 'dashboard':
                    /* The stats are now on a separate page */
                    break;
                case 'elencoCondomini': loadElencoCondomini(); break;
                case 'bacheca': /* No handlers needed for the menu page */ break;
                case 'bacheca_tutte':
                    loadCommunications();
                    document.getElementById('communication-search')?.addEventListener('input', loadCommunications);
                    break;
                case 'bacheca_crea': setupBachecaHandlers(); break;
                case 'sondaggi': /* No handlers needed for the menu page */ break;
                case 'sondaggi_crea': if (userType !== 'custode') { setupPollHandlers(); } break;
                case 'sondaggi_elenco':
                    if (userType !== 'custode') {
                        loadPolls('all');
                        const searchInput = document.getElementById('poll-search');
                        const typeFilter = document.getElementById('poll-type-filter');
                        searchInput?.addEventListener('input', () => loadPolls('all'));
                        typeFilter?.addEventListener('change', () => loadPolls('all'));
                    }
                    break;
                case 'sondaggi_attivi':
                    if (userType !== 'custode') {
                        loadPolls('active');
                        const searchInput = document.getElementById('poll-search');
                        const typeFilter = document.getElementById('poll-type-filter');
                        searchInput?.addEventListener('input', () => loadPolls('active'));
                        typeFilter?.addEventListener('change', () => loadPolls('active'));
                    }
                    break;
                case 'sondaggi_conclusi':
                    if (userType !== 'custode') {
                        loadPolls('closed');
                        const searchInput = document.getElementById('poll-search');
                        const typeFilter = document.getElementById('poll-type-filter');
                        searchInput?.addEventListener('input', () => loadPolls('closed'));
                        typeFilter?.addEventListener('change', () => loadPolls('closed'));
                    }
                    break;
                case 'segnalazioni': /* No handlers needed for the menu page */ break;
                case 'segnalazioni_crea': loadMyReports(); setupReportHandlers(); break;

                case 'segnalazioni_ricevute': loadReceivedReports(); break;
                case 'segnalazioni_urgenti': loadUrgentReports(); break;
                case 'segnalazioni_utente': loadUserReports(); break;
                case 'profilo': setupProfileHandlers(); break;
                case 'infoUtili': /* No handlers needed for the menu page */ break;
                case 'numeriUtiliImportati':
                case 'numeriUtiliManuali':
                    if (userType === 'supervisore') {
                        loadUsefulNumbers();
                        setupInfoUtiliHandlers();
                    }
                    break;
                case 'numeriUtiliRubrica':
                    loadRubricaNumbers();
                    break;
                case 'numeriUtiliCustode':
                    loadCustodeSchedule();
                    break;
                case 'infoUtili_amministratore':
                    setupInfoUtiliAmministratoreHandlers();
                    break;

                case 'userManagement': /* No handlers needed for the menu page */ break;
                case 'userManagement_create': if (['supervisore', 'adm'].includes(userType)) { setupAdminUserCreationHandler(); } break;
                case 'userManagement_list':
                    if (['supervisore', 'adm'].includes(userType)) {
                        loadUserListTable();
                        document.getElementById('user-list-search')?.addEventListener('input', loadUserListTable);
                    }
                    break;
                case 'userManagement_edit':
                    if (['supervisore', 'adm'].includes(userType)) {
                        loadUsers();
                        document.getElementById('user-edit-search')?.addEventListener('input', loadUsers);
                    }
                    break;
                case 'gestioneGruppi': /* No handlers needed for the menu page */ break;
                case 'gestioneGruppi_lista': if (['supervisore', 'adm'].includes(userType)) { loadPartialCondos(); setupUserManagementHandlers(); } break;
                case 'gestioneGruppi_regole': if (['supervisore', 'adm'].includes(userType)) { loadGroupRules(); setupGestioneGruppiHandlers(); } break;
                case 'importazione': if (userType === 'supervisore') { setupImportazioneHandlers(); } break;
                case 'orariCustode': /* No handlers needed for the menu page */ break;
                case 'orariCustode_manuale': if (userType === 'supervisore') { setupOrariCustodeManualeHandlers(); } break;
                case 'orariCustode_import': if (userType === 'supervisore') { setupOrariCustodeImportHandlers(); } break;
                case 'orariCustode_visualizza': if (userType === 'supervisore') { setupOrariCustodeVisualizzaHandlers(); } break;
                case 'datiAmministratore': /* No handlers needed for the menu page */ break;
                case 'datiAmministratore_manuale': if (userType === 'supervisore') { setupDatiAmministratoreManualeHandlers(); } break;
                case 'datiAmministratore_import': if (userType === 'supervisore') { setupDatiAmministratoreImportHandlers(); } break;
                case 'datiAmministratore_visualizza': if (userType === 'supervisore') { setupDatiAmministratoreVisualizzaHandlers(); } break;
                case 'impostazioniSondaggi': if (['supervisore', 'adm'].includes(userType)) { setupImpostazioniSondaggiHandlers(); } break;
                case 'abilitaServizi': if (userProfile?.tipoUtente === 'adm') { setupAbilitaServiziHandlers(); } break;
                case 'cronologiaAttivita': if (userProfile?.tipoUtente === 'adm') { setupCronologiaAttivitaHandlers(); } break;
                case 'puliziaDati': /* No specific handlers needed as logic is in onclick */ break;
                case 'statisticheCondomini': setupStatisticheCondominiHandlers(); break;
                case 'periodiAmministrativi': setupPeriodiAmministrativiHandlers(); break; // NUOVO
                case 'archivio':
                case 'gestione_archivio':
                    setupArchivioHandlers();
                    break;
            }

            if (currentPage !== 'login') {
                checkForNewCommunications();
                checkForNewPolls();
                checkForNewReports();
                checkForNewSolleciti();
                checkForUserReportUpdates();
                checkForNewArchivioActivity();
            }
        };

        const setupLoginHandlers = () => {
            let isRegistering = false;
            let localGroupedProperties = {};
            let localPartialCondosList = [];

            const toggleAuthBtn = document.getElementById("toggle-auth");
            const authTitle = document.getElementById("auth-title");
            const authSubmitBtn = document.getElementById("auth-submit");
            const registerFields = document.getElementById("register-fields");
            const authForm = document.getElementById("auth-form");
            const forgotPasswordBtn = document.getElementById("forgot-password");

            const searchInput = document.getElementById('nominativo-search');
            const optionsContainer = document.getElementById('nominativo-options');
            const propertySelectionWrapper = document.getElementById('property-selection-wrapper');
            const propertyItemsContainer = document.getElementById('property-items-container');
            const summaryEl = document.getElementById('selection-summary');

            const findHeader = (headers, keywords) => {
                const lowerCaseKeywords = keywords.map(k => k.toLowerCase());
                return headers.find(header => lowerCaseKeywords.includes(header.toLowerCase()));
            };

            const loadPartialCondosForRegistration = async () => {
                if (localPartialCondosList.length > 0) return;
                try {
                    const q = query(collection(db, "partialCondos"), orderBy("name"));
                    const querySnapshot = await getDocs(q);
                    localPartialCondosList = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error("Errore nel caricamento dei condomini parziali:", error);
                    localPartialCondosList = [];
                }
            };

            let activeRules = [];
        let importedHeaders = [];

        const getAutomaticGroupByRules = (propertyData) => {
            if (!propertyData || activeRules.length === 0) return '';
            
            for (const rule of activeRules) {
                if (rule.type === 'text_contains_classification' && rule.params) {
                    const targetColumn = rule.params.targetColumn;
                    const searchText = rule.params.searchText.toLowerCase();
                    const propertyValue = (propertyData[targetColumn] || '').toString().toLowerCase();
                    
                    if (propertyValue.includes(searchText)) {
                        return rule.params.classification; // Applica la prima regola che corrisponde
                    }
                }
                // Nota: le regole 'row_range_classification' non sono applicabili in questo contesto.
            }
            
            return ''; // Nessuna regola corrispondente
        };

        const loadActiveGroupRules = async () => {
            if (activeRules.length > 0) return;
            try {
                const q = query(collection(db, "groupRules"), where("isActive", "==", true));
                const snapshot = await getDocs(q);
                activeRules = snapshot.docs.map(doc => doc.data());
            } catch (error) {
                console.error("Errore nel caricamento delle regole di gruppo:", error);
                activeRules = [];
            }
        };

        const loadPropertyDataForRegistration = async () => {
                if (Object.keys(localGroupedProperties).length > 0) return;
                try {
                    const q = query(collection(db, "importedData"), orderBy("uploadedAt", "desc"), limit(1));
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) return;

                    const tableData = querySnapshot.docs[0].data().tableData || [];
                    if (tableData.length === 0) return;

                    const headers = Object.keys(tableData[0]);
                    const nominativoHeader = findHeader(headers, ['nominativo']);
                    const apartmentHeader = findHeader(headers, ['interno', 'appartamento', 'unita']);
                    const millesimiHeader = findHeader(headers, ['millesimi', 'quota']);

                    if (!nominativoHeader || !apartmentHeader || !millesimiHeader) {
                        console.error("Intestazioni non trovate!"); return;
                    }

                    localGroupedProperties = {}; // Assicura che lo stato sia pulito
                    tableData.forEach(item => {
                        const nominativo = item[nominativoHeader];
                        if (!nominativo) return;
                        if (!localGroupedProperties[nominativo]) localGroupedProperties[nominativo] = [];
                        localGroupedProperties[nominativo].push(item);
                    });
                } catch (error) { console.error("Errore nel caricamento dati per la registrazione:", error); }
            };

            const renderDropdownOptions = (filter = '') => {
                if (!optionsContainer) return;
                const lowerFilter = filter.toLowerCase();
                const filteredNames = Object.keys(localGroupedProperties)
                    .filter(name => name.toLowerCase().includes(lowerFilter))
                    .sort();

                if (filteredNames.length === 0) {
                    optionsContainer.innerHTML = `<div class="custom-dropdown-item" style="cursor:default;">Nessun risultato</div>`;
                } else {
                    optionsContainer.innerHTML = filteredNames.map(name =>
                        `<div class="custom-dropdown-item" data-value="${name}">${name}</div>`
                    ).join('');
                }
                optionsContainer.classList.remove('hidden');
            };

            const selectNominativo = async (name) => {
                if (!searchInput || !optionsContainer) return;
                searchInput.value = name;
                optionsContainer.classList.add('hidden');

                const properties = localGroupedProperties[name];
                propertyItemsContainer.innerHTML = '';
                propertySelectionWrapper.classList.add('hidden');
                summaryEl.innerHTML = 'Seleziona un nominativo per continuare...';

                if (!properties) return;

                await loadPartialCondosForRegistration();
                const groupOptionsHtml = `<option value="" disabled selected>Seleziona gruppo...</option>` + localPartialCondosList.map(c => `<option value="${c.name}" data-start="${c.startPlan}" data-end="${c.endPlan}">${c.name}</option>`).join('');

                const headers = Object.keys(properties[0] || {});
                const apartmentHeader = findHeader(headers, ['interno', 'appartamento', 'unita']);
                const millesimiHeader = findHeader(headers, ['millesimi', 'quota']);

                properties.forEach((prop, index) => {
                    const autoGroup = getAutomaticGroupByRules(prop);
                    const isMultiProperty = properties.length > 1;
                    const item = document.createElement('div');
                    item.className = 'property-selection-item';
                    item.dataset.apartment = prop[apartmentHeader];
                    item.dataset.millesimi = prop[millesimiHeader];
                    item.innerHTML = `
                    <label for="prop-${index}">
                        ${isMultiProperty ? `<input type="checkbox" id="prop-${index}" style="width: 20px; height: 20px; accent-color: var(--accent-color);">` : ''}
                        <span>${prop[apartmentHeader]} - ${prop[millesimiHeader]} ‰</span>
                    </label>
                    <div class="property-controls-stack">
                        <select class="form-select group-select">${groupOptionsHtml.replace(`value="${autoGroup}"`, `value="${autoGroup}" selected`)}</select>
                        <select class="form-select plan-select" disabled><option>Seleziona gruppo</option></select>
                    </div>
                `;
                    propertyItemsContainer.appendChild(item);
                });

                const updatePlanOptions = (itemElement) => {
                    const groupSelect = itemElement.querySelector('.group-select');
                    const planSelect = itemElement.querySelector('.plan-select');
                    const selectedOption = groupSelect.options[groupSelect.selectedIndex];
                    
                    if (!selectedOption || !selectedOption.dataset.start) {
                        planSelect.innerHTML = '<option>Seleziona gruppo</option>';
                        planSelect.disabled = true;
                        return;
                    }

                    const start = parseInt(selectedOption.dataset.start, 10);
                    const end = parseInt(selectedOption.dataset.end, 10);
                    
                    let planOptionsHtml = '<option value="" disabled selected>Piano...</option>';
                    for (let i = start; i <= end; i++) {
                        planOptionsHtml += `<option value="${i}">${i}</option>`;
                    }
                    planSelect.innerHTML = planOptionsHtml;
                    planSelect.disabled = false;
                };

                propertyItemsContainer.querySelectorAll('.property-selection-item').forEach(item => {
                    updatePlanOptions(item); // Initial population
                    item.querySelector('.group-select').addEventListener('change', () => {
                        updatePlanOptions(item);
                        updateSummary();
                    });
                });

                propertySelectionWrapper.classList.remove('hidden');
                propertyItemsContainer.addEventListener('change', updateSummary);
                updateSummary();
            };

            const updateSummary = () => {
                const selectedProperties = [];
                propertyItemsContainer.querySelectorAll('.property-selection-item').forEach(item => {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    if (checkbox && !checkbox.checked) return;
                    const groupSelect = item.querySelector('.group-select');
                    const planSelect = item.querySelector('.plan-select');
                    selectedProperties.push({
                        interno: item.dataset.apartment,
                        millesimi: parseFloat(item.dataset.millesimi) || 0,
                        gruppo: groupSelect.value,
                        piano: planSelect.value ? parseInt(planSelect.value, 10) : null
                    });
                });

                if (selectedProperties.length === 0) {
                    summaryEl.innerHTML = '<span style="color:var(--warning);">Seleziona almeno una proprietà.</span>';
                    return;
                }

                let totalMillesimi = selectedProperties.reduce((sum, prop) => sum + prop.millesimi, 0);
                let summaryHtml = '<strong>Unità Selezionate:</strong><ul>';
                selectedProperties.forEach(prop => {
                    summaryHtml += `<li style="list-style-type: disc; margin-left: 20px;">${prop.interno} (${prop.millesimi.toFixed(2)} ‰) - <strong>Piano:</strong> ${prop.piano ?? 'N/A'} - <strong>Gruppo:</strong> ${prop.gruppo || 'N/A'}</li>`;
                });
                summaryHtml += `</ul><hr style="border-color: var(--surface-color); margin: 0.5rem 0;"><strong style="display: flex; justify-content: space-between;"><span>Totale Millesimi:</span><span>${totalMillesimi.toFixed(2)} ‰</span></strong>`;
                summaryEl.innerHTML = summaryHtml;
            };

            // --- Event Listeners ---
            searchInput?.addEventListener('input', () => renderDropdownOptions(searchInput.value));
            searchInput?.addEventListener('focus', () => renderDropdownOptions(searchInput.value));

            optionsContainer?.addEventListener('click', (e) => {
                if (e.target.classList.contains('custom-dropdown-item') && e.target.dataset.value) {
                    selectNominativo(e.target.dataset.value);
                }
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.custom-dropdown-container')) {
                    optionsContainer?.classList.add('hidden');
                }
            });

            toggleAuthBtn?.addEventListener("click", async (event) => {
                event.preventDefault();
                isRegistering = !isRegistering;
                authTitle.textContent = isRegistering ? "Registrati" : "Accedi";
                authSubmitBtn.textContent = isRegistering ? "Registrati" : "Accedi";
                event.target.textContent = isRegistering ? "Accedi" : "Registrati";
                registerFields.classList.toggle("hidden", !isRegistering);
                forgotPasswordBtn.classList.toggle("hidden", isRegistering);
                if (isRegistering) {
                await Promise.all([
                    loadPropertyDataForRegistration(),
                    loadActiveGroupRules()
                ]);
            }
            });

            authForm?.addEventListener("submit", async t => {
                t.preventDefault();
                const o = document.getElementById("email").value, n = document.getElementById("password").value, d = document.getElementById("error-message"), r = document.getElementById("success-message");
                d.style.display = "none"; r.style.display = "none";
                try {
                    if (isRegistering) {
                        const t = document.getElementById("confirm-password").value, i = document.getElementById("nome").value, s = document.getElementById("cognome").value, a = document.getElementById("tipo-utente").value, l = document.getElementById("telefono").value;
                        if (n !== t) throw new Error("Le password non coincidono");
                        if (!i || !s || !a || !l.trim()) throw new Error("Compila tutti i campi obbligatori");

                        const propertiesForUser = [];
                    let groupSelectionMissing = false;
                    propertyItemsContainer.querySelectorAll('.property-selection-item').forEach(item => {
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        if (checkbox && !checkbox.checked) return;

                        const selectedGroup = item.querySelector('.group-select').value;
                        if (!selectedGroup) {
                            groupSelectionMissing = true;
                        }

                        propertiesForUser.push({
                            interno: item.dataset.apartment,
                            millesimi: parseFloat(item.dataset.millesimi) || 0,
                            gruppo: selectedGroup
                        });
                    });

                    if (propertiesForUser.length === 0) throw new Error("Seleziona almeno una unità immobiliare.");
                    let planSelectionMissing = false;
                    propertyItemsContainer.querySelectorAll('.property-selection-item').forEach(item => {
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        if (checkbox && !checkbox.checked) return;

                        const selectedGroup = item.querySelector('.group-select').value;
                        if (!selectedGroup) groupSelectionMissing = true;

                        const selectedPlan = item.querySelector('.plan-select').value;
                        if (!selectedPlan) planSelectionMissing = true;

                        propertiesForUser.push({
                            interno: item.dataset.apartment,
                            millesimi: parseFloat(item.dataset.millesimi) || 0,
                            gruppo: selectedGroup,
                            piano: selectedPlan ? parseInt(selectedPlan, 10) : null
                        });
                    });

                    if (propertiesForUser.length === 0) throw new Error("Seleziona almeno una unità immobiliare.");
                    if (groupSelectionMissing) throw new Error("È obbligatorio assegnare un gruppo a ogni unità immobiliare selezionata.");
                    if (planSelectionMissing) throw new Error("È obbligatorio selezionare un piano per ogni unità immobiliare selezionata.");

                        const internosToRegister = propertiesForUser.map(p => p.interno);
                        const usersSnapshot = await getDocs(collection(db, "users"));
                        for (const userDoc of usersSnapshot.docs) {
                            const user = userDoc.data();
                            if (user.proprieta?.some(p => internosToRegister.includes(p.interno))) {
                                throw new Error(`Una delle unità immobiliari selezionate è già registrata.`);
                            }
                        }

                        await register(o, n, { nome: i, cognome: s, tipoUtente: a, telefono: l, proprieta: propertiesForUser });
                        r.textContent = "Registrazione completata! Ora puoi accedere."; r.style.display = "block"; authForm.reset();
                        propertyItemsContainer.innerHTML = '';
                        propertySelectionWrapper.classList.add('hidden');
                        summaryEl.innerHTML = 'Seleziona un nominativo per continuare...';
                    } else { await login(o, n); }
                } catch (p) { d.textContent = p.message; d.style.display = "block"; }
            });

            forgotPasswordBtn?.addEventListener("click", async t => {
                t.preventDefault(); const e = document.getElementById("email").value, o = document.getElementById("error-message"), n = document.getElementById("success-message");
                if (!e) { o.textContent = "Inserisci la tua email per reimpostare la password"; o.style.display = "block"; return; }
                try { await resetPassword(e); n.textContent = "Email di reset password inviata!"; n.style.display = "block"; o.style.display = "none"; } catch (d) { o.textContent = d.message; o.style.display = "block"; }
            });

            document.querySelectorAll('.password-toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const button = e.currentTarget; const targetId = button.dataset.target; const passwordInput = document.getElementById(targetId);
                    const isPassword = passwordInput.type === 'password'; passwordInput.type = isPassword ? 'text' : 'password';
                    button.innerHTML = isPassword ? eyeSlashIcon : eyeIcon;
                });
            });
        };

        const setupBachecaHandlers = () => {
            const form = document.getElementById("create-communication-form");

            const populateGroupDropdown = async () => {
                const targetSelect = document.getElementById('comm-target-group');
                if (!targetSelect) return;
                try {
                    const q = query(collection(db, "partialCondos"), orderBy("name"));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach(doc => {
                        const group = doc.data();
                        // --- MODIFICA INIZIO: Nasconde l'opzione "Portineria" ---
                        if (group.name.toLowerCase() === 'portineria') {
                            return; // Salta l'aggiunta di questa opzione
                        }
                        // --- MODIFICA FINE ---
                        const option = document.createElement('option');
                        option.value = group.name;
                        option.textContent = group.name;
                        targetSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error("Error populating group dropdown:", error);
                }
            };

            if (form) {
                populateGroupDropdown();

                form.addEventListener("submit", async (event) => {
                    event.preventDefault();
                    const titleInput = document.getElementById("comm-title");
                    const contentInput = document.getElementById("comm-content");
                    const targetGroupInput = document.getElementById("comm-target-group");
                    const publishBtn = document.getElementById("publish-comm-btn");

                    const title = titleInput.value.trim();
                    const content = contentInput.value.trim();
                    const targetGroup = targetGroupInput.value;

                    if (!title || !content) return alert("Compila titolo e messaggio.");

                    publishBtn.disabled = true;
                    publishBtn.textContent = "Pubblicazione...";

                    try {
                        // 1. Create communication document reference to get ID first
                        const newCommRef = doc(collection(db, "communications"));
                        const commId = newCommRef.id;
                        const counterRef = doc(db, "counters", "communicationsCounter");
                        let finalCommNumber;
                        let fileUrls = [];

                        // 2. Upload files if they exist
                        if (selectedCommunicationFiles.length > 0) {
                            publishBtn.textContent = 'Caricamento allegati...';
                            const uploadPromises = selectedCommunicationFiles.map(file => {
                                const filePath = `communications/${commId}/${Date.now()}_${file.name}`;
                                const fileRef = ref(storage, filePath);
                                return uploadBytes(fileRef, file).then(() => getDownloadURL(fileRef));
                            });
                            fileUrls = await Promise.all(uploadPromises);
                        }

                        // 3. Use transaction to get communication number and set document data
                        await runTransaction(db, async (transaction) => {
                            const counterDoc = await transaction.get(counterRef);
                            const newCommNumber = (counterDoc.exists() ? counterDoc.data().lastNumber : 0) + 1;
                            finalCommNumber = newCommNumber;

                            // --- MODIFICATION START ---
                            // Get the state of the new checkbox. It defaults to false if not present.
                            const forwardToCustode = document.getElementById("comm-forward-custode")?.checked || false;

                            const commData = {
                                communicationNumber: newCommNumber,
                                title: title,
                                content: content,
                                targetGroup: targetGroup,
                                forwardToCustode: forwardToCustode, // Save the checkbox state
                                fileUrls: fileUrls,
                                createdBy: `${userProfile.nome} ${userProfile.cognome}`,
                                createdById: currentUser.uid,
                                createdAt: serverTimestamp()
                            };
                            // --- MODIFICATION END ---

                            transaction.set(counterRef, { lastNumber: newCommNumber });
                            transaction.set(newCommRef, commData);
                        });

                        await logActivity("communication_posted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { title: title, targetGroup: targetGroup, attachments: fileUrls.length });

                        const messageBox = document.getElementById('comm-creation-message');
                        if (messageBox) {
                            messageBox.className = 'message-box success';
                            messageBox.textContent = `Comunicazione n. "${finalCommNumber}" pubblicata`;
                            messageBox.style.display = 'block';
                            setTimeout(() => { messageBox.style.display = 'none'; }, 4000);
                        }

                        // Reset form and file state
                        form.reset();
                        selectedCommunicationFiles = [];
                        renderCommunicationFilePreviews();

                        // --- WEBHOOK TRIGGER: Call webhook after comunicazione creation ---
                        (async () => {
                            try {
                                const WEBHOOK_URL = "https://primary-production-36d20.up.railway.app/webhook-test/e487fd84-2324-4508-9bff-769cce2e7c27";
                                // Extract destinatari emails based on UI and rule classification
                                let destinatariEmails = [];
                                if (targetGroup && targetGroup !== 'Tutti') {
                                    // Find users whose UI (proprieta.gruppo) matches the selected group
                                    const usersQuery = query(collection(db, "users"), where("proprieta", ">", []));
                                    const usersSnapshot = await getDocs(usersQuery);
                                    usersSnapshot.forEach(docSnap => {
                                        const user = docSnap.data();
                                        if (Array.isArray(user.proprieta)) {
                                            for (const prop of user.proprieta) {
                                                if (prop.gruppo === targetGroup) {
                                                    destinatariEmails.push(user.email);
                                                    break;
                                                }
                                            }
                                        }
                                    });
                                } else if (targetGroup === 'Tutti') {
                                    // All users with an email
                                    const usersSnapshot = await getDocs(collection(db, "users"));
                                    usersSnapshot.forEach(docSnap => {
                                        const user = docSnap.data();
                                        if (user.email) destinatariEmails.push(user.email);
                                    });
                                }

                                const payload = {
                                    event: "comunicazione.create",
                                    communication: {
                                        title,
                                        content,
                                        targetGroup,
                                        createdBy: `${userProfile.nome} ${userProfile.cognome}`,
                                        createdById: currentUser.uid
                                    },
                                    destinatariEmails
                                };
                                await fetch(WEBHOOK_URL, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(payload)
                                });
                            } catch (err) {
                                console.error("Errore invio webhook comunicazione:", err);
                            }
                        })();

                    } catch (error) {
                        console.error("Errore:", error);
                        alert("Si è verificato un errore.");
                    } finally {
                        publishBtn.disabled = false;
                        publishBtn.textContent = "Pubblica";
                    }
                });
            }
        };
        const setupPollHandlers = () => {
            const form = document.getElementById("create-poll-form");
            if (!form) return;
            const optionsList = document.getElementById("poll-options-list");
            const addOptionBtn = document.getElementById("add-poll-option");

            // I gestori per la ricerca e il filtro dei sondaggi sono stati spostati nella logica della pagina 'sondaggi_elenco'.

            function addOptionInput(value = "") {
                const div = document.createElement("div");
                div.className = "flex items-center gap-2";
                div.innerHTML = `<input type="text" class="form-input" style="flex:1" required placeholder="Testo opzione" value="${value}"><button type="button" class="btn-remove-option" style="background:var(--surface-color-light); border:none; color:var(--primary-text); width:36px; height:36px; border-radius:50%; cursor:pointer;">−</button>`;
                div.querySelector(".btn-remove-option").onclick = () => {
                    optionsList.removeChild(div);
                    if (optionsList.childElementCount < 2) addOptionInput();
                };
                optionsList.appendChild(div);
            }

            if (optionsList.childElementCount === 0) {
                addOptionInput();
                addOptionInput();
            }

            addOptionBtn.onclick = e => {
                e.preventDefault();
                addOptionInput();
            };

            const triggerMakeWebhookForNewPoll = async (pollData) => {
                // --- SECURITY BEST PRACTICE ---
                // This URL should be stored in a secure backend or environment variable,
                // not exposed in client-side code.
                const MAKE_WEBHOOK_URL = "https://primary-production-36d20.up.railway.app/webhook-test/daf02a0d-306e-49c6-9f79-210a88f81de0";

                try {
                    // 1. Fetch all registered user emails from Firestore.
                    const usersSnapshot = await getDocs(collection(db, "users"));
                    const recipientEmails = usersSnapshot.docs
                        .map(doc => doc.data().email)
                        .filter(Boolean); // Filter out any null/undefined emails

                    // 2. Prepare the payload for Make.com.
                    //    The recipientEmails are formatted as a proper JSON array.
                    //    Date objects are automatically converted to ISO strings by JSON.stringify.
                    const payload = {
                        surveyDetails: pollData,
                        recipientEmails: recipientEmails
                    };

                    // 3. Send the data to the Make.com webhook endpoint.
                    const response = await fetch(MAKE_WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`Webhook request failed with status: ${response.status}`);
                    }

                    console.log("Make.com webhook for new survey triggered successfully.");
                    await logActivity("webhook_sent_poll", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { pollTitle: pollData.title, status: 'success' });

                } catch (error) {
                    console.error("Error triggering Make.com webhook:", error);
                    // Log the failure but do not block the user interface.
                    await logActivity("webhook_sent_poll_failed", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { pollTitle: pollData.title, error: error.message });
                }
            };

            form.addEventListener("submit", async (event) => {
                event.preventDefault();
                const messageBox = document.getElementById('poll-creation-message');
                messageBox.style.display = 'none';

                const pollType = document.getElementById("poll-type").value;
                const title = document.getElementById("poll-title").value;
                const description = document.getElementById("poll-description").value;
                const deadlineDate = document.getElementById("poll-deadline").value;
                const deadlineTime = document.getElementById("poll-deadline-time").value;
                const isMultipleChoice = document.getElementById("poll-multiple-choice").checked;
                const optionInputs = form.querySelectorAll('#poll-options-list input[type="text"]');
                const options = Array.from(optionInputs).map(input => input.value.trim()).filter(Boolean).map(text => ({ text: text, votes: 0 }));

                if (!pollType) return alert("Seleziona un tipo di sondaggio.");
                if (options.length < 2) return alert("Inserisci almeno due opzioni.");
                if (!deadlineDate || !deadlineTime) return alert("Inserisci una data e un'ora di scadenza.");

                const deadlineISO = `${deadlineDate}T${deadlineTime}`;
                const deadline = new Date(deadlineISO);

                try {
                    const pollsQuery = query(collection(db, "polls"), orderBy("pollNumber", "desc"), limit(1));
                    const lastPollsSnapshot = await getDocs(pollsQuery);
                    const lastPollNumber = lastPollsSnapshot.empty ? 0 : lastPollsSnapshot.docs[0].data().pollNumber;
                    const newPollNumber = lastPollNumber + 1;

                    const pollData = {
                        pollNumber: newPollNumber,
                        pollType: pollType,
                        title: title,
                        description: description,
                        options: options,
                        deadline: deadline,
                        multipleChoice: isMultipleChoice,
                        createdBy: `${userProfile.nome} ${userProfile.cognome}`,
                        createdById: currentUser.uid,
                        createdAt: serverTimestamp(),
                        voters: []
                    };

                    await addDoc(collection(db, "polls"), pollData);

                    // WEBHOOK TRIGGER: Call the new function after successfully creating the poll.
                    // This is a non-blocking "fire-and-forget" call to avoid delaying the UI.
                    triggerMakeWebhookForNewPoll(pollData);

                    await logActivity("poll_created", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { title: title });

                    form.reset();

                    messageBox.className = 'message-box success';
                    messageBox.textContent = 'Sondaggio creato con successo!';
                    messageBox.style.display = 'block';
                    setTimeout(() => { messageBox.style.display = 'none'; }, 4000);

                } catch (error) {
                    console.error("Errore nella creazione del sondaggio:", error);
                    messageBox.className = 'message-box error';
                    messageBox.textContent = `Errore: ${error.message}`;
                    messageBox.style.display = 'block';
                }
            });

            form.addEventListener("reset", () => {
                setTimeout(() => {
                    optionsList.innerHTML = "";
                    addOptionInput();
                    addOptionInput();
                }, 0);
            });
        };
        const handleReportFileSelection = (event) => {
            selectedReportFiles = [...selectedReportFiles, ...Array.from(event.target.files)];
            renderFilePreviews();
            event.target.value = ''; // Permette di selezionare lo stesso file di nuovo
        };

        const renderFilePreviews = () => {
            const container = document.getElementById('attachment-previews-container');
            if (!container) return;
            container.innerHTML = selectedReportFiles.map((file, index) => {
                const isVideo = file.type.startsWith('video/');
                const objectURL = URL.createObjectURL(file);
                return `
                <div class="preview-item">
                    ${isVideo
                        ? `<video src="${objectURL}" preload="metadata"></video>`
                        : `<img src="${objectURL}" alt="${file.name}">`
                    }
                    <button class="preview-remove-btn" onclick="removeReportFile(${index})">&times;</button>
                </div>`;
            }).join('');
        };

        const removeReportFile = (index) => {
            selectedReportFiles.splice(index, 1);
            renderFilePreviews();
        };

        const handleCommunicationFileSelection = (event) => {
            selectedCommunicationFiles = [...selectedCommunicationFiles, ...Array.from(event.target.files)];
            renderCommunicationFilePreviews();
            event.target.value = ''; // Permette di selezionare lo stesso file di nuovo
        };

        const renderCommunicationFilePreviews = () => {
            const container = document.getElementById('comm-attachment-previews-container');
            if (!container) return;
            container.innerHTML = selectedCommunicationFiles.map((file, index) => {
                const isImage = file.type.startsWith('image/');
                const isVideo = file.type.startsWith('video/');
                const objectURL = URL.createObjectURL(file);
                let previewHtml;

                if (isImage) {
                    previewHtml = `<img src="${objectURL}" alt="${file.name}">`;
                } else if (isVideo) {
                    previewHtml = `<video src="${objectURL}" preload="metadata"></video>`;
                } else {
                    // Generic preview for documents and other files
                    previewHtml = `
                <div class="preview-item-document">
                    <svg fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                    <span>${file.name}</span>
                </div>
            `;
                }

                return `
        <div class="preview-item">
            ${previewHtml}
            <button class="preview-remove-btn" onclick="removeCommunicationFile(${index})">&times;</button>
        </div>`;
            }).join('');
        };

        const removeCommunicationFile = (index) => {
            selectedCommunicationFiles.splice(index, 1);
            renderCommunicationFilePreviews();
        };

        const uploadReportFiles = (reportId, files) => {
            const uploadPromises = files.map(file => {
                const filePath = `reports/${reportId}/${Date.now()}_${file.name}`;
                const fileRef = ref(storage, filePath);
                // Usiamo uploadBytes perché è più semplice per questo caso d'uso
                return uploadBytes(fileRef, file).then(() => getDownloadURL(fileRef));
            });
            return Promise.all(uploadPromises);
        };

        const setupReportHandlers = () => {
            const form = document.getElementById("create-report-form");

            // --- INIZIO BLOCCO MODIFICATO: Popolamento e gestione dropdown unità immobiliari ---
            const propertySelect = document.getElementById("report-property-select");
            const locationInput = document.getElementById("report-location"); // Campo nascosto

            if (propertySelect && locationInput) {
                if (userProfile?.proprieta && userProfile.proprieta.length > 0) {
                    userProfile.proprieta.forEach(prop => {
                        const option = new Option(
                            `Interno: ${prop.interno} (Piano: ${prop.piano ?? 'N/D'})`,
                            `${prop.interno}|${prop.piano ?? 'N/A'}`
                        );
                        propertySelect.add(option);
                    });

                    // Pre-compila se c'è una sola proprietà
                    if (userProfile.proprieta.length === 1) {
                        propertySelect.selectedIndex = 1; // Seleziona il primo elemento reale
                        const [interno, piano] = propertySelect.value.split('|');
                        locationInput.value = `Interno ${interno}, Piano ${piano}`;
                    } else {
                        // Aggiungi un placeholder se ci sono più proprietà
                        propertySelect.selectedIndex = 0;
                    }
                } else {
                    // Gestisce utenti senza proprietà (es. custode) che devono inserire manualmente
                    const parentDiv = propertySelect.parentElement;
                    parentDiv.innerHTML = `
                        <label for="report-location-manual" class="form-label">Ubicazione</label>
                        <input type="text" id="report-location-manual" required class="form-input" placeholder="es. Cortile, Ingresso Principale">
                    `;
                }
            }
            // --- FINE BLOCCO MODIFICATO ---

            form?.addEventListener("submit", async (event) => {
                event.preventDefault();
                const submitBtn = document.getElementById("submit-report-btn");
                submitBtn.disabled = true;
                submitBtn.textContent = 'Invio in corso...';
                
                // --- INIZIO BLOCCO MODIFICATO: Raccolta dati dal form ---
                const title = document.getElementById("report-title").value;
                const description = document.getElementById("report-description").value;
                const category = document.getElementById("report-category").value;
                const priority = document.getElementById("report-priority").value;
                const interestType = document.getElementById("report-interest-type").value;
                const recipient = document.getElementById("report-recipient").value;
                const otherUiOwner = document.getElementById("other-ui-owner").value;
                const communicateOwnerPhone = document.getElementById("communicate-owner-phone").checked;
                const communicateOtherUiPhone = document.getElementById("communicate-other-ui-phone").checked;

                // Gestione dinamica dell'ubicazione
                let location = '';
                let propertyInfo = null;
                const manualLocationInput = document.getElementById("report-location-manual");

                if (manualLocationInput) {
                    location = manualLocationInput.value;
                } else {
                    const selectedPropValue = propertySelect.value;
                    if (selectedPropValue) {
                        const [interno, piano] = selectedPropValue.split('|');
                        location = `Interno ${interno}, Piano ${piano}`;
                        propertyInfo = { interno, piano };
                    }
                }
                
                if (!title || !description || !category || !priority || !location || !recipient) {
                    alert("Compila tutti i campi obbligatori.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Invia Segnalazione';
                    return;
                }
                // --- FINE BLOCCO MODIFICATO ---

                try {
                    const counterRef = doc(db, "counters", "reportsCounter");
                    let finalReportNumber;
                    let fileUrls = [];

                    const newReportDocRef = doc(collection(db, "reports"));
                    const reportId = newReportDocRef.id;

                    if (selectedReportFiles.length > 0) {
                        submitBtn.textContent = 'Caricamento allegati...';
                        fileUrls = await uploadReportFiles(reportId, selectedReportFiles);
                    }

                    submitBtn.textContent = 'Salvataggio dati...';
                    
                    let reportData;
                    await runTransaction(db, async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        const newReportNumber = (counterDoc.exists() ? counterDoc.data().lastNumber : 0) + 1;
                        finalReportNumber = newReportNumber;

                        reportData = {
                            reportNumber: newReportNumber,
                            title, description, category, priority,
                            location, // Ubicazione testuale per compatibilità
                            propertyInfo, // Dati strutturati della proprietà
                            interestType,
                            otherUiOwner: otherUiOwner || null,
                            communicateOwnerPhone,
                            communicateOtherUiPhone,
                            createdByPhone: userProfile.telefono || null,
                            status: "aperta",
                            createdBy: `${userProfile.nome} ${userProfile.cognome}`,
                            createdByUserType: userProfile.tipoUtente,
                            createdById: currentUser.uid,
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp(),
                            recipientType: recipient,
                            updates: [],
                            lastReminderAt: null,
                            reminderCount: 0,
                            fileUrls
                        };

                        transaction.set(counterRef, { lastNumber: newReportNumber });
                        transaction.set(newReportDocRef, reportData);
                    });

                    (async () => {
                        try {
                            const WEBHOOK_URL = "https://primary-production-36d20.up.railway.app/webhook-test/6d501d53-5ec7-449e-b3e4-38316eefd92d";
                            let receiverEmail = null;
                            let recipientQuery = null;
                            if (recipient === "amministratore") {
                                recipientQuery = query(collection(db, "users"), where("tipoUtente", "==", "amministratore"));
                            } else if (recipient === "custode") {
                                recipientQuery = query(collection(db, "users"), where("tipoUtente", "==", "custode"));
                            } else if (recipient === "consigliere") {
                                recipientQuery = query(collection(db, "users"), where("tipoUtente", "==", "consigliere"));
                            } else if (recipient === "adm") {
                                recipientQuery = query(collection(db, "users"), where("tipoUtente", "==", "adm"));
                            }
                            if (recipientQuery) {
                                const snapshot = await getDocs(recipientQuery);
                                if (!snapshot.empty) {
                                    receiverEmail = snapshot.docs[0].data().email;
                                }
                            }

                            const payload = {
                                event: "segnalazioni.create",
                                report: reportData,
                                user: {
                                    id: currentUser.uid,
                                    name: `${userProfile.nome} ${userProfile.cognome}`,
                                    email: currentUser.email
                                },
                                receiverEmail: receiverEmail
                            };
                            await fetch(WEBHOOK_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                        } catch (err) {
                            console.error("Errore invio webhook segnalazione:", err);
                        }
                    })();

                    await logActivity("report_created", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { reportId: reportId, title: title, attachments: fileUrls.length });

                    form.reset();
                    selectedReportFiles = [];
                    renderFilePreviews();

                    alert(`Segnalazione #${finalReportNumber} creata con successo!`);

                } catch (error) {
                    console.error("Errore nella creazione della segnalazione:", error);
                    alert("Si è verificato un errore durante l'invio della segnalazione.");
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Invia Segnalazione';
                }
            });

            const recipientSelect = document.getElementById("report-recipient");
            const prioritySelect = document.getElementById("report-priority");

            const updatePriorityOptions = (options) => {
                prioritySelect.innerHTML = '';
                prioritySelect.add(new Option('Seleziona genere...', ''));
                options.forEach(opt => prioritySelect.add(new Option(opt.text, opt.value)));
                prioritySelect.disabled = false;
            };

            recipientSelect?.addEventListener("change", function () {
                const recipient = this.value;

                if (!recipient) {
                    prioritySelect.innerHTML = '<option value="">Seleziona prima il destinatario...</option>';
                    prioritySelect.disabled = true;
                    return;
                }

                const allOptions = [
                    { value: 'solo-segnalazione', text: 'Segnalazione' },
                    { value: 'richiesta-intervento-propria', text: 'Richiesta d’intervento' },
                    { value: 'altre-richieste', text: 'Altre richieste' }
                ];
                const limitedOptions = [
                    { value: 'solo-segnalazione', text: 'Segnalazione' }
                ];

                if (['amministratore', 'custode'].includes(recipient)) {
                    updatePriorityOptions(allOptions);
                } else if (['consigliere', 'adm', 'condomini'].includes(recipient)) {
                    updatePriorityOptions(limitedOptions);
                } else {
                    prioritySelect.innerHTML = '<option value="">Seleziona prima il destinatario...</option>';
                    prioritySelect.disabled = true;
                }
            });

            const otherUiOwnerField = document.getElementById("other-ui-owner-field");
            const phoneCommunicationCheckboxes = document.getElementById("phone-communication-checkboxes");
            const otherUiPhoneCheckbox = document.getElementById("other-ui-phone-checkbox");

            prioritySelect?.addEventListener("change", function () {
                const selectedValue = this.value;

                if (selectedValue === "richiesta-intervento-danno") {
                    otherUiOwnerField?.classList.remove("hidden");
                } else {
                    otherUiOwnerField?.classList.add("hidden");
                }

                const interventionTypes = ["richiesta-intervento-propria", "richiesta-intervento-danno", "altre-richieste"];
                if (interventionTypes.includes(selectedValue)) {
                    phoneCommunicationCheckboxes?.classList.remove("hidden");
                    if (selectedValue === "richiesta-intervento-danno") {
                        otherUiPhoneCheckbox?.classList.remove("hidden");
                    } else {
                        otherUiPhoneCheckbox?.classList.add("hidden");
                    }
                } else {
                    phoneCommunicationCheckboxes?.classList.add("hidden");
                    otherUiPhoneCheckbox?.classList.add("hidden");
                }
            });
        };
        const setupProfileHandlers = () => {
            const form = document.getElementById("profile-form");
            form?.addEventListener("submit", async (event) => {
                event.preventDefault();
                const nome = document.getElementById("profile-nome").value;
                const cognome = document.getElementById("profile-cognome").value;
                const telefono = document.getElementById("profile-telefono").value;
                const newEmail = document.getElementById("profile-email").value.trim();

                try {
                    // Oggetto per gli aggiornamenti del documento Firestore
                    const firestoreUpdates = {
                        nome: nome,
                        cognome: cognome,
                        telefono: telefono
                    };

                    // 1. Gestisci la modifica dell'email se è cambiata
                    if (newEmail && newEmail !== currentUser.email) {
                        try {
                            // Aggiorna prima l'email in Firebase Authentication
                            await updateEmail(auth.currentUser, newEmail);
                            // Se l'aggiornamento ha successo, aggiungi l'email agli aggiornamenti di Firestore
                            firestoreUpdates.email = newEmail;
                        } catch (authError) {
                            // Gestisci errori comuni, come la necessità di un login recente
                            if (authError.code === 'auth/requires-recent-login') {
                                showProfileMessage("error", "Azione sensibile. Effettua nuovamente il login prima di cambiare l'email.");
                            } else {
                                showProfileMessage("error", `Errore email: ${authError.message}`);
                            }
                            return; // Interrompi l'esecuzione se l'aggiornamento dell'email fallisce
                        }
                    }

                    // 2. Aggiorna il documento utente in Firestore con tutti i dati
                    await updateDoc(doc(db, "users", currentUser.uid), firestoreUpdates);

                    // 3. Ricarica il profilo e mostra il messaggio di successo
                    await loadUserProfile(currentUser);
                    showProfileMessage("success", "Profilo aggiornato con successo!");

                } catch (error) {
                    showProfileMessage("error", `Errore: ${error.message}`);
                }
            });
        };

        const setupInfoUtiliHandlers = () => {
            const manualForm = document.getElementById('add-useful-number-form');
            if (manualForm) {
                manualForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    // Controllo accesso: solo supervisore può aggiungere contatti
                    if (userProfile?.tipoUtente !== 'supervisore') {
                        alert('Non hai i permessi per aggiungere contatti. Solo i supervisori possono eseguire questa operazione.');
                        return;
                    }

                    const title = document.getElementById('nu-title').value.trim();
                    const company = document.getElementById('nu-company').value.trim();
                    const number = document.getElementById('nu-number').value.trim();
                    const number2 = document.getElementById('nu-number-2').value.trim();
                    if (!title || !number) {
                        alert('I campi "INTERVENTO RICHIESTO" e "1 NUM. TELEFONICO" sono obbligatori.');
                        return;
                    }
                    try {
                        await addDoc(collection(db, 'usefulNumbers'), { title, company, number, number2, createdBy: currentUser.uid, createdAt: serverTimestamp() });
                        await logActivity("useful_number_added", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { title });
                        manualForm.reset();
                    } catch (error) {
                        console.error("Errore nell'aggiunta del numero utile:", error);
                        alert("Si è verificato un errore.");
                    }
                });
            }

            const triggerBtn = document.getElementById('trigger-phone-import-btn');
            const fileInput = document.getElementById('info-utili-phone-import-input');
            const messageBox = document.getElementById('info-utili-import-message');
            if (triggerBtn && fileInput && messageBox) {
                triggerBtn.addEventListener('click', () => fileInput.click());

                fileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    // Controllo accesso: solo supervisore può importare file
                    if (userProfile?.tipoUtente !== 'supervisore') {
                        alert('Non hai i permessi per importare file. Solo i supervisori possono eseguire questa operazione.');
                        fileInput.value = '';
                        return;
                    }

                    messageBox.className = 'message-box';
                    messageBox.textContent = 'Lettura del file in corso...';
                    messageBox.style.display = 'block';
                    triggerBtn.disabled = true;
                    triggerBtn.textContent = 'Caricamento...';
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);

                            if (jsonData.length === 0) throw new Error("Il file Excel è vuoto o non valido.");
                            messageBox.textContent = 'Salvataggio dei dati...';
                            await addDoc(collection(db, "importedPhoneNumbers"), {
                                fileName: file.name,
                                tableData: jsonData,
                                uploadedBy: currentUser.uid,
                                uploadedAt: serverTimestamp()
                            });
                            await logActivity("phone_data_imported", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { fileName: file.name, source: 'infoUtiliPage' });

                            messageBox.className = 'message-box success';
                            messageBox.textContent = 'Importazione completata con successo!';
                            setTimeout(() => { messageBox.style.display = 'none'; }, 4000);

                        } catch (err) {
                            messageBox.className = 'message-box error';
                            messageBox.textContent = `Errore: ${err.message}`;
                        } finally {
                            fileInput.value = '';
                            triggerBtn.disabled = false;
                            triggerBtn.textContent = 'Importa Nuovo File';
                        }
                    };
                    reader.readAsArrayBuffer(file);
                });
            }
        };

        const applyClassificationRules = (tableData, rules) => {
            if (!rules || rules.length === 0 || !tableData || tableData.length === 0) {
                return tableData;
            }
            const headers = Object.keys(tableData[0]);
            const groupHeader = headers.find(h => h.toLowerCase() === 'raggruppamento');
            if (!groupHeader) return tableData;

            tableData.forEach((row, index) => {
                const excelRowNumber = index + 2;
                let classificationApplied = false;
                for (const rule of rules) {
                    if (classificationApplied) break;
                    let match = false;
                    if (rule.type === 'row_range_classification') {
                        if (excelRowNumber >= rule.params.startRow && excelRowNumber <= rule.params.endRow) {
                            match = true;
                        }
                    } else if (rule.type === 'text_contains_classification') {
                        const cellValue = row[rule.params.targetColumn] || '';
                        if (cellValue.toString().toLowerCase().includes(rule.params.searchText.toLowerCase())) {
                            match = true;
                        }
                    }
                    if (match) {
                        row[groupHeader] = rule.params.classification;
                        classificationApplied = true;
                    }
                }
            });
            return tableData;
        };

        const setupImportazioneHandlers = async () => {
            let partialCondosList = [];
            let activeRules = [];

            const loadPrerequisites = async () => {
                try {
                    const condosQuery = query(collection(db, "partialCondos"), orderBy("name"));
                    const rulesQuery = query(collection(db, "groupRules"), where("isActive", "==", true));
                    const [condosSnapshot, rulesSnapshot] = await Promise.all([
                        getDocs(condosQuery),
                        getDocs(rulesQuery)
                    ]);
                    partialCondosList = condosSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    activeRules = rulesSnapshot.docs.map(doc => doc.data());
                } catch (error) {
                    console.error("Errore nel caricamento di gruppi e regole:", error);
                    partialCondosList = [];
                    activeRules = [];
                }
            };

            const generateTableHTML = (data, isPreview = false) => {
                if (!data || data.length === 0) return '<p style="color:var(--secondary-text);">Nessun dato da visualizzare.</p>';
                const groupOptionsHtml = `<option value="">Nessun Gruppo</option>` + partialCondosList.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                let tableHTML = `<table class="data-table" id="millesimi-preview-table">`;
                const headers = Object.keys(data[0]);
                tableHTML += '<thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>';
                data.forEach(row => {
                    tableHTML += '<tr>';
                    headers.forEach(header => {
                        const cellValue = row[header] !== undefined ? row[header] : '';
                        if (isPreview && header.toLowerCase() === 'raggruppamento') {
                            const selectedGroupOptions = groupOptionsHtml.replace(`value="${cellValue}"`, `value="${cellValue}" selected`);
                            tableHTML += `<td><select class="form-select" style="padding: 0.4rem 0.6rem; font-size: 0.9rem;">${selectedGroupOptions}</select></td>`;
                        } else {
                            tableHTML += `<td>${cellValue}</td>`;
                        }
                    });
                    tableHTML += '</tr>';
                });
                return tableHTML + '</tbody></table>';
            };

            const convertArrayOfArraysToObjects = (data) => {
                const headers = data[0].map(h => h.toString().trim());
                if (!headers.map(h => h.toLowerCase()).includes('raggruppamento')) {
                    headers.push('Raggruppamento');
                    for (let i = 1; i < data.length; i++) {
                        data[i].push('');
                    }
                }
                return data.slice(1).map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = row[index] !== undefined ? row[index] : '';
                    });
                    return obj;
                });
            };

            const fileInputMillesimi = document.getElementById('excel-file-input-millesimi');
            const tableContainerMillesimi = document.getElementById('excel-table-container-millesimi');
            const messageBoxMillesimi = document.getElementById('message-import-millesimi');
            const saveBtnContainerMillesimi = document.getElementById('save-button-container-millesimi');
            const saveBtnMillesimi = document.getElementById('save-imported-data-btn-millesimi');
            let millesimiFileName = '';

            const loadLatestMillesimiData = async () => {
                const q = query(collection(db, "importedData"), orderBy("uploadedAt", "desc"), limit(1));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    const docData = snapshot.docs[0].data();
                    let data = docData.tableData;
                    data = applyClassificationRules(data, activeRules);
                    tableContainerMillesimi.innerHTML = generateTableHTML(data, true);
                    saveBtnContainerMillesimi.classList.remove('hidden');
                    millesimiFileName = docData.fileName || 'dati_esistenti.xlsx';
                } else {
                    tableContainerMillesimi.innerHTML = '<p style="color:var(--secondary-text);">Nessun dato anagrafico ancora importato.</p>';
                    saveBtnContainerMillesimi.classList.add('hidden');
                }
            };

            fileInputMillesimi.addEventListener('change', (event) => {
                const file = event.target.files[0];
                millesimiFileName = '';
                saveBtnContainerMillesimi.classList.add('hidden'); messageBoxMillesimi.style.display = 'none';
                if (!file) { loadLatestMillesimiData(); return; }
                millesimiFileName = file.name;
                tableContainerMillesimi.innerHTML = '<p>Caricamento anteprima...</p>';
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                        if (jsonData.length < 2) throw new Error("Il file deve contenere almeno un'intestazione e una riga di dati.");
                        let dataAsObjects = convertArrayOfArraysToObjects(jsonData);
                        dataAsObjects = applyClassificationRules(dataAsObjects, activeRules);
                        tableContainerMillesimi.innerHTML = generateTableHTML(dataAsObjects, true);
                        saveBtnContainerMillesimi.classList.remove('hidden');
                    } catch (err) {
                        messageBoxMillesimi.className = 'message-box error';
                        messageBoxMillesimi.textContent = `Errore: ${err.message}`;
                        messageBoxMillesimi.style.display = 'block';
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            saveBtnMillesimi.addEventListener('click', async () => {
                const previewTable = document.getElementById('millesimi-preview-table');
                if (!previewTable) return;
                saveBtnMillesimi.disabled = true; saveBtnMillesimi.textContent = 'Salvataggio...';
                try {
                    const headers = Array.from(previewTable.querySelectorAll('thead th')).map(th => th.textContent.trim());
                    const raggruppamentoIndex = headers.findIndex(h => h.toLowerCase() === 'raggruppamento');
                    const tableData = Array.from(previewTable.querySelectorAll('tbody tr')).map(tr => {
                        const rowObject = {};
                        Array.from(tr.cells).forEach((td, index) => {
                            const header = headers[index];
                            if (index === raggruppamentoIndex) {
                                const select = td.querySelector('select');
                                rowObject[header] = select ? select.value : '';
                            } else {
                                rowObject[header] = td.textContent.trim();
                            }
                        });
                        return rowObject;
                    });
                    if (tableData.length === 0) throw new Error("Nessun dato da salvare.");
                    await addDoc(collection(db, "importedData"), {
                        fileName: millesimiFileName,
                        tableData: tableData,
                        uploadedBy: currentUser.uid,
                        uploadedAt: serverTimestamp()
                    });
                    await logActivity("data_imported", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { fileName: millesimiFileName });
                    fileInputMillesimi.value = '';
                    saveBtnContainerMillesimi.classList.add('hidden');
                    messageBoxMillesimi.className = 'message-box success';
                    messageBoxMillesimi.textContent = 'Dati salvati con successo!';
                    messageBoxMillesimi.style.display = 'block';
                    setTimeout(() => { messageBoxMillesimi.style.display = 'none'; }, 3000);
                    await loadLatestMillesimiData();
                } catch (error) {
                    messageBoxMillesimi.className = 'message-box error';
                    messageBoxMillesimi.textContent = `Errore durante il salvataggio: ${error.message}`;
                    messageBoxMillesimi.style.display = 'block';
                } finally {
                    saveBtnMillesimi.disabled = false; saveBtnMillesimi.textContent = 'Salva Dati Anagrafica';
                }
            });

            await loadPrerequisites();
            await loadLatestMillesimiData();
        };

        const loadAndRenderCustodianSchedule = (containerId, isEditable) => {
            const tableContainer = document.getElementById(containerId);
            if (!tableContainer) return;

            const generateTableHTML = (data) => {
                if (!data || data.length === 0) return '<p style="color:var(--secondary-text);">Nessun dato da visualizzare.</p>';

                const originalHeaders = Object.keys(data[0]);
                const desiredOrderKeywords = ['nominativo', 'lun - ven', 'sabato', 'ruolo', 'telefono'];
                let headers = [];
                let remainingHeaders = [...originalHeaders];

                desiredOrderKeywords.forEach(keyword => {
                    const foundHeader = remainingHeaders.find(h => h.toLowerCase().includes(keyword));
                    if (foundHeader) {
                        headers.push(foundHeader);
                        remainingHeaders = remainingHeaders.filter(h => h !== foundHeader);
                    }
                });

                headers = [...headers, ...remainingHeaders];

                let tableHTML = `<table class="data-table"><thead><tr>`;
                headers.forEach(header => {
                    tableHTML += `<th>${header.toUpperCase()}</th>`;
                });
                if (isEditable) {
                    tableHTML += `<th style="text-align:right;">AZIONI</th>`;
                }
                tableHTML += `</tr></thead><tbody>`;

                data.forEach((row, index) => {
                    tableHTML += `<tr>`;
                    headers.forEach(header => {
                        const cellValue = row[header] !== undefined ? row[header] : '';
                        tableHTML += `<td>${cellValue}</td>`;
                    });

                    if (isEditable) {
                        const editIcon = `<button onclick="editImportedScheduleEntry(${index}, ${JSON.stringify(row).replace(/"/g, '&quot;')})" class="btn-icon" title="Modifica" style="margin-right: 0.5rem;"><svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></button>`;
                        const deleteIcon = `<button onclick="deleteImportedScheduleEntry(${index})" class="btn-icon" title="Elimina" style="background:var(--danger); color:white;"><svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>`;
                        tableHTML += `<td style="text-align:right;">${editIcon}${deleteIcon}</td>`;
                    }
                    tableHTML += `</tr>`;
                });
                tableHTML += '</tbody></table>';
                return tableHTML;
            };

            const q = query(collection(db, "importedCustodeSchedule"), orderBy("uploadedAt", "desc"), limit(1));
            onSnapshot(q, (snapshot) => {
                if (!snapshot.empty) {
                    const docData = snapshot.docs[0].data();
                    const data = docData.tableData;
                    tableContainer.innerHTML = generateTableHTML(data);
                } else {
                    tableContainer.innerHTML = '<p style="color:var(--secondary-text);">Nessun orario custode ancora importato.</p>';
                }
            });
        };

        const setupOrariCustodeManualeHandlers = async () => {
            const addForm = document.getElementById('add-custodian-form');

            if (addForm) {
                addForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const messageBox = document.getElementById('add-custodian-message');
                    const submitBtn = addForm.querySelector('button[type="submit"]');
                    messageBox.style.display = 'none';
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Aggiungo...';

                    try {
                        const qSchedule = query(collection(db, "importedCustodeSchedule"), orderBy("uploadedAt", "desc"), limit(1));
                        const snapshot = await getDocs(qSchedule);

                        let docRef;
                        let tableData = [];
                        let headers = [];

                        if (!snapshot.empty) {
                            const docSnap = snapshot.docs[0];
                            docRef = docSnap.ref;
                            tableData = docSnap.data().tableData || [];
                            if (tableData.length > 0) {
                                headers = Object.keys(tableData[0]);
                            }
                        }

                        const findKey = (keywords, fallback) => headers.find(h => keywords.some(k => h.toLowerCase().includes(k))) || fallback;

                        const nominativo = document.getElementById('custodian-nominativo').value.trim();
                        const lunVen = document.getElementById('custodian-lun-ven').value.trim();
                        const sabato = document.getElementById('custodian-sabato').value.trim();
                        const ruolo = document.getElementById('custodian-ruolo').value.trim();
                        const telefono = document.getElementById('custodian-telefono').value.trim();

                        // Validazione dei campi obbligatori
                        if (!nominativo) {
                            throw new Error('Il campo Nominativo è obbligatorio.');
                        }

                        const newEntry = {
                            [findKey(['nominativo'], 'Nominativo')]: nominativo,
                            [findKey(['lun - ven', 'lun-ven'], 'Lun - Ven')]: lunVen,
                            [findKey(['sabato'], 'Sabato')]: sabato,
                            [findKey(['ruolo'], 'Ruolo')]: ruolo,
                            [findKey(['telefono'], 'Telefono')]: telefono,
                        };

                        tableData.push(newEntry);

                        if (docRef) {
                            await updateDoc(docRef, { tableData: tableData });
                        } else {
                            await addDoc(collection(db, "importedCustodeSchedule"), {
                                fileName: 'dati_manuali.xlsx',
                                tableData: tableData,
                                uploadedBy: currentUser.uid,
                                uploadedAt: serverTimestamp()
                            });
                        }

                        await logActivity("custode_schedule_entry_added", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { entry: newEntry });

                        messageBox.className = 'message-box success';
                        messageBox.textContent = 'Voce aggiunta con successo!';
                        messageBox.style.display = 'block';
                        addForm.reset();
                        setTimeout(() => { messageBox.style.display = 'none'; }, 3000);

                    } catch (error) {
                        console.error("Errore nell'aggiunta della voce orario:", error);
                        messageBox.className = 'message-box error';
                        messageBox.textContent = `Errore: ${error.message}`;
                        messageBox.style.display = 'block';
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Aggiungi Voce';
                    }
                });
            }

            loadAndRenderCustodianSchedule('excel-table-container-orari-custode-manual', true);
        };

        const setupOrariCustodeVisualizzaHandlers = () => {
            loadAndRenderCustodianSchedule('excel-table-container-orari-custode-view', false);
        };

        const loadAndRenderAdminData = (containerId, isEditable) => {
            const tableContainer = document.getElementById(containerId);
            if (!tableContainer) return;

            const generateTableHTML = (data) => {
                if (!data || data.length === 0) return '<p style="color:var(--secondary-text);">Nessun dato da visualizzare.</p>';

                const headers = Object.keys(data[0]);
                let tableHTML = `<table class="data-table"><thead><tr>`;
                headers.forEach(header => {
                    tableHTML += `<th>${header.toUpperCase()}</th>`;
                });
                if (isEditable) {
                    tableHTML += `<th style="text-align:right;">AZIONI</th>`;
                }
                tableHTML += `</tr></thead><tbody>`;

                data.forEach((row, index) => {
                    tableHTML += `<tr>`;
                    headers.forEach(header => {
                        tableHTML += `<td>${row[header] !== undefined ? row[header] : ''}</td>`;
                    });

                    if (isEditable) {
                        const editIcon = `<button onclick="editImportedAdminEntry(${index}, ${JSON.stringify(row).replace(/"/g, '&quot;')})" class="btn-icon" title="Modifica" style="margin-right: 0.5rem;"><svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></button>`;
                        const deleteIcon = `<button onclick="deleteImportedAdminEntry(${index})" class="btn-icon" title="Elimina" style="background:var(--danger); color:white;"><svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>`;
                        tableHTML += `<td style="text-align:right;">${editIcon}${deleteIcon}</td>`;
                    }
                    tableHTML += `</tr>`;
                });
                tableHTML += '</tbody></table>';
                return tableHTML;
            };

            const q = query(collection(db, "importedAdminData"), orderBy("uploadedAt", "desc"), limit(1));
            onSnapshot(q, (snapshot) => {
                if (!snapshot.empty) {
                    tableContainer.innerHTML = generateTableHTML(snapshot.docs[0].data().tableData);
                } else {
                    tableContainer.innerHTML = '<p style="color:var(--secondary-text);">Nessun dato amministratore importato.</p>';
                }
            });
        };

        const setupDatiAmministratoreManualeHandlers = () => {
            const addForm = document.getElementById('add-admin-data-form');
            if (addForm) {
                addForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const messageBox = document.getElementById('add-admin-data-message');
                    const submitBtn = addForm.querySelector('button[type="submit"]');
                    messageBox.style.display = 'none';
                    submitBtn.disabled = true;

                    try {
                        const q = query(collection(db, "importedAdminData"), orderBy("uploadedAt", "desc"), limit(1));
                        const snapshot = await getDocs(q);
                        let docRef, tableData = [], headers = [];

                        if (!snapshot.empty) {
                            docRef = snapshot.docs[0].ref;
                            tableData = snapshot.docs[0].data().tableData || [];
                            if (tableData.length > 0) headers = Object.keys(tableData[0]);
                        }

                        const findKey = (keywords, fallback) => headers.find(h => keywords.some(k => h.toLowerCase().includes(k))) || fallback;

                        const newEntry = {
                            [findKey(['nominativo'], 'Nominativo')]: document.getElementById('admin-data-nominativo').value,
                            [findKey(['referente'], 'Referente')]: document.getElementById('admin-data-referente').value,
                            [findKey(['telefono'], 'Telefono')]: document.getElementById('admin-data-telefono').value,
                            [findKey(['email'], 'Email')]: document.getElementById('admin-data-email').value,
                            [findKey(['orari'], 'Orari')]: document.getElementById('admin-data-orari').value,
                            [findKey(['giorni', 'lavorativi'], 'Giorni Lavorativi')]: document.getElementById('admin-data-giorni-lavorativi').value,
                            [findKey(['ruolo'], 'Ruolo')]: document.getElementById('admin-data-ruolo').value,
                        };

                        tableData.push(newEntry);

                        if (docRef) {
                            await updateDoc(docRef, { tableData });
                        } else {
                            await addDoc(collection(db, "importedAdminData"), {
                                fileName: 'dati_manuali_admin.xlsx',
                                tableData,
                                uploadedBy: currentUser.uid,
                                uploadedAt: serverTimestamp()
                            });
                        }
                        await logActivity("admin_data_entry_added", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { entry: newEntry });
                        messageBox.className = 'message-box success';
                        messageBox.textContent = 'Voce aggiunta con successo!';
                        messageBox.style.display = 'block';
                        addForm.reset();
                        setTimeout(() => { messageBox.style.display = 'none'; }, 3000);
                    } catch (error) {
                        messageBox.className = 'message-box error';
                        messageBox.textContent = `Errore: ${error.message}`;
                        messageBox.style.display = 'block';
                    } finally {
                        submitBtn.disabled = false;
                    }
                });
            }
            loadAndRenderAdminData('table-container-admin-data', true);
        };

        const setupDatiAmministratoreImportHandlers = () => {
            const fileInput = document.getElementById('file-input-admin-data');
            const tableContainer = document.getElementById('table-container-admin-data');
            const messageBox = document.getElementById('message-import-admin-data');
            const saveBtnContainer = document.getElementById('save-button-container-admin-data');
            const saveBtn = document.getElementById('save-imported-data-btn-admin-data');
            let dataToSave = null;
            let fileNameForSave = '';

            const generateTableHTML = (data) => {
                if (!data || data.length === 0) return '<p>File vuoto o non valido.</p>';
                const headers = Object.keys(data[0]);
                let tableHTML = `<table class="data-table"><thead><tr>${headers.map(h => `<th>${h.toUpperCase()}</th>`).join('')}</tr></thead><tbody>`;
                data.forEach(row => {
                    tableHTML += `<tr>${headers.map(h => `<td>${row[h] !== undefined ? row[h] : ''}</td>`).join('')}</tr>`;
                });
                return tableHTML + '</tbody></table>';
            };

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                dataToSave = null;
                fileNameForSave = '';
                saveBtnContainer.classList.add('hidden');
                messageBox.style.display = 'none';
                if (!file) {
                    tableContainer.innerHTML = '<p style="color:var(--secondary-text);">Nessun file selezionato.</p>';
                    return;
                }
                fileNameForSave = file.name;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        if (jsonData.length === 0) throw new Error("Il file è vuoto.");
                        dataToSave = jsonData;
                        tableContainer.innerHTML = generateTableHTML(jsonData);
                        saveBtnContainer.classList.remove('hidden');
                    } catch (err) {
                        messageBox.className = 'message-box error';
                        messageBox.textContent = `Errore: ${err.message}`;
                        messageBox.style.display = 'block';
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            saveBtn.addEventListener('click', async () => {
                if (!dataToSave) return;
                saveBtn.disabled = true;
                try {
                    await addDoc(collection(db, "importedAdminData"), {
                        fileName: fileNameForSave,
                        tableData: dataToSave,
                        uploadedBy: currentUser.uid,
                        uploadedAt: serverTimestamp()
                    });
                    await logActivity("admin_data_imported", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { fileName: fileNameForSave });
                    fileInput.value = '';
                    saveBtnContainer.classList.add('hidden');
                    tableContainer.innerHTML = '<p style="color:var(--secondary-text);">Nessun file selezionato.</p>';
                    messageBox.className = 'message-box success';
                    messageBox.textContent = 'Dati importati con successo!';
                    messageBox.style.display = 'block';
                    setTimeout(() => { messageBox.style.display = 'none'; }, 3000);
                } catch (error) {
                    messageBox.className = 'message-box error';
                    messageBox.textContent = `Errore: ${error.message}`;
                    messageBox.style.display = 'block';
                } finally {
                    saveBtn.disabled = false;
                }
            });
        };

        const setupDatiAmministratoreVisualizzaHandlers = () => {
            loadAndRenderAdminData('table-container-admin-data', false);
        };

        const setupInfoUtiliAmministratoreHandlers = () => {
            loadAndRenderAdminData('admin-data-summary-container', false);
        };

        const setupOrariCustodeImportHandlers = async () => {
            const fileInputOrariCustode = document.getElementById('excel-file-input-orari-custode');
            const tableContainerOrariCustode = document.getElementById('excel-table-container-orari-custode-import');
            const messageBoxOrariCustode = document.getElementById('message-import-orari-custode');
            const saveBtnContainerOrariCustode = document.getElementById('save-button-container-orari-custode');
            const saveBtnOrariCustode = document.getElementById('save-imported-data-btn-orari-custode');
            let orariCustodeFileName = '';
            let orariCustodeDataToSave = null;

            const generateTableHTML = (data) => {
                if (!data || data.length === 0) return '<p style="color:var(--secondary-text);">Nessun dato da visualizzare.</p>';
                const headers = Object.keys(data[0]);
                let tableHTML = `<table class="data-table"><thead><tr>${headers.map(h => `<th>${h.toUpperCase()}</th>`).join('')}</tr></thead><tbody>`;
                data.forEach(row => {
                    tableHTML += `<tr>${headers.map(h => `<td>${row[h] !== undefined ? row[h] : ''}</td>`).join('')}</tr>`;
                });
                tableHTML += '</tbody></table>';
                return tableHTML;
            };

            fileInputOrariCustode.addEventListener('change', (event) => {
                const file = event.target.files[0];
                orariCustodeFileName = '';
                orariCustodeDataToSave = null;
                saveBtnContainerOrariCustode.classList.add('hidden');
                messageBoxOrariCustode.style.display = 'none';

                if (!file) {
                    tableContainerOrariCustode.innerHTML = '<p style="color:var(--secondary-text);">Nessun file selezionato.</p>';
                    return;
                }

                // Validazione del file
                const allowedTypes = ['.xlsx', '.xls'];
                const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
                if (!allowedTypes.includes(fileExtension)) {
                    messageBoxOrariCustode.className = 'message-box error';
                    messageBoxOrariCustode.textContent = 'Errore: Il file deve essere in formato Excel (.xlsx o .xls)';
                    messageBoxOrariCustode.style.display = 'block';
                    tableContainerOrariCustode.innerHTML = '<p style="color:var(--secondary-text);">Nessun file selezionato.</p>';
                    return;
                }

                // Validazione dimensione file (max 10MB)
                const maxSize = 10 * 1024 * 1024; // 10MB
                if (file.size > maxSize) {
                    messageBoxOrariCustode.className = 'message-box error';
                    messageBoxOrariCustode.textContent = 'Errore: Il file è troppo grande. Dimensione massima: 10MB';
                    messageBoxOrariCustode.style.display = 'block';
                    tableContainerOrariCustode.innerHTML = '<p style="color:var(--secondary-text);">Nessun file selezionato.</p>';
                    return;
                }

                orariCustodeFileName = file.name;
                tableContainerOrariCustode.innerHTML = '<p>Caricamento anteprima...</p>';

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                            throw new Error("Il file Excel non contiene fogli di lavoro.");
                        }

                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        if (jsonData.length === 0) {
                            throw new Error("Il file è vuoto o non contiene dati validi.");
                        }

                        // Validazione dei dati
                        const firstRow = jsonData[0];
                        if (!firstRow || Object.keys(firstRow).length === 0) {
                            throw new Error("Il file non contiene colonne valide.");
                        }

                        orariCustodeDataToSave = jsonData;
                        tableContainerOrariCustode.innerHTML = generateTableHTML(jsonData);
                        saveBtnContainerOrariCustode.classList.remove('hidden');

                        // Mostra messaggio di successo
                        messageBoxOrariCustode.className = 'message-box success';
                        messageBoxOrariCustode.textContent = `File caricato con successo! Trovate ${jsonData.length} righe di dati.`;
                        messageBoxOrariCustode.style.display = 'block';
                        setTimeout(() => { messageBoxOrariCustode.style.display = 'none'; }, 3000);

                    } catch (err) {
                        console.error("Errore nel caricamento del file Excel:", err);
                        messageBoxOrariCustode.className = 'message-box error';
                        messageBoxOrariCustode.textContent = `Errore nel caricamento del file: ${err.message}`;
                        messageBoxOrariCustode.style.display = 'block';
                        tableContainerOrariCustode.innerHTML = '<p style="color:var(--secondary-text);">Nessun file selezionato.</p>';
                    }
                };

                reader.onerror = () => {
                    messageBoxOrariCustode.className = 'message-box error';
                    messageBoxOrariCustode.textContent = 'Errore nella lettura del file. Riprova.';
                    messageBoxOrariCustode.style.display = 'block';
                    tableContainerOrariCustode.innerHTML = '<p style="color:var(--secondary-text);">Nessun file selezionato.</p>';
                };

                reader.readAsArrayBuffer(file);
            });

            saveBtnOrariCustode.addEventListener('click', async () => {
                if (!orariCustodeDataToSave) {
                    messageBoxOrariCustode.className = 'message-box error';
                    messageBoxOrariCustode.textContent = 'Nessun dato da salvare. Carica prima un file.';
                    messageBoxOrariCustode.style.display = 'block';
                    return;
                }

                if (!confirm('Sei sicuro di voler sostituire tutti i dati degli orari esistenti? Questa azione è irreversibile.')) {
                    return;
                }

                const saveBtnText = document.getElementById('save-btn-text');
                const saveBtnLoading = document.getElementById('save-btn-loading');

                saveBtnOrariCustode.disabled = true;
                saveBtnText.classList.add('hidden');
                saveBtnLoading.classList.remove('hidden');

                try {
                    // Prima elimina tutti i documenti esistenti
                    const existingDocs = await getDocs(collection(db, "importedCustodeSchedule"));
                    const deletePromises = existingDocs.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deletePromises);

                    // Poi aggiungi il nuovo documento
                    await addDoc(collection(db, "importedCustodeSchedule"), {
                        fileName: orariCustodeFileName,
                        tableData: orariCustodeDataToSave,
                        uploadedBy: currentUser.uid,
                        uploadedAt: serverTimestamp()
                    });

                    await logActivity("custode_schedule_imported", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, {
                        fileName: orariCustodeFileName,
                        rowsImported: orariCustodeDataToSave.length
                    });

                    // Salva il numero di righe prima del reset
                    const rowsImported = orariCustodeDataToSave.length;

                    // Reset del form
                    fileInputOrariCustode.value = '';
                    saveBtnContainerOrariCustode.classList.add('hidden');
                    tableContainerOrariCustode.innerHTML = '<p style="color:var(--secondary-text);">Nessun file selezionato.</p>';
                    orariCustodeFileName = '';
                    orariCustodeDataToSave = null;

                    // Messaggio di successo
                    messageBoxOrariCustode.className = 'message-box success';
                    messageBoxOrariCustode.textContent = `Orari importati con successo! ${rowsImported} righe salvate.`;
                    messageBoxOrariCustode.style.display = 'block';
                    setTimeout(() => { messageBoxOrariCustode.style.display = 'none'; }, 5000);

                } catch (error) {
                    console.error("Errore durante il salvataggio degli orari:", error);
                    messageBoxOrariCustode.className = 'message-box error';
                    messageBoxOrariCustode.textContent = `Errore durante il salvataggio: ${error.message}`;
                    messageBoxOrariCustode.style.display = 'block';
                } finally {
                    saveBtnOrariCustode.disabled = false;
                    saveBtnText.classList.remove('hidden');
                    saveBtnLoading.classList.add('hidden');
                }
            });
        };

        const setupUserManagementHandlers = () => {
            const form = document.getElementById('create-partial-condo-form');
            form?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('partial-condo-name');
                const startPlanInput = document.getElementById('partial-condo-start-plan');
                const endPlanInput = document.getElementById('partial-condo-end-plan');
                
                const name = nameInput.value.trim();
                const startPlan = parseInt(startPlanInput.value, 10);
                const endPlan = parseInt(endPlanInput.value, 10);

                if (!name || isNaN(startPlan) || isNaN(endPlan)) {
                    alert('Tutti i campi sono obbligatori.');
                    return;
                }
                if (startPlan > endPlan) {
                    alert('Il piano iniziale non può essere maggiore del piano finale.');
                    return;
                }

                try {
                    await addDoc(collection(db, 'partialCondos'), {
                        name: name,
                        startPlan: startPlan,
                        endPlan: endPlan,
                        createdBy: currentUser.uid,
                        createdAt: serverTimestamp()
                    });
                    await logActivity("partial_condo_created", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { name: name, planRange: `${startPlan}-${endPlan}` });
                    form.reset();
                } catch (error) {
                    console.error("Errore nella creazione del condominio parziale:", error);
                    alert("Si è verificato un errore.");
                }
            });
        };

        const setupAdminUserCreationHandler = () => {
            let groupedProperties = {};

            const findHeader = (headers, keywords) => headers.find(h => keywords.some(k => h.toLowerCase().includes(k)));

            const loadPrerequisitesForCreation = async () => {
                try {
                    const qGroups = query(collection(db, "partialCondos"), orderBy("name"));
                    const qData = query(collection(db, "importedData"), orderBy("uploadedAt", "desc"), limit(1));

                    const [groupsSnapshot, dataSnapshot] = await Promise.all([getDocs(qGroups), getDocs(qData)]);

                    availableGroups = groupsSnapshot.docs.map(doc => doc.data());

                    if (!dataSnapshot.empty) {
                        const tableData = dataSnapshot.docs[0].data().tableData || [];
                        const headers = tableData.length > 0 ? Object.keys(tableData[0]) : [];
                        const nominativoHeader = findHeader(headers, ['nominativo']);
                        const idHeader = findHeader(headers, ['interno', 'appartamento', 'unita']);
                        const millesimiHeader = findHeader(headers, ['millesimi', 'quota']);
                        const groupHeader = findHeader(headers, ['raggruppamento', 'gruppo']);

                        if (nominativoHeader && idHeader && millesimiHeader) {
                            groupedProperties = {};
                            tableData.forEach(item => {
                                const nominativo = item[nominativoHeader];
                                if (!nominativo) return;
                                if (!groupedProperties[nominativo]) groupedProperties[nominativo] = [];
                                groupedProperties[nominativo].push({
                                    interno: item[idHeader],
                                    millesimi: item[millesimiHeader],
                                    gruppo: item[groupHeader] || ''
                                });
                            });
                        }
                    }
                } catch (error) {
                    console.error("Impossibile caricare i dati per la pagina di creazione:", error);
                }
            };
            loadPrerequisitesForCreation();

            const form = document.getElementById('admin-create-user-form');
            const searchInput = document.getElementById('admin-nominativo-search');
            const optionsContainer = document.getElementById('admin-nominativo-options');
            const propertiesContainer = document.getElementById('properties-editor-container');
            const addPropertyBtn = document.getElementById('admin-add-property-btn');
            const clearSearchBtn = document.getElementById('admin-clear-nominativo-search');
            const nomeInput = document.getElementById('admin-nome');
            const cognomeInput = document.getElementById('admin-cognome');

            const renderDropdownOptions = (filter = '') => {
                const lowerFilter = filter.toLowerCase();
                const filteredNames = Object.keys(groupedProperties).filter(name => name.toLowerCase().includes(lowerFilter)).sort();
                optionsContainer.innerHTML = filteredNames.length > 0
                    ? filteredNames.map(name => `<div class="custom-dropdown-item" data-value="${name}">${name}</div>`).join('')
                    : `<div class="custom-dropdown-item" style="cursor:default;">Nessun risultato</div>`;
                optionsContainer.classList.remove('hidden');
            };

            const selectNominativo = (name) => {
                searchInput.value = name;
                optionsContainer.classList.add('hidden');
                clearSearchBtn.classList.remove('hidden');
                addPropertyBtn.classList.add('hidden');

                // Auto-compila e blocca nome e cognome/azienda secondo la nuova regola
                cognomeInput.value = name;   // Il "Nominativo" della tabella va nel cognome/azienda
                nomeInput.value = '-';       // Il nome è fisso a "-"
                cognomeInput.readOnly = true;
                nomeInput.readOnly = true;

                // Auto-compila e blocca le proprietà (gestisce anche le multiproprietà)
                const properties = groupedProperties[name] || [];
                propertiesContainer.innerHTML = properties.map(prop => `
                    <div class="property-edit-row grid grid-cols-4 gap-2 items-center" style="margin-bottom: 0.5rem;">
                        <input type="text" data-field="interno" value="${prop.interno || ''}" class="form-input" readonly>
                        <input type="number" step="0.01" data-field="millesimi" value="${prop.millesimi || 0}" class="form-input" readonly>
                        <input type="text" data-field="gruppo" value="${prop.gruppo || ''}" class="form-input" readonly>
                        <div/>
                    </div>
                `).join('');
            };

            const clearSelection = () => {
                searchInput.value = '';
                clearSearchBtn.classList.add('hidden');
                addPropertyBtn.classList.remove('hidden');

                // Svuota e sblocca nome e cognome
                cognomeInput.value = '';
                nomeInput.value = '';
                cognomeInput.readOnly = false;
                nomeInput.readOnly = false;

                propertiesContainer.innerHTML = `<p class="form-label" style="color:var(--secondary-text); font-size:0.9rem;">Cerca un nominativo per caricare i dati o aggiungi le proprietà manualmente.</p>`;
            };

            searchInput?.addEventListener('input', () => renderDropdownOptions(searchInput.value));
            searchInput?.addEventListener('focus', () => renderDropdownOptions(searchInput.value));
            clearSearchBtn?.addEventListener('click', clearSelection);
            optionsContainer?.addEventListener('click', (e) => {
                if (e.target.dataset.value) selectNominativo(e.target.dataset.value);
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.custom-dropdown-container')) optionsContainer?.classList.add('hidden');
            });

            form?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const messageBox = document.getElementById('admin-create-user-message');
                messageBox.style.display = 'none';

                try {
                    const propertiesForUser = [];
                    let totalMillesimi = 0;
                    const propertyRows = form.querySelectorAll('.property-edit-row');

                    propertyRows.forEach(row => {
                        const internoInput = row.querySelector('input[data-field="interno"]');
                        const millesimiInput = row.querySelector('input[data-field="millesimi"]');
                        const gruppoSelect = row.querySelector('select[data-field="gruppo"]');
                        const gruppoInput = row.querySelector('input[data-field="gruppo"]');

                        const interno = internoInput.value.trim();
                        const millesimi = parseFloat(millesimiInput.value) || 0;
                        const gruppo = gruppoSelect ? gruppoSelect.value : (gruppoInput ? gruppoInput.value.trim() : '');

                        if (interno) {
                            propertiesForUser.push({ interno, millesimi, gruppo });
                            totalMillesimi += millesimi;
                        }
                    });

                    const profileData = {
                        nome: nomeInput.value,
                        cognome: cognomeInput.value,
                        tipoUtente: document.getElementById('admin-tipo-utente').value,
                        telefono: document.getElementById('admin-telefono').value,
                        proprieta: propertiesForUser,
                        millesimiTotali: totalMillesimi
                    };

                    if (!profileData.nome || !profileData.cognome || !profileData.tipoUtente) {
                        throw new Error('Nome, Cognome e Tipo Utente sono obbligatori.');
                    }

                    await adminCreateUser(document.getElementById('admin-email').value, document.getElementById('admin-password').value, profileData);

                    messageBox.className = 'message-box success';
                    messageBox.textContent = `Utente ${profileData.cognome} creato con successo!`;
                    messageBox.style.display = 'block';
                    form.reset();
                    clearSelection();

                } catch (error) {
                    messageBox.className = 'message-box error';
                    messageBox.textContent = `Errore: ${error.message}`;
                    messageBox.style.display = 'block';
                }
            });
        };

        const loadPartialCondos = () => {
            const listEl = document.getElementById('partial-condos-list');
            if (!listEl) return;
            const q = query(collection(db, "partialCondos"), orderBy("name"));
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    listEl.innerHTML = `<p style="color:var(--secondary-text); padding: 1rem 0;">Nessun gruppo creato.</p>`;
                    return;
                }
                listEl.innerHTML = snapshot.docs.map(docSnap => {
                    const condo = docSnap.data();
                    return `
                    <div class="list-item">
                        <div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M16 14h-2v2h2v-2m4-4h-2v2h2V10m0-4h-2v2h2V6M12 2L2 7v13h20V7L12 2z"/></svg></div>
                        <div class="list-item-content">
                            <div class="title">${condo.name}</div>
                            <div class="subtitle">Piani: ${condo.startPlan ?? 'N/D'} a ${condo.endPlan ?? 'N/D'}</div>
                        </div>
                        <div class="list-item-action flex gap-2">
                            <button onclick="openGroupEditModal('${docSnap.id}', ${JSON.stringify(condo).replace(/"/g, '&quot;')})" class="btn-icon" title="Modifica Gruppo">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                            </button>
                            <button onclick="deletePartialCondo('${docSnap.id}')" class="btn" style="background:var(--danger); color:white; padding: 0.4rem 0.8rem; font-size:0.8rem;">Elimina</button>
                        </div>
                    </div>
                    `;
                }).join('');
            });
        };

        const openGroupEditModal = (groupId, currentData) => {
            const modalContent = `
                <form id="edit-group-form" class="space-y-4" onsubmit="updatePartialCondo(event, '${groupId}')">
                    <div class="form-group">
                        <label for="edit-group-name" class="form-label">Nome Gruppo</label>
                        <input type="text" id="edit-group-name" required class="form-input" value="${currentData.name || ''}">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="edit-group-start-plan" class="form-label">Piano Iniziale</label>
                            <input type="number" id="edit-group-start-plan" required class="form-input" value="${currentData.startPlan ?? ''}">
                        </div>
                        <div class="form-group">
                            <label for="edit-group-end-plan" class="form-label">Piano Finale</label>
                            <input type="number" id="edit-group-end-plan" required class="form-input" value="${currentData.endPlan ?? ''}">
                        </div>
                    </div>
                    <div class="flex justify-end gap-4 pt-2">
                        <button type="button" class="btn btn-secondary" onclick="hideModal()">Annulla</button>
                        <button type="submit" class="btn btn-primary">Salva Modifiche</button>
                    </div>
                </form>
            `;
            showModal('Modifica Gruppo', modalContent);
        };

        const updatePartialCondo = async (event, groupId) => {
            event.preventDefault();
            const name = document.getElementById('edit-group-name').value.trim();
            const startPlan = parseInt(document.getElementById('edit-group-start-plan').value, 10);
            const endPlan = parseInt(document.getElementById('edit-group-end-plan').value, 10);

            if (!name || isNaN(startPlan) || isNaN(endPlan)) {
                alert('Tutti i campi sono obbligatori.');
                return;
            }
            if (startPlan > endPlan) {
                alert('Il piano iniziale non può essere maggiore del piano finale.');
                return;
            }

            try {
                const groupRef = doc(db, 'partialCondos', groupId);
                await updateDoc(groupRef, {
                    name: name,
                    startPlan: startPlan,
                    endPlan: endPlan
                });
                await logActivity("partial_condo_updated", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { groupId: groupId, name: name });
                hideModal();
            } catch (error) {
                console.error("Errore nell'aggiornamento del gruppo:", error);
                alert("Si è verificato un errore durante l'aggiornamento.");
            }
        };

        const deletePartialCondo = async (id) => {
            if (!confirm('Sei sicuro di voler eliminare questo gruppo? L\'azione è irreversibile.')) {
                return;
            }
            try {
                await deleteDoc(doc(db, 'partialCondos', id));
                await logActivity("partial_condo_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { deletedId: id });
            } catch (error) {
                console.error("Errore durante l'eliminazione:", error);
                alert("Si è verificato un errore durante l'eliminazione.");
            }
        };

        const toggleGroupListVisibility = () => {
            const list = document.getElementById('partial-condos-list');
            const chevron = document.getElementById('group-list-chevron');
            if (!list || !chevron) return;
            const isHiding = list.style.display === 'none';
            if (isHiding) {
                list.style.display = 'block';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                list.style.display = 'none';
                chevron.style.transform = 'rotate(-90deg)';
            }
        };

        let groupRulesUnsubscribe = null;
        let partialCondosForRules = [];
        let excelHeadersForRules = [];

        const openRuleEditor = (rule = null) => {
            const card = document.getElementById('rule-editor-card');
            const form = document.getElementById('rule-editor-form');
            const title = document.getElementById('rule-editor-title');
            const classificationSelect = document.getElementById('rule-classification');
            const columnSelect = document.getElementById('rule-target-column');
            classificationSelect.innerHTML = '<option value="">Seleziona un gruppo...</option>' +
                partialCondosForRules.map(condo => `<option value="${condo.name}">${condo.name}</option>`).join('') +
                '<option value="__CREATE_NEW__" style="font-weight:bold; color:var(--accent-color);">++ Crea nuovo gruppo... ++</option>';
            columnSelect.innerHTML = '<option value="">Seleziona colonna...</option>' +
                excelHeadersForRules.map(header => `<option value="${header}">${header}</option>`).join('');
            if (rule) {
                title.textContent = 'Modifica Regola';
                form.querySelector('#rule-id').value = rule.id;
                form.querySelector('#rule-name').value = rule.name;
                form.querySelector('#rule-type').value = rule.type;
                classificationSelect.value = rule.params.classification;
                if (rule.type === 'row_range_classification') {
                    form.querySelector('#rule-start-row').value = rule.params.startRow;
                    form.querySelector('#rule-end-row').value = rule.params.endRow;
                } else if (rule.type === 'text_contains_classification') {
                    columnSelect.value = rule.params.targetColumn;
                    form.querySelector('#rule-search-text').value = rule.params.searchText;
                }
            } else {
                title.textContent = 'Crea Nuova Regola';
                form.reset();
                form.querySelector('#rule-id').value = '';
            }
            const event = new Event('change');
            form.querySelector('#rule-type').dispatchEvent(event);
            classificationSelect.dispatchEvent(event);
            card.classList.remove('hidden');
        };

        const closeRuleEditor = () => {
            const card = document.getElementById('rule-editor-card');
            card.classList.add('hidden');
            document.getElementById('rule-editor-form').reset();
        };

        const saveGroupRule = async (event) => {
            event.preventDefault();
            const form = event.target;
            const ruleId = form.querySelector('#rule-id').value;
            const ruleName = form.querySelector('#rule-name').value.trim();
            const ruleType = form.querySelector('#rule-type').value;
            let classification = form.querySelector('#rule-classification').value;
            if (!ruleName) { alert('Il nome della regola è obbligatorio.'); return; }
            if (classification === '__CREATE_NEW__') {
                const newGroupNameInput = form.querySelector('#rule-new-group-name');
                const newGroupName = newGroupNameInput.value.trim();
                if (!newGroupName) {
                    alert('Inserisci un nome per il nuovo gruppo.');
                    newGroupNameInput.focus();
                    return;
                }
                try {
                    await addDoc(collection(db, 'partialCondos'), { name: newGroupName, createdBy: currentUser.uid, createdAt: serverTimestamp() });
                    classification = newGroupName;
                } catch (error) {
                    console.error("Errore nella creazione del gruppo:", error);
                    alert("Si è verificato un errore nella creazione del nuovo gruppo.");
                    return;
                }
            }
            if (!classification) { alert('Seleziona un gruppo a cui assegnare la classificazione.'); return; }
            const ruleData = { name: ruleName, type: ruleType, params: {}, isActive: true, updatedAt: serverTimestamp() };
            if (ruleType === 'row_range_classification') {
                const startRow = parseInt(form.querySelector('#rule-start-row').value, 10);
                const endRow = parseInt(form.querySelector('#rule-end-row').value, 10);
                if (!startRow || !endRow) { alert('Specifica un intervallo di righe valido.'); return; }
                if (startRow > endRow) { alert('La riga di inizio non può essere maggiore della riga di fine.'); return; }
                ruleData.params = { startRow, endRow, classification };
            } else if (ruleType === 'text_contains_classification') {
                const targetColumn = form.querySelector('#rule-target-column').value;
                const searchText = form.querySelector('#rule-search-text').value.trim();
                if (!targetColumn || !searchText) { alert('Specifica una colonna e un testo da cercare.'); return; }
                ruleData.params = { targetColumn, searchText, classification };
            }
            try {
                if (ruleId) {
                    await updateDoc(doc(db, 'groupRules', ruleId), ruleData);
                    await logActivity("group_rule_updated", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { ruleName: ruleName });
                } else {
                    ruleData.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'groupRules'), ruleData);
                    await logActivity("group_rule_created", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { ruleName: ruleName });
                }
                closeRuleEditor();
            } catch (error) {
                console.error('Errore nel salvataggio della regola:', error);
                alert('Si è verificato un errore durante il salvataggio.');
            }
        };

        const deleteGroupRule = async (ruleId) => {
            if (!confirm('Sei sicuro di voler eliminare questa regola?')) return;
            try {
                await deleteDoc(doc(db, 'groupRules', ruleId));
                await logActivity("group_rule_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { ruleId: ruleId });
            } catch (error) {
                console.error('Errore eliminazione regola:', error);
                alert('Errore durante l\'eliminazione.');
            }
        };

        const toggleRuleStatus = async (ruleId, currentStatus) => {
            try {
                await updateDoc(doc(db, 'groupRules', ruleId), { isActive: !currentStatus });
            } catch (error) {
                console.error('Errore aggiornamento stato regola:', error);
            }
        };

        const loadGroupRules = () => {
            const listEl = document.getElementById('group-rules-list');
            if (!listEl) return;
            const condosQuery = query(collection(db, "partialCondos"), orderBy("name"));
            const headersQuery = query(collection(db, "importedData"), orderBy("uploadedAt", "desc"), limit(1));
            Promise.all([getDocs(condosQuery), getDocs(headersQuery)]).then(([condosSnapshot, headersSnapshot]) => {
                partialCondosForRules = condosSnapshot.docs.map(d => d.data());
                if (!headersSnapshot.empty) {
                    const data = headersSnapshot.docs[0].data().tableData;
                    if (data && data.length > 0) {
                        excelHeadersForRules = Object.keys(data[0]);
                    }
                }
            });
            const rulesQuery = query(collection(db, 'groupRules'), orderBy('createdAt', 'desc'));
            if (groupRulesUnsubscribe) groupRulesUnsubscribe();
            groupRulesUnsubscribe = onSnapshot(rulesQuery, (snapshot) => {
                if (snapshot.empty) {
                    listEl.innerHTML = `<div class="card"><p style="color:var(--secondary-text);">Nessuna regola di classificazione definita.</p></div>`;
                    return;
                }
                listEl.innerHTML = snapshot.docs.map(docSnap => {
                    const rule = { id: docSnap.id, ...docSnap.data() };
                    const params = rule.params;
                    let description = 'Regola non configurata.';
                    if (rule.type === 'row_range_classification') {
                        description = `Se righe da <strong>${params.startRow}</strong> a <strong>${params.endRow}</strong>, assegna a gruppo <strong>${params.classification}</strong>.`;
                    } else if (rule.type === 'text_contains_classification') {
                        description = `Se colonna <strong>${params.targetColumn}</strong> contiene "<strong>${params.searchText}</strong>", assegna a gruppo <strong>${params.classification}</strong>.`;
                    }
                    return `
                    <div class="list-item" style="background-color: var(--surface-color); align-items: flex-start;">
                        <div class="list-item-content" style="padding-top: 0.5rem;">
                            <div class="title" style="font-weight: 600;">${rule.name}</div>
                            <div class="subtitle" style="margin-top: 0.5rem;">${description}</div>
                        </div>
                        <div class="flex flex-col items-end gap-2" style="padding-top: 0.5rem;">
                             <label class="flex items-center gap-2 cursor-pointer" style="font-size: 0.9rem;">
                                <span>${rule.isActive ? 'Attiva' : 'Disattiva'}</span>
                                <div style="position: relative; width: 40px; height: 22px;">
                                    <input type="checkbox" onchange="toggleRuleStatus('${rule.id}', ${rule.isActive})" ${rule.isActive ? 'checked' : ''} class="hidden">
                                    <div style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${rule.isActive ? 'var(--accent-color)' : 'var(--surface-color-light)'}; transition: .4s; border-radius: 34px;"></div>
                                    <div style="position: absolute; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; transform: ${rule.isActive ? 'translateX(18px)' : 'translateX(0)'};"></div>
                                </div>
                            </label>
                            <div class="flex gap-2 mt-2">
                                <button onclick='openRuleEditor(${JSON.stringify(rule).replace(/'/g, "'")})' class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size:0.8rem;">Modifica</button>
                                <button onclick="deleteGroupRule('${rule.id}')" class="btn" style="background:var(--danger); color:white; padding: 0.4rem 0.8rem; font-size:0.8rem;">Elimina</button>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
            });
        };

        const setupGestioneGruppiHandlers = () => {
            const addNewRuleBtn = document.getElementById('add-new-rule-btn');
            const cancelRuleBtn = document.getElementById('cancel-rule-edit-btn');
            const ruleForm = document.getElementById('rule-editor-form');
            const ruleTypeSelect = document.getElementById('rule-type');
            const classificationSelect = document.getElementById('rule-classification');
            addNewRuleBtn?.addEventListener('click', () => openRuleEditor(null));
            cancelRuleBtn?.addEventListener('click', closeRuleEditor);
            ruleForm?.addEventListener('submit', saveGroupRule);
            ruleTypeSelect?.addEventListener('change', (e) => {
                const paramsRowRange = document.getElementById('params-row-range');
                const paramsTextContains = document.getElementById('params-text-contains');
                const isRowRange = e.target.value === 'row_range_classification';
                paramsRowRange.classList.toggle('hidden', !isRowRange);
                paramsTextContains.classList.toggle('hidden', isRowRange);
                paramsRowRange.querySelectorAll('input').forEach(i => i.required = isRowRange);
                paramsTextContains.querySelectorAll('input, select').forEach(i => i.required = !isRowRange);
            });
            classificationSelect?.addEventListener('change', (e) => {
                const newGroupContainer = document.getElementById('new-group-container');
                const isCreateNew = e.target.value === '__CREATE_NEW__';
                newGroupContainer.classList.toggle('hidden', !isCreateNew);
                newGroupContainer.querySelector('input').required = isCreateNew;
            });
        };

        const deleteUsefulNumber = async (id) => {
            // Controllo accesso: solo supervisore può eliminare contatti
            if (userProfile?.tipoUtente !== 'supervisore') {
                alert('Non hai i permessi per eliminare contatti. Solo i supervisori possono eseguire questa operazione.');
                return;
            }

            if (!confirm('Sei sicuro di voler eliminare questo numero?')) {
                return;
            }
            try {
                await deleteDoc(doc(db, 'usefulNumbers', id));
                await logActivity("useful_number_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { deletedId: id });
            } catch (error) {
                console.error("Errore durante l'eliminazione del numero:", error);
                alert("Si è verificato un errore durante l'eliminazione.");
            }
        };

        const editUsefulNumber = async (id, currentData) => {
            // Controllo accesso: solo supervisore può modificare contatti
            if (userProfile?.tipoUtente !== 'supervisore') {
                alert('Non hai i permessi per modificare contatti. Solo i supervisori possono eseguire questa operazione.');
                return;
            }

            const modalContent = `
                <form id="edit-useful-number-form" class="space-y-4">
                    <div><label class="form-label">INTERVENTO RICHIESTO</label><input type="text" id="edit-title" value="${(currentData.title || '').replace(/"/g, '&quot;')}" required class="form-input"></div>
                    <div><label class="form-label">IMPRESA (Opzionale)</label><input type="text" id="edit-company" value="${(currentData.company || '').replace(/"/g, '&quot;')}" class="form-input"></div>
                    <div><label class="form-label">1 NUM. TELEFONICO</label><input type="text" id="edit-number" value="${(currentData.number || '').replace(/"/g, '&quot;')}" required class="form-input"></div>
                    <div><label class="form-label">2 NUM. TELEFONICO (Opzionale)</label><input type="text" id="edit-number-2" value="${(currentData.number2 || '').replace(/"/g, '&quot;')}" class="form-input"></div>
                    <div class="flex justify-end gap-4 pt-2">
                        <button type="button" class="btn btn-secondary" onclick="hideModal()">Annulla</button>
                        <button type="submit" class="btn btn-primary">Salva</button>
                    </div>
                </form>
            `;

            showModal('Modifica Contatto', modalContent);

            const form = document.getElementById('edit-useful-number-form');
            if (form) {
                form.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const title = document.getElementById('edit-title').value.trim();
                    const company = document.getElementById('edit-company').value.trim();
                    const number = document.getElementById('edit-number').value.trim();
                    const number2 = document.getElementById('edit-number-2').value.trim();

                    if (!title || !number) {
                        alert('I campi "INTERVENTO RICHIESTO" e "1 NUM. TELEFONICO" sono obbligatori.');
                        return;
                    }

                    try {
                        await updateDoc(doc(db, 'usefulNumbers', id), {
                            title, company, number, number2, updatedAt: serverTimestamp()
                        });
                        await logActivity("useful_number_updated", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { updatedId: id, title });
                        hideModal();
                    } catch (error) {
                        console.error("Errore durante l'aggiornamento del numero:", error);
                        alert("Si è verificato un errore durante l'aggiornamento.");
                    }
                });
            }
        };

        const deleteMultipleUsefulNumbers = async (ids) => {
            // Controllo accesso: solo supervisore può eliminare contatti
            if (userProfile?.tipoUtente !== 'supervisore') {
                alert('Non hai i permessi per eliminare contatti. Solo i supervisori possono eseguire questa operazione.');
                return;
            }

            if (!confirm(`Sei sicuro di voler eliminare ${ids.length} contatti?`)) {
                return;
            }

            try {
                const deletePromises = ids.map(id => deleteDoc(doc(db, 'usefulNumbers', id)));
                await Promise.all(deletePromises);
                await logActivity("useful_numbers_bulk_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { deletedCount: ids.length });
                alert(`${ids.length} contatti eliminati con successo.`);
            } catch (error) {
                console.error("Errore durante l'eliminazione multipla:", error);
                alert("Si è verificato un errore durante l'eliminazione multipla.");
            }
        };

        // Funzioni helper per le operazioni bulk
        const toggleAllContacts = (checkbox) => {
            const contactCheckboxes = document.querySelectorAll('.contact-checkbox');
            contactCheckboxes.forEach(cb => cb.checked = checkbox.checked);
            updateBulkActions();
        };

        const updateBulkActions = () => {
            const bulkActions = document.getElementById('bulk-actions');
            const selectedCheckboxes = document.querySelectorAll('.contact-checkbox:checked');
            const selectAllCheckbox = document.getElementById('select-all-contacts');

            if (bulkActions) {
                bulkActions.style.display = selectedCheckboxes.length > 0 ? 'flex' : 'none';
            }

            if (selectAllCheckbox) {
                selectAllCheckbox.checked = selectedCheckboxes.length > 0 && selectedCheckboxes.length === document.querySelectorAll('.contact-checkbox').length;
                selectAllCheckbox.indeterminate = selectedCheckboxes.length > 0 && selectedCheckboxes.length < document.querySelectorAll('.contact-checkbox').length;
            }
        };

        const deleteSelectedContacts = () => {
            const selectedCheckboxes = document.querySelectorAll('.contact-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);

            if (selectedIds.length === 0) {
                alert('Nessun contatto selezionato.');
                return;
            }

            deleteMultipleUsefulNumbers(selectedIds);
        };

        // Funzioni helper per la rubrica
        const toggleAllContactsRubrica = (checkbox) => {
            const contactCheckboxes = document.querySelectorAll('.contact-checkbox-rubrica');
            contactCheckboxes.forEach(cb => cb.checked = checkbox.checked);
            updateBulkActionsRubrica();
        };

        const updateBulkActionsRubrica = () => {
            const bulkActions = document.getElementById('bulk-actions-rubrica');
            const selectedCheckboxes = document.querySelectorAll('.contact-checkbox-rubrica:checked');
            const selectAllCheckbox = document.getElementById('select-all-contacts-rubrica');

            if (bulkActions) {
                bulkActions.style.display = selectedCheckboxes.length > 0 ? 'flex' : 'none';
            }

            if (selectAllCheckbox) {
                selectAllCheckbox.checked = selectedCheckboxes.length > 0 && selectedCheckboxes.length === document.querySelectorAll('.contact-checkbox-rubrica').length;
                selectAllCheckbox.indeterminate = selectedCheckboxes.length > 0 && selectedCheckboxes.length < document.querySelectorAll('.contact-checkbox-rubrica').length;
            }
        };

        const deleteSelectedContactsRubrica = () => {
            const selectedCheckboxes = document.querySelectorAll('.contact-checkbox-rubrica:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);

            if (selectedIds.length === 0) {
                alert('Nessun contatto selezionato.');
                return;
            }

            deleteMultipleUsefulNumbers(selectedIds);
        };

        // Funzioni helper per i contatti importati
        const toggleAllContactsImported = (checkbox) => {
            const contactCheckboxes = document.querySelectorAll('.contact-checkbox-imported');
            contactCheckboxes.forEach(cb => cb.checked = checkbox.checked);
            updateBulkActionsImported();
        };

        const updateBulkActionsImported = () => {
            const bulkActions = document.getElementById('bulk-actions-imported');
            const selectedCheckboxes = document.querySelectorAll('.contact-checkbox-imported:checked');
            const selectAllCheckbox = document.getElementById('select-all-contacts-imported');

            if (bulkActions) {
                bulkActions.style.display = selectedCheckboxes.length > 0 ? 'flex' : 'none';
            }

            if (selectAllCheckbox) {
                selectAllCheckbox.checked = selectedCheckboxes.length > 0 && selectedCheckboxes.length === document.querySelectorAll('.contact-checkbox-imported').length;
                selectAllCheckbox.indeterminate = selectedCheckboxes.length > 0 && selectedCheckboxes.length < document.querySelectorAll('.contact-checkbox-imported').length;
            }
        };

        const deleteSelectedContactsImported = () => {
            const selectedCheckboxes = document.querySelectorAll('.contact-checkbox-imported:checked');
            const selectedIndices = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));

            if (selectedIndices.length === 0) {
                alert('Nessun contatto selezionato.');
                return;
            }

            deleteMultipleImportedContacts(selectedIndices);
        };

        const editImportedContact = async (index, currentData) => {
            // Controllo accesso: solo supervisore può modificare contatti
            if (userProfile?.tipoUtente !== 'supervisore') {
                alert('Non hai i permessi per modificare contatti. Solo i supervisori possono eseguire questa operazione.');
                return;
            }

            // Per i contatti importati, creiamo un form dinamico basato sui campi disponibili
            const formFields = Object.keys(currentData).map(key => {
                const value = String(currentData[key] || '');
                const label = key;
                // Using data-key to associate input with its original key, escaping quotes for safety
                return `<div><label class="form-label">${label}</label><input type="text" data-key="${key.replace(/"/g, '&quot;')}" value="${value.replace(/"/g, '&quot;')}" class="form-input"></div>`;
            }).join('');

            const editFormHtml = `
                <form id="edit-imported-contact-form" class="space-y-4">
                    ${formFields}
                    <div class="flex justify-end gap-4 pt-2">
                        <button type="button" class="btn btn-secondary" onclick="hideModal()">Annulla</button>
                        <button type="submit" class="btn btn-primary">Salva</button>
                    </div>
                </form>
            `;

            showModal('Modifica Contatto Importato', editFormHtml);

            // Add event listener to the form after it has been added to the DOM
            const form = document.getElementById('edit-imported-contact-form');
            if (form) {
                form.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    try {
                        const qImported = query(collection(db, "importedPhoneNumbers"), orderBy("uploadedAt", "desc"), limit(1));
                        const snapshot = await getDocs(qImported);

                        if (snapshot.empty) {
                            alert("Impossibile trovare i dati importati.");
                            return;
                        }

                        const docRef = snapshot.docs[0].ref;
                        const docData = snapshot.docs[0].data();
                        const allImportedData = [...docData.tableData];

                        const updatedRow = { ...allImportedData[index] };

                        form.querySelectorAll('input[data-key]').forEach(input => {
                            const key = input.dataset.key;
                            updatedRow[key] = input.value.trim();
                        });

                        allImportedData[index] = updatedRow;

                        await updateDoc(docRef, { tableData: allImportedData });
                        await logActivity("imported_contact_updated", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { updatedIndex: index });

                        hideModal();
                    } catch (error) {
                        console.error("Errore durante l'aggiornamento del contatto importato:", error);
                        alert("Si è verificato un errore durante l'aggiornamento.");
                    }
                });
            }
        };

        const deleteImportedContact = async (index) => {
            // Controllo accesso: solo supervisore può eliminare contatti
            if (userProfile?.tipoUtente !== 'supervisore') {
                alert('Non hai i permessi per eliminare contatti. Solo i supervisori possono eseguire questa operazione.');
                return;
            }

            if (!confirm('Sei sicuro di voler eliminare questo contatto importato?')) {
                return;
            }

            try {
                const qImported = query(collection(db, "importedPhoneNumbers"), orderBy("uploadedAt", "desc"), limit(1));
                const snapshot = await getDocs(qImported);

                if (snapshot.empty) {
                    alert("Impossibile trovare i dati importati.");
                    return;
                }

                const docRef = snapshot.docs[0].ref;
                const docData = snapshot.docs[0].data();
                const updatedData = docData.tableData.filter((_, i) => i !== index);

                await updateDoc(docRef, { tableData: updatedData });
                await logActivity("imported_contact_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { deletedIndex: index });

                alert("Contatto eliminato con successo.");
            } catch (error) {
                console.error("Errore durante l'eliminazione del contatto importato:", error);
                alert("Si è verificato un errore durante l'eliminazione.");
            }
        };

        const deleteMultipleImportedContacts = async (indices) => {
            // Controllo accesso: solo supervisore può eliminare contatti
            if (userProfile?.tipoUtente !== 'supervisore') {
                alert('Non hai i permessi per eliminare contatti. Solo i supervisori possono eseguire questa operazione.');
                return;
            }

            if (!confirm(`Sei sicuro di voler eliminare ${indices.length} contatti importati?`)) {
                return;
            }

            try {
                const qImported = query(collection(db, "importedPhoneNumbers"), orderBy("uploadedAt", "desc"), limit(1));
                const snapshot = await getDocs(qImported);

                if (snapshot.empty) {
                    alert("Impossibile trovare i dati importati.");
                    return;
                }

                const docRef = snapshot.docs[0].ref;
                const docData = snapshot.docs[0].data();
                const updatedData = docData.tableData.filter((_, i) => !indices.includes(i));

                await updateDoc(docRef, { tableData: updatedData });
                await logActivity("imported_contacts_bulk_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { deletedCount: indices.length });

                alert(`${indices.length} contatti eliminati con successo.`);
            } catch (error) {
                console.error("Errore durante l'eliminazione multipla dei contatti importati:", error);
                alert("Si è verificato un errore durante l'eliminazione multipla.");
            }
        };

        const editImportedScheduleEntry = async (index, currentData) => {
            if (userProfile?.tipoUtente !== 'supervisore') {
                alert('Non hai i permessi per modificare questa voce.');
                return;
            }

            const formFields = Object.keys(currentData).map(key => {
                const value = String(currentData[key] || '');
                const label = key;
                return `<div><label class="form-label">${label}</label><input type="text" data-key="${key.replace(/"/g, '&quot;')}" value="${value.replace(/"/g, '&quot;')}" class="form-input"></div>`;
            }).join('');

            const editFormHtml = `<form id="edit-schedule-form" class="space-y-4">${formFields}<div class="flex justify-end gap-4 pt-2"><button type="button" class="btn btn-secondary" onclick="hideModal()">Annulla</button><button type="submit" class="btn btn-primary">Salva</button></div></form>`;

            showModal('Modifica Voce Orario', editFormHtml);

            document.getElementById('edit-schedule-form')?.addEventListener('submit', async (event) => {
                event.preventDefault();
                try {
                    const qSchedule = query(collection(db, "importedCustodeSchedule"), orderBy("uploadedAt", "desc"), limit(1));
                    const snapshot = await getDocs(qSchedule);
                    if (snapshot.empty) throw new Error("Dati orario non trovati.");

                    const docRef = snapshot.docs[0].ref;
                    const allScheduleData = [...snapshot.docs[0].data().tableData];
                    const updatedRow = { ...allScheduleData[index] };

                    event.target.querySelectorAll('input[data-key]').forEach(input => {
                        updatedRow[input.dataset.key] = input.value.trim();
                    });

                    allScheduleData[index] = updatedRow;
                    await updateDoc(docRef, { tableData: allScheduleData });
                    await logActivity("custode_schedule_updated", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { updatedIndex: index });
                    hideModal();
                } catch (error) {
                    console.error("Errore aggiornamento orario:", error);
                    alert("Si è verificato un errore durante l'aggiornamento.");
                }
            });
        };

        const deleteImportedScheduleEntry = async (index) => {
            if (userProfile?.tipoUtente !== 'supervisore') {
                alert('Non hai i permessi per eliminare questa voce.');
                return;
            }
            if (!confirm('Sei sicuro di voler eliminare questa riga dagli orari?')) return;

            try {
                const qSchedule = query(collection(db, "importedCustodeSchedule"), orderBy("uploadedAt", "desc"), limit(1));
                const snapshot = await getDocs(qSchedule);
                if (snapshot.empty) throw new Error("Dati orario non trovati.");

                const docRef = snapshot.docs[0].ref;
                const updatedData = snapshot.docs[0].data().tableData.filter((_, i) => i !== index);

                await updateDoc(docRef, { tableData: updatedData });
                await logActivity("custode_schedule_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { deletedIndex: index });
            } catch (error) {
                console.error("Errore eliminazione orario:", error);
                alert("Si è verificato un errore durante l'eliminazione.");
            }
        };

        const editImportedAdminEntry = async (index, currentData) => {
            if (userProfile?.tipoUtente !== 'supervisore') return;
            const formFields = Object.keys(currentData).map(key => {
                const value = currentData[key] || '';
                return `<div><label class="form-label">${key}</label><input type="text" data-key="${key.replace(/"/g, '&quot;')}" value="${value.replace(/"/g, '&quot;')}" class="form-input"></div>`;
            }).join('');
            const editFormHtml = `<form id="edit-admin-data-form" class="space-y-4">${formFields}<div class="flex justify-end gap-4 pt-2"><button type="button" class="btn btn-secondary" onclick="hideModal()">Annulla</button><button type="submit" class="btn btn-primary">Salva</button></div></form>`;
            showModal('Modifica Voce Amministratore', editFormHtml);
            document.getElementById('edit-admin-data-form')?.addEventListener('submit', async (event) => {
                event.preventDefault();
                try {
                    const q = query(collection(db, "importedAdminData"), orderBy("uploadedAt", "desc"), limit(1));
                    const snapshot = await getDocs(q);
                    if (snapshot.empty) throw new Error("Dati amministratore non trovati.");
                    const docRef = snapshot.docs[0].ref;
                    const allData = [...snapshot.docs[0].data().tableData];
                    const updatedRow = { ...allData[index] };
                    event.target.querySelectorAll('input[data-key]').forEach(input => {
                        updatedRow[input.dataset.key] = input.value.trim();
                    });
                    allData[index] = updatedRow;
                    await updateDoc(docRef, { tableData: allData });
                    await logActivity("admin_data_updated", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { updatedIndex: index });
                    hideModal();
                } catch (error) {
                    alert("Si è verificato un errore durante l'aggiornamento.");
                }
            });
        };

        const deleteImportedAdminEntry = async (index) => {
            if (userProfile?.tipoUtente !== 'supervisore' || !confirm('Sei sicuro di voler eliminare questa voce?')) return;
            try {
                const q = query(collection(db, "importedAdminData"), orderBy("uploadedAt", "desc"), limit(1));
                const snapshot = await getDocs(q);
                if (snapshot.empty) throw new Error("Dati amministratore non trovati.");
                const docRef = snapshot.docs[0].ref;
                const updatedData = snapshot.docs[0].data().tableData.filter((_, i) => i !== index);
                await updateDoc(docRef, { tableData: updatedData });
                await logActivity("admin_data_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { deletedIndex: index });
            } catch (error) {
                alert("Si è verificato un errore durante l'eliminazione.");
            }
        };

        // Funzioni helper per i contatti importati nella rubrica
        const toggleAllContactsRubricaImported = (checkbox) => {
            const contactCheckboxes = document.querySelectorAll('.contact-checkbox-rubrica-imported');
            contactCheckboxes.forEach(cb => cb.checked = checkbox.checked);
            updateBulkActionsRubricaImported();
        };

        const updateBulkActionsRubricaImported = () => {
            const bulkActions = document.getElementById('bulk-actions-rubrica-imported');
            const selectedCheckboxes = document.querySelectorAll('.contact-checkbox-rubrica-imported:checked');
            const selectAllCheckbox = document.getElementById('select-all-contacts-rubrica-imported');

            if (bulkActions) {
                bulkActions.style.display = selectedCheckboxes.length > 0 ? 'flex' : 'none';
            }

            if (selectAllCheckbox) {
                selectAllCheckbox.checked = selectedCheckboxes.length > 0 && selectedCheckboxes.length === document.querySelectorAll('.contact-checkbox-rubrica-imported').length;
                selectAllCheckbox.indeterminate = selectedCheckboxes.length > 0 && selectedCheckboxes.length < document.querySelectorAll('.contact-checkbox-rubrica-imported').length;
            }
        };

        const deleteSelectedContactsRubricaImported = () => {
            const selectedCheckboxes = document.querySelectorAll('.contact-checkbox-rubrica-imported:checked');
            const selectedIndices = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));

            if (selectedIndices.length === 0) {
                alert('Nessun contatto selezionato.');
                return;
            }

            deleteMultipleImportedContacts(selectedIndices);
        };

        const renderNumeriUtiliRubrica = () => {
            const isSupervisore = userProfile?.tipoUtente === 'supervisore';
            const descriptionText = isSupervisore
                ? 'Visualizzazione unificata di tutti i contatti, sia quelli importati automaticamente che quelli inseriti manualmente.'
                : 'Contatti fornitori condominiali - SOLO IN CASO DI EMERGENZA';

            return `
            ${renderHeader('Rubrica Completa')}
            <main>
                <div class="card">
                    <p class="form-label" style="color: var(--secondary-text); margin-bottom: 2rem;">
                        ${descriptionText}
                    </p>

                    <h3 class="section-title" style="font-size: 1.1rem;">Contatti da Importazione Automatica</h3>
                    <div id="rubrica-imported-container" class="data-table-container" style="margin-bottom: 2.5rem;">
                        <p style="color:var(--secondary-text);">Caricamento contatti importati...</p>
                    </div>

                    <h3 class="section-title" style="font-size: 1.1rem;">Contatti da Inserimento Manuale</h3>
                    <div id="rubrica-manual-container" class="data-table-container">
                        <p style="color:var(--secondary-text);">Caricamento contatti manuali...</p>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;
        };

        const loadRubricaNumbers = () => {
            const importedContainer = document.getElementById('rubrica-imported-container');
            const manualContainer = document.getElementById('rubrica-manual-container');

            // Carica contatti importati
            if (importedContainer) {
                const qImported = query(collection(db, "importedPhoneNumbers"), orderBy("uploadedAt", "desc"), limit(1));
                onSnapshot(qImported, (snapshot) => {
                    if (snapshot.empty) {
                        importedContainer.innerHTML = `<p style="color:var(--secondary-text);">Nessun contatto importato trovato.</p>`;
                        return;
                    }
                    const data = snapshot.docs[0].data().tableData;
                    if (!data || data.length === 0) {
                        importedContainer.innerHTML = `<p style="color:var(--secondary-text);">Il file importato è vuoto.</p>`;
                        return;
                    }
                    const headers = Object.keys(data[0]);
                    const { headers: orderedHeaders, data: orderedData } = reorderColumns(data, headers);

                    const canManage = userProfile?.tipoUtente === 'supervisore';

                    // Aggiungi header per checkbox e azioni se l'utente può gestire
                    const headerRow = canManage ?
                        `<tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="select-all-contacts-rubrica-imported" onchange="toggleAllContactsRubricaImported(this)">
                            </th>
                            ${orderedHeaders.map(h => `<th>${h}</th>`).join('')}
                            <th style="text-align:right;">AZIONI</th>
                        </tr>` :
                        `<tr>${orderedHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;

                    let tableHTML = '<table class="data-table"><thead>' + headerRow + '</thead><tbody>';

                    orderedData.forEach((row, index) => {
                        tableHTML += '<tr>';
                        if (canManage) {
                            tableHTML += `<td><input type="checkbox" class="contact-checkbox-rubrica-imported" value="${index}" onchange="updateBulkActionsRubricaImported()"></td>`;
                        }
                        orderedHeaders.forEach(h => tableHTML += `<td>${row[h] !== undefined ? row[h] : ''}</td>`);

                        if (canManage) {
                            const editIcon = `<button onclick="editImportedContact(${index}, ${JSON.stringify(row).replace(/"/g, '&quot;')})" class="btn-icon" title="Modifica" style="margin-right: 0.5rem;">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                            </button>`;
                            const deleteIcon = `<button onclick="deleteImportedContact(${index})" class="btn-icon" title="Elimina" style="background:var(--danger); color:white;">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                            </button>`;
                            tableHTML += `<td style="text-align:right;">${editIcon}${deleteIcon}</td>`;
                        }
                        tableHTML += '</tr>';
                    });
                    tableHTML += '</tbody></table>';

                    importedContainer.innerHTML = tableHTML;

                    // Aggiungi pulsante per eliminazione multipla se l'utente può gestire
                    if (canManage) {
                        const bulkActionsHtml = `<div class="flex gap-2 mt-4" id="bulk-actions-rubrica-imported" style="display: none;">
                            <button onclick="deleteSelectedContactsRubricaImported()" class="btn" style="background:var(--danger); color:white;">
                                Elimina Selezionati
                            </button>
                        </div>`;
                        importedContainer.insertAdjacentHTML('afterbegin', bulkActionsHtml);
                    }
                });
            }

            // Carica contatti manuali
            if (manualContainer) {
                const qManual = query(collection(db, "usefulNumbers"), orderBy("createdAt", "desc"));
                onSnapshot(qManual, (snapshot) => {
                    if (snapshot.empty) {
                        manualContainer.innerHTML = `<p style="color:var(--secondary-text);">Nessun contatto inserito manualmente.</p>`;
                        return;
                    }

                    const canManage = userProfile?.tipoUtente === 'supervisore';

                    // Aggiungi header per checkbox e azioni se l'utente può gestire
                    const headerRow = canManage ?
                        `<tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="select-all-contacts-rubrica" onchange="toggleAllContactsRubrica(this)">
                            </th>
                            <th>INTERVENTO RICHIESTO</th>
                            <th>IMPRESA</th>
                            <th>1 NUM. TELEFONICO</th>
                            <th>2 NUM. TELEFONICO</th>
                            <th style="text-align:right;">AZIONI</th>
                        </tr>` :
                        `<tr>
                            <th>INTERVENTO RICHIESTO</th>
                            <th>IMPRESA</th>
                            <th>1 NUM. TELEFONICO</th>
                            <th>2 NUM. TELEFONICO</th>
                        </tr>`;

                    let tableHTML = `<table class="data-table">
                        <thead>${headerRow}</thead>
                        <tbody>`;

                    tableHTML += snapshot.docs.map(docSnap => {
                        const contact = docSnap.data();
                        if (canManage) {
                            const editIcon = `<button onclick="editUsefulNumber('${docSnap.id}', ${JSON.stringify(contact).replace(/"/g, '&quot;')})" class="btn-icon" title="Modifica" style="margin-right: 0.5rem;">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                            </button>`;
                            const deleteIcon = `<button onclick="deleteUsefulNumber('${docSnap.id}')" class="btn-icon" title="Elimina" style="background:var(--danger); color:white;">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                            </button>`;

                            return `<tr>
                                <td><input type="checkbox" class="contact-checkbox-rubrica" value="${docSnap.id}" onchange="updateBulkActionsRubrica()"></td>
                                <td>${contact.title}</td>
                                <td>${contact.company || '–'}</td>
                                <td>${contact.number}</td>
                                <td>${contact.number2 || '–'}</td>
                                <td style="text-align:right;">${editIcon}${deleteIcon}</td>
                            </tr>`;
                        } else {
                            return `<tr>
                                <td>${contact.title}</td>
                                <td>${contact.company || '–'}</td>
                                <td>${contact.number}</td>
                                <td>${contact.number2 || '–'}</td>
                            </tr>`;
                        }
                    }).join('');

                    tableHTML += '</tbody></table>';

                    manualContainer.innerHTML = tableHTML;

                    // Aggiungi pulsante per eliminazione multipla se l'utente può gestire
                    if (canManage) {
                        const bulkActionsHtml = `<div class="flex gap-2 mt-4" id="bulk-actions-rubrica" style="display: none;">
                            <button onclick="deleteSelectedContactsRubrica()" class="btn" style="background:var(--danger); color:white;">
                                Elimina Selezionati
                            </button>
                        </div>`;
                        manualContainer.insertAdjacentHTML('afterbegin', bulkActionsHtml);
                    }
                });
            }
        };

        const renderNumeriUtiliCustode = () => `
            ${renderHeader('Custode')}
            <main>
                <div class="card">
                    <h3 class="card-title">Orari del Custode</h3>
                    <p class="form-label" style="color: var(--secondary-text); margin-bottom: 2rem;">
                        SCORRERE A DESTRA PER VISUALIZZARE AL COMPLETO
                    </p>
                    <div id="custode-schedule-container" class="data-table-container">
                        <p style="color:var(--secondary-text);">Caricamento orari custode...</p>
                    </div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;





        const loadCustodeSchedule = () => {
            const scheduleContainer = document.getElementById('custode-schedule-container');
            if (!scheduleContainer) return;

            const qSchedule = query(collection(db, "importedCustodeSchedule"), orderBy("uploadedAt", "desc"), limit(1));
            onSnapshot(qSchedule, (snapshot) => {
                if (snapshot.empty) {
                    scheduleContainer.innerHTML = `<p style="color:var(--secondary-text);">Nessun orario custode ancora importato.</p>`;
                    return;
                }

                const scheduleData = snapshot.docs[0].data();
                if (scheduleData.tableData && scheduleData.tableData.length > 0) {
                    const originalHeaders = Object.keys(scheduleData.tableData[0]);
                    const canManage = userProfile?.tipoUtente === 'supervisore';

                    // --- LOGICA DI ORDINAMENTO UNIFICATA E ROBUSTA ---
                    const desiredOrderKeywords = ['nominativo', 'lun - ven', 'sabato', 'ruolo', 'telefono'];
                    let headers = [];
                    let remainingHeaders = [...originalHeaders];

                    desiredOrderKeywords.forEach(keyword => {
                        const foundHeader = remainingHeaders.find(h => h.toLowerCase().includes(keyword));
                        if (foundHeader) {
                            headers.push(foundHeader);
                            remainingHeaders = remainingHeaders.filter(h => h !== foundHeader);
                        }
                    });

                    headers = [...headers, ...remainingHeaders];
                    // --- FINE LOGICA DI ORDINAMENTO ---

                    let tableHTML = `<table class="data-table"><thead><tr>`;
                    headers.forEach(header => {
                        tableHTML += `<th>${header.toUpperCase()}</th>`;
                    });
                    if (canManage) { // La colonna Azioni appare solo per il supervisore
                        tableHTML += `<th style="text-align:right;">AZIONI</th>`;
                    }
                    tableHTML += `</tr></thead><tbody>`;

                    scheduleData.tableData.forEach((row, index) => {
                        tableHTML += `<tr>`;
                        headers.forEach(header => {
                            tableHTML += `<td>${row[header] || '–'}</td>`;
                        });

                        if (canManage) {
                            const editIcon = `<button onclick="editImportedScheduleEntry(${index}, ${JSON.stringify(row).replace(/"/g, '&quot;')})" class="btn-icon" title="Modifica" style="margin-right: 0.5rem;"><svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></button>`;
                            const deleteIcon = `<button onclick="deleteImportedScheduleEntry(${index})" class="btn-icon" title="Elimina" style="background:var(--danger); color:white;"><svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>`;
                            tableHTML += `<td style="text-align:right;">${editIcon}${deleteIcon}</td>`;
                        }
                        tableHTML += `</tr>`;
                    });

                    tableHTML += '</tbody></table>';
                    scheduleContainer.innerHTML = tableHTML;
                } else {
                    scheduleContainer.innerHTML = `<p style="color:var(--secondary-text);">Nessun orario custode ancora importato.</p>`;
                }
            }, (error) => {
                console.error("Errore nel caricamento degli orari del custode:", error);
                scheduleContainer.innerHTML = `<div class="message-box error" style="display:block;">Errore nel caricamento degli orari.</div>`;
            });
        };

        const editCustodeScheduleEntry = async (docId, index, currentData) => {
            if (userProfile?.tipoUtente !== 'supervisore') {
                alert('Non hai i permessi per modificare gli orari.');
                return;
            }

            const formFields = Object.keys(currentData).map(key => {
                const value = currentData[key] || '';
                const sanitizedKey = key.replace(/[^a-zA-Z0-9]/g, '');
                return `<div><label class="form-label">${key}</label><input type="text" id="edit-schedule-${sanitizedKey}" value="${value}" class="form-input"></div>`;
            }).join('');

            const modalContent = `
                <form id="edit-schedule-form" class="space-y-4">
                    ${formFields}
                    <div class="flex justify-end gap-4 mt-4">
                        <button type="button" class="btn btn-secondary" onclick="hideModal()">Annulla</button>
                        <button type="submit" class="btn btn-primary">Salva</button>
                    </div>
                </form>
            `;
            showModal('Modifica Riga Orario', modalContent);

            document.getElementById('edit-schedule-form').onsubmit = async (e) => {
                e.preventDefault();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Salvataggio...';

                try {
                    const docRef = doc(db, "importedCustodeSchedule", docId);
                    await runTransaction(db, async (transaction) => {
                        const docSnap = await transaction.get(docRef);
                        if (!docSnap.exists()) throw new Error("Documento degli orari non trovato.");

                        const tableData = docSnap.data().tableData;
                        const newRowData = {};
                        Object.keys(currentData).forEach(key => {
                            const sanitizedKey = key.replace(/[^a-zA-Z0-9]/g, '');
                            newRowData[key] = document.getElementById(`edit-schedule-${sanitizedKey}`).value;
                        });
                        tableData[index] = newRowData;
                        transaction.update(docRef, { tableData });
                    });

                    await logActivity("custode_schedule_entry_updated", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { updatedIndex: index });
                    hideModal();
                } catch (error) {
                    console.error("Errore aggiornamento orario:", error);
                    alert("Errore durante il salvataggio: " + error.message);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Salva';
                }
            };
        };

        const deleteCustodeScheduleEntry = async (docId, index) => {
            if (userProfile?.tipoUtente !== 'supervisore') {
                alert('Non hai i permessi per eliminare orari.');
                return;
            }
            if (!confirm('Sei sicuro di voler eliminare questa riga di orario?')) return;

            try {
                const docRef = doc(db, "importedCustodeSchedule", docId);
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(docRef);
                    if (!docSnap.exists()) throw new Error("Documento degli orari non trovato.");

                    const tableData = docSnap.data().tableData;
                    const updatedData = tableData.filter((_, i) => i !== index);
                    transaction.update(docRef, { tableData: updatedData });
                });

                await logActivity("custode_schedule_entry_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { deletedIndex: index });
            } catch (error) {
                console.error("Errore eliminazione orario:", error);
                alert("Errore durante l'eliminazione: " + error.message);
            }
        };



        const showProfileMessage = (e, t) => { const o = document.getElementById("profile-message"); o && (o.className = `message-box ${e}`, o.textContent = t, o.style.display = "block", setTimeout(() => { o.style.display = "none" }, 5e3)) };

        const showCommunicationDetail = async (commId) => {
            try {
                const commDoc = await getDoc(doc(db, "communications", commId));
                if (commDoc.exists()) {
                    const comm = commDoc.data();
                    let attachmentsHtml = '';
                    
                    // --- MODIFICATION START ---
                    // This block now renders a gallery of attachments if fileUrls exist.
                    if (comm.fileUrls && comm.fileUrls.length > 0) {
                        attachmentsHtml = `
                        <h4 style="font-size: 1rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem;">Allegati:</h4>
                        <div class="report-attachments-gallery" style="padding-left: 0;">
                            ${comm.fileUrls.map(url => {
                                // Simple logic to differentiate file types based on common extensions in the URL
                                const lowerUrl = url.toLowerCase();
                                const isImage = /\.(jpg|jpeg|png|gif|webp)$/.test(lowerUrl);
                                const isVideo = /\.(mp4|mov|webm)$/.test(lowerUrl);
                                
                                let fileName = 'Documento';
                                try {
                                    // Extract a user-friendly file name from the URL
                                    const urlPath = new URL(url).pathname;
                                    const decodedPath = decodeURIComponent(urlPath);
                                    fileName = decodedPath.substring(decodedPath.lastIndexOf('/') + 1);
                                    // Remove the timestamp prefix for display
                                    if (fileName.includes('_')) {
                                        fileName = fileName.substring(fileName.indexOf('_') + 1);
                                    }
                                } catch (e) { /* Fallback if URL parsing fails */ }

                                if (isImage) {
                                    return `<a href="${url}" target="_blank" class="gallery-item"><img src="${url}" alt="Allegato immagine"></a>`;
                                } else if (isVideo) {
                                    return `<a href="${url}" target="_blank" class="gallery-item"><video src="${url}" controls preload="metadata"></video></a>`;
                                } else {
                                    // Fallback for documents (PDF, DOCX, etc.)
                                    return `
                                    <a href="${url}" target="_blank" class="gallery-item">
                                        <div class="preview-item-document">
                                            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                                            <span>${fileName}</span>
                                        </div>
                                    </a>`;
                                }
                            }).join('')}
                        </div>
                        `;
                    }
                    // --- MODIFICATION END ---

                    const contentHtml = `<p>${comm.content.replace(/\n/g, '<br>')}</p>${attachmentsHtml}`;
                    showModal(comm.title, contentHtml);

                    const latestCommQuery = query(collection(db, "communications"), orderBy("createdAt", "desc"), limit(1));
                    const snapshot = await getDocs(latestCommQuery);
                    if (!snapshot.empty) {
                        localStorage.setItem(`lastSeenComm_${currentUser.uid}`, snapshot.docs[0].data().createdAt.toMillis());
                        updateNotificationUI('bacheca', 0);
                    }
                }
            } catch (error) {
                console.error("Errore nel caricare la comunicazione:", error);
            }
        };

        const loadCommunications = () => {
            const listEl = document.getElementById("communications-list");
            if (!listEl) return;

            const searchInput = document.getElementById("communication-search");
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';

            const q = query(collection(db, "communications"), orderBy("createdAt", "desc"));
            onSnapshot(q, snapshot => {
                const userGroups = userProfile.proprieta?.map(p => p.gruppo).filter(Boolean) || [];
                const canSeeAll = ['adm', 'supervisore', 'amministratore', 'consigliere'].includes(userProfile.tipoUtente);

                let filteredDocs = snapshot.docs.filter(docSnap => {
                    const comm = docSnap.data();
                    const userRole = userProfile?.tipoUtente;

                    // Logica specifica per il Custode: vede solo le comunicazioni a lui inoltrate.
                    if (userRole === 'custode') {
                        return comm.forwardToCustode === true;
                    }
                    
                    // Logica generale per tutti gli altri utenti.
                    const hasGeneralPermission = canSeeAll || !comm.targetGroup || comm.targetGroup === 'Tutti' || userGroups.includes(comm.targetGroup);
                    return hasGeneralPermission;
                });

                if (searchTerm) {
                    filteredDocs = filteredDocs.filter(docSnap => {
                        const comm = docSnap.data();
                        const title = (comm.title || '').toLowerCase();
                        const content = (comm.content || '').toLowerCase();
                        return title.includes(searchTerm) || content.includes(searchTerm);
                    });
                }

                if (filteredDocs.length === 0) {
                    const message = searchTerm ? 'Nessuna comunicazione trovata con i criteri di ricerca.' : 'Nessuna comunicazione per te.';
                    listEl.innerHTML = `<p style="color:var(--secondary-text); padding: 1rem 0;">${message}</p>`;
                } else {
                    listEl.innerHTML = filteredDocs.map(docSnap => {
                        const comm = docSnap.data();
                        if (!comm.createdAt) return "";

                        const dateFormatted = comm.createdAt.toDate().toLocaleString("it-IT", { day: "2-digit", month: "short", year: "numeric" });
                        
                        const targetGroupHtml = comm.targetGroup && comm.targetGroup !== 'Tutti'
                            ? `<span class="badge status-aperta" style="font-size: 0.7rem; text-transform: uppercase;">${comm.targetGroup}</span>`
                            : '';

                        const custodeBadgeHtml = comm.forwardToCustode
                            ? `<span class="badge status-in-corso" style="font-size: 0.7rem; text-transform: uppercase;">CUSTODE</span>`
                            : '';

                        return `
                <div class="list-item" onclick="showCommunicationDetail('${docSnap.id}')">
                    <div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg></div>
                    <div class="list-item-content">
                        <div class="title" style="display: flex; align-items: center; justify-content: space-between; gap: 0.5rem;">
                            <span style="white-space: normal; flex-grow: 1; padding-right: 0.5rem;">${comm.communicationNumber ? `#${comm.communicationNumber}: ` : ''}${comm.title}</span>
                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.25rem; flex-shrink: 0;">
                                ${targetGroupHtml}
                                ${custodeBadgeHtml}
                            </div>
                        </div>
                        <div class="subtitle">${comm.content.substring(0, 50)}...</div>
                        <div class="subtitle" style="font-size:0.75rem; margin-top:4px;">${comm.createdBy} - ${dateFormatted}</div>
                    </div>
                </div>`;
                    }).join("");
                }

                if (currentPage === 'bacheca_tutte' && !snapshot.empty) {
                    const latestCommTimestamp = snapshot.docs.length > 0 ? snapshot.docs[0].data().createdAt.toMillis() : Date.now();
                    localStorage.setItem(`lastSeenComm_${currentUser.uid}`, latestCommTimestamp);
                    updateNotificationUI('bacheca', 0);
                }
            });
        };

        const isUserAllowedToVote = (userType, setting) => {
            // ADM can always vote
            if (userType === 'adm') return true;

            const allowedRoles = {
                option1: ['supervisore', 'amministratore', 'consigliere'],
                option2: ['supervisore', 'amministratore', 'consigliere', 'condomino'],
                option3: ['supervisore', 'consigliere']
            };
            const roles = allowedRoles[setting] || allowedRoles['option2'];

            // Check if user is a condomino (including condomino2, condomino3, etc.)
            if (userType.startsWith('condomino') && roles.includes('condomino')) {
                return true;
            }

            return roles.includes(userType);
        };

        const isUserAllowedToCreatePolls = async () => {
            if (!userProfile) return false;

            const userType = userProfile.tipoUtente;

            // Definiamo una lista fissa di ruoli che possono CREARE sondaggi.
            const creatorRoles = [
                'adm',
                'supervisore',
                'amministratore',
                'consigliere'
            ];

            // La funzione ora si limita a controllare se il ruolo dell'utente è in questa lista.
            return creatorRoles.includes(userType);
        };

        const showPollVoters = async (pollId) => {
            try {
                const pollDoc = await getDoc(doc(db, "polls", pollId));
                if (pollDoc.exists()) {
                    const poll = pollDoc.data();
                    let votersHtml;
                    if (poll.voters && poll.voters.length > 0) {
                        const totalVoters = poll.voters.length;
                        const totalMillesimi = poll.voters.reduce((sum, voter) => sum + (parseFloat(voter.millesimi) || 0), 0);

                        const summaryHtml = `
                            <div style="background: var(--surface-color-light); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 1.5rem; font-size: 0.9rem;">
                                <div style="display:flex; justify-content:space-between; font-weight:600;"><span>N. Condomini Votanti:</span><span>${totalVoters}</span></div>
                                <hr style="border:none; border-top: 1px solid var(--surface-color); margin: 0.75rem 0;">
                                <div style="display:flex; justify-content:space-between; font-weight:600;"><span>Tot. Millesimi Votanti:</span><span>${totalMillesimi.toFixed(2)} ‰</span></div>
                            </div>
                            <h4 style="font-weight: 600; margin-bottom: 0.5rem;">Dettaglio per Condomino:</h4>
                        `;

                        const votersListHtml = poll.voters.map(voter => `
                            <div class="voter-item">
                                <span>${voter.name}</span>
                                <span style="color:var(--secondary-text); text-align:right;">
                                    <div>${voter.vote}</div>
                                    <div style="font-size:0.8rem">${(parseFloat(voter.millesimi) || 0).toFixed(2)} ‰</div>
                                </span>
                            </div>
                        `).join('');
                        votersHtml = summaryHtml + votersListHtml;
                    } else {
                        votersHtml = '<p>Nessun voto registrato per questo sondaggio.</p>';
                    }
                    showModal('Dettaglio Voti e Millesimi', votersHtml);
                }
            } catch (error) {
                console.error("Errore nel caricare i votanti:", error);
            }
        };

        const loadPolls = (status = 'all') => {
            // Logica di reset notifiche
            if (currentPage === 'sondaggi_elenco') {
                const q = query(collection(db, "polls"), orderBy("createdAt", "desc"), limit(1));
                getDocs(q).then(snapshot => {
                    if (!snapshot.empty) {
                        localStorage.setItem(`lastSeenPoll_${currentUser.uid}`, snapshot.docs[0].data().createdAt.toMillis());
                        updateNotificationUI('sondaggi', 0);
                    }
                });
            }
            const container = document.getElementById("polls-container");
            if (!container) return;

            const settingsRef = doc(db, "settings", "pollCreationAuthorization");
            getDoc(settingsRef).then(settingsSnap => {
                const pollSetting = settingsSnap.exists() ? settingsSnap.data().setting : 'option2';
                const canUserVote = isUserAllowedToVote(userProfile.tipoUtente, pollSetting);
                const q = query(collection(db, "polls"), orderBy("createdAt", "desc"));
                onSnapshot(q, snapshot => {
                    if (snapshot.empty) {
                        let message = 'Nessun sondaggio disponibile.';
                        if (status === 'active') {
                            message = 'Nessun sondaggio attivo disponibile.';
                        } else if (status === 'closed') {
                            message = 'Nessun sondaggio concluso disponibile.';
                        }
                        container.innerHTML = `<div class="card"><p style="color:var(--secondary-text); padding: 1rem 0;">${message}</p></div>`;
                        return;
                    }

                    // Get search and filter values
                    const searchTerm = document.getElementById('poll-search')?.value?.toLowerCase() || '';
                    const typeFilter = document.getElementById('poll-type-filter')?.value || '';

                    // Filter polls based on search, type, status, and user role
                    let filteredPolls = snapshot.docs.filter(docSnap => {
                        const poll = docSnap.data();

                        // --- NUOVA LOGICA DI FILTRAGGIO (PIÙ CHIARA E CORRETTA) ---
                        const userRole = userProfile.tipoUtente;
                        const pollType = poll.pollType;

                        if (userRole === 'adm' || userRole === 'amministratore' || userRole === 'supervisore') {
                            // Questi ruoli possono vedere tutti i tipi di sondaggi.
                            // Non facciamo nulla e proseguiamo con gli altri filtri (status, ricerca, etc.)
                        } else if (userRole === 'consigliere') {
                            // Il consigliere può vedere sia i sondaggi per 'condomini' che quelli per 'supervisor-consiglieri'.
                            if (pollType !== 'condomini' && pollType !== 'supervisor-consiglieri') {
                                return false; // Nascondi tutti gli altri tipi di sondaggi
                            }
                        } else if (userRole.startsWith('condomino')) {
                            // Il condomino può vedere solo i sondaggi per 'condomini'.
                            if (pollType !== 'condomini') {
                                return false; // Nascondi tutti gli altri tipi di sondaggi
                            }
                        } else {
                            // Tutti gli altri ruoli (es. custode, fornitore) non vedono nessun sondaggio.
                            return false;
                        }
                        // --- FINE DELLA NUOVA LOGICA ---

                        // Filter by status (active/closed)
                        if (status !== 'all') {
                            if (!poll.deadline) {
                                // Polls without deadline are considered active
                                if (status === 'closed') return false;
                            } else {
                                const deadline = poll.deadline.toDate();
                                const isExpired = deadline < new Date();
                                if (status === 'active' && isExpired) return false;
                                if (status === 'closed' && !isExpired) return false;
                            }
                        }

                        // Filter by type if specified
                        if (typeFilter && poll.pollType !== typeFilter) {
                            return false;
                        }

                        // Filter by search term
                        if (searchTerm) {
                            const searchableText = `${poll.title} ${poll.description || ''}`.toLowerCase();
                            if (!searchableText.includes(searchTerm)) {
                                return false;
                            }
                        }

                        return true;
                    });

                    if (filteredPolls.length === 0) {
                        let message = 'Nessun sondaggio trovato con i criteri di ricerca.';
                        if (status === 'active') {
                            message = 'Nessun sondaggio attivo trovato.';
                        } else if (status === 'closed') {
                            message = 'Nessun sondaggio concluso trovato.';
                        }
                        container.innerHTML = `<div class="card"><p style="color:var(--secondary-text); padding: 1rem 0;">${message}</p></div>`;
                        return;
                    }

                    // Sort by poll number for numbered display
                    filteredPolls.sort((a, b) => {
                        const pollA = a.data();
                        const pollB = b.data();
                        return (pollA.pollNumber || 0) - (pollB.pollNumber || 0);
                    });

                    container.innerHTML = filteredPolls.map((docSnap, index) => {
                        const poll = docSnap.data();
                        const deadline = poll.deadline ? poll.deadline.toDate() : null;
                        const isExpired = deadline ? deadline < new Date() : false;
                        const hasVoted = poll.voters && poll.voters.some(v => v.uid === currentUser.uid);
                        const totalVotes = poll.options.reduce((sum, opt) => sum + (opt.votes || 0), 0);
                        const showVoteUI = !isExpired && canUserVote;

                        const pollTypeLabel = poll.pollType === 'supervisor-consiglieri' ? 'Supervisor e Consiglieri' : 'Condomini';
                        const pollTitle = poll.pollNumber ? `Sondaggio N. ${poll.pollNumber}: ${poll.title}` : poll.title;
                        const buttonText = hasVoted ? 'Cambia Voto' : 'Invia Voto';

                        const dateOptions = { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
                        const creationDate = poll.createdAt ? poll.createdAt.toDate().toLocaleString("it-IT", dateOptions) : 'N/D';
                        const closingDate = deadline ? deadline.toLocaleString("it-IT", dateOptions) : 'Senza scadenza';
                        const dateInfoHtml = `
                        <div style="font-size: 0.8rem; color: var(--secondary-text); margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--surface-color-light);">
                            <div><strong>Tipo:</strong> ${pollTypeLabel}</div>
                            <div><strong>Creato il:</strong> ${creationDate}</div>
                            <div><strong>Scade il:</strong> ${closingDate}</div>
                        </div>`;

                        let optionsHtml = '';
                        if (showVoteUI) {
                            if (poll.multipleChoice) {
                                const voterRecord = poll.voters.find(v => v.uid === currentUser.uid);
                                const previousVotes = hasVoted && voterRecord ? voterRecord.vote.split(', ') : [];
                                const optionsCheckboxes = poll.options.map((option, index) => {
                                    const percentage = totalVotes > 0 ? Math.round((option.votes || 0) / totalVotes * 100) : 0;
                                    const isChecked = hasVoted && previousVotes.includes(option.text);
                                    return `
                                    <div>
                                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem;">
                                            <span class="font-medium">${option.text}</span>
                                            <span style="color:var(--secondary-text); font-size:0.9rem;">${percentage}%</span>
                                        </div>
                                        <div class="poll-option-bar"><div class="poll-option-fill" style="width: ${percentage}%"></div></div>
                                        <label class="flex items-center gap-3 p-3 mt-3 rounded-md cursor-pointer" style="background-color: var(--surface-color-light);">
                                            <input type="checkbox" class="poll-option-checkbox-${docSnap.id}" value="${index}" ${isChecked ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: var(--accent-color);">
                                            <span>Seleziona questa opzione</span>
                                        </label>
                                    </div>`;
                                }).join('');
                                const submitButton = `<button onclick="voteOnPoll('${docSnap.id}')" class="btn btn-primary w-full mt-4">${buttonText}</button>`;
                                optionsHtml = `<div class="space-y-4">${optionsCheckboxes}</div>${submitButton}`;
                            } else {
                                optionsHtml = `<div class="space-y-4">${poll.options.map((option, index) => {
                                    const percentage = totalVotes > 0 ? Math.round((option.votes || 0) / totalVotes * 100) : 0;
                                    return `
                                    <div>
                                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem;">
                                            <span class="font-medium">${option.text}</span>
                                            <span style="color:var(--secondary-text); font-size:0.9rem;">${percentage}%</span>
                                        </div>
                                        <div class="poll-option-bar"><div class="poll-option-fill" style="width: ${percentage}%"></div></div>
                                        <button onclick="voteOnPoll('${docSnap.id}', ${index})" class="btn btn-secondary" style="width:100%; margin-top:0.75rem;">${hasVoted ? 'Vota di nuovo per' : 'Vota per'} "${option.text}"</button>
                                    </div>`;
                                }).join("")}</div>`;
                            }
                        } else {
                            optionsHtml = `<div class="space-y-4">${poll.options.map(option => {
                                const percentage = totalVotes > 0 ? Math.round((option.votes || 0) / totalVotes * 100) : 0;
                                return `
                                <div>
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.25rem;">
                                        <span class="font-medium">${option.text}</span>
                                        <span style="color:var(--secondary-text); font-size:0.9rem;">${percentage}%</span>
                                    </div>
                                    <div class="poll-option-bar"><div class="poll-option-fill" style="width: ${percentage}%"></div></div>
                                </div>`;
                            }).join("")}</div>`;
                        }

                        let votingInstructionHtml = '';
                        if (showVoteUI) {
                            let instructionText = poll.multipleChoice ? 'Puoi selezionare più risposte.' : 'Scegli una sola risposta.';
                            if (hasVoted) {
                                instructionText = 'Hai già votato. Puoi modificare la tua scelta qui sotto.';
                            }
                            votingInstructionHtml = `<p class="form-label" style="margin-bottom: 1rem; color: var(--secondary-text);">${instructionText}</p>`;
                        }

                        const actionButtons = [];
                        actionButtons.push(`<button onclick="showPollVoters('${docSnap.id}')" class="btn btn-secondary" style="flex-grow:1;">Mostra Votanti</button>`);

                        if (poll.createdById === currentUser.uid && !isExpired) {
                            actionButtons.push(`<button onclick="deletePoll('${docSnap.id}')" class="btn" style="background:var(--danger); color:white; flex-grow:1;">Elimina</button>`);
                        }
                        const actionButtonsHtml = actionButtons.length > 0 ? `<div class="flex gap-4 mt-4">${actionButtons.join('')}</div>` : '';

                        const typeBadge = `<span class="badge" style="background: var(--accent-color); color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.8rem; margin-bottom: 0.5rem; display: inline-block;">${pollTypeLabel}</span>`;

                        return `
                        <div class="card" style="padding:1rem; margin-bottom:1rem;">
                            <div class="list-item" style="padding:0; margin-bottom:1rem; cursor:default;">
                                <div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/></svg></div>
                                <div class="list-item-content">
                                    <div class="title">${pollTitle}</div>
                                    <div class="subtitle">${isExpired ? "Sondaggio chiuso" : "Sondaggio attivo"} ${hasVoted ? "· Hai votato" : ""}</div>
                                </div>
                            </div>
                            ${typeBadge}
                            ${poll.description ? `<p style="color: var(--secondary-text); margin-bottom: 1rem; font-style: italic;">${poll.description}</p>` : ''}
                            ${votingInstructionHtml}
                            ${optionsHtml}
                            ${dateInfoHtml}
                            ${actionButtonsHtml}
                        </div>`;
                    }).join("");
                });
            });
        };

        const renderReportCardHTML = (report, reportId, index = null) => {

            if (!report.createdAt) return "";

            // Banner periodo amministrativo corrente (solo se disponibile)
            let periodBannerHtml = '';
            if (typeof renderCurrentPeriodBanner === 'function' && currentAdministrativePeriod) {
                periodBannerHtml = renderCurrentPeriodBanner();
            }

            const isManager = ["amministratore", "custode", "consigliere", "fornitore", "supervisore", "adm"].includes(userProfile?.tipoUtente);
            const isCreator = report.createdById === currentUser.uid;
            const canManageThisReport = isManager && (
                report.recipientType === userProfile.tipoUtente ||
                (report.recipientType === 'consigliere' && userProfile.tipoUtente === 'consigliere') ||
                userProfile.tipoUtente === 'supervisore' ||
                userProfile.tipoUtente === 'adm' ||
                (userProfile.tipoUtente === 'amministratore' && report.forwardedByUserId === currentUser.uid) || // Admin can manage tickets they forwarded
                (userProfile.tipoUtente === 'custode' && report.originalRecipient === 'custode' && report.forwardedBy) // Custode can manage reports they originally received, even if forwarded
            );

            let primaryActionButtonsHtml = '';
            let forwardButtonHtml = '';
            let updateButtonHtml = '';

            // Logica pulsanti per il gestore
            if (canManageThisReport) {
                if (report.status === 'aperta') {
                    // --- MODIFICA SUPERVISORE/CONSIGLIERE: Visibilità condizionale "Prendi in Carico" ---
                    // Il pulsante appare per tutti i manager, tranne per il supervisore se il ticket non è suo e per il consigliere.
                    const isSupervisor = userProfile?.tipoUtente === 'supervisore';
                    const isConsigliere = userProfile?.tipoUtente === 'consigliere';
                    const isForSupervisor = report.recipientType === 'supervisore';

                    if ((!isSupervisor || (isSupervisor && isForSupervisor)) && !isConsigliere) {
                        primaryActionButtonsHtml += `<button onclick="updateReportStatus('${reportId}', 'in-corso')" class="btn btn-primary" style="flex:1;">Prendi in Carico</button>`;
                    }
                    // --- FINE MODIFICA ---
                }
                if (report.status === 'in-corso' && userProfile?.tipoUtente !== 'consigliere') {
                    // --- MODIFICA SUPERVISORE INIZIO: Azione "Risolta" personalizzata ---
                    if (userProfile?.tipoUtente === 'supervisore') {
                        // Per il supervisore, l'azione aggiunge un commento specifico.
                        primaryActionButtonsHtml += `<button onclick="updateReportStatus('${reportId}', 'risolta', 'Risolto da Supervisore.')" class="btn btn-primary" style="flex:1;">Marca come Risolta</button>`;
                    } else {
                        // Gli altri ruoli usano l'azione standard.
                        primaryActionButtonsHtml += `<button onclick="updateReportStatus('${reportId}', 'risolta')" class="btn btn-primary" style="flex:1;">Marca come Risolta</button>`;
                    }
                    // --- MODIFICA SUPERVISORE FINE ---
                }
                if (userProfile?.tipoUtente === 'amministratore') {
                    if (report.status === 'aperta' || report.status === 'in-corso') {
                        primaryActionButtonsHtml += `<button onclick="openReassignmentModal('${reportId}')" class="btn btn-secondary" style="flex:1; background-color: var(--warning); color: var(--bg-color);">Riassegna</button>`;
                    }
                    // NUOVA LOGICA: Pulsante per chiudere ticket risolti
                    if (report.status === 'risolta') {
                        primaryActionButtonsHtml += `<button onclick="updateReportStatus('${reportId}', 'chiusa', 'Segnalazione chiusa dall\\'amministratore.')" class="btn btn-primary" style="flex:1;">Chiudi Segnalazione</button>`;
                    }
                }

                if (userProfile?.tipoUtente === 'custode' && (report.status === 'aperta' || report.status === 'in-corso')) {
                    forwardButtonHtml = `<button onclick="forwardReportToAdmin('${reportId}')" class="btn btn-secondary" style="width: 100%; background-color: var(--accent-color-dark); color: white;">Inoltra ad Amministratore</button>`;
                }

                // Pulsante Aggiorna separato - andrà in una riga separata
                if (report.status !== 'chiusa') {
                    // --- MODIFICA SUPERVISORE/CONSIGLIERE: Pulsante Aggiorna personalizzato ---
                    if (userProfile?.tipoUtente === 'supervisore') {
                        // Il supervisore ha un pulsante specifico per aggiungere commenti.
                        updateButtonHtml = `<button onclick="openReportUpdateModal('${reportId}')" class="btn btn-secondary" style="width: 100%;">Commento da Supervisor</button>`;
                    } else if (userProfile?.tipoUtente === 'consigliere') {
                        // Il consigliere ha un pulsante specifico per i commenti.
                        updateButtonHtml = `<button onclick="openReportUpdateModal('${reportId}')" class="btn btn-secondary" style="width: 100%;">Commento da Consigliere</button>`;
                    } else {
                        // Gli altri ruoli mantengono il pulsante standard.
                        updateButtonHtml = `<button onclick="openReportUpdateModal('${reportId}')" class="btn btn-secondary" style="width: 100%;">Aggiorna</button>`;
                    }
                    // --- FINE MODIFICA ---
                }
            }

            // Logica pulsanti per il creatore (solo se è un "condomino")
            if (isCreator && userProfile?.tipoUtente === 'condomino') {
                if (report.status === 'aperta' || report.status === 'in-corso') {
                    primaryActionButtonsHtml += `<button onclick="sendReportReminder('${reportId}')" class="btn btn-secondary" style="flex:1;">Sollecita</button>`;
                }
                if (report.status === 'risolta') {
                    primaryActionButtonsHtml += `<button onclick="confirmReportResolution('${reportId}', true)" class="btn btn-primary" style="flex:1;">Conferma Risoluzione</button>`;
                    primaryActionButtonsHtml += `<button onclick="confirmReportResolution('${reportId}', false)" class="btn" style="background:var(--danger); color:white; flex:1;">Non Risolto</button>`;
                }
            }

            const updatesHtml = report.updates && report.updates.length > 0 ? `
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--surface-color-light);">
                    <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem;">Cronologia Aggiornamenti:</h4>
                    <div style="font-size: 0.85rem; color: var(--secondary-text);">
                        ${report.updates.map(upd => {
                const attachmentsHtml = upd.fileUrls && upd.fileUrls.length > 0 ? `
                                <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--surface-color-light); border-radius: 4px;">
                                    <strong style="font-size: 0.8rem;">Allegati:</strong>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.25rem;">
                                        ${upd.fileUrls.map(url => {
                    const fileName = url.split('/').pop().split('?')[0].split('_').slice(1).join('_') || 'File';
                    const isImage = url.includes('.jpg') || url.includes('.jpeg') || url.includes('.png') || url.includes('.gif');

                    if (isImage) {
                        return `<img src="${url}" alt="${fileName}" style="max-width: 100px; max-height: 100px; border-radius: 4px; cursor: pointer;" onclick="window.open('${url}', '_blank')">`;
                    } else {
                        return `<a href="${url}" target="_blank" style="display: inline-flex; align-items: center; padding: 0.25rem 0.5rem; background: var(--primary); color: white; text-decoration: none; border-radius: 4px; font-size: 0.75rem;">
                                                    <svg fill="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px; margin-right: 0.25rem;">
                                                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                                                    </svg>
                                                    ${fileName}
                                                </a>`;
                    }
                }).join('')}
                                    </div>
                                </div>
                            ` : '';

                return `<div style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--surface-color-light);">
                                <div><strong>${upd.at.toDate().toLocaleString('it-IT', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}</strong> (${upd.by}): ${upd.text}</div>
                                ${attachmentsHtml}
                            </div>`;
            }).join('')}
                    </div>
                </div>
            ` : '';

            return `
            <div class="card" style="margin-bottom: 1rem; position: relative;">
                ${periodBannerHtml}
                ${index !== null ? `<div style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--primary); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold;">${index}</div>` : ''}
                <div class="list-item" style="padding:0; cursor:default;">
                    <div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg></div>
                    <div class="list-item-content">
                        <div class="title" style="display: flex; align-items: center; gap: 8px;">
    <span>${report.reportNumber ? `#${report.reportNumber}:` : ''} ${report.title}</span>
    ${/* Indicatore visivo per segnalazioni modificate */''}
    ${(report.updates && report.updates.length > 0 && report.updates[report.updates.length - 1].by !== `${userProfile?.nome} ${userProfile?.cognome}`) ? `
        <span style="width: 10px; height: 10px; background-color: var(--danger); border-radius: 50%; display: inline-block; animation: pulse 1.5s infinite;" title="Segnalazione modificata"></span>
        <style> @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } } </style>
    ` : ''}
</div>
                        <div class="subtitle" style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-top:0.25rem;">
    <span class="badge ${getPriorityColor(report.priority)}">${getPriorityDisplayText(report.priority)}</span>
    <span class="badge ${getStatusColor(report.status)}">${report.status}</span>
    ${report.interestType ? `<span class="badge status-in-corso" style="text-transform: capitalize;">${report.interestType}</span>` : ''}
    <span class="badge status-aperta">Dest: ${report.recipientType.charAt(0).toUpperCase() + report.recipientType.slice(1)}</span>
</div>
                    </div>
                </div>
                <p class="form-label" style="padding-left: 64px; color: var(--secondary-text); margin-top: 0.75rem;">Inviata da: <strong>${report.createdByUserType ? (report.createdByUserType.charAt(0).toUpperCase() + report.createdByUserType.slice(1)) : report.createdBy}</strong></p>
                ${report.forwardedBy ? `<p class="form-label" style="padding-left: 64px; color: var(--accent-color); margin-top: 0.5rem;">Inoltrata da: <strong>${report.forwardedBy}</strong> (${report.originalRecipient}) → Attualmente gestita da: <strong>${report.recipientType.charAt(0).toUpperCase() + report.recipientType.slice(1)}</strong></p>` : ''}
                ${report.communicateOwnerPhone && report.createdByPhone ? `<p class="form-label" style="padding-left: 64px; color: var(--accent-color); margin-top: 0.5rem;">📞 Telefono condomino: <strong>${report.createdByPhone}</strong></p>` : ''}
                ${report.otherUiOwner ? `<p class="form-label" style="padding-left: 64px; color: var(--secondary-text); margin-top: 0.5rem;">Proprietario altra U.I.: <strong>${report.otherUiOwner}</strong></p>` : ''}
                
                ${/* Informazioni di contatto specifiche per Fornitore */ userProfile?.tipoUtente === 'fornitore' && report.shareContactWithSupplier ? `
                    <div style="padding-left: 64px; margin-top: 0.75rem; padding: 0.75rem; background: var(--surface-color-light); border-radius: var(--radius-sm); border-left: 4px solid var(--accent-color);">
                        <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-color);">📋 Informazioni di Contatto</h4>
                        ${report.createdByPhone ? `<p style="margin: 0.25rem 0; font-size: 0.85rem;"><strong>Telefono richiedente:</strong> ${report.createdByPhone}</p>` : ''}
                        <p style="margin: 0.25rem 0; font-size: 0.85rem;"><strong>Nome richiedente:</strong> ${report.createdBy}</p>
                        ${report.otherUiOwner && report.communicateOtherUiPhone ? `<p style="margin: 0.25rem 0; font-size: 0.85rem;"><strong>Altra U.I. coinvolta:</strong> ${report.otherUiOwner}</p>` : ''}
                        <p style="margin: 0.25rem 0; font-size: 0.85rem; color: var(--secondary-text);"><em>Informazioni condivise dall'amministratore</em></p>
                    </div>
                ` : ''}
                
                <p style="color: var(--secondary-text); margin-top: 0.5rem; padding-left: 64px;">${report.description}</p>

                <div style="padding-left: 64px; margin-top: 0.75rem; font-size: 0.9rem;">
                    <strong style="color: var(--primary-text);">UBICAZIONE (PIANO):</strong> 
                    <span style="color: var(--secondary-text);">${report.propertyInfo ? `Interno ${report.propertyInfo.interno}, Piano ${report.propertyInfo.piano}` : report.location}</span>
                </div>
                
                <!-- SEZIONE TIMESTAMP -->
                <div style="padding-left: 64px; margin-top: 0.75rem; font-size: 0.85rem; color: var(--secondary-text);">
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <strong>Creata:</strong> ${report.createdAt.toDate().toLocaleString('it-IT', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}
                        </div>
                        ${report.takenInChargeAt ? `
                            <div>
                                <strong>Presa in carico:</strong> ${report.takenInChargeAt.toDate().toLocaleString('it-IT', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}
                            </div>
                        ` : ''}
                    </div>
                </div>
                <!-- FINE SEZIONE TIMESTAMP -->
                
                <!-- NUOVA SEZIONE PER VISUALIZZARE ALLEGATI -->
                ${report.fileUrls && report.fileUrls.length > 0 ? `
                    <div class="report-attachments-gallery">
                        ${report.fileUrls.map(url => {
                const isVideo = url.includes('.mp4') || url.includes('.mov') || url.includes('.webm');
                return `
                            <a href="${url}" target="_blank" class="gallery-item">
                                ${isVideo
                        ? `<video src="${url}" preload="metadata"></video>`
                        : `<img src="${url}" alt="Allegato segnalazione">`
                    }
                            </a>`;
            }).join('')}
                    </div>
                ` : ''}
                <!-- FINE NUOVA SEZIONE -->

                ${updatesHtml}
                ${primaryActionButtonsHtml ? `<div class="flex flex-wrap gap-2 mt-4">${primaryActionButtonsHtml}</div>` : ''}
                ${forwardButtonHtml ? `<div class="mt-2">${forwardButtonHtml}</div>` : ''}
                ${updateButtonHtml ? `<div class="mt-2">${updateButtonHtml}</div>` : ''}
            </div>`;
        };

        const loadMyReports = () => {
            const secondaryContainer = document.getElementById('reports-secondary-container');
            if (!secondaryContainer) return;

            const renderSnapshot = (e, t, o) => { if (t.empty) return void (e.innerHTML = `<p style="color:var(--secondary-text); padding: 1rem 0;">${o}</p>`); const a = t.docs.sort((e, t) => { const o = e.data().createdAt?.toMillis() || 0, n = t.data().createdAt?.toMillis() || 0; return n - o }); e.innerHTML = a.map((e, index) => renderReportCardHTML(e.data(), e.id, index + 1)).join("") };

            const userId = currentUser.uid, qSent = query(collection(db, "reports"), where("createdById", "==", userId)); onSnapshot(qSent, s => renderSnapshot(secondaryContainer, s, "Non hai inviato segnalazioni."));
        };

        const loadFilteredReports = (filterType) => {
            const mainContainer = document.getElementById('reports-main-container');
            if (!mainContainer) return;

            const userRole = userProfile?.tipoUtente;

            const renderAndSort = (docs, emptyMessage) => {
                if (!docs || docs.length === 0) {
                    mainContainer.innerHTML = `<div class="card"><p style="color:var(--secondary-text); padding: 1rem 0;">${emptyMessage}</p></div>`;
                    return;
                }
                const sortedDocs = docs.sort((a, b) => {
                    const timeA = a.data().createdAt?.toMillis() || 0;
                    const timeB = b.data().createdAt?.toMillis() || 0;
                    return timeB - timeA;
                });
                mainContainer.innerHTML = sortedDocs.map((doc, index) => renderReportCardHTML(doc.data(), doc.id, index + 1)).join("");
            };

            let reportsQuery;

            // RUOLI "MANAGER" (Amministratore, Supervisore, ADM, Fornitore): Vedono tutte le segnalazioni per una data categoria.
            if (['amministratore', 'supervisore', 'adm', 'consigliere', 'fornitore'].includes(userRole)) {
                // Query semplice: filtra solo per destinatario e ordina. Funziona senza indici custom.
                reportsQuery = query(
                    collection(db, "reports"),
                    where("recipientType", "==", filterType),
                    orderBy("createdAt", "desc")
                );
                onSnapshot(reportsQuery, (snapshot) => {
                    // Use the handler with counters and filters for all user types
                    handleFilteredReports(snapshot.docs, filterType);
                });
            }
            // CUSTODE: Vede le segnalazioni a lui destinate E quelle che ha inoltrato all'amministratore
            else if (userRole === 'custode' && filterType === 'custode') {
                // Query per tutte le segnalazioni ordinate per data
                reportsQuery = query(
                    collection(db, "reports"),
                    orderBy("createdAt", "desc")
                );
                onSnapshot(reportsQuery, (snapshot) => {
                    // Filtra per includere sia quelle dirette che quelle inoltrate
                    const filteredDocs = snapshot.docs.filter(doc => {
                        const data = doc.data();
                        return data.recipientType === 'custode' ||
                            (data.recipientType === 'amministratore' && data.forwardedBy && data.originalRecipient === 'custode');
                    });
                    handleFilteredReports(filteredDocs, filterType);
                });
            }
            // ALTRI RUOLI (Condomino, Consigliere, etc.): Vedono solo le segnalazioni che LORO hanno inviato.
            else {
                // Query semplice: prende tutte le segnalazioni dell'utente e le ordina.
                reportsQuery = query(
                    collection(db, "reports"),
                    where("createdById", "==", currentUser.uid),
                    orderBy("createdAt", "desc")
                );
                onSnapshot(reportsQuery, (snapshot) => {
                    // Filter for the correct recipient type and use the handler with counters and filters
                    const filteredDocs = snapshot.docs.filter(doc => doc.data().recipientType === filterType);
                    handleFilteredReports(filteredDocs, filterType);
                });
            }
        };

        const handleFornitoreReports = (docs, filterType) => {
            const mainContainer = document.getElementById('reports-main-container');
            const searchInput = document.getElementById('report-search-input');
            const statusFilter = document.getElementById('report-status-filter');
            const counterContainer = document.getElementById('ticket-counters');

            if (!mainContainer) return;

            // Aggiorna contatori
            if (counterContainer) {
                const openCount = docs.filter(doc => doc.data().status === 'aperta').length;
                const inProgressCount = docs.filter(doc => doc.data().status === 'in-corso').length;
                const totalCount = docs.length;
                counterContainer.innerHTML = `
                    <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--danger);">${openCount}</div><div class="page-subtitle" style="text-transform: none;">Richieste aperte n.${openCount}</div></div>
                    <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--warning);">${inProgressCount}</div><div class="page-subtitle" style="text-transform: none;">Richieste in corso n.${inProgressCount}</div></div>
                    <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--primary);">${totalCount}</div><div class="page-subtitle" style="text-transform: none;">Tutte</div></div>
                `;
            }

            // Funzione per il rendering con filtri
            const renderFilteredReports = () => {
                let filteredDocs = docs;

                // Filtra per ricerca testuale
                if (searchInput && searchInput.value) {
                    const searchTerm = searchInput.value.toLowerCase().trim();
                    filteredDocs = filteredDocs.filter(doc => {
                        const data = doc.data();
                        const reportNum = data.reportNumber ? `#${data.reportNumber}` : '';
                        return `${reportNum} ${data.title} ${data.description}`.toLowerCase().includes(searchTerm);
                    });
                }

                // Filtra per stato
                if (statusFilter && statusFilter.value !== 'all') {
                    filteredDocs = filteredDocs.filter(doc => doc.data().status === statusFilter.value);
                }

                // Ordina e renderizza
                const sortedDocs = filteredDocs.sort((a, b) => {
                    const timeA = a.data().createdAt?.toMillis() || 0;
                    const timeB = b.data().createdAt?.toMillis() || 0;
                    return timeB - timeA;
                });

                mainContainer.innerHTML = sortedDocs.length > 0
                    ? sortedDocs.map((doc, index) => renderReportCardHTML(doc.data(), doc.id, index + 1)).join("")
                    : `<div class="card"><p style="color:var(--secondary-text); padding: 1rem 0;">Nessuna segnalazione trovata per: ${filterType}.</p></div>`;
            };

            // Esegui il primo rendering
            renderFilteredReports();

            // Aggiungi event listener ai filtri
            if (searchInput) {
                searchInput.oninput = renderFilteredReports;
            }
            if (statusFilter) {
                statusFilter.onchange = renderFilteredReports;
            }
        };

        const handleFilteredReports = (docs, filterType) => {
            const mainContainer = document.getElementById('reports-main-container');
            const searchInput = document.getElementById('report-search-input');
            const statusFilter = document.getElementById('report-status-filter');
            const counterContainer = document.getElementById('ticket-counters');

            if (!mainContainer) return;

            // Aggiorna contatori
            if (counterContainer) {
                const openCount = docs.filter(doc => doc.data().status === 'aperta').length;
                const inProgressCount = docs.filter(doc => doc.data().status === 'in-corso').length;
                const totalCount = docs.length;
                counterContainer.innerHTML = `
                    <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--danger);">${openCount}</div><div class="page-subtitle" style="text-transform: none;">Richieste aperte n.${openCount}</div></div>
                    <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--warning);">${inProgressCount}</div><div class="page-subtitle" style="text-transform: none;">Richieste in corso n.${inProgressCount}</div></div>
                    <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--primary);">${totalCount}</div><div class="page-subtitle" style="text-transform: none;">Tutte</div></div>
                `;
            }

            // Funzione per il rendering con filtri
            const renderFilteredReports = () => {
                let filteredDocs = docs;

                // Filtra per ricerca testuale
                if (searchInput && searchInput.value) {
                    const searchTerm = searchInput.value.toLowerCase().trim();
                    filteredDocs = filteredDocs.filter(doc => {
                        const data = doc.data();
                        const reportNum = data.reportNumber ? `#${data.reportNumber}` : '';
                        return `${reportNum} ${data.title} ${data.description}`.toLowerCase().includes(searchTerm);
                    });
                }

                // Filtra per stato
                if (statusFilter && statusFilter.value !== 'all') {
                    filteredDocs = filteredDocs.filter(doc => doc.data().status === statusFilter.value);
                }

                // Ordina e renderizza
                const sortedDocs = filteredDocs.sort((a, b) => {
                    const timeA = a.data().createdAt?.toMillis() || 0;
                    const timeB = b.data().createdAt?.toMillis() || 0;
                    return timeB - timeA;
                });

                mainContainer.innerHTML = sortedDocs.length > 0
                    ? sortedDocs.map((doc, index) => renderReportCardHTML(doc.data(), doc.id, index + 1)).join("")
                    : `<div class="card"><p style="color:var(--secondary-text); padding: 1rem 0;">Nessuna segnalazione trovata per: ${filterType}.</p></div>`;
            };

            // Esegui il primo rendering
            renderFilteredReports();

            // Aggiungi event listener ai filtri
            if (searchInput) {
                searchInput.oninput = renderFilteredReports;
            }
            if (statusFilter) {
                statusFilter.onchange = renderFilteredReports;
            }
        };

        const renderSegnalazioniRicevute = () => {
            const isAdmin = userProfile?.tipoUtente === 'amministratore';
            const isCustode = userProfile?.tipoUtente === 'custode';
            const isFornitore = userProfile?.tipoUtente === 'fornitore';

            // Contatori e Filtri per amministratore, custode e fornitore
            const shouldShowControls = isAdmin || isCustode || isFornitore;
            const adminControlsHtml = shouldShowControls ? `
        <div id="ticket-counters" class="grid grid-cols-3 gap-2" style="margin-bottom: 1rem;">
            <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--danger);">0</div><div class="page-subtitle" style="text-transform: none;">Richieste aperte n.0</div></div>
            <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--warning);">0</div><div class="page-subtitle" style="text-transform: none;">Richieste in corso n.0</div></div>
            <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--primary);">0</div><div class="page-subtitle" style="text-transform: none;">Tutte</div></div>
        </div>
        <div class="card" style="margin-bottom: 1.5rem; padding: 1rem;">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="form-group" style="flex-grow: 1; margin-bottom: 0;">
                    <div style="position: relative; display: flex; align-items: center;">
                        <svg style="position: absolute; left: 1rem; width: 20px; height: 20px; color: var(--secondary-text);" fill="currentColor" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        <input type="text" id="report-search-input" placeholder="Cerca per titolo, numero o descrizione..." class="form-input" style="padding-left: 3rem;">
                    </div>
                </div>
                <div class="form-group" style="flex-shrink: 0; min-width: 150px; margin-bottom: 0;">
                    <select id="report-status-filter" class="form-select">
                        <option value="all">Tutti gli stati</option>
                        <option value="aperta">Aperta</option>
                        <option value="in-corso">In Corso</option>
                        <option value="risolta">Risolta</option>
                    </select>
                </div>
                <div class="form-group" style="flex-shrink: 0; min-width: 150px; margin-bottom: 0;">
                    <select id="report-recipient-filter" class="form-select">
                        <option value="all">Tutti i destinatari</option>
                        <option value="amministratore">Amministratore</option>
                        <option value="custode">Custode</option>
                        <option value="consigliere">Consiglieri</option>
                        <option value="fornitore">Fornitore</option>
                        <option value="adm">Sviluppatore</option>
                    </select>
                </div>
            </div>
        </div>
    ` : '';

            return `
    ${renderHeader('Segnalazioni Ricevute')}
    <main>
        ${adminControlsHtml}
        ${shouldShowControls ? `
            <div style="margin-bottom: 2.5rem;">
                <h2 class="section-title">Ticket Attivi</h2>
                <div id="reports-active-container" class="list-container"></div>
            </div>
            <div>
                <h2 class="section-title">Ticket Chiusi</h2>
                <div id="reports-closed-container" class="list-container"></div>
            </div>
        ` : `
            <div id="reports-main-container" class="list-container"></div>
        `}
    </main>
    ${renderBottomNavigation()}
    `;
        };

        const loadReceivedReports = () => {
            const userRole = userProfile?.tipoUtente;
            const isAdmin = userRole === 'amministratore';
            const isCustode = userRole === 'custode';
            const isFornitore = userRole === 'fornitore';
            const shouldShowControls = isAdmin || isCustode || isFornitore;

            // Riferimenti ai container
            const mainContainer = document.getElementById('reports-main-container');
            const activeContainer = document.getElementById('reports-active-container');
            const closedContainer = document.getElementById('reports-closed-container');
            const searchInput = document.getElementById('report-search-input');
            const statusFilter = document.getElementById('report-status-filter');
            const counterContainer = document.getElementById('ticket-counters');

            // Se non siamo nella pagina giusta (es. altro ruolo), esci
            if (!mainContainer && !activeContainer) return;

            // Funzione per il rendering dei ticket
            const renderTickets = (allDocs) => {
                // Filtra in base ai controlli UI (per admin e custode)
                let filteredDocs = allDocs;
                if (shouldShowControls) {
                    const searchTerm = searchInput.value.toLowerCase().trim();
                    const status = statusFilter.value;
                    const recipientFilter = document.getElementById('report-recipient-filter');
                    const recipient = recipientFilter ? recipientFilter.value : 'all';

                    if (searchTerm) {
                        filteredDocs = filteredDocs.filter(doc => {
                            const data = doc.data();
                            const reportNum = data.reportNumber ? `#${data.reportNumber}` : '';
                            return `${reportNum} ${data.title} ${data.description}`.toLowerCase().includes(searchTerm);
                        });
                    }
                    if (status !== 'all') {
                        filteredDocs = filteredDocs.filter(doc => doc.data().status === status);
                    }
                    if (recipient !== 'all') {
                        filteredDocs = filteredDocs.filter(doc => doc.data().recipientType === recipient);
                    }
                }

                // Aggiorna contatori (per admin e custode)
                if (shouldShowControls && counterContainer) {
                    const openCount = allDocs.filter(doc => doc.data().status === 'aperta').length;
                    const inProgressCount = allDocs.filter(doc => doc.data().status === 'in-corso').length;
                    const totalCount = allDocs.length;
                    counterContainer.innerHTML = `
                <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--danger);">${openCount}</div><div class="page-subtitle" style="text-transform: none;">Richieste aperte n.${openCount}</div></div>
                <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--warning);">${inProgressCount}</div><div class="page-subtitle" style="text-transform: none;">Richieste in corso n.${inProgressCount}</div></div>
                <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--primary);">${totalCount}</div><div class="page-subtitle" style="text-transform: none;">Tutte</div></div>
            `;
                }

                // Dividi in attivi e chiusi (per admin e custode)
                if (shouldShowControls) {
                    const activeTickets = filteredDocs.filter(doc => doc.data().status !== 'chiusa' && doc.data().status !== 'risolta');
                    const closedTickets = filteredDocs.filter(doc => doc.data().status === 'chiusa' || doc.data().status === 'risolta');

                    activeContainer.innerHTML = activeTickets.length > 0
                        ? activeTickets.map((doc, index) => renderReportCardHTML(doc.data(), doc.id, index + 1)).join("")
                        : `<div class="card"><p style="color:var(--secondary-text);">Nessun ticket attivo trovato.</p></div>`;

                    closedContainer.innerHTML = closedTickets.length > 0
                        ? closedTickets.map((doc, index) => renderReportCardHTML(doc.data(), doc.id, index + 1)).join("")
                        : `<div class="card"><p style="color:var(--secondary-text);">Nessun ticket chiuso trovato.</p></div>`;
                } else {
                    // Logica per gli altri ruoli manager
                    mainContainer.innerHTML = filteredDocs.length > 0
                        ? filteredDocs.map((doc, index) => renderReportCardHTML(doc.data(), doc.id, index + 1)).join("")
                        : `<div class="card"><p style="color:var(--secondary-text);">Nessuna segnalazione ricevuta.</p></div>`;
                }
            };

            // Logica di reset notifiche
            const q = query(collection(db, "reports"), orderBy("createdAt", "desc"), limit(1));
            getDocs(q).then(snapshot => {
                if (!snapshot.empty) {
                    localStorage.setItem(`lastSeenReport_${currentUser.uid}`, snapshot.docs[0].data().createdAt.toMillis());
                    updateNotificationUI('segnalazioni', 0);
                }
            });

            // Query base
            const baseQuery = query(collection(db, "reports"), orderBy("createdAt", "desc"));

            // Snapshot listener
            onSnapshot(baseQuery, (snapshot) => {
                let relevantDocs = [];
                // Roles that can see ALL reports + tickets they forwarded
                if (['amministratore', 'supervisore', 'adm'].includes(userRole)) {
                    if (userRole === 'amministratore') {
                        // Administrators see ALL reports + tickets they forwarded to others
                        relevantDocs = snapshot.docs.filter(doc => {
                            const data = doc.data();
                            return data.recipientType === 'amministratore' || // Direct assignments
                                (data.forwardedByUserId === currentUser.uid) || // Tickets they forwarded
                                (data.originalRecipient === 'amministratore' && data.forwardedBy); // Tickets forwarded back to admin
                        });
                    } else {
                        // Supervisore and ADM see all reports
                        relevantDocs = snapshot.docs;
                    }
                }
                // Roles with a restricted view
                else if (['custode', 'consigliere', 'fornitore'].includes(userRole)) {
                    if (userRole === 'custode') {
                        // Custode sees tickets assigned to them AND tickets they forwarded
                        relevantDocs = snapshot.docs.filter(doc => {
                            const data = doc.data();
                            return data.recipientType === userRole ||
                                (data.recipientType === 'amministratore' && data.forwardedBy && data.originalRecipient === 'custode');
                        });
                    } else {
                        // Consigliere and Fornitore only see tickets assigned directly to them
                        relevantDocs = snapshot.docs.filter(doc => doc.data().recipientType === userRole);
                    }
                }

                // Esegui il primo rendering
                renderTickets(relevantDocs);

                // Aggiungi event listener ai filtri (per admin, custode e fornitore)
                if (shouldShowControls) {
                    searchInput.oninput = () => renderTickets(relevantDocs);
                    statusFilter.onchange = () => renderTickets(relevantDocs);
                    const recipientFilter = document.getElementById('report-recipient-filter');
                    if (recipientFilter) {
                        recipientFilter.onchange = () => renderTickets(relevantDocs);
                    }
                }
            });
        };

        const renderSegnalazioniUrgenti = () => `
            ${renderHeader('Solleciti ricevuti')}
            <main>
                ${renderCurrentPeriodBanner()}
                <div id="ticket-counters" class="grid grid-cols-3 gap-2" style="margin-bottom: 1rem;">
                    <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--danger);">0</div><div class="page-subtitle" style="text-transform: none;">Richieste aperte n.0</div></div>
                    <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--warning);">0</div><div class="page-subtitle" style="text-transform: none;">Richieste in corso n.0</div></div>
                    <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--primary);">0</div><div class="page-subtitle" style="text-transform: none;">Tutte</div></div>
                </div>
                <div class="card" style="margin-bottom: 1.5rem; padding: 1rem;">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="form-group" style="flex-grow: 1; margin-bottom: 0;">
                            <div style="position: relative; display: flex; align-items: center;">
                                <svg style="position: absolute; left: 1rem; width: 20px; height: 20px; color: var(--secondary-text);" fill="currentColor" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                                <input type="text" id="report-search-input" placeholder="Cerca per titolo, numero o descrizione..." class="form-input" style="padding-left: 3rem;">
                            </div>
                        </div>
                        <div class="form-group" style="flex-shrink: 0; min-width: 150px; margin-bottom: 0;">
                            <select id="report-status-filter" class="form-select">
                                <option value="all">Tutti gli stati</option>
                                <option value="aperta">Aperta</option>
                                <option value="in-corso">In Corso</option>
                                <option value="risolta">Risolta</option>
                            </select>
                        </div>
                    </div>
                </div>
                <p class="form-label" style="margin-bottom: 1.5rem; color: var(--secondary-text);">
                    Elenco delle segnalazioni per cui è stato inviato un sollecito.
                </p>
                <div id="reports-main-container" class="list-container"></div>
            </main>
            ${renderBottomNavigation()}
        `;

        const loadUrgentReports = () => {
            const mainContainer = document.getElementById('reports-main-container');
            if (!mainContainer) return;

            // Marca i solleciti come visti
            const q = query(
                collection(db, "reports"),
                where("priority", "in", ["alta", "richiesta-intervento-danno"]),
                where("status", "in", ["aperta", "in-corso"]),
                orderBy("updatedAt", "desc"),
                limit(1)
            );
            getDocs(q).then(snapshot => {
                if (!snapshot.empty) {
                    localStorage.setItem(`lastSeenSolleciti_${currentUser.uid}`, snapshot.docs[0].data().updatedAt.toMillis());
                    updateNotificationUI('solleciti', 0);
                }
            });

            const userRole = userProfile?.tipoUtente;

            // Query per i solleciti urgenti che l'utente può gestire
            const urgentQuery = query(collection(db, "reports"), where("isUrgent", "==", true), orderBy("createdAt", "desc"));

            onSnapshot(urgentQuery, (snapshot) => {
                let relevantDocs = [];

                // Filter urgent tickets based on user role - same logic as loadReceivedReports
                if (['amministratore', 'supervisore', 'adm'].includes(userRole)) {
                    if (userRole === 'amministratore') {
                        // Administrators see urgent reports assigned to them + tickets they forwarded
                        relevantDocs = snapshot.docs.filter(doc => {
                            const data = doc.data();
                            return data.recipientType === 'amministratore' || // Direct assignments
                                (data.forwardedByUserId === currentUser.uid) || // Tickets they forwarded
                                (data.originalRecipient === 'amministratore' && data.forwardedBy); // Tickets forwarded back to admin
                        });
                    } else {
                        // Supervisore and ADM see all urgent reports
                        relevantDocs = snapshot.docs;
                    }
                }
                else if (['custode', 'consigliere', 'fornitore'].includes(userRole)) {
                    if (userRole === 'custode') {
                        // Custode sees urgent tickets assigned to them AND tickets they forwarded
                        relevantDocs = snapshot.docs.filter(doc => {
                            const data = doc.data();
                            return data.recipientType === userRole ||
                                (data.recipientType === 'amministratore' && data.forwardedBy && data.originalRecipient === 'custode');
                        });
                    } else {
                        // Consigliere and Fornitore only see urgent tickets assigned directly to them
                        relevantDocs = snapshot.docs.filter(doc => doc.data().recipientType === userRole);
                    }
                }

                handleFilteredReports(relevantDocs, 'solleciti urgenti');
            });
        };

        const renderSegnalazioniUtente = () => `
            ${renderHeader('Segnalazioni Inviate')}
            <main>
                <div id="ticket-counters" class="grid grid-cols-3 gap-2" style="margin-bottom: 1rem;">
                    <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--danger);">0</div><div class="page-subtitle" style="text-transform: none;">Richieste aperte n.0</div></div>
                    <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--warning);">0</div><div class="page-subtitle" style="text-transform: none;">Richieste in corso n.0</div></div>
                    <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--primary);">0</div><div class="page-subtitle" style="text-transform: none;">Tutte</div></div>
                </div>
                <div class="card" style="margin-bottom: 1.5rem; padding: 1rem;">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="form-group" style="flex-grow: 1; margin-bottom: 0;">
                            <div style="position: relative; display: flex; align-items: center;">
                                <svg style="position: absolute; left: 1rem; width: 20px; height: 20px; color: var(--secondary-text);" fill="currentColor" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                                <input type="text" id="report-search-input" placeholder="Cerca per titolo, numero o descrizione..." class="form-input" style="padding-left: 3rem;">
                            </div>
                        </div>
                        <div class="form-group" style="flex-shrink: 0; min-width: 150px; margin-bottom: 0;">
                            <select id="report-status-filter" class="form-select">
                                <option value="all">Tutti gli stati</option>
                                <option value="aperta">Aperta</option>
                                <option value="in-corso">In Corso</option>
                                <option value="risolta">Risolta</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex-shrink: 0; min-width: 150px; margin-bottom: 0;">
                            <select id="report-recipient-filter" class="form-select">
                                <option value="all">Tutti i destinatari</option>
                                <option value="amministratore">Amministratore</option>
                                <option value="custode">Custode</option>
                                <option value="consigliere">Consiglieri</option>
                                <option value="fornitore">Fornitore</option>
                                <option value="adm">Sviluppatore</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h2 class="section-title">Ticket Attivi</h2>
                    <p class="form-label" style="margin-bottom: 1.5rem; color: var(--secondary-text);">
                        Segnalazioni aperte, in lavorazione o in attesa di una tua conferma.
                    </p>
                    <div id="user-reports-active" class="list-container"></div>
                </div>

                <div>
                    <h2 class="section-title">Ticket Chiusi</h2>
                     <p class="form-label" style="margin-bottom: 1.5rem; color: var(--secondary-text);">
                        Storico delle segnalazioni completate e archiviate.
                    </p>
                    <div id="user-reports-closed" class="list-container"></div>
                </div>
            </main>
            ${renderBottomNavigation()}
        `;

        const loadUserReports = () => {
            const activeContainer = document.getElementById('user-reports-active');
            const closedContainer = document.getElementById('user-reports-closed');
            if (!activeContainer || !closedContainer) return;

            // Reset notifiche per aggiornamenti sui report dell'utente
            localStorage.setItem(`lastSeenSegnalazioniInviate_${currentUser.uid}`, Date.now());
            updateNotificationUI('segnalazioni-inviate', 0);

            const userReportsQuery = query(collection(db, "reports"), where("createdById", "==", currentUser.uid), orderBy("createdAt", "desc"));

            onSnapshot(userReportsQuery, (snapshot) => {
                handleUserReports(snapshot.docs);
            });
        };

        const handleUserReports = (docs) => {
            const activeContainer = document.getElementById('user-reports-active');
            const closedContainer = document.getElementById('user-reports-closed');
            const searchInput = document.getElementById('report-search-input');
            const statusFilter = document.getElementById('report-status-filter');
            const counterContainer = document.getElementById('ticket-counters');

            if (!activeContainer || !closedContainer) return;

            // Aggiorna contatori
            if (counterContainer) {
                const openCount = docs.filter(doc => doc.data().status === 'aperta').length;
                const inProgressCount = docs.filter(doc => doc.data().status === 'in-corso').length;
                const totalCount = docs.length;
                counterContainer.innerHTML = `
                    <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--danger);">${openCount}</div><div class="page-subtitle" style="text-transform: none;">Richieste aperte n.${openCount}</div></div>
                    <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--warning);">${inProgressCount}</div><div class="page-subtitle" style="text-transform: none;">Richieste in corso n.${inProgressCount}</div></div>
                    <div class="card" style="padding: 0.75rem; text-align: center;"><div class="page-title" style="font-size: 1.5rem; color: var(--primary);">${totalCount}</div><div class="page-subtitle" style="text-transform: none;">Tutte</div></div>
                `;
            }

            // Funzione per il rendering con filtri
            const renderFilteredUserReports = () => {
                let filteredDocs = docs;

                // Filtra per ricerca testuale
                if (searchInput && searchInput.value) {
                    const searchTerm = searchInput.value.toLowerCase().trim();
                    filteredDocs = filteredDocs.filter(doc => {
                        const data = doc.data();
                        const reportNum = data.reportNumber ? `#${data.reportNumber}` : '';
                        return `${reportNum} ${data.title} ${data.description}`.toLowerCase().includes(searchTerm);
                    });
                }

                // Filtra per stato
                if (statusFilter && statusFilter.value !== 'all') {
                    filteredDocs = filteredDocs.filter(doc => doc.data().status === statusFilter.value);
                }

                // Filtra per destinatario
                const recipientFilter = document.getElementById('report-recipient-filter');
                if (recipientFilter && recipientFilter.value !== 'all') {
                    filteredDocs = filteredDocs.filter(doc => doc.data().recipientType === recipientFilter.value);
                }

                // Separa in attivi e chiusi
                const activeTickets = [];
                const closedTickets = [];

                filteredDocs.forEach(doc => {
                    const report = doc.data();
                    if (report.status === 'chiusa' || report.status === 'risolta') {
                        closedTickets.push({ id: doc.id, data: report });
                    } else {
                        activeTickets.push({ id: doc.id, data: report });
                    }
                });

                // Ordina per data di creazione
                const sortByDate = (a, b) => {
                    const timeA = a.data.createdAt?.toMillis() || 0;
                    const timeB = b.data.createdAt?.toMillis() || 0;
                    return timeB - timeA;
                };

                activeTickets.sort(sortByDate);
                closedTickets.sort(sortByDate);

                // Renderizza i risultati
                if (activeTickets.length === 0) {
                    activeContainer.innerHTML = `<div class="card"><p style="color:var(--secondary-text); padding: 1rem 0;">Nessun ticket attivo trovato.</p></div>`;
                } else {
                    activeContainer.innerHTML = activeTickets.map((t, index) => renderReportCardHTML(t.data, t.id, index + 1)).join("");
                }

                if (closedTickets.length === 0) {
                    closedContainer.innerHTML = `<div class="card"><p style="color:var(--secondary-text); padding: 1rem 0;">Nessun ticket chiuso trovato.</p></div>`;
                } else {
                    closedContainer.innerHTML = closedTickets.map((t, index) => renderReportCardHTML(t.data, t.id, index + 1)).join("");
                }
            };

            // Esegui il primo rendering
            renderFilteredUserReports();

            // Aggiungi event listener ai filtri
            if (searchInput) {
                searchInput.oninput = renderFilteredUserReports;
            }
            if (statusFilter) {
                statusFilter.onchange = renderFilteredUserReports;
            }
            const recipientFilter = document.getElementById('report-recipient-filter');
            if (recipientFilter) {
                recipientFilter.onchange = renderFilteredUserReports;
            }
        };

        const deleteUser = async (userId, userName) => {
            if (!confirm(`Sei sicuro di voler eliminare l'utente ${userName}? L'utente verrà rimosso dal sistema e non potrà più accedere. L'azione è irreversibile.`)) {
                return;
            }
            try {
                await deleteDoc(doc(db, 'users', userId));
                await logActivity("user_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { deletedUserId: userId, deletedUserName: userName });
                // Nota: L'eliminazione dell'utente da Firebase Authentication non può essere eseguita in modo sicuro dal client.
                // Richiede una Cloud Function o la riautenticazione dell'utente da eliminare.
                // Eliminando il documento utente da Firestore, l'utente non potrà più caricare il suo profilo e usare l'app.
                loadUsers(); // Ricarica la lista per riflettere il cambiamento
            } catch (error) {
                console.error("Errore durante l'eliminazione dell'utente:", error);
                alert(`Si è verificato un errore: ${error.message}`);
            }
        };

        const updateUser = async (event) => {
            event.preventDefault();
            const form = event.target;
            const userId = form.querySelector('#edit-user-id').value;
            const submitButton = form.querySelector('button[type="submit"]');
            const messageBox = form.querySelector('#edit-user-message');

            submitButton.disabled = true;
            submitButton.textContent = 'Salvataggio...';
            messageBox.style.display = 'none';

            try {
                const updatedProperties = [];
                let totalMillesimi = 0;
                const propertyRows = form.querySelectorAll('.property-edit-row');

                propertyRows.forEach(row => {
                    const interno = row.querySelector('input[data-field="interno"]').value.trim();
                    const millesimi = parseFloat(row.querySelector('input[data-field="millesimi"]').value) || 0;
                    const gruppo = row.querySelector('select[data-field="gruppo"]').value;
                        const pianoSelect = row.querySelector('select[data-field="piano"]');
                        const piano = pianoSelect.value ? parseInt(pianoSelect.value, 10) : null;

                        if (interno) {
                            updatedProperties.push({ interno, millesimi, gruppo, piano });
                            totalMillesimi += millesimi;
                        }
                });

                const updatedData = {
                    nome: form.querySelector('#edit-nome').value,
                    cognome: form.querySelector('#edit-cognome').value,
                    tipoUtente: form.querySelector('#edit-tipo-utente').value,
                    telefono: form.querySelector('#edit-telefono').value,
                    proprieta: updatedProperties,
                    millesimiTotali: totalMillesimi
                };

                await updateDoc(doc(db, "users", userId), updatedData);
                await logActivity("user_updated", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { updatedUserId: userId, changes: updatedData });

                hideModal();
                if (currentPage === 'userManagement_edit') {
                    loadUsers();
                }
            } catch (error) {
                console.error("Errore durante l'aggiornamento dell'utente:", error);
                messageBox.className = 'message-box error';
                messageBox.textContent = `Errore: ${error.message}`;
                messageBox.style.display = 'block';
                submitButton.disabled = false;
                submitButton.textContent = 'Salva Modifiche';
            }
        };

        const openUserEditModal = async (user) => {
            // Carica i gruppi disponibili prima di costruire il modal
            try {
                const q = query(collection(db, "partialCondos"), orderBy("name"));
                const querySnapshot = await getDocs(q);
                availableGroups = querySnapshot.docs.map(doc => doc.data());
            } catch (error) {
                console.error("Impossibile caricare i gruppi per il modal:", error);
                availableGroups = []; // Assicura che sia un array vuoto in caso di errore
            }

            let allRoles = ["condomino", "amministratore", "custode", "consigliere", "fornitore", "supervisore"];
            if (userProfile?.tipoUtente === 'adm') {
                allRoles.push("adm");
            }
            const rolesOptions = allRoles.map(role => {
                const capitalizedRole = role === 'adm'
                    ? 'Admin (ADM)'
                    : role.charAt(0).toUpperCase() + role.slice(1);
                return `<option value="${role}" ${user.tipoUtente === role ? 'selected' : ''}>${capitalizedRole}</option>`
            }).join('');

            const isSupervisor = ['supervisore', 'adm'].includes(userProfile?.tipoUtente);
            const propertiesHtml = (user.proprieta || []).map((prop, index) => {
                const groupOptionsHtml = availableGroups.map(group =>
                    `<option value="${group.name}" data-start="${group.startPlan}" data-end="${group.endPlan}" ${prop.gruppo === group.name ? 'selected' : ''}>${group.name}</option>`
                ).join('');

                let planOptionsHtml = '<option value="">Seleziona gruppo</option>';
                const selectedGroup = availableGroups.find(g => g.name === prop.gruppo);
                if (selectedGroup) {
                    for (let i = selectedGroup.startPlan; i <= selectedGroup.endPlan; i++) {
                        planOptionsHtml += `<option value="${i}" ${prop.piano === i ? 'selected' : ''}>${i}</option>`;
                    }
                }

                return `
                <div class="property-edit-row grid grid-cols-5 gap-2 items-center" style="margin-bottom: 0.5rem;" data-row-index="${index}">
                    <input type="text" data-field="interno" value="${prop.interno || ''}" class="form-input" placeholder="ID Unità">
                    <input type="number" step="0.01" data-field="millesimi" value="${prop.millesimi || 0}" class="form-input" placeholder="Millesimi">
                    <select data-field="gruppo" class="form-select">${groupOptionsHtml}</select>
                    <select data-field="piano" class="form-select" ${!isSupervisor ? 'disabled' : ''}>${planOptionsHtml}</select>
                    <button type="button" onclick="this.parentElement.remove()" class="btn-icon" style="background:var(--danger); color:white;">&times;</button>
                </div>
                `;
            }).join('');

            const modalContent = `
                <form id="edit-user-form" class="space-y-4" onsubmit="updateUser(event)">
                    <input type="hidden" id="edit-user-id" value="${user.id}">
                    <div id="edit-user-message" class="message-box"></div>
                    <div class="form-group"><label class="form-label">Email</label><input type="email" value="${user.email || ''}" class="form-input" disabled></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group"><label for="edit-nome" class="form-label">Nome</label><input id="edit-nome" type="text" required class="form-input" value="${user.nome || ''}"></div>
                        <div class="form-group"><label for="edit-cognome" class="form-label">Cognome</label><input id="edit-cognome" type="text" required class="form-input" value="${user.cognome || ''}"></div>
                    </div>
                    <div class="form-group"><label for="edit-tipo-utente" class="form-label">Tipo Utente</label><select id="edit-tipo-utente" required class="form-select">${rolesOptions}</select></div>
                    <div class="form-group"><label for="edit-telefono" class="form-label">Telefono</label><input id="edit-telefono" type="tel" class="form-input" value="${user.telefono || ''}"></div>
                    <hr style="border-color: var(--surface-color-light); margin: 1.5rem 0;">
                    <div class="form-group">
                        <div class="flex justify-between items-center mb-2">
                            <label class="form-label" style="margin-bottom:0;">Proprietà, Millesimi e Gruppi</label>
                            <button type="button" onclick="addPropertyRow()" class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size:0.8rem;">+ Aggiungi</button>
                        </div>
                        <div id="properties-editor-container">${propertiesHtml}</div>
                    </div>
                    <div class="flex justify-end gap-4 pt-2">
                       <button type="button" class="btn btn-secondary" onclick="hideModal()">Annulla</button>
                       <button type="submit" class="btn btn-primary">Salva Modifiche</button>
                    </div>
                </form>
            `;

            showModal(`Modifica Utente: ${user.nome} ${user.cognome}`, modalContent);
            
            // Add event listeners for dynamic plan selects
            document.querySelectorAll('.property-edit-row .form-select[data-field="gruppo"]').forEach(groupSelect => {
                groupSelect.addEventListener('change', (e) => {
                    const row = e.target.closest('.property-edit-row');
                    const planSelect = row.querySelector('select[data-field="piano"]');
                    const selectedOption = e.target.options[e.target.selectedIndex];

                    if (!selectedOption || !selectedOption.dataset.start) {
                        planSelect.innerHTML = '<option>Seleziona gruppo</option>';
                        return;
                    }

                    const start = parseInt(selectedOption.dataset.start, 10);
                    const end = parseInt(selectedOption.dataset.end, 10);
                    
                    let planOptionsHtml = '<option value="" disabled selected>Piano...</option>';
                    for (let i = start; i <= end; i++) {
                        planOptionsHtml += `<option value="${i}">${i}</option>`;
                    }
                    planSelect.innerHTML = planOptionsHtml;
                });
            });
        };

        const loadUsers = async () => {
            const container = document.getElementById('user-list-container');
            if (!container) return;
            if (!['supervisore', 'adm'].includes(userProfile?.tipoUtente)) {
                container.innerHTML = '<p>Accesso non autorizzato.</p>';
                return;
            }
            try {
                const searchTerm = document.getElementById('user-edit-search')?.value.toLowerCase().trim() || '';
                const usersSnapshot = await getDocs(query(collection(db, "users"), orderBy("cognome")));

                const filteredUsers = usersSnapshot.docs.filter(doc => {
                    if (!searchTerm) return true;
                    const user = doc.data();
                    const fullName = `${user.nome || ''} ${user.cognome || ''}`.toLowerCase();
                    return fullName.includes(searchTerm);
                });

                if (filteredUsers.length === 0) {
                    container.innerHTML = '<p>Nessun utente trovato con i criteri di ricerca.</p>';
                } else {
                    container.innerHTML = filteredUsers.map(docSnap => {
                        const user = docSnap.data();
                        const userId = docSnap.id;
                        const propertiesHtml = user.proprieta && user.proprieta.length > 0
                            ? user.proprieta.map(p => `<li>${p.interno}: Piano ${p.piano ?? 'N/A'}, ${(p.millesimi || 0).toFixed(2)} ‰ ${p.gruppo ? `- <strong>Gruppo:</strong> ${p.gruppo}` : ''}</li>`).join('')
                            : '<li>Nessuna proprietà</li>';

                        const userObjectString = JSON.stringify({ id: userId, ...user }).replace(/'/g, "&apos;");

                        return `
                        <div class="card" style="margin-bottom: 1rem;">
                            <div class="list-item" style="padding:0; cursor:default; align-items: flex-start;">
                                <div class="list-item-icon" style="margin-top: 0.5rem;"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></svg></div>
                                <div class="list-item-content" style="padding-top: 0.5rem;">
                                    <div class="title">${user.nome} ${user.cognome}</div>
                                    <div class="subtitle">${user.email} - ${user.tipoUtente}</div>
                                </div>
                                <div class="list-item-action flex gap-2" style="padding-top: 0.5rem;">
                                    <button class="user-action-btn" onclick='openUserEditModal(${userObjectString})' title="Modifica Utente">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                    </button>
                                    ${user.tipoUtente !== 'adm' ? `
                                    <button class="user-action-btn" onclick="deleteUser('${userId}', '${user.nome} ${user.cognome}')" title="Elimina Utente">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                            <div style="padding-left: 64px; margin-top: 0.5rem; font-size: 0.9rem;">
                                <strong class="form-label" style="color:var(--primary-text);">Proprietà e Millesimi:</strong>
                                <ul style="list-style-type: disc; margin-left: 20px; color: var(--secondary-text);">
                                   ${propertiesHtml}
                                </ul>
                                <hr style="border-color: var(--surface-color); margin: 0.75rem 0;">
                                <div style="display:flex; justify-content:space-between; font-weight:600;"><span>Millesimi Totali:</span><span>${(user.millesimiTotali || 0).toFixed(2)} ‰</span></div>
                            </div>
                        </div>`;
                    }).join("");
                }
            } catch (error) {
                console.error("Errore nel caricare gli utenti:", error);
                container.innerHTML = '<p>Errore nel caricamento degli utenti.</p>';
            }
        };

        const loadUserListTable = async () => {
            const container = document.getElementById('user-summary-table-container');
            if (!container) return;
            try {
                const searchTerm = document.getElementById('user-list-search')?.value.toLowerCase().trim() || '';
                const usersSnapshot = await getDocs(query(collection(db, "users"), orderBy("cognome")));

                const filteredUsers = usersSnapshot.docs.filter(doc => {
                    if (!searchTerm) return true;
                    const user = doc.data();
                    const fullName = `${user.nome || ''} ${user.cognome || ''}`.toLowerCase();
                    return fullName.includes(searchTerm);
                });

                if (filteredUsers.length === 0) {
                    container.innerHTML = '<p>Nessun utente trovato con i criteri di ricerca.</p>';
                    return;
                }

                let tableHtml = `<table class="data-table"><thead><tr><th>Nome</th><th>Cognome</th><th>Proprietà</th><th>Piano</th><th>Raggruppamento</th><th>Millesimi</th></tr></thead><tbody>`;

                filteredUsers.forEach(docSnap => {
                    const user = docSnap.data();
                    const userObjectString = JSON.stringify({ id: docSnap.id, ...user }).replace(/'/g, "&apos;");
                    const editIconHtml = `<button class="inline-edit-btn" onclick='openUserEditModal(${userObjectString})' title="Modifica utente"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M14.06,9L15,9.94L5.92,19H5V18.08L14.06,9M17.66,3C17.41,3 17.15,3.1 16.96,3.29L15.13,5.12L18.88,8.87L20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18.17,3.09 17.92,3 17.66,3M14.06,6.19L3,17.25V21H6.75L17.81,9.94L14.06,6.19Z"/></svg></button>`;
                    const createCell = (content) => `<div class="cell-content-wrapper"><span>${content}</span>${editIconHtml}</div>`;

                    if (user.proprieta && user.proprieta.length > 0) {
                        user.proprieta.forEach((prop, index) => {
                            tableHtml += `<tr>
                                ${index === 0 ? `<td data-label="Nome" rowspan="${user.proprieta.length}">${createCell(user.nome)}</td><td data-label="Cognome" rowspan="${user.proprieta.length}">${createCell(user.cognome)}</td>` : ''}
                                <td data-label="Proprietà">${createCell(prop.interno || 'N/D')}</td>
                                <td data-label="Piano">${createCell(prop.piano ?? 'N/A')}</td>
                                <td data-label="Raggruppamento">${createCell(prop.gruppo || 'N/D')}</td>
                                <td data-label="Millesimi">${createCell((prop.millesimi || 0).toFixed(2))}</td>
                            </tr>`;
                        });
                    } else {
                        tableHtml += `<tr>
                            <td data-label="Nome">${createCell(user.nome)}</td>
                            <td data-label="Cognome">${createCell(user.cognome)}</td>
                            <td data-label="Proprietà">${createCell('Nessuna')}</td>
                            <td data-label="Piano">${createCell('N/A')}</td>
                            <td data-label="Raggruppamento">${createCell('N/D')}</td>
                            <td data-label="Millesimi">${createCell('0.00')}</td>
                        </tr>`;
                    }
                });

                tableHtml += `</tbody></table>`;
                container.innerHTML = tableHtml;

            } catch (error) {
                console.error("Errore nel caricare la tabella utenti:", error);
                container.innerHTML = '<p>Errore nel caricamento della tabella utenti.</p>';
            }
        };

        // Funzione helper per riordinare le colonne secondo la sequenza richiesta
        const reorderColumns = (data, headers) => {
            const desiredOrder = ['INTERVENTO RICHIESTO', 'IMPRESA', '1 NUM. TELEFONICO', '2 NUM. TELEFONICO', 'AZIONE'];

            // Mappa per convertire i nomi delle colonne esistenti
            const columnMapping = {
                'Intervento richiesto': 'INTERVENTO RICHIESTO',
                'Impresa': 'IMPRESA',
                '1 num.Telefonico': '1 NUM. TELEFONICO',
                '1 num. Telefonico': '1 NUM. TELEFONICO',
                '2 num.Telefonico': '2 NUM. TELEFONICO',
                '2 num. Telefonico': '2 NUM. TELEFONICO',
                'Azione': 'AZIONE'
            };

            // Trova le colonne corrispondenti nell'ordine desiderato
            const orderedHeaders = [];
            const orderedData = [];

            desiredOrder.forEach(desiredCol => {
                const foundHeader = headers.find(h => {
                    const normalizedH = h.trim();
                    return normalizedH === desiredCol || columnMapping[normalizedH] === desiredCol;
                });
                if (foundHeader) {
                    orderedHeaders.push(desiredCol);
                    // Riorganizza i dati per questa colonna
                    data.forEach((row, rowIndex) => {
                        if (!orderedData[rowIndex]) orderedData[rowIndex] = {};
                        orderedData[rowIndex][desiredCol] = row[foundHeader];
                    });
                }
            });

            // Aggiungi le colonne rimanenti che non sono nell'ordine desiderato
            headers.forEach(h => {
                if (!orderedHeaders.includes(h) && !Object.values(columnMapping).includes(h)) {
                    orderedHeaders.push(h);
                    data.forEach((row, rowIndex) => {
                        if (!orderedData[rowIndex]) orderedData[rowIndex] = {};
                        orderedData[rowIndex][h] = row[h];
                    });
                }
            });

            return { headers: orderedHeaders, data: orderedData };
        };

        const loadUsefulNumbers = () => {
            const manualTableBody = document.getElementById('useful-numbers-table-body');
            const importedTableContainer = document.getElementById('imported-numbers-table-container');
            const canManage = userProfile?.tipoUtente === 'supervisore';

            if (manualTableBody) {
                const qManual = query(collection(db, "usefulNumbers"), orderBy("createdAt", "desc"));
                onSnapshot(qManual, (snapshot) => {
                    if (snapshot.empty) {
                        manualTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:var(--secondary-text);">Nessun contatto inserito.</td></tr>`;
                        return;
                    }

                    // Aggiungi header per checkbox e azioni se l'utente può gestire
                    const headerRow = canManage ?
                        `<tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="select-all-contacts" onchange="toggleAllContacts(this)">
                            </th>
                            <th>INTERVENTO RICHIESTO</th>
                            <th>IMPRESA</th>
                            <th>1 NUM. TELEFONICO</th>
                            <th>2 NUM. TELEFONICO</th>
                            <th style="text-align:right;">AZIONI</th>
                        </tr>` :
                        `<tr>
                            <th>INTERVENTO RICHIESTO</th>
                            <th>IMPRESA</th>
                            <th>1 NUM. TELEFONICO</th>
                            <th>2 NUM. TELEFONICO</th>
                        </tr>`;

                    const tableHeader = `<thead>${headerRow}</thead>`;

                    // Aggiungi pulsante per eliminazione multipla se l'utente può gestire
                    const bulkActionsHtml = canManage ?
                        `<div class="flex gap-2 mt-4" id="bulk-actions" style="display: none;">
                            <button onclick="deleteSelectedContacts()" class="btn" style="background:var(--danger); color:white;">
                                Elimina Selezionati
                            </button>
                        </div>` : '';

                    // Inserisci le azioni bulk prima della tabella
                    const tableContainer = manualTableBody.closest('.data-table-container');
                    if (tableContainer && canManage) {
                        const existingBulkActions = tableContainer.querySelector('#bulk-actions');
                        if (!existingBulkActions) {
                            tableContainer.insertAdjacentHTML('afterbegin', bulkActionsHtml);
                        }
                    }

                    const rowsHtml = snapshot.docs.map(docSnap => {
                        const contact = docSnap.data();
                        if (canManage) {
                            const editIcon = `<button onclick="editUsefulNumber('${docSnap.id}', ${JSON.stringify(contact).replace(/"/g, '&quot;')})" class="btn-icon" title="Modifica" style="margin-right: 0.5rem;">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                            </button>`;
                            const deleteIcon = `<button onclick="deleteUsefulNumber('${docSnap.id}')" class="btn-icon" title="Elimina" style="background:var(--danger); color:white;">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                            </button>`;

                            return `<tr>
                                <td><input type="checkbox" class="contact-checkbox" value="${docSnap.id}" onchange="updateBulkActions()"></td>
                                <td>${contact.title}</td>
                                <td>${contact.company || '–'}</td>
                                <td>${contact.number}</td>
                                <td>${contact.number2 || '–'}</td>
                                <td style="text-align:right;">${editIcon}${deleteIcon}</td>
                            </tr>`;
                        } else {
                            return `<tr>
                                <td>${contact.title}</td>
                                <td>${contact.company || '–'}</td>
                                <td>${contact.number}</td>
                                <td>${contact.number2 || '–'}</td>
                            </tr>`;
                        }
                    }).join('');

                    manualTableBody.innerHTML = tableHeader + `<tbody>${rowsHtml}</tbody>`;
                });
            }
            if (importedTableContainer) {
                const qImported = query(collection(db, "importedPhoneNumbers"), orderBy("uploadedAt", "desc"), limit(1));
                onSnapshot(qImported, (snapshot) => {
                    if (snapshot.empty) {
                        importedTableContainer.innerHTML = `<p style="color:var(--secondary-text);">Nessun contatto importato trovato.</p>`;
                        return;
                    }
                    const data = snapshot.docs[0].data().tableData;
                    if (!data || data.length === 0) {
                        importedTableContainer.innerHTML = `<p style="color:var(--secondary-text);">Il file importato è vuoto.</p>`;
                        return;
                    }
                    const headers = Object.keys(data[0]);
                    const { headers: orderedHeaders, data: orderedData } = reorderColumns(data, headers);

                    // Aggiungi header per checkbox e azioni se l'utente può gestire
                    const headerRow = canManage ?
                        `<tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="select-all-contacts-imported" onchange="toggleAllContactsImported(this)">
                            </th>
                            ${orderedHeaders.map(h => `<th>${h}</th>`).join('')}
                            <th style="text-align:right;">AZIONI</th>
                        </tr>` :
                        `<tr>${orderedHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;

                    let tableHTML = '<table class="data-table"><thead>' + headerRow + '</thead><tbody>';

                    orderedData.forEach((row, index) => {
                        tableHTML += '<tr>';
                        if (canManage) {
                            tableHTML += `<td><input type="checkbox" class="contact-checkbox-imported" value="${index}" onchange="updateBulkActionsImported()"></td>`;
                        }
                        orderedHeaders.forEach(h => tableHTML += `<td>${row[h] !== undefined ? row[h] : ''}</td>`);

                        if (canManage) {
                            const editIcon = `<button onclick="editImportedContact(${index}, ${JSON.stringify(row).replace(/"/g, '&quot;')})" class="btn-icon" title="Modifica" style="margin-right: 0.5rem;">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                            </button>`;
                            const deleteIcon = `<button onclick="deleteImportedContact(${index})" class="btn-icon" title="Elimina" style="background:var(--danger); color:white;">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                            </button>`;
                            tableHTML += `<td style="text-align:right;">${editIcon}${deleteIcon}</td>`;
                        }
                        tableHTML += '</tr>';
                    });
                    tableHTML += '</tbody></table>';

                    importedTableContainer.innerHTML = tableHTML;

                    // Aggiungi pulsante per eliminazione multipla se l'utente può gestire
                    if (canManage) {
                        const bulkActionsHtml = `<div class="flex gap-2 mt-4" id="bulk-actions-imported" style="display: none;">
                            <button onclick="deleteSelectedContactsImported()" class="btn" style="background:var(--danger); color:white;">
                                Elimina Selezionati
                            </button>
                        </div>`;
                        importedTableContainer.insertAdjacentHTML('afterbegin', bulkActionsHtml);
                    }
                });
            }
        };

        const voteOnPoll = async (pollId, optionIndex) => {
            try {
                const settingsRef = doc(db, "settings", "pollCreationAuthorization");
                const settingsSnap = await getDoc(settingsRef);
                const pollSetting = settingsSnap.exists() ? settingsSnap.data().setting : "option2";
                if (!isUserAllowedToVote(userProfile.tipoUtente, pollSetting)) {
                    return alert("Non sei autorizzato a votare in questo sondaggio.");
                }

                const pollRef = doc(db, "polls", pollId);
                const pollSnap = await getDoc(pollRef);
                if (!pollSnap.exists()) return;

                const poll = pollSnap.data();
                if (poll.deadline && poll.deadline.toDate() < new Date()) return alert("Sondaggio scaduto.");

                const updatedOptions = [...poll.options];
                let updatedVoters = [...poll.voters || []];
                const voterIndex = updatedVoters.findIndex(v => v.uid === currentUser.uid);

                // Se l'utente ha già votato, annulla il suo voto precedente
                if (voterIndex > -1) {
                    const oldVoteRecord = updatedVoters[voterIndex];
                    const oldChoices = oldVoteRecord.vote.split(', ');
                    oldChoices.forEach(oldChoiceText => {
                        const optionToDecrement = updatedOptions.find(opt => opt.text === oldChoiceText);
                        if (optionToDecrement && optionToDecrement.votes > 0) {
                            optionToDecrement.votes -= 1;
                        }
                    });
                    // Rimuovi il vecchio record di voto
                    updatedVoters.splice(voterIndex, 1);
                }

                // Applica il nuovo voto
                let newSelectedOptionsText = [];
                if (typeof optionIndex !== 'undefined') { // Risposta singola
                    updatedOptions[optionIndex].votes = (updatedOptions[optionIndex].votes || 0) + 1;
                    newSelectedOptionsText.push(poll.options[optionIndex].text);
                } else { // Risposta multipla
                    const checkedBoxes = document.querySelectorAll(`.poll-option-checkbox-${pollId}:checked`);
                    if (checkedBoxes.length === 0) return alert("Seleziona almeno un'opzione per votare.");

                    checkedBoxes.forEach(box => {
                        const idx = parseInt(box.value, 10);
                        if (!isNaN(idx) && updatedOptions[idx]) {
                            updatedOptions[idx].votes = (updatedOptions[idx].votes || 0) + 1;
                            newSelectedOptionsText.push(poll.options[idx].text);
                        }
                    });
                }

                // Aggiungi il nuovo record di voto
                const userMillesimi = userProfile?.millesimiTotali || 0;
                updatedVoters.push({
                    uid: currentUser.uid,
                    name: `${userProfile.nome} ${userProfile.cognome}`,
                    vote: newSelectedOptionsText.join(', '),
                    millesimi: userMillesimi
                });

                await updateDoc(pollRef, { options: updatedOptions, voters: updatedVoters });
                await logActivity("poll_voted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, {
                    pollTitle: poll.title,
                    option: newSelectedOptionsText.join(', '),
                    isChange: voterIndex > -1
                });

            } catch (error) {
                console.error("Errore nel voto:", error);
                alert("Si è verificato un errore durante il voto.");
            }
        };

        const updateReportStatus = async (reportId, newStatus, updateText = null) => {
            try {
                const reportRef = doc(db, "reports", reportId);
                const updateData = {
                    status: newStatus,
                    updatedAt: serverTimestamp()
                };

                // Aggiungi timestamp quando viene preso in carico
                if (newStatus === 'in-corso') {
                    updateData.takenInChargeAt = serverTimestamp();
                    // Clear urgent flag when ticket is taken in charge
                    updateData.isUrgent = false;

                    // Add automatic update message for taking charge
                    if (!updateText) {
                        const takeChargeUpdate = {
                            text: `Segnalazione presa in carico da ${userProfile.nome} ${userProfile.cognome}`,
                            by: `${userProfile.nome} ${userProfile.cognome}`,
                            at: new Date()
                        };
                        updateData.updates = arrayUnion(takeChargeUpdate);
                    }
                }

                // Clear urgent flag and add automatic messages when ticket is resolved or closed
                if (newStatus === 'risolta') {
                    updateData.isUrgent = false;
                    updateData.resolvedAt = serverTimestamp();

                    // Add automatic update message for resolution if no custom text provided
                    if (!updateText) {
                        const resolvedUpdate = {
                            text: `Segnalazione marcata come risolta da ${userProfile.nome} ${userProfile.cognome}`,
                            by: `${userProfile.nome} ${userProfile.cognome}`,
                            at: new Date()
                        };
                        updateData.updates = arrayUnion(resolvedUpdate);
                    }
                }

                if (newStatus === 'chiusa') {
                    updateData.isUrgent = false;
                    updateData.closedAt = serverTimestamp();

                    // Add automatic update message for closure if no custom text provided
                    if (!updateText) {
                        const closedUpdate = {
                            text: `Segnalazione chiusa da ${userProfile.nome} ${userProfile.cognome}`,
                            by: `${userProfile.nome} ${userProfile.cognome}`,
                            at: new Date()
                        };
                        updateData.updates = arrayUnion(closedUpdate);
                    }
                }

                if (updateText) {
                    const newUpdate = {
                        text: updateText,
                        by: `${userProfile.nome} ${userProfile.cognome}`,
                        at: new Date() // Usiamo un timestamp client per l'array
                    };
                    updateData.updates = arrayUnion(newUpdate);
                }

                await updateDoc(reportRef, updateData);
                await logActivity("report_status_updated", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { reportId: reportId, newStatus: newStatus });

                // Show success message
                if (newStatus === 'in-corso') {
                    alert("Segnalazione presa in carico con successo!");
                } else if (newStatus === 'risolta') {
                    alert("Segnalazione marcata come risolta!");
                } else if (newStatus === 'chiusa') {
                    alert("Segnalazione chiusa!");
                }

            } catch (error) {
                console.error("Errore nell'aggiornamento dello stato:", error);
                alert("Si è verificato un errore nell'aggiornamento dello stato della segnalazione.");
            }
        };

        const toggleContactSharing = async (reportId, shareContacts) => {
            try {
                const reportRef = doc(db, "reports", reportId);
                await updateDoc(reportRef, {
                    shareContactWithSupplier: shareContacts,
                    updatedAt: serverTimestamp()
                });

                const actionText = shareContacts ? 'abilitata' : 'disabilitata';
                alert(`Condivisione contatti ${actionText} con successo.`);

                // Log the activity
                await logActivity("contact_sharing_toggled", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, {
                    reportId: reportId,
                    shareContacts: shareContacts
                });

            } catch (error) {
                console.error("Errore nella modifica della condivisione contatti:", error);
                alert("Si è verificato un errore nella modifica della condivisione contatti.");
            }
        };

        const openReportUpdateModal = (reportId) => {
            const modalContent = `
                <form id="report-update-form" class="space-y-4">
                    <input type="hidden" id="update-report-id" value="${reportId}">
                    <div>
                        <label for="update-text" class="form-label">Testo dell'aggiornamento</label>
                        <textarea id="update-text" rows="4" required class="form-textarea" placeholder="Scrivi qui l'aggiornamento..."></textarea>
                    </div>
                    
                    <!-- Sezione per allegati -->
                    <div>
                        <label class="form-label">Allegati (opzionale)</label>
                        <div class="attachment-upload-container" onclick="document.getElementById('update-file-input').click()">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 48px; height: 48px; color: var(--secondary-text); margin-bottom: 0.5rem;">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                            </svg>
                            <p style="color: var(--secondary-text); margin: 0;">Clicca per aggiungere foto o documenti</p>
                            <p style="color: var(--secondary-text); font-size: 0.8rem; margin: 0.5rem 0 0 0;">Formati supportati: JPG, PNG, PDF, DOC, DOCX</p>
                        </div>
                        <input type="file" id="update-file-input" multiple accept="image/*,.pdf,.doc,.docx" style="display: none;">
                        <div id="update-attachment-previews" class="attachment-previews"></div>
                    </div>
                    
                    <div class="flex justify-end gap-4 pt-2">
                        <button type="button" class="btn btn-secondary" onclick="hideModal()">Annulla</button>
                        <button type="submit" class="btn btn-primary">Invia Aggiornamento</button>
                    </div>
                </form>
            `;
            showModal('Aggiungi Aggiornamento', modalContent);

            // Setup file input handler
            const fileInput = document.getElementById('update-file-input');
            const previewContainer = document.getElementById('update-attachment-previews');
            let selectedUpdateFiles = [];

            fileInput.addEventListener('change', (e) => {
                selectedUpdateFiles = Array.from(e.target.files);
                displayUpdateFilePreviews();
            });

            const displayUpdateFilePreviews = () => {
                previewContainer.innerHTML = '';
                selectedUpdateFiles.forEach((file, index) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';

                    if (file.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = URL.createObjectURL(file);
                        img.alt = file.name;
                        previewItem.appendChild(img);
                    } else {
                        const docIcon = document.createElement('div');
                        docIcon.innerHTML = `
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 100%; height: 100%; color: var(--secondary-text);">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                            </svg>
                            <p style="font-size: 0.7rem; margin-top: 0.25rem; text-align: center;">${file.name}</p>
                        `;
                        previewItem.appendChild(docIcon);
                    }

                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '×';
                    removeBtn.className = 'preview-remove-btn';
                    removeBtn.onclick = (e) => {
                        e.preventDefault();
                        selectedUpdateFiles.splice(index, 1);
                        displayUpdateFilePreviews();
                    };
                    previewItem.appendChild(removeBtn);
                    previewContainer.appendChild(previewItem);
                });
            };

            document.getElementById('report-update-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = document.getElementById('update-text').value.trim();
                if (!text) return;

                try {
                    // Upload files if any
                    let fileUrls = [];
                    if (selectedUpdateFiles.length > 0) {
                        for (const file of selectedUpdateFiles) {
                            const fileName = `${Date.now()}_${file.name}`;
                            const fileRef = ref(storage, `reports/${reportId}/updates/${fileName}`);
                            await uploadBytes(fileRef, file);
                            const downloadURL = await getDownloadURL(fileRef);
                            fileUrls.push(downloadURL);
                        }
                    }

                    const newUpdate = {
                        text: text,
                        by: `${userProfile.nome} ${userProfile.cognome}`,
                        at: new Date(),
                        fileUrls: fileUrls.length > 0 ? fileUrls : null
                    };

                    await updateDoc(doc(db, "reports", reportId), {
                        updates: arrayUnion(newUpdate),
                        updatedAt: serverTimestamp()
                    });
                    await logActivity("report_comment_added", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { reportId: reportId });
                    hideModal();
                } catch (error) {
                    console.error("Errore nell'aggiungere l'aggiornamento:", error);
                    alert("Si è verificato un errore.");
                }
            });
        };

        const sendReportReminder = async (reportId) => {
            if (!confirm("Vuoi inviare un sollecito per questa segnalazione?")) return;
            try {
                const reportRef = doc(db, "reports", reportId);
                let reportDocSnap;
                await runTransaction(db, async (transaction) => {
                    reportDocSnap = await transaction.get(reportRef);
                    if (!reportDocSnap.exists()) throw "Segnalazione non trovata.";

                    const currentReminderCount = reportDocSnap.data().reminderCount || 0;
                    const newUpdate = {
                        text: "L'utente ha inviato un sollecito.",
                        by: "Sistema",
                        at: new Date()
                    };

                    transaction.update(reportRef, {
                        lastReminderAt: serverTimestamp(),
                        reminderCount: currentReminderCount + 1,
                        updates: arrayUnion(newUpdate),
                        isUrgent: true // NUOVO: Marca il ticket come urgente
                    });
                });

                // --- WEBHOOK TRIGGER: Call webhook after sollecito creation ---
                (async () => {
                    try {
                        const WEBHOOK_URL = "https://primary-production-36d20.up.railway.app/webhook-test/98dd3855-bcf5-4ef3-867b-2888ef3f801c";
                        // Extract receiver email from Firestore based on report recipientType
                        let receiverEmail = null;
                        let recipientType = reportDocSnap.data().recipientType;
                        let recipientQuery = null;
                        if (recipientType === "amministratore") {
                            recipientQuery = query(collection(db, "users"), where("tipoUtente", "==", "amministratore"));
                        } else if (recipientType === "custode") {
                            recipientQuery = query(collection(db, "users"), where("tipoUtente", "==", "custode"));
                        } else if (recipientType === "consigliere") {
                            recipientQuery = query(collection(db, "users"), where("tipoUtente", "==", "consigliere"));
                        } else if (recipientType === "adm") {
                            recipientQuery = query(collection(db, "users"), where("tipoUtente", "==", "adm"));
                        }
                        if (recipientQuery) {
                            const snapshot = await getDocs(recipientQuery);
                            if (!snapshot.empty) {
                                receiverEmail = snapshot.docs[0].data().email;
                            }
                        }

                        const payload = {
                            event: "solleciti.create",
                            reportId: reportId,
                            report: reportDocSnap.data(),
                            user: {
                                id: currentUser.uid,
                                name: `${userProfile.nome} ${userProfile.cognome}`,
                                email: currentUser.email
                            },
                            receiverEmail: receiverEmail
                        };
                        await fetch(WEBHOOK_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                    } catch (err) {
                        console.error("Errore invio webhook sollecito:", err);
                    }
                })();

                await logActivity("report_reminder_sent", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { reportId: reportId });
                alert("Sollecito inviato.");
            } catch (error) {
                console.error("Errore nell'invio del sollecito:", error);
                alert("Si è verificato un errore.");
            }
        };

        const confirmReportResolution = async (reportId, isResolved) => {
            if (isResolved) {
                await updateReportStatus(reportId, 'chiusa', 'Utente ha confermato la risoluzione.');
            } else {
                openJustificationModal(reportId);
            }
        };

        const openJustificationModal = (reportId) => {
            const modalContent = `
            <form id="justification-form" class="space-y-4">
                <p class="form-label" style="color:var(--secondary-text);">Per favore, descrivi perché ritieni che il problema non sia stato risolto. Questo aiuterà a gestirlo più rapidamente.</p>
                <div>
                    <label for="justification-text" class="form-label">Motivazione</label>
                    <textarea id="justification-text" rows="4" required class="form-textarea" placeholder="Es. La perdita continua, anche se più lentamente..."></textarea>
                </div>
                <div class="flex justify-end gap-4 pt-2">
                    <button type="button" class="btn btn-secondary" onclick="hideModal()">Annulla</button>
                    <button type="submit" class="btn btn-primary">Riapri Segnalazione</button>
                </div>
            </form>
        `;
            showModal('Problema Non Risolto', modalContent);

            document.getElementById('justification-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const justification = document.getElementById('justification-text').value.trim();
                if (!justification) {
                    alert('Per favore, fornisci una motivazione.');
                    return;
                }
                const updateText = `Utente ha riaperto il ticket. Motivazione: "${justification}"`;
                await updateReportStatus(reportId, 'aperta', updateText);
                hideModal();
            });
        };

        const openReassignmentModal = (reportId) => {
            const modalContent = `
                <form id="report-reassignment-form" class="space-y-4">
                    <input type="hidden" id="reassign-report-id" value="${reportId}">
                    <div class="form-group">
                        <label for="reassign-to" class="form-label">Riassegna a:</label>
                        <select id="reassign-to" required class="form-select">
                            <option value="">Seleziona un ruolo...</option>
                            <option value="custode">Custode</option>
                            <option value="fornitore">Fornitore</option>
                        </select>
                    </div>
                    
                    <!-- Opzione condivisione contatti (visibile solo per fornitore) -->
                    <div id="contact-sharing-option" class="form-group hidden">
                        <div style="padding: 1rem; background: var(--surface-color-light); border-radius: var(--radius-sm); border-left: 4px solid var(--accent-color);">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="share-contacts-checkbox" style="margin: 0;">
                                <span style="font-weight: 500;">📞 Condividi informazioni di contatto con il fornitore</span>
                            </label>
                            <p style="font-size: 0.85rem; color: var(--secondary-text); margin: 0.5rem 0 0 1.5rem;">
                                Include nome e telefono del richiedente (se disponibili) nella visualizzazione del ticket per il fornitore
                            </p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="reassign-comment" class="form-label">Motivo/Commento (opzionale)</label>
                        <textarea id="reassign-comment" rows="3" class="form-textarea" placeholder="Aggiungi una nota per il prossimo gestore..."></textarea>
                    </div>
                    <div class="flex justify-end gap-4 pt-2">
                        <button type="button" class="btn btn-secondary" onclick="hideModal()">Annulla</button>
                        <button type="submit" class="btn btn-primary">Conferma Riassegnazione</button>
                    </div>
                </form>
            `;
            showModal('Riassegna Segnalazione', modalContent);

            // Add event listener to show/hide contact sharing option
            const reassignSelect = document.getElementById('reassign-to');
            const contactSharingOption = document.getElementById('contact-sharing-option');

            reassignSelect.addEventListener('change', function () {
                if (this.value === 'fornitore') {
                    contactSharingOption.classList.remove('hidden');
                } else {
                    contactSharingOption.classList.add('hidden');
                    document.getElementById('share-contacts-checkbox').checked = false;
                }
            });

            document.getElementById('report-reassignment-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newRecipient = document.getElementById('reassign-to').value;
                const comment = document.getElementById('reassign-comment').value.trim();
                const shareContacts = document.getElementById('share-contacts-checkbox').checked;
                if (!newRecipient) return;

                await reassignReport(reportId, newRecipient, comment, shareContacts);
            });
        };

        const reassignReport = async (reportId, newRecipient, comment, shareContacts = false) => {
            try {
                const reportRef = doc(db, "reports", reportId);
                let updateText = `Riassegnato a: ${newRecipient}.`;
                if (comment) {
                    updateText += ` Motivo: ${comment}`;
                }
                if (newRecipient === 'fornitore' && shareContacts) {
                    updateText += ` Contatti condivisi con il fornitore.`;
                }

                const newUpdate = {
                    text: updateText,
                    by: `${userProfile.nome} ${userProfile.cognome}`,
                    at: new Date()
                };

                const updateData = {
                    recipientType: newRecipient,
                    status: 'aperta', // Il ticket viene riaperto per il nuovo destinatario
                    updates: arrayUnion(newUpdate),
                    updatedAt: serverTimestamp(),
                    reassignedBy: currentUser.uid // Always track who reassigned
                };

                // Add contact sharing setting if assigning to fornitore
                if (newRecipient === 'fornitore') {
                    updateData.shareContactWithSupplier = shareContacts;
                }

                // Track forwarding information when administrator forwards to external parties
                if (userProfile?.tipoUtente === 'amministratore' && ['fornitore', 'custode', 'consigliere'].includes(newRecipient)) {
                    updateData.forwardedBy = `${userProfile.nome} ${userProfile.cognome}`;
                    updateData.forwardedAt = serverTimestamp();
                    updateData.originalRecipient = 'amministratore';
                    updateData.forwardedByUserId = currentUser.uid;
                }

                await updateDoc(reportRef, updateData);

                await logActivity("report_reassigned", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, {
                    reportId: reportId,
                    newRecipient: newRecipient
                });

                hideModal();
                alert(`Segnalazione riassegnata con successo a: ${newRecipient}.`);

            } catch (error) {
                console.error("Errore durante la riassegnazione:", error);
                alert("Si è verificato un errore durante la riassegnazione.");
            }
        };

        const forwardReportToAdmin = async (reportId) => {
            if (!confirm("Sei sicuro di voler inoltrare questa segnalazione all'amministratore?")) {
                return;
            }

            try {
                const reportRef = doc(db, "reports", reportId);
                const newUpdate = {
                    text: `Inoltrato all'Amministratore dal Custode.`,
                    by: `${userProfile.nome} ${userProfile.cognome}`,
                    at: new Date()
                };

                await updateDoc(reportRef, {
                    recipientType: 'amministratore',
                    status: 'aperta',
                    updates: arrayUnion(newUpdate),
                    updatedAt: serverTimestamp(),
                    forwardedBy: `${userProfile.nome} ${userProfile.cognome}`,
                    forwardedAt: serverTimestamp(),
                    originalRecipient: 'custode'
                });

                await logActivity("report_forwarded", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, {
                    reportId: reportId,
                    newRecipient: 'amministratore'
                });

                alert('Segnalazione inoltrata con successo.');

            } catch (error) {
                console.error("Errore durante l'inoltro della segnalazione:", error);
                alert("Si è verificato un errore durante l'inoltro.");
            }
        };
        const loadStorageItems = async (path) => {
            const container = document.getElementById('storage-list-container');
            const breadcrumbsContainer = document.getElementById('storage-breadcrumbs');
            if (!container || !breadcrumbsContainer) return;

            container.innerHTML = `<p style="color:var(--secondary-text);">Caricamento elementi...</p>`;

            const pathSegments = path.split('/').filter(Boolean);
            let breadcrumbsHtml = `<div class="chip active" onclick="handleBreadcrumbClick('')">Archivio</div>`;
            let currentPath = '';
            pathSegments.forEach(segment => {
                currentPath += segment + '/';
                breadcrumbsHtml += `<div style="color:var(--secondary-text); align-self:center;">/</div><div class="chip active" onclick="handleBreadcrumbClick('${currentPath}')">${segment}</div>`;
            });
            breadcrumbsContainer.innerHTML = breadcrumbsHtml;

            try {
                const listRef = ref(storage, path);
                const res = await listAll(listRef);
                const canManage = ['supervisore', 'adm'].includes(userProfile?.tipoUtente);

                let itemsHtml = '';

                res.prefixes.forEach(folderRef => {
                    const managementActions = canManage ? `
                        <div class="list-item-action flex gap-2">
                            <button onclick="event.stopPropagation(); handleDeleteItem('${folderRef.fullPath}', true)" class="btn-icon" title="Elimina Cartella" style="background:var(--danger); color:white;">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                            </button>
                        </div>
                    ` : '';
                    itemsHtml += `
                    <div class="list-item" onclick="handleFolderClick('${folderRef.name}')">
                        <div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></div>
                        <div class="list-item-content"><div class="title">${folderRef.name}</div></div>
                        ${managementActions}
                    </div>`;
                });

                res.items.forEach(itemRef => {
                    if (itemRef.name === '.placeholder') return;
                    const managementActions = canManage ? `
                        <div class="list-item-action">
                            <button onclick="event.stopPropagation(); handleDeleteItem('${itemRef.fullPath}', false)" class="btn-icon" title="Elimina File" style="background:var(--danger); color:white;">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                            </button>
                        </div>
                    ` : '';
                    itemsHtml += `
                    <div class="list-item" onclick="handleDownloadFile('${itemRef.fullPath}', '${itemRef.name}')">
                        <div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg></div>
                        <div class="list-item-content"><div class="title">${itemRef.name}</div></div>
                        ${managementActions}
                    </div>`;
                });

                if (itemsHtml === '') {
                    container.innerHTML = `<p style="color:var(--secondary-text);">Questa cartella è vuota.</p>`;
                } else {
                    container.innerHTML = itemsHtml;
                }

            } catch (error) {
                console.error("Errore nel caricare l'archivio:", error);
                container.innerHTML = `<div class="message-box error" style="display:block;">Errore: ${error.message}</div>`;
            }
        };

        const handleFolderClick = (folderName) => {
            currentStoragePath += folderName + '/';
            loadStorageItems(currentStoragePath);
        };

        const handleBreadcrumbClick = (path) => {
            currentStoragePath = path;
            loadStorageItems(currentStoragePath);
        };

        const handleFileUpload = (event) => {
            const files = event.target.files;
            if (!files.length) return;

            const uploadPath = selectedUploadPath || currentStoragePath;
            const progressContainer = document.getElementById('upload-progress-container');
            progressContainer.innerHTML = '';
            progressContainer.classList.remove('hidden');

            Array.from(files).forEach(file => {
                const filePath = uploadPath + file.name;
                const storageRef = ref(storage, filePath);
                const uploadTask = uploadBytesResumable(storageRef, file);

                const progressElement = document.createElement('div');
                progressElement.innerHTML = `
                    <div style="margin-bottom: 0.5rem;">Caricamento di <strong>${file.name}</strong> in <i>${uploadPath || 'Archivio'}</i>...</div>
                    <div class="poll-option-bar"><div class="poll-option-fill" id="progress-bar-${file.name.replace(/[^a-zA-Z0-9]/g, '')}" style="background: var(--accent-color);"></div></div>
                `;
                progressContainer.appendChild(progressElement);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        const progressBar = document.getElementById(`progress-bar-${file.name.replace(/[^a-zA-Z0-9]/g, '')}`);
                        if (progressBar) progressBar.style.width = progress + '%';
                    },
                    (error) => {
                        console.error("Errore di upload:", error);
                        progressElement.innerHTML += `<div class="message-box error" style="display:block; margin-top:0.5rem;">Upload fallito: ${error.code}</div>`;
                    },
                    () => {
                        getDownloadURL(uploadTask.snapshot.ref).then(async (downloadURL) => {
                            await logActivity("file_uploaded", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { path: filePath });
                            progressElement.innerHTML = `<div class="message-box success" style="display:block;"><strong>${file.name}</strong> caricato con successo.</div>`;
                            if (uploadPath === currentStoragePath) {
                                loadStorageItems(currentStoragePath);
                            }
                            setTimeout(() => {
                                progressElement.remove();
                                if (progressContainer.childElementCount === 0) {
                                    progressContainer.classList.add('hidden');
                                }
                            }, 5000);
                        });
                    }
                );
            });
            event.target.value = '';
            selectedUploadPath = '';
        };

        const openUploadModal = async () => {
            showModal('Seleziona Cartella di Destinazione', '<p>Caricamento struttura cartelle...</p>');

            const getFolderTree = async (path = '') => {
                const listRef = ref(storage, path);
                const res = await listAll(listRef);
                const children = await Promise.all(res.prefixes.map(folderRef => getFolderTree(folderRef.fullPath)));
                return { name: path.split('/').filter(Boolean).pop() || 'Archivio', path, children };
            };

            const renderFolderTree = (node, level = 0) => {
                let html = `
                    <div class="list-item" style="padding-left: ${level * 1.5}rem; background-color: var(--surface-color-light); margin-bottom: 0.5rem;">
                        <div class="list-item-icon"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></div>
                        <div class="list-item-content"><div class="title">${node.name}</div></div>
                        <div class="list-item-action">
                            <button class="btn btn-primary" style="padding: 0.4rem 0.8rem;" onclick="selectUploadPath('${node.path}')">Carica qui</button>
                        </div>
                    </div>
                `;
                node.children.forEach(child => {
                    html += renderFolderTree(child, level + 1);
                });
                return html;
            };

            try {
                const tree = await getFolderTree();
                const treeHtml = renderFolderTree(tree);
                modalBody.innerHTML = `<div class="list-container">${treeHtml}</div>`;
            } catch (error) {
                modalBody.innerHTML = `<div class="message-box error" style="display:block;">Impossibile caricare la struttura: ${error.message}</div>`;
            }
        };

        const selectUploadPath = (path) => {
            selectedUploadPath = path;
            hideModal();
            document.getElementById('file-upload-input').click();
        };

        const handleRenameFolder = async (oldPath) => {
            const oldName = oldPath.split('/').filter(Boolean).pop();
            const newName = prompt("Inserisci il nuovo nome per la cartella:", oldName);

            if (!newName || newName.trim() === '' || newName.includes('/')) {
                alert("Nome non valido.");
                return;
            }
            if (newName === oldName) return;

            const parentPath = oldPath.substring(0, oldPath.lastIndexOf(oldName));
            const newPath = parentPath + newName.trim() + '/';

            showModal('Ridenominazione in corso...', '<p>Questa operazione potrebbe richiedere alcuni istanti. Non chiudere la pagina.</p>');

            try {
                await moveFolderContents(oldPath, newPath);
                await logActivity("folder_renamed", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { from: oldPath, to: newPath });
                hideModal();
                loadStorageItems(currentStoragePath);
            } catch (error) {
                console.error("Errore durante la ridenominazione:", error);
                hideModal();
                alert(`Errore: ${error.message}`);
            }
        };

        const moveFolderContents = async (oldPath, newPath) => {
            const listRef = ref(storage, oldPath);
            const res = await listAll(listRef);

            // 1. Sposta tutti i file dalla vecchia alla nuova posizione, uno alla volta (sequenziale).
            for (const itemRef of res.items) {
                const newFileRef = ref(storage, newPath + itemRef.name);
                const blob = await getBlob(itemRef); // Usa getBlob per evitare problemi di CORS
                await uploadBytes(newFileRef, blob);
                await deleteObject(itemRef); // Elimina il vecchio file solo dopo la copia
            }

            // 2. Esegui la stessa operazione ricorsivamente per tutte le sottocartelle.
            for (const folderRef of res.prefixes) {
                await moveFolderContents(folderRef.fullPath, newPath + folderRef.name + '/');
            }
        };

        const handleCreateFolder = async () => {
            const folderName = prompt("Inserisci il nome della nuova cartella:");
            if (!folderName || folderName.trim() === '') return;

            // In Storage, le cartelle sono create caricando un file placeholder al loro interno.
            const placeholderPath = `${currentStoragePath}${folderName.trim()}/.placeholder`;
            const placeholderRef = ref(storage, placeholderPath);

            try {
                await uploadBytes(placeholderRef, new Blob()); // Carica un file vuoto
                await logActivity("folder_created", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { path: `${currentStoragePath}${folderName.trim()}` });
                loadStorageItems(currentStoragePath); // Refresh list
            } catch (error) {
                console.error("Errore nella creazione della cartella:", error);
                alert(`Impossibile creare la cartella: ${error.message}`);
            }
        };

        const handleDownloadFile = async (fullPath, fileName) => {
            try {
                const url = await getDownloadURL(ref(storage, fullPath));
                const link = document.createElement('a');
                link.href = url;
                link.target = '_blank'; // Apre in una nuova scheda
                link.download = fileName; // Suggerisce il nome del file per il salvataggio
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error("Errore nel download:", error);
                alert(`Impossibile scaricare il file: ${error.message}`);
            }
        };

        const handleDeleteItem = async (fullPath, isFolder) => {
            const itemType = isFolder ? "cartella" : "file";
            if (!confirm(`Sei sicuro di voler eliminare questo ${itemType}? L'azione è irreversibile.`)) return;

            if (isFolder) {
                // La cancellazione di cartelle non vuote non è supportata direttamente dal client SDK.
                // Eliminiamo il placeholder per "cancellare" la cartella vuota.
                // Per cartelle non vuote, mostriamo un avviso.
                const listRef = ref(storage, fullPath);
                const res = await listAll(listRef);
                if (res.items.length > 1 || res.prefixes.length > 0) {
                    alert("Impossibile eliminare cartelle non vuote dall'app. Si prega di svuotare prima la cartella.");
                    return;
                }
                // Se è vuota (o contiene solo il placeholder), elimina il placeholder.
                const placeholderPath = `${fullPath}/.placeholder`;
                const placeholderRef = ref(storage, placeholderPath);
                try {
                    await deleteObject(placeholderRef);
                    await logActivity("folder_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { path: fullPath });
                    loadStorageItems(currentStoragePath);
                } catch (error) {
                    // Se il placeholder non esiste ma la cartella sì, potrebbe essere un residuo.
                    // In questo caso, l'utente deve gestirlo dalla console Firebase.
                    if (error.code === 'storage/object-not-found') {
                        await logActivity("folder_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { path: fullPath });
                        loadStorageItems(currentStoragePath); // Ricarica per rimuoverla dalla vista
                    } else {
                        console.error(`Errore eliminazione cartella:`, error);
                        alert(`Impossibile eliminare la cartella: ${error.message}`);
                    }
                }
            } else {
                // Cancellazione di un file singolo
                const fileRef = ref(storage, fullPath);
                try {
                    await deleteObject(fileRef);
                    await logActivity("file_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { path: fullPath });
                    loadStorageItems(currentStoragePath);
                } catch (error) {
                    console.error(`Errore eliminazione file:`, error);
                    alert(`Impossibile eliminare il file: ${error.message}`);
                }
            }
        };

        const updateNotificationUI = (service, count) => {
            const navBadge = document.getElementById(`${service}-notification-badge`);
            const dashboardBadge = document.getElementById(`dashboard-${service}-badge`);
            const menuBadge = document.getElementById(`${service}-menu-notification-badge`);
            const badges = [navBadge, dashboardBadge, menuBadge];

            badges.forEach(badge => {
                if (badge) {
                    const shouldBeHidden = count === 0;
                    badge.classList.toggle("hidden", shouldBeHidden);
                    if (!shouldBeHidden) {
                        badge.textContent = count > 9 ? '9+' : count;
                    }
                }
            });
        };
        const checkForNewCommunications = () => {
            if (!currentUser) return;
            communicationsListener && communicationsListener();

            let lastSeen = parseInt(localStorage.getItem(`lastSeenComm_${currentUser.uid}`), 10);

            // Se non c'è un timestamp salvato, inizializza con il timestamp corrente per evitare notifiche per vecchie comunicazioni
            if (!lastSeen) {
                lastSeen = Date.now();
                localStorage.setItem(`lastSeenComm_${currentUser.uid}`, lastSeen);
            }

            const lastSeenDate = new Date(lastSeen);
            const q = query(collection(db, "communications"), where("createdAt", ">", lastSeenDate));

            communicationsListener = onSnapshot(q, snapshot => {
                const unreadCount = snapshot.docs.filter(docSnap => {
                    const comm = docSnap.data();
                    const userGroups = userProfile.proprieta?.map(p => p.gruppo).filter(Boolean) || [];
                    if (!comm.targetGroup || comm.targetGroup === 'Tutti') return true;
                    return userGroups.includes(comm.targetGroup);
                }).length;
                updateNotificationUI('bacheca', unreadCount);
            });
        };

        const checkForNewPolls = () => {
            if (!currentUser) return;
            pollsListener && pollsListener();
            const lastSeen = parseInt(localStorage.getItem(`lastSeenPoll_${currentUser.uid}`), 10) || 0;
            const lastSeenDate = new Date(lastSeen);
            const q = query(collection(db, "polls"), where("createdAt", ">", lastSeenDate));
            pollsListener = onSnapshot(q, snapshot => {
                const unreadCount = snapshot.size; // Per i sondaggi, tutti i nuovi sono rilevanti
                updateNotificationUI('sondaggi', unreadCount);
            });
        };

        const checkForNewReports = () => {
            if (!currentUser || !["amministratore", "custode", "consigliere", "fornitore", "supervisore", "adm"].includes(userProfile?.tipoUtente)) return;
            reportsListener && reportsListener();

            let lastSeen = parseInt(localStorage.getItem(`lastSeenReport_${currentUser.uid}`), 10);

            // Se non c'è un timestamp salvato, inizializza con il timestamp corrente per evitare notifiche per vecchi report
            if (!lastSeen) {
                lastSeen = Date.now();
                localStorage.setItem(`lastSeenReport_${currentUser.uid}`, lastSeen);
            }

            const lastSeenDate = new Date(lastSeen);

            let q;
            if (['supervisore', 'adm', 'amministratore', 'consigliere'].includes(userProfile.tipoUtente)) {
                // Supervisore, Admin, Amministratore e Consigliere vedono le notifiche per tutte le nuove e aggiornate segnalazioni
                q = query(collection(db, "reports"), where("updatedAt", ">", lastSeenDate));
            } else {
                // Gli altri ruoli manageriali vedono solo quelle a loro destinate che sono state aggiornate
                q = query(collection(db, "reports"), where("recipientType", "==", userProfile.tipoUtente), where("updatedAt", ">", lastSeenDate));
            }

            reportsListener = onSnapshot(q, snapshot => {
                const unreadCount = snapshot.size;
                updateNotificationUI('segnalazioni', unreadCount);
            });
        };

        const checkForNewSolleciti = () => {
            if (!currentUser || !['supervisore', 'adm', 'amministratore', 'consigliere'].includes(userProfile?.tipoUtente)) return;
            sollecitisListener && sollecitisListener();

            let lastSeen = parseInt(localStorage.getItem(`lastSeenSolleciti_${currentUser.uid}`), 10);

            // Se non c'è un timestamp salvato, inizializza con il timestamp corrente per evitare notifiche per vecchi solleciti
            if (!lastSeen) {
                lastSeen = Date.now();
                localStorage.setItem(`lastSeenSolleciti_${currentUser.uid}`, lastSeen);
            }

            const lastSeenDate = new Date(lastSeen);

            // Query per solleciti urgenti - segnalazioni con priorità alta che sono ancora aperte
            const q = query(
                collection(db, "reports"),
                where("priority", "in", ["alta", "richiesta-intervento-danno"]),
                where("status", "in", ["aperta", "in-corso"]),
                where("updatedAt", ">", lastSeenDate)
            );

            sollecitisListener = onSnapshot(q, snapshot => {
                const unreadCount = snapshot.size;
                updateNotificationUI('solleciti', unreadCount);
            });
        };

        // Nuova funzione per notificare di nuovi file/cartelle nell'archivio
        const checkForNewArchivioActivity = () => {
            if (!currentUser || !['supervisore', 'adm', 'amministratore', 'consigliere'].includes(userProfile?.tipoUtente)) return;

            let lastSeen = parseInt(localStorage.getItem(`lastSeenArchivio_${currentUser.uid}`), 10);

            // Se non c'è un timestamp salvato, inizializza con il timestamp corrente
            if (!lastSeen) {
                lastSeen = Date.now();
                localStorage.setItem(`lastSeenArchivio_${currentUser.uid}`, lastSeen);
            }

            const lastSeenDate = new Date(lastSeen);

            // Query per attività di archivio (file caricati, cartelle create)
            const q = query(
                collection(db, "activities"),
                where("action", "in", ["file_uploaded", "folder_created"]),
                where("timestamp", ">", lastSeenDate)
            );

            onSnapshot(q, snapshot => {
                const unreadCount = snapshot.size;
                updateNotificationUI('gestione-archivio', unreadCount);
                updateNotificationUI('archivio', unreadCount); // Also update main archivio badge
            });
        };

        // Nuova funzione per notificare i creatori di segnalazioni quando i loro report vengono aggiornati
        const checkForUserReportUpdates = () => {
            if (!currentUser) return;

            let lastSeen = parseInt(localStorage.getItem(`lastSeenSegnalazioniInviate_${currentUser.uid}`), 10);

            // Se non c'è un timestamp salvato, inizializza con il timestamp corrente per evitare notifiche per vecchi aggiornamenti
            if (!lastSeen) {
                lastSeen = Date.now();
                localStorage.setItem(`lastSeenSegnalazioniInviate_${currentUser.uid}`, lastSeen);
            }

            const lastSeenDate = new Date(lastSeen);

            // Query per segnalazioni create dall'utente che sono state aggiornate
            const q = query(
                collection(db, "reports"),
                where("createdById", "==", currentUser.uid),
                where("updatedAt", ">", lastSeenDate)
            );

            onSnapshot(q, snapshot => {
                // Filtra solo i report che sono stati aggiornati da altri (non dall'utente stesso)
                const updatedByOthers = snapshot.docs.filter(doc => {
                    const report = doc.data();
                    const lastUpdate = report.updates && report.updates.length > 0 ?
                        report.updates[report.updates.length - 1] : null;

                    // Se c'è un aggiornamento e non è stato fatto dall'utente corrente, o se lo status è cambiato
                    const userFullName = `${userProfile?.nome} ${userProfile?.cognome}`;
                    const wasUpdatedByOthers = lastUpdate && lastUpdate.by !== userFullName;
                    const statusChanged = report.status !== 'aperta'; // Considera cambiamenti di stato

                    return wasUpdatedByOthers || statusChanged;
                });

                const unreadCount = updatedByOthers.length;
                updateNotificationUI('segnalazioni-inviate', unreadCount);
            });
        };

        window.navigateTo = navigateTo;
        window.navigateBack = navigateBack;
        window.logout = logout;
        window.toggleTheme = toggleTheme;
        window.refreshApplication = refreshApplication;
        window.voteOnPoll = voteOnPoll;
        window.updateReportStatus = updateReportStatus;
        window.toggleContactSharing = toggleContactSharing;
        window.openReportUpdateModal = openReportUpdateModal;
        window.sendReportReminder = sendReportReminder;
        window.confirmReportResolution = confirmReportResolution;
        window.openReassignmentModal = openReassignmentModal;
        window.forwardReportToAdmin = forwardReportToAdmin;
        window.openJustificationModal = openJustificationModal;
        window.showCommunicationDetail = showCommunicationDetail;
        window.showPollVoters = showPollVoters;
        window.hideModal = hideModal;
        window.openGroupEditModal = openGroupEditModal;
        window.updatePartialCondo = updatePartialCondo;
        window.deletePartialCondo = deletePartialCondo;
        window.deleteUsefulNumber = deleteUsefulNumber;
        window.editUsefulNumber = editUsefulNumber;
        window.deleteMultipleUsefulNumbers = deleteMultipleUsefulNumbers;
        window.toggleAllContacts = toggleAllContacts;
        window.updateBulkActions = updateBulkActions;
        window.deleteSelectedContacts = deleteSelectedContacts;
        window.toggleAllContactsRubrica = toggleAllContactsRubrica;
        window.updateBulkActionsRubrica = updateBulkActionsRubrica;
        window.deleteSelectedContactsRubrica = deleteSelectedContactsRubrica;
        window.toggleAllContactsImported = toggleAllContactsImported;
        window.updateBulkActionsImported = updateBulkActionsImported;
        window.deleteSelectedContactsImported = deleteSelectedContactsImported;
        window.editImportedContact = editImportedContact;
        window.deleteImportedContact = deleteImportedContact;
        window.deleteMultipleImportedContacts = deleteMultipleImportedContacts;
        window.toggleAllContactsRubricaImported = toggleAllContactsRubricaImported;
        window.updateBulkActionsRubricaImported = updateBulkActionsRubricaImported;
        window.deleteSelectedContactsRubricaImported = deleteSelectedContactsRubricaImported;
        window.editImportedScheduleEntry = editImportedScheduleEntry;
        window.deleteImportedScheduleEntry = deleteImportedScheduleEntry;
        window.editImportedAdminEntry = editImportedAdminEntry;
        window.deleteImportedAdminEntry = deleteImportedAdminEntry;
        window.openRuleEditor = openRuleEditor;
        window.deleteGroupRule = deleteGroupRule;
        window.toggleRuleStatus = toggleRuleStatus;
        window.toggleGroupListVisibility = toggleGroupListVisibility;
        window.loadElencoCondomini = loadElencoCondomini;
        window.deleteUser = deleteUser;
        window.openUserEditModal = openUserEditModal;
        window.handleReportFileSelection = handleReportFileSelection;
        window.removeReportFile = removeReportFile;
        window.handleCommunicationFileSelection = handleCommunicationFileSelection;
        window.removeCommunicationFile = removeCommunicationFile;
        window.handleFolderClick = handleFolderClick;
        window.handleBreadcrumbClick = handleBreadcrumbClick;
        window.handleFileUpload = handleFileUpload;
        window.handleCreateFolder = handleCreateFolder;
        window.handleDownloadFile = handleDownloadFile;
        window.handleDeleteItem = handleDeleteItem;
        window.openUploadModal = openUploadModal;
        window.selectUploadPath = selectUploadPath;
        window.handleRenameFolder = handleRenameFolder;
        window.loadItemsForCleanup = loadItemsForCleanup;
        window.toggleAllForCleanup = toggleAllForCleanup;
        window.handleCleanupSelectionChange = handleCleanupSelectionChange;
        window.handleBulkDelete = handleBulkDelete;
        window.clearActivityHistory = clearActivityHistory;
        window.deleteAdministrativePeriod = deleteAdministrativePeriod; // NUOVO

        const deletePoll = async (pollId) => {
            if (!confirm('Sei sicuro di voler eliminare questo sondaggio? L\'azione è irreversibile.')) {
                return;
            }
            try {
                await deleteDoc(doc(db, 'polls', pollId));
                await logActivity("poll_deleted", currentUser.uid, `${userProfile.nome} ${userProfile.cognome}`, { deletedPollId: pollId });
            } catch (error) {
                console.error("Errore durante l'eliminazione del sondaggio:", error);
                alert("Si è verificato un errore durante l'eliminazione.");
            }
        };

        window.updateUser = updateUser;
        window.deletePoll = deletePoll;

        let availableGroups = []; // Variabile globale per contenere i gruppi

        const addPropertyRow = () => {
            const container = document.getElementById('properties-editor-container');
            if (!container) return;

            const groupOptionsHtml = availableGroups.map(group =>
                `<option value="${group.name}">${group.name}</option>`
            ).join('');

            const newRow = document.createElement('div');
            newRow.className = 'property-edit-row grid grid-cols-4 gap-2 items-center';
            newRow.style.marginBottom = '0.5rem';
            newRow.innerHTML = `
                <input type="text" data-field="interno" value="" class="form-input" placeholder="ID Unità">
                <input type="number" step="0.01" data-field="millesimi" value="0" class="form-input" placeholder="Millesimi">
                <select data-field="gruppo" class="form-select">
                    <option value="">Nessun Gruppo</option>
                    ${groupOptionsHtml}
                </select>
                <button type="button" onclick="this.parentElement.remove()" class="btn-icon" style="background:var(--danger); color:white;">&times;</button>
            `;
            container.appendChild(newRow);
        };
        window.addPropertyRow = addPropertyRow;

        // Initialize theme immediately on page load
        initializeTheme();

        // --- FUNZIONE onAuthStateChanged CORRETTA E ROBUSTA ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // L'utente è loggato o si è appena loggato
                currentUser = user;
                await loadUserProfile(user);
                await loadServicePermissions();
                await loadCurrentAdministrativePeriod(); // NUOVO

                const userType = userProfile?.tipoUtente;
                let landingPage = 'dashboard';

                // Se l'utente si trova sulla pagina di login, lo reindirizziamo alla sua home.
                // Altrimenti (se ha ricaricato la pagina), gli mostriamo la pagina su cui si trovava.
                if (currentPage === 'login' || !currentPage) {
                    navigateTo(landingPage);
                } else {
                    await renderCurrentPage();
                }

            } else {
                // L'utente non è loggato o ha appena fatto logout
                if (communicationsListener) {
                    communicationsListener();
                    communicationsListener = null;
                }
                if (pollsListener) { // NUOVO BLOCCO
                    pollsListener();
                    pollsListener = null;
                }
                if (reportsListener) { // NUOVO BLOCCO
                    reportsListener();
                    reportsListener = null;
                }
                currentUser = null;
                userProfile = null;
                navigationHistory = []; // Resetta la cronologia al logout
                // Resetta lo stato specifico della registrazione per evitare dati "sporchi"
                groupedProperties = {};
                partialCondosList = [];

                // Naviga alla pagina di login in modo pulito
                navigateTo('login');
            }
        });

        // Add keyboard shortcut for refresh (Ctrl+R or F5)
        document.addEventListener('keydown', (e) => {
            // Prevent default browser refresh and use our custom refresh function
            if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
                e.preventDefault();
                if (currentUser && currentPage !== 'login') {
                    refreshApplication();
                }
            }
        });
    </script>

    <!-- Registrazione del Service Worker per la PWA -->
    <script>
        // Controlliamo se il browser supporta i service worker
        if ('serviceWorker' in navigator) {
            // Aspettiamo che la pagina sia completamente caricata per non rallentare l'avvio
            window.addEventListener('load', () => {
                // Registriamo il nostro file sw.js
                // Il percorso è fondamentale per GitHub Pages!
                navigator.serviceWorker.register('/Con-bridge/sw.js')
                    .then(registration => {
                        console.log('Service Worker registrato con successo:', registration);
                    })
                    .catch(error => {
                        console.log('Registrazione Service Worker fallita:', error);
                    });
            });
        }
    </script>
</body>

</html>
